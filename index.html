<script>
// ===== Cart (persistent + renders to overlay) =====
const CART_KEY = 'fitsnacks.cart.v1';
const fmt = n => '$' + n.toFixed(2);

function loadCart() {
  try { return new Map(JSON.parse(localStorage.getItem(CART_KEY) || '[]')); }
  catch { return new Map(); }
}
function saveCart(map) {
  localStorage.setItem(CART_KEY, JSON.stringify(Array.from(map.entries())));
}

let cart = loadCart();

function refreshBadge(){
  let n = 0; for (const v of cart.values()) n += v.qty;
  const b = document.querySelector('#cartBadge');
  if (!b) return;
  if (n > 0) { b.textContent = n; b.style.display = 'inline-flex'; }
  else { b.style.display = 'none'; }
}

function renderCart(){
  let total = 0;
  let html = '';

  for (const [name, info] of cart) {
    const line = info.price * info.qty;
    total += line;
    html += `
      <div class="row-between" style="margin-top:8px; gap:10px">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <button class="ghost" data-act="dec" data-name="${name}" style="padding:4px 10px">−</button>
          <div style="min-width:28px;text-align:center">${info.qty}</div>
          <button class="ghost" data-act="inc" data-name="${name}" style="padding:4px 10px">+</button>
          <div style="font-weight:700;margin-left:4px">${name}</div>
          <button class="ghost" data-act="del" data-name="${name}" style="padding:4px 10px">Remove</button>
        </div>
        <div style="font-weight:700">${fmt(line)}</div>
      </div>`;
  }

  const list = document.querySelector('#cartContent');
  list.innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
  document.querySelector('#cartTotal').textContent = fmt(total);

  saveCart(cart);
  refreshBadge();
}

// Handle +/−/remove inside cart
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if (!btn || !btn.dataset.act || !btn.dataset.name) return;

  const name = btn.dataset.name;
  const entry = cart.get(name);
  if (!entry) return;

  if (btn.dataset.act === 'inc') entry.qty += 1;
  if (btn.dataset.act === 'dec') entry.qty = Math.max(1, entry.qty - 1);
  if (btn.dataset.act === 'del') cart.delete(name);

  renderCart();
}, {passive:true});

// Hook the quick-add sheet
let current = null;
document.querySelectorAll('.add').forEach(b => b.addEventListener('click', e => {
  const card = e.target.closest('.card');
  current = { name: card.dataset.name, price: parseFloat(card.dataset.price) };
  document.querySelector('#sheetTitle').textContent = current.name;
  document.querySelector('#sheetPrice').textContent = fmt(current.price);
  document.querySelector('#qtyVal').textContent = 1;
  document.querySelector('#sheetAdd').textContent = 'Add • ' + fmt(current.price);
  document.querySelector('#productSheet').classList.add('show');
}));

document.querySelector('#qtyPlus').addEventListener('click', ()=>{
  const n = Math.min(99, parseInt(document.querySelector('#qtyVal').textContent) + 1);
  document.querySelector('#qtyVal').textContent = n;
  document.querySelector('#sheetAdd').textContent = 'Add • ' + fmt(current.price * n);
});
document.querySelector('#qtyMinus').addEventListener('click', ()=>{
  const n = Math.max(1, parseInt(document.querySelector('#qtyVal').textContent) - 1);
  document.querySelector('#qtyVal').textContent = n;
  document.querySelector('#sheetAdd').textContent = 'Add • ' + fmt(current.price * n);
});
function closeSheet(){ document.querySelector('#productSheet').classList.remove('show'); }
document.querySelector('#sheetCancel').addEventListener('click', closeSheet);
document.querySelector('#sheetClose').addEventListener('click', closeSheet);

document.querySelector('#sheetAdd').addEventListener('click', ()=>{
  const n = parseInt(document.querySelector('#qtyVal').textContent);
  const existing = cart.get(current.name) || { price: current.price, qty: 0 };
  existing.qty += n;
  cart.set(current.name, existing);
  closeSheet();
  renderCart();                                   // show items in list
  document.querySelector('#cartOverlay').classList.add('show'); // open cart
});

// open/close cart refresh
function openCart(){ renderCart(); document.querySelector('#cartOverlay').classList.add('show'); }
function closeCart(){ document.querySelector('#cartOverlay').classList.remove('show'); }
document.addEventListener('click', (e)=>{
  if (e.target.closest('#cartBtn')) openCart();
  if (e.target.closest('#cartClose')) closeCart();
}, {passive:true});

// show saved cart + badge on load
renderCart();
</script>