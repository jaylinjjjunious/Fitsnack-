<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>FitSnacks</title>
  <meta name="theme-color" content="#0b0b0d">
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root{
      --bg:#0b0b0d;
      --card:rgba(20,20,24,.6);
      --text:#e9e9ec;
      --muted:#b9bac4;
      --accent:#6ea8fe;
      --danger:#ff5c5c;
      --ok:#3cd27f;
      --radius:18px;
      --border:rgba(255,255,255,.10);
      --glass:blur(16px);
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif}
    .app{max-width:393px;min-height:100svh;margin:0 auto;padding:12px 12px 36px;box-sizing:border-box}

    /* shared glass */
    .glass{backdrop-filter:var(--glass);-webkit-backdrop-filter:var(--glass);background:var(--card);border:1px solid var(--border);}

    /* header */
    .row{display:flex;align-items:center;gap:10px}
    .search-wrap{position:relative;flex:1}
    .search{width:100%;border-radius:999px;padding:12px 42px 12px 38px;border:1px solid #2a2a30;background:#141418;color:var(--text);outline:none}
    .search::placeholder{color:#8e8e96}
    .icon-left{position:absolute;left:12px;top:50%;transform:translateY(-50%)}
    .icon-btn{width:44px;height:44px;border-radius:14px;border:1px solid #2a2a30;background:#17171c;color:var(--text);display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .badge{position:absolute;top:-6px;right:-6px;background:#ff3b30;color:#fff;border-radius:999px;padding:1px 6px;font-size:12px;font-weight:700;display:none}

    /* greet */
    .greet{margin:8px 2px 6px;color:#c7c7cc;font-size:14px}

    /* promo card-snap carousel */
    .carousel{margin:6px 0 10px}
    .snap{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding:0 12px}
    .snap::-webkit-scrollbar{display:none}
    .snap-spacer{flex:0 0 7%}
    .snap-card{flex:0 0 86%;height:100px;border-radius:14px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.28);scroll-snap-align:center}
    .snap-card img{width:100%;height:100%;object-fit:cover;display:block}
    .snap-meta{position:absolute;left:10px;right:10px;bottom:8px;display:flex;justify-content:space-between;align-items:end;gap:8px}
    .snap-title{font-weight:800;text-shadow:0 1px 6px rgba(0,0,0,.6)}
    .snap-cta{border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.25);color:#eaeaf0;border-radius:10px;padding:6px 10px;cursor:pointer}
    .snap-dots{display:flex;justify-content:center;gap:6px;margin-top:6px}
    .dot{width:6px;height:6px;border-radius:999px;background:#2d3447;border:1px solid rgba(255,255,255,.18)}
    .dot.active{background:#7fb1ff}

    /* chips */
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .chip{border-radius:999px;padding:6px 10px;border:1px solid #2a2a30;background:#191a20;cursor:pointer}
    .chip.active{box-shadow:0 0 0 2px rgba(110,168,254,.45) inset}

    /* grid */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{position:relative;border-radius:16px;padding:12px;border:1px solid var(--border);background:rgba(24,24,32,.6);display:flex;flex-direction:column;min-height:190px}
    .thumb{height:92px;border-radius:12px;overflow:hidden;background:#0f0f12;display:flex;align-items:center;justify-content:center;margin-bottom:8px}
    .thumb img{width:100%;height:100%;object-fit:contain}
    .title{font-weight:700;margin-top:2px}
    .price{color:#cfd0d7;margin-top:auto}
    .add{position:absolute;right:12px;bottom:12px;background:var(--accent);color:#071427;border:none;border-radius:14px;width:42px;height:42px;font-size:22px;font-weight:800;cursor:pointer}
    .fav{position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);cursor:pointer}
    .fav.active{background:rgba(255,215,0,.14);box-shadow:0 0 0 1px rgba(255,215,0,.35) inset}

    /* overlays */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:18px;z-index:10000}
    .overlay.show{display:flex}
    .sheet{width:100%;max-width:480px;border-radius:22px 22px 0 0;padding:14px 14px calc(16px + env(safe-area-inset-bottom));position:relative;transform:translateY(100%);animation:slideUp .22s ease-out forwards}
    .sheet.glass{background:rgba(24,24,32,.92)}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .ghost{border:1px solid #2a2a30;background:#1b1b20;color:#e9e9ec;border-radius:12px;padding:8px 10px;cursor:pointer}
    .primary{background:var(--accent);border:0;color:#071427;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .field{display:flex;align-items:center;gap:8px;padding:8px;border-radius:12px;border:1px solid #2a2a30;background:#101014;color:#e9e9ec}

    /* lists */
    .admin-list{border:1px solid #2a2a30;border-radius:12px;padding:8px;margin-top:8px}
    .line{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 0;border-top:1px solid rgba(255,255,255,.07)}
    .line:first-child{border-top:none}

    /* tabs */
    .tabs{display:flex;gap:8px;margin:6px 0 12px}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid #2a2a30;background:#18181d;cursor:pointer}
    .tab.active{background:#26262d}
    .subtabs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
    .subtab{padding:6px 10px;border-radius:10px;border:1px solid #2a2a30;background:#18181d;cursor:pointer;font-size:13px}
    .subtab.active{background:#26262d}

    /* mini product sheet */
    .qty{display:flex;align-items:center;gap:10px}
    .qty button{width:36px;height:36px;border-radius:10px;border:1px solid #2a2a30;background:#1c1c22;color:var(--text);font-size:20px;font-weight:700}

    /* analytics (simple) */
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{padding:10px;border-radius:12px;border:1px solid var(--border)}
    .kpi .label{color:#c7c7cc;font-size:12px}
    .kpi .value{font-weight:800;font-size:18px;margin-top:4px}

    /* toast */
    #toastHost{position:fixed;left:0;right:0;bottom:calc(16px + env(safe-area-inset-bottom));display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;z-index:11000}
    .toast{pointer-events:auto;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:rgba(24,24,32,.92);font-weight:600;opacity:0;transform:translateY(8px);transition:opacity .22s ease,transform .22s ease}
    .toast.show{opacity:1;transform:translateY(0)}

    /* ensure order sheet always above settings if both are open */
    #orderOverlay{z-index:10050}
  </style>
</head>

<body>
  <div class="app" role="application">
    <!-- Header -->
    <div class="row">
      <div class="search-wrap">
        <span class="icon-left" aria-hidden="true">üîç</span>
        <input id="search" class="search" placeholder="Search snacks‚Ä¶" autocomplete="off">
      </div>
      <button id="cartBtn" class="icon-btn" aria-label="Open cart" style="position:relative">
        üõí <span id="cartBadge" class="badge">0</span>
      </button>
      <button id="settingsBtn" class="icon-btn" aria-label="Open settings">‚öôÔ∏è</button>
    </div>

    <!-- Greeting -->
    <div id="greet" class="greet">Welcome üëã</div>

    <!-- Promo carousel -->
    <div class="carousel" aria-label="Promotions">
      <div id="snap" class="snap" aria-roledescription="carousel">
        <div class="snap-spacer" aria-hidden="true"></div>
        <!-- promo cards injected by JS -->
        <div class="snap-spacer" aria-hidden="true"></div>
      </div>
      <div id="snapDots" class="snap-dots" aria-hidden="true"></div>
    </div>

    <!-- Chips -->
    <div id="chips" class="chips" role="listbox" aria-label="Filters">
      <div class="chip" data-filter="">all</div>
      <div class="chip" data-filter="vegan">vegan</div>
      <div class="chip" data-filter="gluten-free">gluten-free</div>
      <div class="chip" data-filter="protein">protein</div>
      <div class="chip" data-filter="favorites">favorites</div>
    </div>

    <!-- Product grid -->
    <div id="grid" class="grid" role="list">
      <!-- Example seed products; you can extend freely -->
      <div class="card" role="listitem" data-name="Potato Chips" data-price="2.50" data-img="assets/product-funyuns.jpg" data-tags="snack">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-funyuns.jpg" alt="Potato Chips" loading="lazy"></div>
        <div class="title">Potato Chips</div>
        <div class="price">$2.50</div>
        <button class="add" aria-label="Add Potato Chips">+</button>
      </div>

      <div class="card" role="listitem" data-name="Protein Bar" data-price="2.99" data-img="assets/product-chesters.jpg" data-tags="protein">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-chesters.jpg" alt="Protein Bar" loading="lazy"></div>
        <div class="title">Protein Bar</div>
        <div class="price">$2.99</div>
        <button class="add" aria-label="Add Protein Bar">+</button>
      </div>

      <div class="card" role="listitem" data-name="Trail Mix" data-price="3.49" data-img="assets/product-cheetos.jpg" data-tags="vegan,gluten-free">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-cheetos.jpg" alt="Trail Mix" loading="lazy"></div>
        <div class="title">Trail Mix</div>
        <div class="price">$3.49</div>
        <button class="add" aria-label="Add Trail Mix">+</button>
      </div>
    </div>
  </div> <!-- /app -->

  <!-- Mini product sheet -->
  <div id="productOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Add item">
    <div class="sheet glass" role="document">
      <div class="row-between">
        <h3 id="sheetTitle">Item</h3>
        <button id="sheetClose" class="ghost">Close</button>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
        <div style="width:88px;height:88px;border-radius:12px;overflow:hidden;border:1px solid #2a2a30">
          <img id="sheetImg" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div style="flex:1">
          <div id="sheetPrice" class="price" style="font-size:18px"></div>
          <div id="sheetStock" style="margin-top:6px;color:#c7c7cc;font-size:13px">Stock: --</div>
          <div id="sheetLowWarn" style="display:none;margin-top:6px;color:#ff6b6b;font-weight:600;font-size:13px">Low stock</div>
        </div>
      </div>

      <div class="row-between" style="margin-top:10px">
        <div class="qty">
          <button id="qtyMinus" aria-label="Decrease">‚àí</button>
          <div id="qtyVal">1</div>
          <button id="qtyPlus" aria-label="Increase">+</button>
        </div>
        <button id="sheetAdd" class="primary">Add</button>
      </div>
    </div>
  </div>

  <!-- Cart sheet -->
  <div id="cartOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Cart">
    <div class="sheet glass" role="document">
      <div class="row-between">
        <h3>Cart</h3>
        <button id="cartClose" class="ghost">Close</button>
      </div>

      <div id="cartContent" class="admin-list">Cart is empty</div>

      <div class="row-between" style="margin-top:10px">
        <strong>Total</strong><strong id="cartTotal">$0.00</strong>
      </div>

      <div class="row" style="gap:10px;margin-top:12px">
        <button id="reorderLast" class="ghost">Re-order last</button>
        <button id="cartCheckout" class="primary" style="margin-left:auto">Checkout</button>
      </div>
    </div>
  </div>

  <!-- Checkout sheet -->
  <div id="checkoutOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Checkout">
    <div class="sheet glass" role="document">
      <div class="row-between">
        <h3>Checkout</h3>
        <button id="checkoutClose" class="ghost">Close</button>
      </div>

      <div class="admin-list" style="margin-top:10px">
        <div class="line"><span>Your name</span></div>
        <input id="checkoutName" class="field" placeholder="Your name">
        <div class="line"><span>Where are you on campus?</span></div>
        <input id="checkoutLocation" class="field" placeholder="Location">
      </div>

      <!-- Promo -->
      <div class="row" style="gap:8px;margin-top:12px">
        <input id="checkoutPromo" class="field" placeholder="Promo code" style="flex:1;min-width:0">
        <button id="checkoutApplyPromo" class="ghost">Apply</button>
        <div id="promoStatus" style="display:none" class="ghost"></div>
      </div>

      <!-- Tip -->
      <div style="margin-top:12px">Tip (optional)</div>
      <div id="tipGroup" class="row" style="gap:8px;flex-wrap:wrap;margin-top:6px">
        <button class="ghost tip-btn" data-tip="none">No tip</button>
        <button class="ghost tip-btn" data-tip="amount:1">$1</button>
        <button class="ghost tip-btn" data-tip="amount:2">$2</button>
        <button class="ghost tip-btn" data-tip="percent:10">10%</button>
        <div style="margin-left:auto;display:flex;gap:8px">
          <input id="tipCustomAmount" type="number" min="0" step="0.5" class="field" placeholder="Custom $" style="width:120px">
          <button id="tipApplyCustom" class="ghost">Set</button>
        </div>
      </div>

      <!-- Notes -->
      <div style="margin-top:12px">Delivery notes (optional)</div>
      <textarea id="checkoutNotes" class="field" placeholder="e.g., Meet at library entrance"></textarea>

      <!-- Breakdown -->
      <div class="admin-list" style="margin-top:12px">
        <div class="line"><div>Subtotal</div><div id="ckSub">$0.00</div></div>
        <div class="line"><div>Discount</div><div id="ckDisc">-$0.00</div></div>
        <div class="line"><div>Tip</div><div id="ckTip">$0.00</div></div>
        <div class="line" style="font-weight:800"><div>Total</div><div id="ckTotal">$0.00</div></div>
      </div>

      <div id="checkoutError" style="display:none;color:#ff6b6b;margin-top:10px">Please fill both fields.</div>

      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="checkoutSubmit" class="primary">Place Order</button>
      </div>
    </div>
  </div>

  <!-- Settings sheet -->
  <div id="settingsOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Settings">
    <div class="sheet glass" role="document">
      <div class="row-between">
        <h3>Settings</h3>
        <button id="settingsClose" class="ghost">Close</button>
      </div>

      <div class="tabs" role="tablist" aria-label="Settings Tabs">
        <button id="tabGeneral" class="tab active" role="tab" aria-selected="true" aria-controls="panelGeneral">General</button>
        <button id="tabAdmin" class="tab" role="tab" aria-selected="false" aria-controls="panelAdmin">Admin</button>
      </div>

      <div id="panelGeneral" role="tabpanel" aria-labelledby="tabGeneral">
        <div class="row" style="gap:12px">
          <div class="ghost">Dark Mode (disabled)</div>
          <div class="ghost">Notifications (disabled)</div>
        </div>
      </div>

      <div id="panelAdmin" role="tabpanel" aria-labelledby="tabAdmin" style="display:none">
        <!-- Login -->
        <div id="adminLogin">
          <div style="margin-top:6px">Admin password:</div>
          <input id="adminPassword" type="password" class="field" placeholder="Password">
          <div id="adminError" style="display:none;color:#ff6b6b;margin-top:6px">Wrong password.</div>
          <div class="row" style="margin-top:12px">
            <button id="adminSubmit" class="primary">Unlock</button>
          </div>
        </div>

        <!-- Content -->
        <div id="adminContent" style="display:none">
          <div class="subtabs">
            <button class="subtab active" data-subtab="orders">Orders</button>
            <button class="subtab" data-subtab="inventory">Inventory</button>
            <button class="subtab" data-subtab="analytics">Analytics</button>
            <button class="subtab" data-subtab="history">History</button>
          </div>

          <div class="row" style="gap:8px;margin:4px 0 8px;align-items:center">
            <button id="adminLock" class="ghost">Lock Admin</button>
            <div id="adminState" style="font-size:12px;color:#c7c7cc">State: <strong id="adminStateVal">unknown</strong></div>
          </div>

          <div id="subtab-orders">
            <div style="margin-top:6px;font-weight:700">Orders</div>
            <div id="ordersList" class="admin-list">No orders yet</div>
          </div>

          <div id="subtab-inventory" style="display:none">
            <div style="margin-top:6px;font-weight:700">Inventory (Stock & Low)</div>
            <div id="inventoryList" class="admin-list">Loading‚Ä¶</div>
          </div>

          <div id="subtab-analytics" style="display:none">
            <div style="margin-top:6px;font-weight:700">Analytics Overview</div>
            <div class="kpis" style="margin-top:8px">
              <div class="kpi"><div class="label">Revenue</div><div id="kpiRevenue" class="value">$0.00</div></div>
              <div class="kpi"><div class="label">Orders</div><div id="kpiOrders" class="value">0</div></div>
              <div class="kpi"><div class="label">AOV</div><div id="kpiAOV" class="value">$0.00</div></div>
              <div class="kpi"><div class="label">Items sold</div><div id="kpiItems" class="value">0</div></div>
            </div>
            <div style="margin-top:12px;font-weight:700">Top Products</div>
            <div id="topProducts" class="admin-list"></div>
            <div style="margin-top:12px;font-weight:700">Funnel by Product</div>
            <div id="funnels" class="admin-list"></div>
          </div>

          <div id="subtab-history" style="display:none">
            <div class="row-between" style="margin-top:6px">
              <div style="font-weight:700">Delivered Orders (auto-clears after 3 days)</div>
              <button id="historyClear" class="ghost">Clear history now</button>
            </div>
            <div id="historyList" class="admin-list" style="margin-top:8px">No delivered orders</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order details sheet (admin) -->
  <div id="orderOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Order details">
    <div class="sheet glass" role="document">
      <div class="row-between">
        <h3>Order</h3>
        <button id="orderClose" class="ghost">Close</button>
      </div>
      <div id="orderMeta" style="margin-top:6px;color:#c7c7cc;font-size:13px">‚Äì</div>
      <div id="orderLines" class="admin-list" style="margin-top:8px">‚Äì</div>
      <div class="row-between" style="margin-top:10px">
        <strong>Total</strong><strong id="orderTotal">$0.00</strong>
      </div>
      <div class="row" style="gap:10px;margin-top:12px">
        <button id="orderCancel" class="ghost">Cancel</button>
        <button id="orderDelivered" class="primary" style="margin-left:auto">Mark Delivered</button>
      </div>
    </div>
  </div>

  <!-- Toast host -->
  <div id="toastHost"></div>

<script>
/* =========================
   FitSnacks App ‚Äì Core JS
   (Chunk 3/8)
   ========================= */

/* --- Schema + service worker --- */
const APP_SCHEMA_VERSION = 3;
const SCHEMA_KEY = 'fitsnacks.schema.v';
try {
  const cur = Number(localStorage.getItem(SCHEMA_KEY) || '0');
  if (cur < APP_SCHEMA_VERSION) {
    localStorage.setItem(SCHEMA_KEY, String(APP_SCHEMA_VERSION));
  }
} catch {
  localStorage.setItem(SCHEMA_KEY, String(APP_SCHEMA_VERSION));
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    try { navigator.serviceWorker.register('./sw.js'); } catch {}
  });
}

/* --- Mini DOM helpers --- */
const $  = (s, r = document) => r.querySelector(s);
const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

/* --- Storage keys --- */
const CART_KEY         = 'fitsnacks.cart.v1';
const ORDERS_KEY       = 'fitsnacks.orders';
const DELIVERED_KEY    = 'fitsnacks.orders.delivered';
const UNLOCK_KEY       = 'fitsnacks.admin.unlocked';
const STOCK_QTY_KEY    = 'fitsnacks.stock.qty';
const STOCK_LOW_KEY    = 'fitsnacks.stock.low';
const STOCK_SET_KEY    = 'fitsnacks.stock.set';
const FAVORITES_KEY    = 'fitsnacks.favorites';
const PROMOS_KEY       = 'fitsnacks.promos';
const ANALYTICS_KEY    = 'fitsnacks.analytics.products';
const PROFILE_NAME_KEY = 'fitsnacks.profile.name';
const PROFILE_LOC_KEY  = 'fitsnacks.profile.location';
const SALES_HEAT_KEY   = 'fitsnacks.sales.heatmap';

/* --- Simple (safe) loaders/savers --- */
const loadJSON = (k, d) => {
  try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; }
  catch { return d; }
};
const saveJSON = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

function loadCart() {
  try { return new Map(loadJSON(CART_KEY, [])); } catch { return new Map(); }
}
function saveCart(map) {
  saveJSON(CART_KEY, Array.from(map.entries()));
}

function fmt(n) { return '$' + (Number(n)||0).toFixed(2); }
function haptic(ms = 15){ try{ navigator.vibrate && navigator.vibrate(ms); } catch{} }

/* --- App state (in-memory mirrors of storage) --- */
let cart          = loadCart();                      // Map(name -> {price, qty})
let favorites     = new Set(loadJSON(FAVORITES_KEY, []));
let stockQty      = loadJSON(STOCK_QTY_KEY, {});
let stockLow      = loadJSON(STOCK_LOW_KEY, {});
let stockSet      = loadJSON(STOCK_SET_KEY, {});
let prodAnalytics = loadJSON(ANALYTICS_KEY, {});     // per-product {opens/adds/addedQty/purchasedQty/revenue}
let salesHeat     = loadJSON(SALES_HEAT_KEY,       // 7√ó24 array
                      Array.from({length:7}, () => Array(24).fill(0)));

/* --- Small UI helpers --- */
function showToast(msg, ms = 1800) {
  const host = $('#toastHost'); if (!host) return;
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  host.appendChild(el);
  requestAnimationFrame(() => el.classList.add('show'));
  setTimeout(() => {
    el.classList.remove('show');
    setTimeout(() => el.remove(), 240);
  }, ms);
}

function updateGreeting() {
  const name = localStorage.getItem(PROFILE_NAME_KEY) || '';
  $('#greet') && ($('#greet').textContent = name ? `Hi, ${name} üëã` : 'Welcome üëã');
}

function refreshBadge() {
  let n = 0; for (const v of cart.values()) n += v.qty;
  const b = $('#cartBadge');
  if (!b) return;
  if (n > 0) { b.textContent = n; b.style.display = 'inline-flex'; }
  else       { b.style.display = 'none'; }
}

/* =========================
   Promotions carousel
   ========================= */
function seedPromosOnce() {
  if (!localStorage.getItem(PROMOS_KEY)) {
    saveJSON(PROMOS_KEY, [
      { img:'assets/carousel-1.jpg', title:'Fuel your study grind', cta:'Shop snacks', action:'scrollGrid' },
      { img:'assets/carousel-2.jpg', title:'Protein picks',        cta:'Filter: protein', action:'filter', value:'protein' },
      { img:'assets/carousel-3.jpg', title:'Need help?',           cta:'Open settings', action:'openSettings' }
    ]);
  }
}
seedPromosOnce();

function promoAction(p) {
  if (p.action === 'openSettings') { $('#settingsOverlay').classList.add('show'); switchSettingsTab('general'); }
  if (p.action === 'filter')       { activateChip(p.value || ''); }
  if (p.action === 'scrollGrid')   { $('#grid')?.scrollIntoView({behavior:'smooth', block:'start'}); }
}

function buildPromos() {
  const data = loadJSON(PROMOS_KEY, []);
  const snapper = $('#snapper'); const dotsWrap = $('#snapDots');
  if (!snapper || !dotsWrap) return;

  // clear existing
  $$('.snap-card', snapper).forEach(n => n.remove());
  dotsWrap.innerHTML = '';

  const after = snapper.lastElementChild; // keep trailing spacer

  data.forEach(p => {
    const card = document.createElement('div');
    card.className = 'snap-card';
    card.innerHTML = `
      <img class="banner" src="${p.img}" alt="${p.title||'promo'}" loading="lazy">
      <div class="snap-meta">
        <div class="snap-title">${p.title || ''}</div>
        ${p.cta ? `<button class="ghost snap-cta">${p.cta}</button>` : ''}
      </div>`;
    snapper.insertBefore(card, after);

    // whole card triggers the action; CTA stops propagation
    card.addEventListener('click', (e) => {
      if (e.target.closest('.snap-cta')) return;
      promoAction(p);
    }, { passive:true });
    card.querySelector('.snap-cta')?.addEventListener('click', (e) => {
      e.stopPropagation(); promoAction(p);
    }, { passive:true });
  });

  // dots
  const cards = $$('.snap-card', snapper);
  dotsWrap.innerHTML = cards.map(() => `<div class="snap-dot"></div>`).join('');
  const dots = $$('.snap-dot', dotsWrap);

  // auto-advance (pauses on touch/hover; no sticky bar here)
  let idx = 0, paused = false, tId = null, raf = null;
  const holdMs = 5000, slideMs = 320;

  function setDot(i){ dots.forEach((d,k) => d.classList.toggle('active', k === i)); }

  function snapTo(i, dur = 0) {
    const cardsNow = $$('.snap-card', snapper);
    if (!cardsNow.length) return;
    i = (i + cardsNow.length) % cardsNow.length;
    idx = i; setDot(idx);
    const target = cardsNow[i].offsetLeft - (snapper.clientWidth - cardsNow[i].clientWidth)/2;
    if (dur <= 0) { snapper.scrollLeft = target; return; }
    const from = snapper.scrollLeft, dist = target - from, start = performance.now();
    cancelAnimationFrame(raf);
    const step = (now) => {
      const t = Math.min(1, (now - start) / dur);
      const eased = t < .5 ? 4*t*t*t : (t-1)*(2*t-2)*(2*t-2) + 1;
      snapper.scrollLeft = from + dist*eased;
      if (t < 1 && !paused) raf = requestAnimationFrame(step);
    };
    raf = requestAnimationFrame(step);
  }

  function start() {
    paused = false; clearTimeout(tId);
    const loop = () => {
      if (paused) return;
      tId = setTimeout(() => { snapTo(idx + 1, slideMs); loop(); }, holdMs);
    };
    loop();
  }
  function stop(){ paused = true; clearTimeout(tId); cancelAnimationFrame(raf); }

  // inputs to pause/resume
  ['pointerdown','touchstart','mouseenter','mousedown'].forEach(ev => snapper.addEventListener(ev, stop));
  ['pointerup','touchend','mouseleave','mouseup'].forEach(ev => snapper.addEventListener(ev, start));

  // update dot on manual scroll
  snapper.addEventListener('scroll', () => {
    const cardsNow = $$('.snap-card', snapper);
    if (!cardsNow.length) return;
    const cMid = snapper.getBoundingClientRect().left + snapper.clientWidth/2;
    let best = 1e9, bestI = 0;
    cardsNow.forEach((el,i) => {
      const r = el.getBoundingClientRect(); const mid = r.left + r.width/2;
      const d = Math.abs(mid - cMid); if (d < best){ best = d; bestI = i; }
    });
    if (bestI !== idx){ idx = bestI; setDot(idx); }
  }, { passive:true });

  // dot clicks
  dots.forEach((d,i) => d.addEventListener('click', () => { stop(); snapTo(i, 300); start(); }));

  // init
  setDot(0);
  snapTo(0, 0);
  start();
}

/* =========================
   Search + chips + favorites
   ========================= */
function activateChip(tag) {
  $$('#chips .chip').forEach(c => c.classList.toggle('active', (c.dataset.filter||'') === (tag||'')));

  const wantFavs = tag === 'favorites';
  $$('.card', $('#grid')).forEach(card => {
    const name = card.dataset.name || '';
    const tags = (card.dataset.tags || '').toLowerCase();
    const hit = !tag || tag === '' ||
                (wantFavs ? favorites.has(name) : tags.includes(tag));
    card.style.display = hit ? '' : 'none';
  });
}

function syncFavStars() {
  $$('.card').forEach(card => {
    const btn = card.querySelector('.fav');
    if (!btn) return;
    const on = favorites.has(card.dataset.name || '');
    btn.classList.toggle('active', !!on);
  });
}

function wireSearchAndChips() {
  // search
  $('#search')?.addEventListener('input', (e) => {
    const q = (e.target.value || '').toLowerCase();
    $$('.card', $('#grid')).forEach(card => {
      const hit = (card.dataset.name || '').toLowerCase().includes(q);
      card.style.display = hit ? '' : 'none';
    });
  });

  // chips
  $('#chips')?.addEventListener('click', (e) => {
    const chip = e.target.closest('.chip'); if (!chip) return;
    activateChip(chip.dataset.filter || '');
  }, { passive:true });

  // favorite toggles
  document.addEventListener('click', (e) => {
    const favBtn = e.target.closest('.fav'); if (!favBtn) return;
    const card = favBtn.closest('.card'); if (!card) return;
    const name = card.dataset.name || '';
    if (favorites.has(name)) favorites.delete(name);
    else favorites.add(name);
    saveJSON(FAVORITES_KEY, Array.from(favorites));
    syncFavStars();
  }, { passive:true });

  // default filter
  activateChip('');
}

/* =========================
   Cart render (no sticky bar)
   ========================= */
function renderCart() {
  const out = $('#cartContent'); const totalEl = $('#cartTotal');
  if (!out || !totalEl) return;

  let total = 0, html = '';
  for (const [name, info] of cart) {
    const line = (info.price || 0) * (info.qty || 0);
    total += line;
    html += `
      <div class="row-between" style="margin-top:6px">
        <div style="display:flex;gap:10px;align-items:center">
          <button class="ghost" data-act="minus" data-name="${name}" style="padding:4px 8px">‚àí</button>
          <div style="min-width:24px;text-align:center">${info.qty}</div>
          <button class="ghost" data-act="plus" data-name="${name}" style="padding:4px 8px">+</button>
          <button class="ghost" data-act="remove" data-name="${name}" title="Remove item" style="padding:4px 8px">üóë</button>
          <div style="font-weight:700;margin-left:8px">${name}</div>
        </div>
        <div style="font-weight:700">${fmt(line)}</div>
      </div>`;
  }

  out.innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
  totalEl.textContent = fmt(total);
  saveCart(cart);
  refreshBadge();
}

/* Delegated cart +/-/remove */
document.addEventListener('click', (e) => {
  const b = e.target.closest('button[data-act][data-name]'); if (!b) return;
  const act = b.getAttribute('data-act'); const name = b.getAttribute('data-name');
  const entry = cart.get(name); if (!entry) return;

  if (act === 'plus')  entry.qty = Math.min(999, entry.qty + 1);
  if (act === 'minus') entry.qty = Math.max(1,   entry.qty - 1);
  if (act === 'remove') cart.delete(name);

  renderCart();
}, { passive:true });

/* =========================
   Product sheet open
   ========================= */
let currentProduct = null;

function ensureMetrics(name) {
  if (!prodAnalytics[name]) {
    prodAnalytics[name] = { opens:0, adds:0, addedQty:0, purchasedQty:0, revenue:0 };
  }
  return prodAnalytics[name];
}

function openProductSheet(card) {
  const name  = card.dataset.name;
  const price = Number(card.dataset.price || '0');
  const img   = card.dataset.img || '';

  currentProduct = { name, price, img };

  $('#sheetTitle').textContent  = name;
  $('#sheetImg').src            = img;
  $('#sheetImg').alt            = name;
  $('#sheetPrice').textContent  = fmt(price);
  $('#qtyVal').textContent      = '1';
  $('#sheetAdd').textContent    = 'Add ‚Ä¢ ' + fmt(price);

  // stock snippet (if explicitly set for this product)
  if (stockSet[name]) {
    const q = Number(stockQty[name] || 0);
    const l = Number(stockLow[name] || 0);
    $('#sheetStock').textContent = 'Stock: ' + q;
    const warn = $('#sheetLowWarn');
    if (l > 0 && q <= l) { warn.style.display = 'block'; warn.textContent = `Low stock (${q} ‚â§ ${l})`; }
    else { warn.style.display = 'none'; }
  } else {
    $('#sheetStock').textContent = 'Stock: --';
    $('#sheetLowWarn').style.display = 'none';
  }

  ensureMetrics(name).opens++;
  saveJSON(ANALYTICS_KEY, prodAnalytics);

  $('#productSheet').classList.add('show');
}

/* Click a card (but not the star or +) -> open sheet */
function wireProductCards() {
  $$('.card').forEach(card => {
    card.addEventListener('click', (e) => {
      if (e.target.closest('.fav') || e.target.closest('.add')) return; // handled elsewhere
      openProductSheet(card);
    });
  });
}

/* Quantity controls inside the product sheet */
$('#qtyPlus')?.addEventListener('click', () => {
  const n = Math.min(99, (parseInt($('#qtyVal').textContent,10) || 1) + 1);
  $('#qtyVal').textContent   = String(n);
  $('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmt((currentProduct?.price || 0) * n);
});
$('#qtyMinus')?.addEventListener('click', () => {
  const n = Math.max(1, (parseInt($('#qtyVal').textContent,10) || 1) - 1);
  $('#qtyVal').textContent   = String(n);
  $('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmt((currentProduct?.price || 0) * n);
});
$('#sheetClose')?.addEventListener('click', () => $('#productSheet').classList.remove('show'));

/* Add to cart from product sheet (does not open sticky bar; cart drawer stays closed) */
$('#sheetAdd')?.addEventListener('click', () => {
  if (!currentProduct || !currentProduct.name) return;
  const n = Math.max(1, parseInt($('#qtyVal').textContent,10) || 1);

  const m = ensureMetrics(currentProduct.name);
  m.adds = (m.adds||0) + 1;
  m.addedQty = (m.addedQty||0) + n;
  saveJSON(ANALYTICS_KEY, prodAnalytics);

  const entry = cart.get(currentProduct.name) || { price: currentProduct.price, qty: 0 };
  entry.qty += n; cart.set(currentProduct.name, entry);
  renderCart();
  $('#productSheet').classList.remove('show');
  showToast(`Added ${n} √ó ${currentProduct.name}`);
  haptic(12);
});

/* =========================
   Overlays: cart / settings
   ========================= */
function openCart(){  $('#cartOverlay').classList.add('show'); }
function closeCart(){ $('#cartOverlay').classList.remove('show'); }
function openSettings(){ $('#settingsOverlay').classList.add('show'); switchSettingsTab('general'); }
function closeSettings(){ $('#settingsOverlay').classList.remove('show'); }

$('#cartBtn')?.addEventListener('click', openCart);
$('#cartBack')?.addEventListener('click', closeCart);
$('#settingsBtn')?.addEventListener('click', openSettings);
$('#settingsClose')?.addEventListener('click', closeSettings);

/* =========================
   Initial paint
   ========================= */
buildPromos();
wireSearchAndChips();
wireProductCards();
renderCart();
refreshBadge();
updateGreeting();
</script>

<script>
/* =========================
   Admin, Orders, Inventory, History, Analytics
   (Chunk 4/8)
   ========================= */

/* --- DOM id compatibility patch (prevents "buttons not working") --- */
(function fixIds() {
  const snap = document.getElementById('snap');
  if (snap && !document.getElementById('snapper')) snap.id = 'snapper';

  const prodOv = document.getElementById('productOverlay');
  if (prodOv && !document.getElementById('productSheet')) prodOv.id = 'productSheet';

  // Also ensure we close cart via either id present
  const cartClose = document.getElementById('cartClose');
  if (cartClose) cartClose.addEventListener('click', () => $('#cartOverlay')?.classList.remove('show'));
  const cartBack = document.getElementById('cartBack');
  if (cartBack) cartBack.addEventListener('click', () => $('#cartOverlay')?.classList.remove('show'));
})();

/* --- Admin auth + tabs --- */
const ADMIN_PASSWORD = '8TSB077';

function isUnlocked(){ return localStorage.getItem(UNLOCK_KEY) === '1'; }
function setUnlocked(v){ localStorage.setItem(UNLOCK_KEY, v ? '1':'0'); }

function switchSettingsTab(which){
  const tabG=$('#tabGeneral'), tabA=$('#tabAdmin'),
        panG=$('#panelGeneral'), panA=$('#panelAdmin');
  if(which==='admin'){
    tabG.classList.remove('active'); tabG.setAttribute('aria-selected','false');
    tabA.classList.add('active');    tabA.setAttribute('aria-selected','true');
    panG.style.display='none'; panA.style.display='block';
    ensureAdminLoginVisible();
  }else{
    tabA.classList.remove('active'); tabA.setAttribute('aria-selected','false');
    tabG.classList.add('active');    tabG.setAttribute('aria-selected','true');
    panA.style.display='none'; panG.style.display='block';
  }
}

function showAdminState(){
  const el = $('#adminStateVal');
  if (!el) return;
  el.textContent = isUnlocked() ? 'Unlocked' : 'Locked';
}

function ensureAdminLoginVisible(){
  const logged = isUnlocked();
  $('#adminLogin').style.display  = logged ? 'none'  : 'block';
  $('#adminContent').style.display= logged ? 'block' : 'none';
  showAdminState();
  if (logged){
    renderOrders();
    renderInventory();
    renderHistory();
    renderAnalytics();
    updateStockBadges();
  }
}

/* Tab switches */
document.addEventListener('click',(e)=>{
  if(e.target.closest('#tabGeneral')) switchSettingsTab('general');
  if(e.target.closest('#tabAdmin'))   switchSettingsTab('admin');
}, {passive:true});

/* Admin lock/unlock */
document.addEventListener('click',(e)=>{
  if(e.target.closest('#adminSubmit')){
    const ok = ($('#adminPassword').value || '') === ADMIN_PASSWORD;
    if (ok){
      setUnlocked(true);
      $('#adminError').style.display='none';
      ensureAdminLoginVisible();
    }else{
      $('#adminError').style.display='block';
    }
  }
  if(e.target.closest('#adminLock')){
    setUnlocked(false);
    ensureAdminLoginVisible();
  }
}, {passive:true});

/* Subtabs */
document.addEventListener('click',(e)=>{
  const btn = e.target.closest('.subtab'); if(!btn) return;
  $$('.subtab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const id = btn.getAttribute('data-subtab');

  $('#subtab-orders').style.display    = (id==='orders')   ? 'block' : 'none';
  $('#subtab-inventory').style.display = (id==='inventory')? 'block' : 'none';
  $('#subtab-analytics').style.display = (id==='analytics')? 'block' : 'none';
  $('#subtab-history').style.display   = (id==='history')  ? 'block' : 'none';

  if(id==='orders')     renderOrders();
  if(id==='inventory'){ renderInventory(); updateStockBadges(); }
  if(id==='analytics')  renderAnalytics();
  if(id==='history'){   pruneDelivered(72); renderHistory(); }
}, {passive:true});

/* =========================
   Orders list + Order dialog
   ========================= */
function loadOrders(){ return loadJSON(ORDERS_KEY, []); }
function saveOrders(v){ saveJSON(ORDERS_KEY, v || []); }

function renderOrders(){
  const box = $('#ordersList'); if(!box) return;
  const list = loadOrders();
  if(!list.length){ box.innerHTML = 'No orders yet'; return; }
  box.innerHTML = list.map((o,i)=> {
    const items = o.lines.map(l=>`${l.name} √ó ${l.qty} -- ${fmt(l.line)}`).join('<br>');
    const when  = new Date(o.when).toLocaleString();
    return `<div class="order-item" data-idx="${i}" role="button" tabindex="0"
              style="padding:8px;border-bottom:1px solid #2a2a30;cursor:pointer">
              <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
                <div>
                  <div style="font-weight:700">${when}</div>
                  <div style="color:#bbb;margin-top:4px">${o.name} @ ${o.location}</div>
                </div>
                <div style="font-weight:700">${fmt(o.total)}</div>
              </div>
              <div style="margin-top:6px">${items}</div>
              ${o.notes?`<div style="margin-top:6px;color:#c7c7cc;font-size:12px">üìù ${o.notes}</div>`:''}
            </div>`;
  }).join('');
}

/* Open order details overlay (always above settings) */
let currentOrderIndex = null;

function openOrderOverlay(idx){
  const orders = loadOrders();
  const o = orders[idx]; if(!o) return;
  currentOrderIndex = idx;

  $('#orderMeta').textContent  = `${new Date(o.when).toLocaleString()} ‚Ä¢ ${o.name} @ ${o.location}`;
  $('#orderLines').innerHTML   = o.lines.map(l=>`<div class="row-between" style="padding:6px 0">
                              <div>${l.name} √ó ${l.qty}</div>
                              <div style="font-weight:700">${fmt(l.line)}</div></div>`).join('');
  $('#orderTotal').textContent = fmt(o.total);

  // ensure overlay is last child so it sits on top
  const ov = $('#orderOverlay'); if (ov) { document.body.appendChild(ov); ov.classList.add('show'); }
  // preserve focus
  $('#orderClose')?.focus();
}

function closeOrderOverlay(){
  $('#orderOverlay')?.classList.remove('show');
  currentOrderIndex = null;
}

document.addEventListener('click', (e)=>{
  const row = e.target.closest('.order-item'); if(row) {
    openOrderOverlay(parseInt(row.getAttribute('data-idx')||'-1',10));
  }
}, {passive:true});

document.addEventListener('keydown', (e)=>{
  if(e.key!=='Enter' && e.key!==' ') return;
  const row = e.target.closest('.order-item'); if(!row) return;
  e.preventDefault();
  openOrderOverlay(parseInt(row.getAttribute('data-idx')||'-1',10));
});

$('#orderClose')?.addEventListener('click', closeOrderOverlay);
$('#orderCancel')?.addEventListener('click', closeOrderOverlay);

/* Delivered ‚Üí move to history */
function loadDelivered(){ return loadJSON(DELIVERED_KEY, []); }
function saveDelivered(v){ saveJSON(DELIVERED_KEY, v || []); }

$('#orderDelivered')?.addEventListener('click', ()=>{
  const idx = currentOrderIndex; if (idx == null) return;
  const active = loadOrders();
  if (idx >= 0 && idx < active.length){
    const delivered = active.splice(idx,1)[0];
    delivered.deliveredWhen = new Date().toISOString();
    const hist = loadDelivered(); hist.unshift(delivered);
    saveDelivered(hist); saveOrders(active);
    renderOrders(); renderHistory();
  }
  closeOrderOverlay();
});

/* =========================
   Inventory + stock badges
   ========================= */
function renderInventory(){
  const wrap = $('#inventoryList'); if(!wrap) return;
  const cards = $$('.card'); if(!cards.length){ wrap.textContent = 'No products'; return; }
  wrap.innerHTML = Array.from(cards).map(c=>{
    const name = c.dataset.name;
    const hasQ = Object.prototype.hasOwnProperty.call(stockQty, name);
    const hasL = Object.prototype.hasOwnProperty.call(stockLow, name);
    const qVal = hasQ ? Number(stockQty[name]||0) : '';
    const lVal = hasL ? Number(stockLow[name]||0) : '';
    return `<div class="field" data-prod="${name}">
      <div style="flex:1;font-weight:600">${name}</div>
      <label style="font-size:12px;color:#c7c7cc">Stock</label>
      <input type="number" min="0" value="${qVal}" data-k="qty" placeholder="--">
      <label style="font-size:12px;color:#c7c7cc">Low</label>
      <input type="number" min="0" value="${lVal}" data-k="low" placeholder="--">
    </div>`;
  }).join('');
}

/* inputs in inventory panel -> persist + badges */
document.addEventListener('input', (e)=>{
  const row = e.target.closest('.field[data-prod]'); if(!row) return;
  const name = row.getAttribute('data-prod') || '';
  if (e.target.matches('input[data-k="qty"]')){
    const v = (e.target.value || '').trim();
    if (v === ''){ delete stockQty[name]; delete stockSet[name]; }
    else { stockQty[name] = Number(v); stockSet[name] = 1; }
    saveJSON(STOCK_QTY_KEY, stockQty); saveJSON(STOCK_SET_KEY, stockSet);
    updateStockBadges(); refreshMiniIfOpen();
  }
  if (e.target.matches('input[data-k="low"]')){
    const v2 = (e.target.value || '').trim();
    if (v2 === '') delete stockLow[name];
    else stockLow[name] = Number(v2);
    saveJSON(STOCK_LOW_KEY, stockLow);
    updateStockBadges(); refreshMiniIfOpen();
  }
});

/* badge helpers on product cards */
function ensureBadgeWrap(card){
  let w = card.querySelector('.badge-wrap');
  if(!w){ w = document.createElement('div'); w.className = 'badge-wrap'; card.appendChild(w); }
  return w;
}
function updateStockBadges(){
  $$('.card').forEach(card=>{
    const name = card.dataset.name, wrap = ensureBadgeWrap(card);
    wrap.innerHTML = '';
    if (!stockSet[name]) return; // show only if stock explicitly set for that product
    const qty = Number(stockQty[name] || 0);
    const low = Number(stockLow[name] || 0);
    const b = document.createElement('div');
    b.className = 'stock-badge';
    b.textContent = 'Stock: ' + qty;
    wrap.appendChild(b);
    if (low > 0 && qty <= low){
      const l = document.createElement('div');
      l.className = 'stock-badge low-badge';
      l.textContent = `Only ${qty} left`;
      wrap.appendChild(l);
    }
  });
}
function refreshMiniIfOpen(){
  const ov = $('#productSheet');
  if (!ov || !ov.classList.contains('show') || !currentProduct) return;
  const name = currentProduct.name;
  if (stockSet[name]){
    const q = Number(stockQty[name] || 0);
    const l = Number(stockLow[name] || 0);
    $('#sheetStock').textContent = 'Stock: ' + q;
    const lw = $('#sheetLowWarn');
    if (l > 0 && q <= l){ lw.style.display = 'block'; lw.textContent = `Low stock (${q} ‚â§ ${l})`; }
    else { lw.style.display = 'none'; }
  }else{
    $('#sheetStock').textContent = 'Stock: --';
    $('#sheetLowWarn').style.display = 'none';
  }
}

/* =========================
   History (auto-prune 3 days)
   ========================= */
function pruneDelivered(hours){
  const list = loadDelivered();
  const cutoff = Date.now() - hours*3600*1000;
  const keep = list.filter(o=>{
    const t = Date.parse(o.deliveredWhen || o.when || 0);
    return isFinite(t) && t >= cutoff;
  });
  if (keep.length !== list.length) saveDelivered(keep);
}

function renderHistory(){
  const box = $('#historyList'); if(!box) return;
  pruneDelivered(72); // 72 hours
  const list = loadDelivered();
  if(!list.length){ box.textContent = 'No delivered orders'; return; }
  box.innerHTML = list.map(o=>{
    const items = o.lines.map(l=>`${l.name} √ó ${l.qty} -- ${fmt(l.line)}`).join('<br>');
    const placed = new Date(o.when).toLocaleString();
    const del    = o.deliveredWhen ? new Date(o.deliveredWhen).toLocaleString() : '--';
    return `<div style="padding:8px;border-bottom:1px solid #2a2a30">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div>
          <div style="font-weight:700">Delivered: ${del}</div>
          <div style="color:#bbb;margin-top:2px">Placed: ${placed}</div>
          <div style="color:#bbb;margin-top:2px">${o.name} @ ${o.location}</div>
        </div>
        <div style="font-weight:700">${fmt(o.total)}</div>
      </div>
      <div style="margin-top:6px">${items}</div>
      ${o.notes?`<div style="margin-top:6px;color:#c7c7cc;font-size:12px">üìù ${o.notes}</div>`:''}
    </div>`;
  }).join('');
}

$('#historyClear')?.addEventListener('click', ()=>{
  saveDelivered([]); renderHistory();
});

/* =========================
   Analytics (KPIs + simple tables)
   ========================= */
function renderAnalytics(){
  // combine active + delivered for totals
  const active = loadOrders(), delivered = loadDelivered(), all = active.concat(delivered);

  let rev=0, ordersCnt=all.length, items=0;
  all.forEach(o => { rev += o.total || 0; o.lines.forEach(l=> items += (l.qty||0)); });

  const aov = ordersCnt ? (rev / ordersCnt) : 0;
  $('#kpiRevenue').textContent = fmt(rev);
  $('#kpiOrders').textContent  = ordersCnt;
  $('#kpiAOV').textContent     = fmt(aov);
  $('#kpiItems').textContent   = items;

  // ensure metrics objects exist for visible products
  $$('.card').forEach(c => {
    const n = c.dataset.name; if (n) ensureMetrics(n);
  });
  saveJSON(ANALYTICS_KEY, prodAnalytics);

  // Top products (by revenue) and simple funnel percentages
  const rows = Object.entries(prodAnalytics).map(([name,m])=>({
    name,
    opens:        m.opens||0,
    adds:         m.adds||0,
    addedQty:     m.addedQty||0,
    purchasedQty: m.purchasedQty||0,
    revenue:      m.revenue||0
  }));

  const top = rows.slice().sort((a,b)=>b.revenue-a.revenue).slice(0,8);
  const maxR = Math.max(1, ...top.map(r=>r.revenue));
  const maxQ = Math.max(1, ...top.map(r=>r.purchasedQty));

  $('#topProducts').innerHTML = top.length ? top.map(r=>{
    const conv = r.opens ? Math.round((r.purchasedQty/r.opens)*100) : 0;
    return `<div class="row-between" style="padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">
      <div style="flex:1">${r.name}</div>
      <div style="width:70px;text-align:right">${r.purchasedQty}</div>
      <div style="width:90px;text-align:right">${fmt(r.revenue)}</div>
      <div style="width:60px;text-align:right">${conv}%</div>
    </div>
    <div style="padding:0 8px 8px">
      <div class="bar"><i style="width:${(r.revenue/maxR)*100}%"></i></div>
      <div class="bar" style="margin-top:6px"><i style="width:${(r.purchasedQty/maxQ)*100}%"></i></div>
    </div>`;
  }).join('') : '<div style="padding:8px">No sales yet</div>';

  const funnelHtml = rows.map(r=>{
    const a=r.opens||0, b=r.adds||0, c=r.purchasedQty||0;
    const ab=a?Math.round((b/a)*100):0, bc=b?Math.round((c/b)*100):0, ac=a?Math.round((c/a)*100):0;
    return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">
      <div style="font-weight:700">${r.name}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:6px">
        <div>
          <div class="label">Opens</div>
          <div class="value">${a}</div>
          <div class="bar" style="margin-top:4px"><i style="width:${a?100:0}%"></i></div>
        </div>
        <div>
          <div class="label">Adds</div>
          <div class="value">${b} <span style="color:#c7c7cc;font-size:12px">(${ab}% of opens)</span></div>
          <div class="bar" style="margin-top:4px"><i style="width:${a?(b/a)*100:0}%"></i></div>
        </div>
        <div>
          <div class="label">Purchases</div>
          <div class="value">${c} <span style="color:#c7c7cc;font-size:12px">(${bc}% of adds ‚Ä¢ ${ac}% of opens)</span></div>
          <div class="bar" style="margin-top:4px"><i style="width:${a?(c/a)*100:0}%"></i></div>
        </div>
      </div>
    </div>`;
  }).join('');
  $('#funnels').innerHTML = funnelHtml || '<div style="padding:8px">No funnel data yet</div>';
}

/* Open Settings (gear) if user clicks the button -- ensure tabs work */
$('#settingsBtn')?.addEventListener('click', () => {
  $('#settingsOverlay').classList.add('show');
  switchSettingsTab('general');
});

</script>

<script>
/* =========================
   Checkout submit + IFTTT webhook (Chunk 5/8)
   ========================= */

/* --- CONFIG: IFTTT Maker Webhook --- */
/* You asked me to embed the key directly. */
const IFTTT_URL = "https://maker.ifttt.com/trigger/Fitsnack_order/with/key/MGeBZrzbzW3CyUXlWVMpQkvI1bRVirGd0gkcYZiA";
const IFTTT_DEBUG_KEY = "fitsnacks.ifttt.lastStatus";

/* Helpers already defined earlier in your file (referenced here):
   - fmt(n)                      // formats currency
   - addOrderFromCart(name,loc,notes, discount, tip)
   - computeTotals(), updateCheckoutBreakdown()
   - saveProfile(name, loc)
   - showToast(msg)
   - renderCart(), refreshBadge(), updateGreeting()
*/

/* Avoid double-binding if this chunk is pasted twice by mistake */
if (!window.__FS_CHECKOUT_BIND_5__) {
  window.__FS_CHECKOUT_BIND_5__ = true;

  /* -------- Robust IFTTT sender (3 strategies) -------- */
  async function sendOrderToIFTTT(order){
    // Prepare concise strings for SMS
    const title   = `${order.name} @ ${order.location}`;
    const lines   = order.lines.map(l => `${l.name}√ó${l.qty}`).join(', ');
    const summary = `Total ${fmt(order.total)}${order.discount?` (disc ${fmt(order.discount)})`:''}${order.tip?` (tip ${fmt(order.tip)})`:''}`;
    const notes   = order.notes ? ` | Notes: ${order.notes}` : '';
    const payload = {
      value1: title,
      value2: `${lines} | ${summary}`,
      value3: `${new Date(order.when).toLocaleString()}${notes}`
    };

    // Strategy A: normal POST JSON (works if CORS is allowed)
    try{
      const res = await fetch(IFTTT_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        // Keep it simple first; many browsers allow this to IFTTT directly
      });
      // Even if opaque, try to treat as success when no exception thrown
      if (!res || (res.status && res.status >= 400)) throw new Error('IFTTT POST failed');
      localStorage.setItem(IFTTT_DEBUG_KEY, JSON.stringify({t:Date.now(), via:'post', ok:true}));
      return true;
    }catch(e1){
      // Strategy B: POST but allow no-cors (response becomes opaque, but fires)
      try{
        await fetch(IFTTT_URL, {
          method:'POST',
          mode:'no-cors',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        localStorage.setItem(IFTTT_DEBUG_KEY, JSON.stringify({t:Date.now(), via:'post-no-cors', ok:true}));
        return true;
      }catch(e2){
        // Strategy C: GET beacon using query params (Maker supports value1..3 on GET)
        try{
          const qs = new URLSearchParams({
            value1: payload.value1,
            value2: payload.value2,
            value3: payload.value3
          });
          // Use Image beacon to avoid fetch/CORS altogether
          await new Promise((resolve, reject)=>{
            const img = new Image();
            img.onload = ()=>resolve();
            img.onerror= ()=>resolve(); // treat error as fire-and-forget success
            img.src = `${IFTTT_URL}?${qs.toString()}`;
            // Resolve even if no onload fires in 2s (best-effort)
            setTimeout(resolve, 2000);
          });
          localStorage.setItem(IFTTT_DEBUG_KEY, JSON.stringify({t:Date.now(), via:'img-get', ok:true}));
          return true;
        }catch(e3){
          localStorage.setItem(IFTTT_DEBUG_KEY, JSON.stringify({t:Date.now(), via:'failed', ok:false, e:String(e3)}));
          return false;
        }
      }
    }
  }

  /* -------- Checkout "Place Order" handler -------- */
  const elCheckoutSubmit = document.getElementById('checkoutSubmit');
  if (elCheckoutSubmit) {
    elCheckoutSubmit.addEventListener('click', async ()=>{
      const name = (document.getElementById('checkoutName')?.value || '').trim();
      const loc  = (document.getElementById('checkoutLocation')?.value || '').trim();
      const notes= (document.getElementById('checkoutNotes')?.value || '').trim();
      const err  = document.getElementById('checkoutError');
      if(!name || !loc){
        if (err) err.style.display = 'block';
        return;
      }
      if (err) err.style.display = 'none';

      // persist profile
      saveProfile(name, loc);

      // compute discount & tip (from promo/tip state)
      const totals = typeof computeTotals === 'function' ? computeTotals() : {subtotal:0, disc:0, tip:0, total:0};

      // add order (this persists the order & updates sales heatmap via your existing addOrderFromCart)
      const order = addOrderFromCart(name, loc, notes, totals.disc, totals.tip);

      // Fire IFTTT in the background (do not block UI)
      sendOrderToIFTTT(order).then(ok=>{
        if (ok) {
          showToast('Order sent ‚Ä¢ You should receive a text');
        } else {
          showToast('Order placed ‚Ä¢ SMS send failed (check IFTTT)');
        }
      });

      // clear cart + close sheet + update UI
      if (window.cart && cart.clear) cart.clear();
      if (typeof renderCart === 'function') renderCart();
      document.getElementById('checkoutOverlay')?.classList.remove('show');
      if (typeof updateGreeting === 'function') updateGreeting();

      // Optional: open Settings ‚Üí Orders so you can see it immediately (disabled)
      // document.getElementById('settingsOverlay')?.classList.add('show'); switchSettingsTab('admin');
      // document.querySelector('[data-subtab="orders"]')?.click();
    });
  }

  /* -------- Ensure "Checkout" entry points open the sheet properly -------- */
  const cartCheckoutBtn = document.getElementById('cartCheckout');
  if (cartCheckoutBtn) {
    cartCheckoutBtn.addEventListener('click', ()=>{
      // Pre-fill name/location from profile and reset promo/tip UI
      try{
        const pName = localStorage.getItem('fitsnacks.profile.name') || '';
        const pLoc  = localStorage.getItem('fitsnacks.profile.location') || '';
        const nameEl = document.getElementById('checkoutName');
        const locEl  = document.getElementById('checkoutLocation');
        if (nameEl) nameEl.value = pName;
        if (locEl)  locEl.value  = pLoc;
      }catch{}

      const err = document.getElementById('checkoutError');
      if (err) err.style.display = 'none';
      const promo = document.getElementById('checkoutPromo');
      if (promo) promo.value = '';
      const badge = document.getElementById('promoStatus');
      if (badge){ badge.style.display='none'; badge.textContent=''; }

      // reset tip quick buttons / custom
      document.querySelectorAll('#tipGroup .tip-btn').forEach(b=>b.classList.remove('active'));
      // recompute breakdown
      if (typeof updateCheckoutBreakdown === 'function') updateCheckoutBreakdown();

      // Show the sheet
      document.getElementById('cartOverlay')?.classList.remove('show');
      document.getElementById('checkoutOverlay')?.classList.add('show');
    });
  }

  /* Also wire sticky cart bar button if present */
  const cartBarCheckoutBtn = document.getElementById('cartBarCheckout');
  if (cartBarCheckoutBtn) {
    cartBarCheckoutBtn.addEventListener('click', ()=>{
      // mirror the same open behavior as cartCheckoutBtn
      try{
        const pName = localStorage.getItem('fitsnacks.profile.name') || '';
        const pLoc  = localStorage.getItem('fitsnacks.profile.location') || '';
        const nameEl = document.getElementById('checkoutName');
        const locEl  = document.getElementById('checkoutLocation');
        if (nameEl) nameEl.value = pName;
        if (locEl)  locEl.value  = pLoc;
      }catch{}
      const err = document.getElementById('checkoutError'); if (err) err.style.display = 'none';
      const promo = document.getElementById('checkoutPromo'); if (promo) promo.value = '';
      const badge = document.getElementById('promoStatus'); if (badge){ badge.style.display='none'; badge.textContent=''; }
      if (typeof updateCheckoutBreakdown === 'function') updateCheckoutBreakdown();
      document.getElementById('checkoutOverlay')?.classList.add('show');
    });
  }
}
</script>

<script>
/* =========================
   Cart + Controls Hardening (Chunk 6/8)
   ========================= */

/* Utility to bind safely (no throw if element missing) */
function on(el, ev, fn, opts){ if (el) el.addEventListener(ev, fn, opts||{passive:true}); }

/* ---------- Badge + Empty state helpers ---------- */
function recalcBadgeAndBar(){
  let count = 0;
  for (const v of (window.cart?.values?.() || [])) count += v.qty||0;
  const badge = document.getElementById('cartBadge');
  if (badge){
    if (count > 0){ badge.textContent = count; badge.style.display = 'inline-flex'; }
    else { badge.textContent = '0'; badge.style.display = 'none'; }
  }
  if (typeof updateCartBar === 'function') updateCartBar();
}

function ensureEmptyCartMessage(){
  const content = document.getElementById('cartContent');
  if (!content) return;
  const hasLines = !!content.querySelector('[data-cart-line]');
  if (!hasLines){
    content.innerHTML = '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
  }
}

/* ---------- RenderCart patch (adds Remove √ó) ---------- */
(function patchRenderCart(){
  if (window.__FS_RENDER_PATCHED__) return;
  window.__FS_RENDER_PATCHED__ = true;

  const orig = window.renderCart;
  window.renderCart = function(){
    // If we have an original and it draws the lines, call it first and then augment.
    if (typeof orig === 'function'){
      try { orig(); } catch {}
    } else {
      // Minimal compatible renderer if original not present
      const box = document.getElementById('cartContent');
      let total = 0, html = '';
      if (window.cart instanceof Map){
        for (const [name,info] of cart){
          const line = (info.price||0) * (info.qty||0); total += line;
          html += `<div class="row-between" data-cart-line data-name="${name}" style="margin-top:6px">
            <div style="display:flex;gap:8px;align-items:center">
              <button data-act="-" data-name="${name}" class="ghost" style="padding:4px 8px">‚àí</button>
              <div style="min-width:24px;text-align:center">${info.qty||0}</div>
              <button data-act="+" data-name="${name}" class="ghost" style="padding:4px 8px">+</button>
              <div style="font-weight:700;margin-left:8px">${name}</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <div style="font-weight:700">${fmt(line)}</div>
              <button data-act="remove" data-name="${name}" class="ghost" title="Remove" aria-label="Remove" style="padding:4px 8px">√ó</button>
            </div>
          </div>`;
        }
      }
      if (box) box.innerHTML = html;
      const totalEl = document.getElementById('cartTotal');
      if (totalEl) totalEl.textContent = fmt(total);
    }

    // Ensure remove buttons exist even if original rendered lines
    const box = document.getElementById('cartContent');
    if (box){
      // Add a remove button to any line that doesn't have it yet
      box.querySelectorAll('.row-between[data-name]').forEach(row=>{
        if (!row.querySelector('[data-act="remove"]')){
          const name = row.getAttribute('data-name');
          const right = row.querySelector('div:last-child');
          const btn = document.createElement('button');
          btn.className = 'ghost';
          btn.setAttribute('data-act','remove');
          btn.setAttribute('data-name', name);
          btn.style.padding = '4px 8px';
          btn.title = 'Remove';
          btn.setAttribute('aria-label','Remove');
          btn.textContent = '√ó';
          if (right) right.appendChild(btn);
        }
      });
    }

    // Save + badges + empty message
    try { saveCart?.(cart); } catch {}
    recalcBadgeAndBar();
    ensureEmptyCartMessage();
  };
})();

/* ---------- Click handlers for + / ‚àí / remove √ó ---------- */
document.addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if (!b) return;

  // Plus/Minus/Remove act inside cart
  if (b.matches('[data-act][data-name]')){
    const name = b.getAttribute('data-name');
    const act  = b.getAttribute('data-act');
    const entry = cart?.get?.(name);
    if (!entry) return;

    if (act === '+'){
      entry.qty = Math.max(1, (entry.qty||0) + 1);
    } else if (act === '-'){
      entry.qty = Math.max(1, (entry.qty||0) - 1);
    } else if (act === 'remove'){
      cart.delete(name);
    }
    if (typeof renderCart === 'function') renderCart();
    return;
  }

  // Gear button fallback (open settings)
  if (b.id === 'settingsBtn'){
    const ov = document.getElementById('settingsOverlay');
    if (ov){ ov.classList.add('show'); }
    // Default to General tab to avoid admin lock confusion
    if (typeof switchSettingsTab === 'function') switchSettingsTab('general');
    return;
  }

  // Checkout button fallback (open checkout sheet)
  if (b.id === 'cartCheckout'){
    const ovC = document.getElementById('cartOverlay');
    const ovX = document.getElementById('checkoutOverlay');
    if (ovX){ ovX.classList.add('show'); }
    if (ovC){ ovC.classList.remove('show'); }
    return;
  }
}, {passive:true});

/* ---------- Ensure cart open/close are wired ---------- */
on(document.getElementById('cartBtn'), 'click', ()=> document.getElementById('cartOverlay')?.classList.add('show'));
on(document.getElementById('cartBack'), 'click', ()=> document.getElementById('cartOverlay')?.classList.remove('show'));
on(document.getElementById('cartClose'), 'click', ()=> document.getElementById('cartOverlay')?.classList.remove('show'));

/* ---------- Initial sync so badge/empty state are correct ---------- */
recalcBadgeAndBar();
ensureEmptyCartMessage();

</script>

<script>
/* =========================
   Promo + Tips + Sticky Cart Bar (Chunk 7/8)
   ========================= */

if (!window.__FS_PROMO_TIPS_7__) {
  window.__FS_PROMO_TIPS_7__ = true;

  /* --- PROMOS --- */
  // Simple promo table; expand as needed
  const PROMO_TABLE = {
    'SAVE10': {type:'percent', value:0.10, label:'10% off sitewide'},
    'BAR1'  : {type:'amount',  value:1.00, label:'$1 off protein items', rule:'tag:protein'}
  };

  let activePromo = null;

  function evalPromoDiscount(code){
    code = (code||'').trim().toUpperCase();
    if (!code || !PROMO_TABLE[code]) return null;

    const conf = PROMO_TABLE[code];

    // Subtotal from cart
    let subtotal = 0; for (const [,info] of (window.cart||[])) subtotal += (info.price||0)*(info.qty||0);
    if (subtotal <= 0) return null;

    let discount = 0;

    // Optional rule: only apply to items with tag:X
    if (conf.rule && conf.rule.startsWith('tag:')){
      const t = conf.rule.slice(4).toLowerCase();
      let eligible = 0;
      document.querySelectorAll('.card').forEach(c=>{
        const name = c.dataset.name;
        const tags = (c.dataset.tags||'').toLowerCase();
        const entry = window.cart?.get?.(name);
        if (entry && tags.includes(t)){
          eligible += (entry.price||0) * (entry.qty||0);
        }
      });
      if (eligible <= 0) {
        return {code, type:'none', value:0, label:`No eligible items for ${code}`, rule:conf.rule, discount:0, ok:false};
      }
      discount = conf.type==='percent' ? eligible*conf.value : Math.min(conf.value, eligible);
    } else {
      discount = conf.type==='percent' ? subtotal*conf.value : Math.min(conf.value, subtotal);
    }

    return {code, type:conf.type, value:conf.value, label:conf.label, rule:conf.rule||'', discount:Math.max(0, discount), ok:true};
  }

  function computeTotals(){
    let subtotal = 0; for (const [,info] of (window.cart||[])) subtotal += (info.price||0)*(info.qty||0);
    const disc = activePromo?.discount || 0;
    const tip  = Math.max(0, +(window.__FS_ACTIVE_TIP_AMOUNT__||0));
    const total = Math.max(0, subtotal - disc) + tip;
    return {subtotal, disc, tip, total};
  }

  function updateCheckoutBreakdown(){
    const {subtotal, disc, tip, total} = computeTotals();
    const set = (id, val)=>{ const el=document.getElementById(id); if(el) el.textContent = val; };
    set('ckSub',  fmt(subtotal));
    set('ckDisc', `-${fmt(disc)}`);
    set('ckTip',  fmt(tip));
    set('ckTotal',fmt(total));
  }
  window.computeTotals = computeTotals;           // expose to other chunks
  window.updateCheckoutBreakdown = updateCheckoutBreakdown;

  // Apply promo button
  (function bindPromo(){
    const btn = document.getElementById('checkoutApplyPromo');
    if(!btn) return;
    btn.addEventListener('click', ()=>{
      const code  = (document.getElementById('checkoutPromo')?.value||'').trim();
      const badge = document.getElementById('promoStatus');
      const res = evalPromoDiscount(code);
      if (res && res.ok){
        activePromo = res;
        if (badge){
          badge.textContent = `${res.code} ‚Ä¢ ${res.label} ‚Ä¢ -${fmt(res.discount)}`;
          badge.style.display = 'inline-flex';
          badge.classList.remove('promo-bad'); badge.classList.add('promo-ok');
        }
      }else{
        activePromo = null;
        if (badge){
          badge.textContent = res ? (res.label||'Not eligible') : 'Invalid code';
          badge.style.display = 'inline-flex';
          badge.classList.add('promo-bad'); badge.classList.remove('promo-ok');
        }
      }
      updateCheckoutBreakdown();
    }, {passive:true});
  })();

  /* --- TIPS --- */
  window.__FS_ACTIVE_TIP_AMOUNT__ = 0;

  function setTipAmount(kind, amount){
    window.__FS_ACTIVE_TIP_AMOUNT__ = Math.max(0, +amount||0);
    // Update buttons visual state
    document.querySelectorAll('#tipGroup .tip-btn').forEach(b=>b.classList.remove('active'));
    if (kind === 'none'){
      const noneBtn = document.querySelector('#tipGroup .tip-btn[data-tip="none"]');
      if (noneBtn) noneBtn.classList.add('active');
    }
    updateCheckoutBreakdown();
  }

  // Quick tip buttons
  (function bindTipButtons(){
    const group = document.getElementById('tipGroup');
    if (!group) return;

    group.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tip-btn'); if(!btn) return;
      document.querySelectorAll('#tipGroup .tip-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      const spec = btn.getAttribute('data-tip') || 'none';
      if (spec === 'none'){ setTipAmount('none', 0); return; }

      const [k,v] = spec.split(':');
      const {subtotal, disc} = computeTotals(); // recompute on the fly
      if (k === 'percent'){
        const base = Math.max(0, subtotal - disc);
        setTipAmount('percent', base * (+v/100));
      }else if (k === 'amount'){
        setTipAmount('amount', +v);
      }
    }, {passive:true});
  })();

  // Custom tip
  (function bindTipCustom(){
    const btn = document.getElementById('tipApplyCustom');
    const box = document.getElementById('tipCustomAmount');
    if (!btn || !box) return;
    btn.addEventListener('click', ()=>{
      const v = +(box.value||0);
      // Clear quick buttons‚Äô active state for clarity
      document.querySelectorAll('#tipGroup .tip-btn').forEach(b=>b.classList.remove('active'));
      setTipAmount('amount', v);
    }, {passive:true});
  })();

  /* --- STICKY CART BAR --- */
  function stickyCartEvaluate(){
    const bar = document.getElementById('cartBar');
    if (!bar) return;
    let count = 0, total = 0;
    for (const [,info] of (window.cart||[])){
      count += (info.qty||0);
      total += (info.price||0)*(info.qty||0);
    }
    const tEl = document.getElementById('cartBarTotal');
    if (tEl) tEl.textContent = fmt(total);
    if (count > 0 && total > 0) bar.classList.add('show');
    else bar.classList.remove('show');
  }
  window.updateCartBar = stickyCartEvaluate;

  // Make sure view/checkout from sticky bar always work
  (function bindStickyBarButtons(){
    const view = document.getElementById('cartBarView');
    const go   = document.getElementById('cartBarCheckout');

    if (view){
      view.addEventListener('click', ()=>{
        document.getElementById('cartOverlay')?.classList.add('show');
      }, {passive:true});
    }
    if (go){
      go.addEventListener('click', ()=>{
        // mirror the open-checkout behavior
        const nameEl = document.getElementById('checkoutName');
        const locEl  = document.getElementById('checkoutLocation');
        try{
          const pName = localStorage.getItem('fitsnacks.profile.name')||'';
          const pLoc  = localStorage.getItem('fitsnacks.profile.location')||'';
          if (nameEl) nameEl.value = pName;
          if (locEl)  locEl.value  = pLoc;
        }catch{}
        const err = document.getElementById('checkoutError'); if (err) err.style.display='none';
        const promo = document.getElementById('checkoutPromo'); if (promo) promo.value='';
        const badge = document.getElementById('promoStatus'); if (badge){ badge.style.display='none'; badge.textContent=''; }
        updateCheckoutBreakdown();
        document.getElementById('checkoutOverlay')?.classList.add('show');
      }, {passive:true});
    }
  })();

  // Initial compute to sync totals if the sheet is open
  try { updateCheckoutBreakdown(); } catch {}
  try { stickyCartEvaluate(); } catch {}
}
</script>

<script>
/* =========================
   Final Boot + Sanity Checks (Chunk 8/8)
   ========================= */

if (!window.__FS_BOOT_8__) {
  window.__FS_BOOT_8__ = true;

  /* ---- Safe aliases (project had both names in different versions) ---- */
  if (typeof window.switchSettingsTab !== 'function' && typeof window.switchTab === 'function') {
    window.switchSettingsTab = window.switchTab;
  }
  if (typeof window.updateCartBar !== 'function') {
    window.updateCartBar = function(){ /* no-op fallback */ };
  }

  /* ---- Profile Greeting Prefill ---- */
  function updateGreeting(){
    const el = document.getElementById('greet');
    if (!el) return;
    try {
      const name = localStorage.getItem('fitsnacks.profile.name') || '';
      el.textContent = name ? `Hi, ${name} üëã` : 'Welcome üëã';
    } catch { /* ignore */ }
  }
  window.updateGreeting = window.updateGreeting || updateGreeting;

  /* ---- Promo carousel guard (build + auto dots if builder exists) ---- */
  (function initPromosIfNeeded(){
    const snapper = document.getElementById('snapper');
    const dots    = document.getElementById('snapDots');
    const haveCards = !!(snapper && snapper.querySelector('.snap-card'));
    if (!haveCards && typeof window.buildPromos === 'function') {
      try { window.buildPromos(); } catch {}
    }
    if (typeof window.initCarousel === 'function') {
      try { window.initCarousel(); } catch {}
    } else {
      // Minimal dots init to avoid dead UI if custom carousel isn‚Äôt present
      if (snapper && dots) {
        const cards = snapper.querySelectorAll('.snap-card');
        dots.innerHTML = Array.from(cards).map(() => '<div class="snap-dot"></div>').join('');
        const first = dots.firstElementChild; if (first) first.classList.add('active');
      }
    }
  })();

  /* ---- Cart badge + empty state at boot ---- */
  function bootSyncCartUI(){
    try {
      if (typeof window.renderCart === 'function') window.renderCart();
      // If renderCart didn‚Äôt run (or cart is empty), still force badge/empty text once
      let count = 0;
      for (const v of (window.cart?.values?.() || [])) count += v.qty||0;
      const badge = document.getElementById('cartBadge');
      if (badge){
        if (count>0){ badge.textContent = count; badge.style.display='inline-flex'; }
        else        { badge.textContent = '0';   badge.style.display='none'; }
      }
      const content = document.getElementById('cartContent');
      if (content && !content.querySelector('[data-cart-line]')) {
        content.innerHTML = '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
      }
      if (typeof window.updateCartBar === 'function') window.updateCartBar();
    } catch { /* ignore */ }
  }

  /* ---- Settings open/close safety ---- */
  function safeBindSettings(){
    const openBtn = document.getElementById('settingsBtn');
    const closeBtn= document.getElementById('settingsClose');
    const overlay = document.getElementById('settingsOverlay');
    if (openBtn && overlay){
      openBtn.addEventListener('click', ()=>{
        overlay.classList.add('show');
        if (typeof window.switchSettingsTab === 'function') window.switchSettingsTab('general');
      }, {passive:true});
    }
    if (closeBtn && overlay){
      closeBtn.addEventListener('click', ()=> overlay.classList.remove('show'), {passive:true});
    }
  }

  /* ---- Cart open/close safety ---- */
  function safeBindCartOverlays(){
    const cartBtn = document.getElementById('cartBtn');
    const cartOv  = document.getElementById('cartOverlay');
    const back    = document.getElementById('cartBack') || document.getElementById('cartClose');
    if (cartBtn && cartOv){
      cartBtn.addEventListener('click', ()=> cartOv.classList.add('show'), {passive:true});
    }
    if (back && cartOv){
      back.addEventListener('click', ()=> cartOv.classList.remove('show'), {passive:true});
    }
  }

  /* ---- Checkout open safety (from cart + sticky bar) ---- */
  function safeBindCheckoutOpeners(){
    const openers = [
      document.getElementById('cartCheckout'),
      document.getElementById('cartBarCheckout')
    ].filter(Boolean);

    openers.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const ck = document.getElementById('checkoutOverlay');
        if (!ck) return;
        // Prefill profile if saved
        try{
          const pName = localStorage.getItem('fitsnacks.profile.name')||'';
          const pLoc  = localStorage.getItem('fitsnacks.profile.location')||'';
          const nameEl = document.getElementById('checkoutName');
          const locEl  = document.getElementById('checkoutLocation');
          if (nameEl) nameEl.value = pName;
          if (locEl)  locEl.value  = pLoc;
        }catch{}
        const err = document.getElementById('checkoutError'); if (err) err.style.display='none';
        const promo = document.getElementById('checkoutPromo'); if (promo) promo.value='';
        const badge = document.getElementById('promoStatus'); if (badge){ badge.style.display='none'; badge.textContent=''; }
        if (typeof window.updateCheckoutBreakdown === 'function') window.updateCheckoutBreakdown();
        ck.classList.add('show');
        // Close cart drawer if it‚Äôs open
        document.getElementById('cartOverlay')?.classList.remove('show');
      }, {passive:true});
    });
  }

  /* ---- Admin subtabs click safety (Orders / Inventory / Analytics / History) ---- */
  function safeBindAdminSubtabs(){
    const wrap = document.querySelector('.admin-subtabs');
    if (!wrap) return;
    wrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('.subtab'); if (!btn) return;
      document.querySelectorAll('.subtab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-subtab');

      const ids = ['orders','inventory','analytics','history'];
      ids.forEach(k=>{
        const pane = document.getElementById(`subtab-${k}`);
        if (pane) pane.style.display = (k===id) ? 'block' : 'none';
      });

      if (id==='orders'   && typeof window.renderOrders    === 'function') window.renderOrders();
      if (id==='inventory'&& typeof window.renderInventory === 'function') { window.renderInventory(); window.updateStockBadges?.(); }
      if (id==='analytics'&& typeof window.renderAnalytics === 'function') window.renderAnalytics();
      if (id==='history'  && typeof window.renderHistory   === 'function') window.renderHistory();
    }, {passive:true});
  }

  /* ---- Global click hardening for +/-/remove & order rows ---- */
  function safeBindDelegates(){
    document.addEventListener('click', (e)=>{
      const b = e.target.closest('button'); 
      if (!b) return;

      // Cart quantity & remove (in case earlier chunks didn‚Äôt catch)
      if (b.matches('[data-act][data-name]')){
        const name = b.getAttribute('data-name');
        const act  = b.getAttribute('data-act');
        const entry = window.cart?.get?.(name);
        if (entry){
          if (act === '+') entry.qty = Math.max(1, (entry.qty||0)+1);
          else if (act === '-') entry.qty = Math.max(1, (entry.qty||0)-1);
          else if (act === 'remove') window.cart.delete(name);
          if (typeof window.renderCart === 'function') window.renderCart();
        }
        return;
      }

      // Order list ‚Üí open order sheet (if not already bound)
      if (e.target.closest('.order-item')){
        const row = e.target.closest('.order-item');
        const idx = parseInt(row.getAttribute('data-idx')||'-1', 10);
        if (idx>=0 && typeof window.openOrderSheet === 'function') window.openOrderSheet(idx);
      }
    }, {passive:true});
  }

  /* ---- Final sanity: verify critical nodes exist ---- */
  function sanityCheck(){
    const critical = [
      '#settingsBtn','#settingsOverlay',
      '#cartBtn','#cartOverlay','#cartContent','#cartTotal',
      '#cartCheckout','#checkoutOverlay','#checkoutSubmit',
      '#grid','#snapper'
    ];
    const missing = critical.filter(sel => !document.querySelector(sel));
    if (missing.length){
      // Log in console for debugging without interrupting the UX
      console.warn('[FitSnacks] Missing nodes:', missing.join(', '));
    }
  }

  /* ---- Boot sequence ---- */
  function boot(){
    // make sure state structures exist
    window.cart = window.cart instanceof Map ? window.cart : new Map();
    try { if (!localStorage.getItem('fitsnacks.sales.buckets')) {
      const seed = Array.from({length:7},()=>Array(24).fill(0));
      localStorage.setItem('fitsnacks.sales.buckets', JSON.stringify(seed));
    }} catch {}

    updateGreeting();
    bootSyncCartUI();
    safeBindSettings();
    safeBindCartOverlays();
    safeBindCheckoutOpeners();
    safeBindAdminSubtabs();
    safeBindDelegates();
    sanityCheck();
  }

  // Run after DOM is ready
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(boot, 0);
  } else {
    document.addEventListener('DOMContentLoaded', boot, {once:true});
  }
}
</script>