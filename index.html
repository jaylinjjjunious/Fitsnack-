<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>FitSnacks</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0d">

  <!-- Performance: preloads for promo images (optional, keep or remove if not present) -->
  <link rel="preload" as="image" href="assets/carousel-1.jpg">
  <link rel="preload" as="image" href="assets/carousel-2.jpg">
  <link rel="preload" as="image" href="assets/carousel-3.jpg">

  <style>
    :root {
      --bg:#0b0b0d;
      --card:rgba(20,20,24,0.6);
      --text:#e9e9ec;
      --muted:#aaa;
      --accent:#6ea8fe;
      --badge:#ff3b30;
      --good:#3cd27f;
      --warn:#ffb020;
      --radius:18px;
      --blur:18px;
      --grid-gap:6px;
      --snap-gap:12px;
    }

    html,body{
      margin:0;height:100%;
      background:var(--bg);color:var(--text);
      font:16px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif
    }
    .app{max-width:393px;min-height:100svh;margin:0 auto;padding:12px 12px 32px;box-sizing:border-box}

    /* Glass look + glow */
    .card,.sheet,.btn,.search,.chip,.tab,.ghost,.primary,.field{
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      background: var(--card);
      border:1px solid rgba(255,255,255,0.08);
      box-shadow: 0 4px 24px rgba(0,255,0,0.08);
    }

    /* Header */
    .row{position:relative;display:flex;align-items:center;gap:0}
    .search-wrap{flex:none;width:calc(100% - 200px);}
    .search{width:100%;border-radius:999px;padding:12px 44px;color:var(--text);outline:none;border:1px solid #2a2a2e}
    .search::placeholder{color:#6c6c70}
    .icon-left{position:absolute;left:12px;top:50%;transform:translateY(-50%)}
    .icon-rights{position:absolute; right:8px; top:50%; transform:translateY(-50%); display:flex; gap:10px; margin-left:0}
    .btn{-webkit-appearance:none;appearance:none;border-radius:14px;width:44px;height:44px;padding:0;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    #cartBtn{position:relative;display:flex;align-items:center;justify-content:center}
    .badge{position:absolute;top:-6px;right:-8px;background:var(--badge);color:#fff;border-radius:999px;padding:1px 6px;font-size:12px;font-weight:700;display:none;align-items:center;justify-content:center}

    /* Greeting */
    .greet{margin:8px 2px 2px;color:#c7c7cc;font-size:14px}

    /* Promo ‚Äì card-snap carousel (no undefined JS dependencies) */
    .carousel{margin:10px 0 6px}
    .snapper{
      height:100px;display:flex;align-items:stretch;gap:var(--snap-gap);
      overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;
      padding:0 var(--snap-gap)
    }
    .snapper::-webkit-scrollbar{display:none}
    .snap-spacer{flex:0 0 7.5%}
    .snap-card{
      position:relative;flex:0 0 85%;scroll-snap-align:center;border-radius:14px;overflow:hidden;
      border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;height:100%
    }
    .banner{width:100%;height:100%;object-fit:contain;display:block}
    .snap-meta{position:absolute;left:10px;bottom:8px;right:10px;display:flex;justify-content:space-between;align-items:end;gap:8px;pointer-events:none}
    .snap-title{font-weight:800;text-shadow:0 1px 6px rgba(0,0,0,.6)}
    .snap-cta{pointer-events:auto}
    .snap-dots{display:flex;justify-content:center;gap:6px;margin-top:6px}
    .snap-dot{width:6px;height:6px;border-radius:999px;background:#2c3447;border:1px solid rgba(255,255,255,.18)}
    .snap-dot.active{background:#7fb1ff}

    /* Chips */
    .chips{display:flex;gap:10px;margin:6px 0 12px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
    .chip.active{outline:2px solid rgba(110,168,254,.5)}

    /* Grid */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{border-radius:var(--radius);padding:12px;position:relative;display:flex;flex-direction:column;min-height:190px}
    .thumb{height:90px;border-radius:12px;overflow:hidden;margin-bottom:8px;display:flex;align-items:center;justify-content:center;background:#0e0e12}
    .thumb img{width:100%;height:100%;object-fit:contain}
    .title{font-weight:700;margin:4px 0 2px;letter-spacing:0.2px}
    .price{color:#c7c7cc;font-weight:600;margin-top:auto}
    .add{position:absolute;right:12px;bottom:12px;background:var(--accent);border:none;color:#001230;border-radius:14px;width:42px;height:42px;font-size:22px;display:flex;align-items:center;justify-content:center;font-weight:800;cursor:pointer}
    .fav{position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:12px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);cursor:pointer}
    .fav.active{background:rgba(255,215,0,.15);box-shadow:0 0 0 1px rgba(255,215,0,.35) inset}

    /* Overlays */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .overlay.show{display:flex}
    .sheet{width:92%;max-width:480px;border-radius:20px;padding:16px}
    #cartOverlay,#checkoutOverlay,#settingsOverlay,#orderSheet{align-items:flex-end}
    #cartOverlay .sheet,#checkoutOverlay .sheet,#settingsOverlay .sheet,#orderSheet .sheet{
      width:100%;border-top-left-radius:24px;border-top-right-radius:24px;border-bottom-left-radius:0;border-bottom-right-radius:0;
      padding-bottom:calc(16px + env(safe-area-inset-bottom));
      transform:translateY(100%);animation:slideUp 220ms ease-out forwards
    }
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .qty{display:flex;align-items:center;gap:10px}
    .qty button{width:36px;height:36px;border-radius:10px;border:1px solid #2a2a30;background:#1c1c22;color:var(--text);font-size:20px;font-weight:700}
    .primary{background:var(--accent);border:0;color:#081425;font-weight:800;border-radius:12px;padding:12px 14px}
    .ghost{border:1px solid #2a2a30;color:#e7e7eb;border-radius:12px;padding:10px 12px;background:#1b1b20}
    .actions{display:flex;gap:10px;margin-top:12px}

    /* Settings + admin */
    .tabs{display:flex;gap:8px;margin:6px 0 12px}
    .tab{padding:8px 10px;border-radius:10px;cursor:pointer;border:1px solid #2a2a30;background:#18181d}
    .tab.active{background:#24242a}
    .sheet-body{max-height:70svh;overflow:auto;padding-right:4px}
    .admin-subtabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
    .subtab{padding:6px 10px;border-radius:10px;cursor:pointer;border:1px solid #2a2a30;background:#18181d;font-size:13px}
    .subtab.active{background:#24242a}
    .admin-list{border:1px solid #2a2a30;border-radius:12px;padding:8px;margin-top:8px}
    .field{display:flex;align-items:center;gap:8px;padding:8px;border-radius:12px}
    .field input{width:72px;padding:8px;border-radius:10px;border:1px solid #2a2a30;background:#101014;color:#e9e9ec}

    /* Heat map */
    .heat-wrap{margin-top:8px}
    .heat-grid{display:grid;grid-template-columns:repeat(24, minmax(10px,1fr));gap:var(--grid-gap)}
    .heat-cell{width:100%;aspect-ratio:1/1;border-radius:6px;background:rgba(110,168,254,0.08)}

    /* Stock badges */
    .badge-wrap{position:absolute;left:12px;bottom:12px;display:flex;gap:6px;align-items:center}
    .stock-badge{background:#0f172acc;color:#dbeafe;border:1px solid #1f2a44;padding:4px 8px;border-radius:10px;font-size:12px}
    .low-badge{background:#2a1a10cc;color:#ffd8b0;border:1px solid #3b2412}

    /* Toasts */
    #toastHost{position:fixed;left:0;right:0;bottom:calc(16px + env(safe-area-inset-bottom));display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;z-index:11000}
    .toast{pointer-events:auto;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:rgba(24,24,32,.9);font-weight:600;opacity:0;transform:translateY(8px);transition:opacity .22s ease,transform .22s ease}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <div class="app" role="application">
    <!-- Header -->
    <div class="row">
      <div class="search-wrap">
        <span class="icon-left" aria-hidden="true">üîç</span>
        <input id="search" class="search" placeholder="Search snacks‚Ä¶" autocomplete="off">
      </div>
      <div class="icon-rights">
        <button type="button" class="btn" id="cartBtn" aria-label="Open cart">
          üõí <span id="cartBadge" class="badge">0</span>
        </button>
        <button type="button" class="btn" id="settingsBtn" aria-label="Open settings">‚öôÔ∏è</button>
      </div>
    </div>

    <!-- Greeting -->
    <div id="greet" class="greet">Welcome üëã</div>

    <!-- Promo (card-snap carousel) -->
    <div class="carousel" aria-label="Promotions">
      <div id="snapper" class="snapper" aria-roledescription="carousel">
        <div class="snap-spacer" aria-hidden="true"></div>
        <!-- promo cards injected by JS -->
        <div class="snap-spacer" aria-hidden="true"></div>
      </div>
      <div id="snapDots" class="snap-dots" aria-hidden="true"></div>
    </div>

    <!-- Chips -->
    <div class="chips" id="chips">
      <div class="chip" data-filter="">all</div>
      <div class="chip" data-filter="vegan">vegan</div>
      <div class="chip" data-filter="gluten-free">gluten-free</div>
      <div class="chip" data-filter="protein">protein</div>
      <div class="chip" data-filter="favorites">favorites</div>
    </div>

    <!-- Products -->
    <div id="grid" class="grid" role="list">
      <div class="card" role="listitem" data-name="Potato Chips" data-price="2.50" data-img="assets/product-funyuns.jpg" data-tags="snack">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-funyuns.jpg" alt="Potato Chips" loading="lazy"></div>
        <div class="title">Potato Chips</div>
        <div class="price">$2.50</div>
        <button class="add" aria-label="Add Potato Chips">+</button>
      </div>

      <div class="card" role="listitem" data-name="Protein Bar" data-price="2.99" data-img="assets/product-chesters.jpg" data-tags="protein">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-chesters.jpg" alt="Protein Bar" loading="lazy"></div>
        <div class="title">Protein Bar</div>
        <div class="price">$2.99</div>
        <button class="add" aria-label="Add Protein Bar">+</button>
      </div>

      <div class="card" role="listitem" data-name="Trail Mix" data-price="3.49" data-img="assets/product-cheetos.jpg" data-tags="vegan,gluten-free">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-cheetos.jpg" alt="Trail Mix" loading="lazy"></div>
        <div class="title">Trail Mix</div>
        <div class="price">$3.49</div>
        <button class="add" aria-label="Add Trail Mix">+</button>
      </div>
    </div>
        <!-- Product mini sheet -->
    <div id="productSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Add item">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3 id="sheetTitle">Item</h3>
          <div class="ghost" id="sheetClose">Close</div>
        </div>
        <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
          <div style="width:88px;height:88px;border-radius:12px;overflow:hidden;border:1px solid #2a2a30;">
            <img id="sheetImg" alt="" style="width:100%;height:100%;object-fit:cover">
          </div>
          <div style="flex:1">
            <div id="sheetPrice" class="price" style="font-size:18px;"></div>
            <div id="sheetStock" style="margin-top:6px;color:#c7c7cc;font-size:13px;">Stock: --</div>
            <div id="sheetLowWarn" style="display:none;margin-top:6px;color:#ff6b6b;font-weight:600;font-size:13px;">Low stock</div>
          </div>
        </div>
        <div class="row-between" style="margin-top:10px;">
          <div class="qty">
            <button id="qtyMinus">‚àí</button>
            <div id="qtyVal">1</div>
            <button id="qtyPlus">+</button>
          </div>
          <button class="primary" id="sheetAdd">Add</button>
        </div>
      </div>
    </div>

    <!-- Order details sheet -->
    <div id="orderSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Order details">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Order</h3>
          <div class="ghost" id="orderClose">Close</div>
        </div>
        <div id="orderMeta" style="margin-top:6px;color:#c7c7cc;font-size:13px">‚Äì</div>
        <div id="orderLines" class="admin-list" style="margin-top:8px">‚Äì</div>
        <div class="row-between" style="margin-top:10px;">
          <strong>Total</strong><strong id="orderTotal">$0.00</strong>
        </div>
        <div class="actions" style="margin-top:12px;">
          <button class="ghost" id="orderCancel">Cancel</button>
          <button class="primary" id="orderDelivered">Mark Delivered</button>
        </div>
      </div>
    </div>

    <!-- Cart bottom-sheet -->
    <div id="cartOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Cart">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Cart</h3>
          <div class="ghost" id="cartBack">Back</div>
        </div>
        <div id="cartContent" class="sheet-body">Cart is empty</div>
        <div class="row-between" style="margin-top:10px;">
          <strong>Total</strong><strong id="cartTotal">$0.00</strong>
        </div>
        <div class="actions">
          <button class="ghost" id="reorderLast">Re-order last</button>
          <button class="primary" id="cartCheckout">Checkout</button>
        </div>
      </div>
    </div>

    <!-- Checkout bottom-sheet -->
    <div id="checkoutOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Checkout">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Checkout</h3>
          <div class="ghost" id="checkoutClose">Close</div>
        </div>

        <div class="sheet-body">
          <!-- Profile -->
          <div style="margin-top:6px;">Your name:</div>
          <input id="checkoutName" class="field" style="width:100%;padding:10px;border-radius:10px">
          <div style="margin-top:10px;">Where are you on campus?</div>
          <input id="checkoutLocation" class="field" style="width:100%;padding:10px;border-radius:10px">

          <!-- Promo -->
          <div style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div class="field-inline" style="flex:1">
              <input id="checkoutPromo" placeholder="Promo code" class="field" style="flex:1;min-width:0;padding:10px;border-radius:10px">
              <button class="ghost" id="checkoutApplyPromo">Apply</button>
            </div>
            <div id="promoStatus" class="badge-pill" style="display:none"></div>
          </div>

          <!-- Tip -->
          <div style="margin-top:12px;">Tip (optional)</div>
          <div class="tip-group" id="tipGroup">
            <button class="tip-btn" data-tip="none">No tip</button>
            <button class="tip-btn" data-tip="amount:1">$1</button>
            <button class="tip-btn" data-tip="amount:2">$2</button>
            <button class="tip-btn" data-tip="percent:10">10%</button>
            <div class="field-inline" style="margin-left:auto">
              <input id="tipCustomAmount" type="number" min="0" step="0.5" placeholder="Custom $" class="field" style="width:110px">
              <button class="ghost" id="tipApplyCustom">Set</button>
            </div>
          </div>

          <!-- Notes -->
          <div style="margin-top:12px;">Delivery notes (optional)</div>
          <textarea id="checkoutNotes" class="notes" placeholder="e.g., Meet at library entrance, 2nd floor."></textarea>

          <!-- Breakdown -->
          <div class="breakdown" style="margin-top:12px">
            <div class="break-row"><div class="muted">Subtotal</div><div id="ckSub">$0.00</div></div>
            <div class="break-row"><div class="muted">Discount</div><div id="ckDisc">-$0.00</div></div>
            <div class="break-row"><div class="muted">Tip</div><div id="ckTip">$0.00</div></div>
            <div class="break-row" style="font-weight:800"><div>Total</div><div id="ckTotal">$0.00</div></div>
          </div>

          <div id="checkoutError" style="display:none;color:#ff6b6b;margin-top:10px;">Please fill both fields.</div>
        </div>

        <div class="actions" style="margin-top:12px;">
          <button class="primary" id="checkoutSubmit">Place Order</button>
        </div>
      </div>
    </div>

    <!-- Settings bottom-sheet -->
    <div id="settingsOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Settings">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Settings</h3>
          <div class="ghost" id="settingsClose">Close</div>
        </div>

        <div class="tabs" role="tablist" aria-label="Settings Tabs">
          <button id="tabGeneral" class="tab active" role="tab" aria-selected="true" aria-controls="panelGeneral">General</button>
          <button id="tabAdmin" class="tab" role="tab" aria-selected="false" aria-controls="panelAdmin">Admin</button>
        </div>

        <div class="sheet-body">
          <!-- General -->
          <div id="panelGeneral" role="tabpanel" aria-labelledby="tabGeneral">
            <div style="display:flex;gap:12px">
              <div class="ghost">Dark Mode (disabled)</div>
              <div class="ghost">Notifications (disabled)</div>
            </div>
          </div>

          <!-- Admin -->
          <div id="panelAdmin" role="tabpanel" aria-labelledby="tabAdmin" style="display:none">
            <!-- Login -->
            <div id="adminLogin">
              <div style="margin-top:6px;">Admin password:</div>
              <input id="adminPassword" type="password" class="field" style="width:100%;padding:10px;border-radius:10px">
              <div id="adminError" style="display:none;color:#ff6b6b;margin-top:6px;">Wrong password.</div>
              <div class="actions" style="margin-top:12px;">
                <button class="primary" id="adminSubmit">Unlock</button>
              </div>
            </div>

            <!-- Content (locked until unlock) -->
            <div id="adminContent" style="display:none">
              <div class="admin-subtabs">
                <button class="subtab active" data-subtab="orders">Orders</button>
                <button class="subtab" data-subtab="inventory">Inventory</button>
                <button class="subtab" data-subtab="analytics">Analytics</button>
                <button class="subtab" data-subtab="history">History</button>
              </div>

              <div style="margin:4px 0 8px;display:flex;gap:8px;align-items:center;">
                <button class="ghost" id="adminLock" style="padding:6px 10px">Lock Admin</button>
                <div id="adminState" style="font-size:12px;color:#c7c7cc">
                  State: <strong id="adminStateVal">unknown</strong>
                </div>
              </div>

              <!-- Orders -->
              <div id="subtab-orders">
                <div style="margin-top:6px;font-weight:700">Orders</div>
                <div id="ordersList" class="admin-list">No orders yet</div>
              </div>

              <!-- Inventory -->
              <div id="subtab-inventory" style="display:none">
                <div style="margin-top:6px;font-weight:700">Inventory (Stock & Low)</div>
                <div id="inventoryList" class="admin-list">Loading‚Ä¶</div>
              </div>

              <!-- Analytics -->
              <div id="subtab-analytics" style="display:none">
                <div style="margin-top:6px;font-weight:700">Analytics Overview</div>
                <div class="kpis" style="margin-top:8px">
                  <div class="kpi"><div class="label">Revenue</div><div id="kpiRevenue" class="value">$0.00</div></div>
                  <div class="kpi"><div class="label">Orders</div><div id="kpiOrders" class="value">0</div></div>
                  <div class="kpi"><div class="label">AOV</div><div id="kpiAOV" class="value">$0.00</div></div>
                  <div class="kpi"><div class="label">Items sold</div><div id="kpiItems" class="value">0</div></div>
                </div>
                <div style="margin-top:12px">
                  <div class="label" style="margin-bottom:6px">Revenue (last 7 days)</div>
                  <svg id="revSpark" class="spark" viewBox="0 0 100 40" preserveAspectRatio="none" aria-label="Revenue last 7 days"></svg>
                </div>
                <div style="margin-top:12px;font-weight:700">Top Products</div>
                <div class="table">
                  <div class="rowh"><div>Product</div><div>Qty</div><div>Revenue</div><div>Conv%</div></div>
                  <div id="topProducts"></div>
                </div>
                <div style="margin-top:12px;font-weight:700">Funnel by Product</div>
                <div id="funnels" class="admin-list"></div>
              </div>

              <!-- History -->
              <div id="subtab-history" style="display:none">
                <div class="row-between" style="margin-top:6px;">
                  <div style="font-weight:700">Delivered Orders (auto-clears after 3 days)</div>
                  <button class="ghost" id="historyClear" style="padding:6px 10px">Clear history now</button>
                </div>
                <div id="historyList" class="admin-list" style="margin-top:8px">No delivered orders</div>
              </div>
            </div> <!-- /#adminContent -->
          </div> <!-- /#panelAdmin -->
        </div> <!-- /.sheet-body -->
      </div>
    </div>

    <!-- Toast host -->
    <div id="toastHost"></div>
        <!-- Cart bottom-sheet -->
    <div id="cartOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Cart">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Cart</h3>
          <div class="ghost" id="cartBack">Back</div>
        </div>
        <div id="cartContent" class="sheet-body">Cart is empty</div>
        <div class="row-between" style="margin-top:10px;">
          <strong>Total</strong><strong id="cartTotal">$0.00</strong>
        </div>
        <div class="actions">
          <button class="ghost" id="reorderLast">Re-order last</button>
          <button class="primary" id="cartCheckout">Checkout</button>
        </div>
      </div>
    </div>

    <!-- Checkout bottom-sheet -->
    <div id="checkoutOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Checkout">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Checkout</h3>
          <div class="ghost" id="checkoutClose">Close</div>
        </div>
        <div class="sheet-body">
          <div style="margin-top:6px;">Your name:</div>
          <input id="checkoutName" class="field" style="width:100%;padding:10px;border-radius:10px">
          <div style="margin-top:10px;">Where are you on campus?</div>
          <input id="checkoutLocation" class="field" style="width:100%;padding:10px;border-radius:10px">
          <div id="checkoutError" style="display:none;color:#ff6b6b;margin-top:10px;">Please fill both fields.</div>
        </div>
        <div class="actions" style="margin-top:12px;">
          <button class="primary" id="checkoutSubmit">Place Order</button>
        </div>
      </div>
    </div>

    <!-- Settings bottom-sheet -->
    <div id="settingsOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Settings">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Settings</h3>
          <div class="ghost" id="settingsClose">Close</div>
        </div>
        <div class="tabs" role="tablist" aria-label="Settings Tabs">
          <button id="tabGeneral" class="tab active" role="tab" aria-selected="true" aria-controls="panelGeneral">General</button>
          <button id="tabAdmin" class="tab" role="tab" aria-selected="false" aria-controls="panelAdmin">Admin</button>
        </div>
        <div class="sheet-body">
          <!-- General -->
          <div id="panelGeneral" role="tabpanel" aria-labelledby="tabGeneral">
            <div style="display:flex;gap:12px">
              <div class="ghost">Dark Mode (disabled)</div>
              <div class="ghost">Notifications (disabled)</div>
            </div>
          </div>

          <!-- Admin -->
          <div id="panelAdmin" role="tabpanel" aria-labelledby="tabAdmin" style="display:none">
            <div id="adminLogin">
              <div style="margin-top:6px;">Admin password:</div>
              <input id="adminPassword" type="password" class="field" style="width:100%;padding:10px;border-radius:10px">
              <div id="adminError" style="display:none;color:#ff6b6b;margin-top:6px;">Wrong password.</div>
              <div class="actions" style="margin-top:12px;">
                <button class="primary" id="adminSubmit">Unlock</button>
              </div>
            </div>
            <div id="adminContent" style="display:none">
              <div class="admin-subtabs">
                <button class="subtab active" data-subtab="orders">Orders</button>
                <button class="subtab" data-subtab="inventory">Inventory</button>
                <button class="subtab" data-subtab="analytics">Analytics</button>
              </div>
              <div id="subtab-orders">
                <div style="margin-top:6px;font-weight:700">Orders</div>
                <div id="ordersList" class="admin-list">No orders yet</div>
              </div>
              <div id="subtab-inventory" style="display:none">
                <div style="margin-top:6px;font-weight:700">Inventory (Stock & Low)</div>
                <div id="inventoryList" class="admin-list">Loading‚Ä¶</div>
              </div>
              <div id="subtab-analytics" style="display:none">
                <div style="margin-top:6px;font-weight:700">Heat Map (Checkouts by Hour)</div>
                <div class="heat-wrap">
                  <div id="heatGrid" class="heat-grid"></div>
                  <div class="heat-legend">
                    <span>Low</span>
                    <span class="legend-swatch" style="background:rgba(110,168,254,0.10)"></span>
                    <span class="legend-swatch" style="background:rgba(110,168,254,0.25)"></span>
                    <span class="legend-swatch" style="background:rgba(110,168,254,0.45)"></span>
                    <span class="legend-swatch" style="background:rgba(110,168,254,0.70)"></span>
                    <span>High</span>
                  </div>
                </div>
              </div>
            </div>
          </div> <!-- /panelAdmin -->
        </div> <!-- /sheet-body -->
      </div>
    </div>
        <script>
    // PWA: register SW if present
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }

    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // Storage keys
    const CART_KEY   = 'fitsnacks.cart.v1';
    const ORDERS_KEY = 'fitsnacks.orders';
    const UNLOCK_KEY = 'fitsnacks.admin.unlocked';
    const STOCK_KEY  = 'fitsnacks.stock.qty';
    const LOW_KEY    = 'fitsnacks.stock.low';
    const SALES_KEY  = 'fitsnacks.sales.buckets'; // 7x24

    const ADMIN_PASSWORD = '8TSB077';
    const fmt = n => '$' + n.toFixed(2);

    // Helpers for persisted maps/objects
    function loadCart(){ try{ return new Map(JSON.parse(localStorage.getItem(CART_KEY)||'[]')); }catch{ return new Map(); } }
    function saveCart(m){ try{ localStorage.setItem(CART_KEY, JSON.stringify(Array.from(m.entries())));}catch{} }
    function loadObj(key){ try{ return JSON.parse(localStorage.getItem(key) || '{}'); }catch{ return {}; } }
    function saveObj(key, obj){ localStorage.setItem(key, JSON.stringify(obj||{})); }

    // Sales buckets: 7x24 matrix
    function loadSales(){
      try{
        const raw = JSON.parse(localStorage.getItem(SALES_KEY)||'null');
        if (raw && raw.length===7 && raw[0].length===24) return raw;
      }catch{}
      return Array.from({length:7}, ()=>Array(24).fill(0));
    }
    function saveSales(mat){ localStorage.setItem(SALES_KEY, JSON.stringify(mat)); }

    // State
    let cart = loadCart();
    let stockQty = loadObj(STOCK_KEY);
    let stockLow = loadObj(LOW_KEY);
    let sales = loadSales();
        /* ---------- SEARCH (live filter) ---------- */
    $('#search')?.addEventListener('input', (e) => {
      const q = (e.target.value || '').toLowerCase();
      const cards = $$('.card');
      let any = false;
      cards.forEach(c => {
        const hit = (c.dataset.name || '').toLowerCase().includes(q);
        c.style.display = hit ? '' : 'none';
        if (hit) any = true;
      });
      // optional: simple empty-search feedback via toast
      if (!any && q.length) {
        // no-op to avoid spammy toasts; uncomment if you want feedback:
        // showToast('No results found');
      }
    });

    /* ---------- SAFE CAROUSEL GUARD (card-snap variant) ---------- */
    (function initSnapDots(){
      const snapper = $('#snapper');
      const dotsWrap = $('#snapDots');
      if (!snapper || !dotsWrap) return;           // not present in some builds
      const cards = Array.from(snapper.querySelectorAll('.snap-card'));
      if (!cards.length) return;

      dotsWrap.innerHTML = cards.map(()=>'<div class="snap-dot"></div>').join('');
      const dots = Array.from(dotsWrap.querySelectorAll('.snap-dot'));
      const setDot = (i)=> dots.forEach((d,k)=>d.classList.toggle('active',k===i));
      setDot(0);

      // track current by proximity to center
      function centerOf(el){ const r=el.getBoundingClientRect(); return r.left + r.width/2; }
      function containerCenter(){ const r=snapper.getBoundingClientRect(); return r.left + r.width/2; }
      snapper.addEventListener('scroll', () => {
        const c = containerCenter(); let best=Infinity, idx=0;
        cards.forEach((card,i)=>{ const d=Math.abs(c-centerOf(card)); if(d<best){best=d; idx=i;} });
        setDot(idx);
      }, {passive:true});

      // allow clicking dots to scroll to that card
      dots.forEach((dot,i)=>{
        dot.addEventListener('click', ()=>{
          const card = cards[i];
          if (!card) return;
          const target = card.offsetLeft - (snapper.clientWidth - card.clientWidth)/2;
          snapper.scrollTo({left: Math.max(0,target), behavior:'smooth'});
        }, {passive:true});
      });
    })();

    /* ---------- FAVORITES (star toggle) ---------- */
    const FAVORITES_KEY = 'fitsnacks.favorites';
    function loadFavs(){ try{ return new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY)||'[]')); }catch{ return new Set(); } }
    function saveFavs(set){ try{ localStorage.setItem(FAVORITES_KEY, JSON.stringify(Array.from(set))); }catch{} }
    let favorites = loadFavs();

    function syncFavStars(){
      $$('.card').forEach(c=>{
        const f = c.querySelector('.fav');
        if (!f) return;
        f.classList.toggle('active', favorites.has(c.dataset.name));
      });
    }
    // click star only toggles favorite (won't open product modal)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.fav');
      if (!btn) return;
      e.stopPropagation();
      const card = btn.closest('.card'); if (!card) return;
      const name = card.dataset.name;
      favorites.has(name) ? favorites.delete(name) : favorites.add(name);
      saveFavs(favorites);
      syncFavStars();
    }, {passive:true});

    // filter chips (including "favorites")
    function activateChip(val){
      $$('#chips .chip').forEach(ch=>ch.classList.toggle('active', ch.dataset.filter===val));
      $$('.card').forEach(c=>{
        const tags = (c.dataset.tags||'').toLowerCase();
        const name = c.dataset.name;
        const hit = !val || val==='' ||
                    (val==='favorites' ? favorites.has(name) : tags.includes(val));
        c.style.display = hit ? '' : 'none';
      });
    }
    $('#chips')?.addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      activateChip(chip.dataset.filter||'');
    }, {passive:true});
    activateChip('');       // default view
    syncFavStars();         // paint stars on load

    /* ---------- CART HELPERS ---------- */
    const fmtMoney = (n)=>'$'+n.toFixed(2);

    function cartTotals(){
      let total = 0, count = 0;
      for (const [,info] of cart){ total += info.price * info.qty; count += info.qty; }
      return {total, count};
    }

    function refreshBadge(){
      const {count} = cartTotals();
      const b = $('#cartBadge'); if (!b) return;
      if (count>0){ b.textContent = count; b.style.display='inline-flex'; }
      else { b.style.display='none'; }
    }

    function renderCart(){
      let total=0, html='';
      for (const [name, info] of cart){
        const line = info.price*info.qty; total += line;
        html += `<div class="row-between" style="margin-top:6px">
          <div style="display:flex;gap:10px;align-items:center">
            <button data-act="-" data-name="${name}" class="ghost" style="padding:4px 8px">‚àí</button>
            <div style="min-width:24px;text-align:center">${info.qty}</div>
            <button data-act="+" data-name="${name}" class="ghost" style="padding:4px 8px">+</button>
            <div style="font-weight:700;margin-left:8px">${name}</div>
          </div>
          <div style="font-weight:700">${fmtMoney(line)}</div>
        </div>`;
      }
      $('#cartContent').innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
      $('#cartTotal').textContent = fmtMoney(total);
      saveCart(cart);
      refreshBadge();
    }

    // +/- quantity in cart (event delegation)
    document.addEventListener('click', (e)=>{
      const b = e.target.closest('button'); if (!b) return;
      if (!b.hasAttribute('data-act') || !b.hasAttribute('data-name')) return;
      const name = b.getAttribute('data-name');
      const act  = b.getAttribute('data-act');
      const entry = cart.get(name); if (!entry) return;
      if (act === '+') entry.qty = Math.min(99, entry.qty+1);
      else entry.qty = Math.max(1, entry.qty-1);
      renderCart();
    }, {passive:true});

    /* ---------- PRODUCT SHEET & ADD FLOW ---------- */
    let currentProduct = null;

    function openProductSheet(card){
      currentProduct = {
        name:  card.dataset.name,
        price: parseFloat(card.dataset.price),
        img:   card.dataset.img || ''
      };
      $('#sheetTitle').textContent = currentProduct.name;
      $('#sheetImg').src = currentProduct.img;
      $('#sheetImg').alt = currentProduct.name;
      $('#sheetPrice').textContent = fmtMoney(currentProduct.price);
      $('#qtyVal').textContent = '1';
      $('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmtMoney(currentProduct.price);

      // stock (only if present)
      const q = Number((stockQty||{})[currentProduct.name] ?? NaN);
      const l = Number((stockLow||{})[currentProduct.name] ?? NaN);
      if (Number.isFinite(q)){
        $('#sheetStock').textContent = 'Stock: ' + q;
        if (Number.isFinite(l) && l>0 && q<=l){
          $('#sheetLowWarn').style.display='block';
          $('#sheetLowWarn').textContent = `Low stock (${q} ‚â§ ${l})`;
        }else{
          $('#sheetLowWarn').style.display='none';
        }
      }else{
        $('#sheetStock').textContent = 'Stock: --';
        $('#sheetLowWarn').style.display='none';
      }

      $('#productSheet').classList.add('show');
    }
    function closeProductSheet(){ $('#productSheet').classList.remove('show'); }

    // card click opens product sheet (but clicking + or ‚≠ê uses their own handlers)
    $$('.card').forEach(card=>{
      card.addEventListener('click', (e)=>{
        if (e.target.closest('.add') || e.target.closest('.fav')) return;
        openProductSheet(card);
      }, {passive:true});
    });

    // + button on cards opens the sheet (with quantity control)
    $$('.add').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const card = btn.closest('.card'); if (!card) return;
        openProductSheet(card);
        e.stopPropagation();
      });
    });

    // quantity control in sheet
    $('#qtyPlus')?.addEventListener('click', ()=>{
      if (!currentProduct) return;
      const n = Math.min(99, parseInt($('#qtyVal').textContent||'1',10)+1);
      $('#qtyVal').textContent = n;
      $('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmtMoney(currentProduct.price*n);
    });
    $('#qtyMinus')?.addEventListener('click', ()=>{
      if (!currentProduct) return;
      const n = Math.max(1, parseInt($('#qtyVal').textContent||'1',10)-1);
      $('#qtyVal').textContent = n;
      $('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmtMoney(currentProduct.price*n);
    });

    // close sheet (both close + cancel paths)
    $('#sheetClose')?.addEventListener('click', closeProductSheet);

    // Add to cart from sheet
    $('#sheetAdd')?.addEventListener('click', ()=>{
      if (!currentProduct) return;
      const qty = Math.max(1, parseInt($('#qtyVal').textContent||'1',10));
      const entry = cart.get(currentProduct.name) || {price: currentProduct.price, qty: 0};
      entry.qty += qty;
      entry.price = currentProduct.price;               // keep latest price
      cart.set(currentProduct.name, entry);
      saveCart(cart);
      renderCart();
      closeProductSheet();
      $('#cartOverlay').classList.add('show');
    });

    /* ---------- OVERLAYS (Cart / Settings / Checkout) ---------- */
    function openCart(){ $('#cartOverlay')?.classList.add('show'); }
    function closeCart(){ $('#cartOverlay')?.classList.remove('show'); }
    function openSettings(defaultToAdmin=false){
      $('#settingsOverlay')?.classList.add('show');
      switchTab(defaultToAdmin ? 'admin' : 'general');
    }
    function closeSettings(){ $('#settingsOverlay')?.classList.remove('show'); }

    // header buttons
    $('#cartBtn')?.addEventListener('click', openCart);
    $('#cartBack')?.addEventListener('click', closeCart);
    $('#settingsBtn')?.addEventListener('click', ()=>openSettings(false));
    $('#settingsClose')?.addEventListener('click', closeSettings);

    // initial paint
    renderCart();
    refreshBadge();
        /* ---------- RE-ORDER LAST ---------- */
    function reorderLast(){
      const active = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]');
      if (!active.length){
        alert('No previous orders');
        return;
      }
      const last = active[0];
      cart = new Map();
      last.lines.forEach(l=>{
        cart.set(l.name, {price:l.price, qty:l.qty});
      });
      saveCart(cart);
      renderCart();
      openCart();
    }
    $('#reorderLast')?.addEventListener('click', reorderLast);

    /* ---------- CHECKOUT FLOW ---------- */
    $('#cartCheckout')?.addEventListener('click', ()=>{
      $('#checkoutName').value='';
      $('#checkoutLocation').value='';
      $('#checkoutError').style.display='none';
      closeCart();
      $('#checkoutOverlay').classList.add('show');
    });
    $('#checkoutClose')?.addEventListener('click', ()=>$('#checkoutOverlay').classList.remove('show'));

    $('#checkoutSubmit')?.addEventListener('click', ()=>{
      const name = $('#checkoutName').value.trim();
      const loc  = $('#checkoutLocation').value.trim();
      if (!name || !loc){
        $('#checkoutError').style.display='block';
        return;
      }
      // add order + clear cart
      addOrderFromCart(name, loc);
      cart.clear();
      renderCart();
      $('#checkoutOverlay').classList.remove('show');
    });

    /* ---------- ORDERS + ADMIN ---------- */
    function addOrderFromCart(name, location){
      const lines=[]; let total=0;
      for(const [n,info] of cart){
        const line=info.price*info.qty; total+=line;
        lines.push({name:n, price:info.price, qty:info.qty, line});
      }
      const order={when:new Date().toISOString(), name, location, lines, total};
      const list = JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]');
      list.unshift(order);
      localStorage.setItem(ORDERS_KEY, JSON.stringify(list));
      renderOrders();
      return order;
    }

    function renderOrders(){
      const list = JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]');
      const box = $('#ordersList'); if (!box) return;
      if (!list.length){ box.innerHTML='No orders yet'; return; }
      box.innerHTML = list.map(o=>{
        const items = o.lines.map(l=>`${l.name} √ó ${l.qty} -- ${fmtMoney(l.line)}`).join('<br>');
        const when = new Date(o.when).toLocaleString();
        return `<div style="padding:8px;border-bottom:1px solid #2a2a30">
          <div style="font-weight:700">${when}</div>
          <div style="margin-top:4px">${items}</div>
          <div style="margin-top:6px;font-weight:700">Total: ${fmtMoney(o.total)}</div>
          <div style="color:#bbb;margin-top:4px">${o.name} @ ${o.location}</div>
        </div>`;
      }).join('');
    }

    function switchTab(which){
      const tabG=$('#tabGeneral'), tabA=$('#tabAdmin');
      const panG=$('#panelGeneral'), panA=$('#panelAdmin');
      if(which==='admin'){
        tabG.classList.remove('active'); tabG.setAttribute('aria-selected','false');
        tabA.classList.add('active'); tabA.setAttribute('aria-selected','true');
        panG.style.display='none'; panA.style.display='block';
        ensureAdminLoginVisible();
      } else {
        tabA.classList.remove('active'); tabA.setAttribute('aria-selected','false');
        tabG.classList.add('active'); tabG.setAttribute('aria-selected','true');
        panA.style.display='none'; panG.style.display='block';
      }
    }

    function ensureAdminLoginVisible(){
      const loggedIn = localStorage.getItem(UNLOCK_KEY)==='1';
      $('#adminLogin').style.display = loggedIn ? 'none' : 'block';
      $('#adminContent').style.display = loggedIn ? 'block' : 'none';
      if (loggedIn){
        renderOrders();
        renderInventory();
        renderHeat();
      }
    }

    document.addEventListener('click',(e)=>{
      if(e.target.closest('#tabGeneral')) switchTab('general');
      if(e.target.closest('#tabAdmin'))   switchTab('admin');
    }, {passive:true});

    // admin login
    $('#adminSubmit')?.addEventListener('click', ()=>{
      const ok = $('#adminPassword').value === ADMIN_PASSWORD;
      if(ok){
        localStorage.setItem(UNLOCK_KEY,'1');
        $('#adminError').style.display='none';
        ensureAdminLoginVisible();
      } else {
        $('#adminError').style.display='block';
      }
    });
        /* ---------- INVENTORY (stock & low) ---------- */
    function getProducts(){
      return $$('.card').map(c=>({
        name: c.dataset.name,
        price: +c.dataset.price,
        img: c.dataset.img || '',
        tags: (c.dataset.tags||'').toLowerCase()
      }));
    }

    function renderInventory(){
      const wrap = $('#inventoryList'); if (!wrap) return;
      const products = getProducts();
      if(!products.length){ wrap.textContent='No products'; return; }
      wrap.innerHTML = products.map(p=>{
        const hasQ = Object.prototype.hasOwnProperty.call(stockQty, p.name);
        const hasL = Object.prototype.hasOwnProperty.call(stockLow, p.name);
        const qty  = hasQ ? Number(stockQty[p.name]||0) : '';
        const low  = hasL ? Number(stockLow[p.name]||0) : '';
        return `<div class="field" data-prod="${p.name}">
          <div style="flex:1;font-weight:600">${p.name}</div>
          <label style="font-size:12px;color:#c7c7cc">Stock</label>
          <input type="number" min="0" value="${qty}" data-k="qty" placeholder="--">
          <label style="font-size:12px;color:#c7c7cc">Low</label>
          <input type="number" min="0" value="${low}" data-k="low" placeholder="--">
        </div>`;
      }).join('');
    }

    // reflect stock/low in product mini sheet (if open)
    function refreshMiniIfOpen(){
      const ov = $('#productSheet');
      if (!ov || !ov.classList.contains('show') || !currentProduct) return;
      const name = currentProduct.name;
      const q = Number(stockQty[name] ?? NaN);
      const l = Number(stockLow[name] ?? NaN);
      if (Number.isFinite(q)){
        $('#sheetStock').textContent = 'Stock: ' + q;
        if (Number.isFinite(l) && l>0 && q<=l){
          $('#sheetLowWarn').style.display='block';
          $('#sheetLowWarn').textContent = `Low stock (${q} ‚â§ ${l})`;
        } else {
          $('#sheetLowWarn').style.display='none';
        }
      } else {
        $('#sheetStock').textContent = 'Stock: --';
        $('#sheetLowWarn').style.display='none';
      }
    }

    // persist inventory edits
    document.addEventListener('input', (e)=>{
      const row = e.target.closest('.field[data-prod]'); if(!row) return;
      const name = row.getAttribute('data-prod');
      if (e.target.matches('input[data-k="qty"]')){
        const v = (e.target.value||'').trim();
        if (v===''){ delete stockQty[name]; }
        else { stockQty[name] = Math.max(0, Number(v)||0); }
        saveObj(STOCK_KEY, stockQty);
        refreshMiniIfOpen();
      }
      if (e.target.matches('input[data-k="low"]')){
        const v2 = (e.target.value||'').trim();
        if (v2===''){ delete stockLow[name]; }
        else { stockLow[name] = Math.max(0, Number(v2)||0); }
        saveObj(LOW_KEY, stockLow);
        refreshMiniIfOpen();
      }
    });

    /* ---------- HEAT MAP (checkouts by hour) ---------- */
    function renderHeat(){
      const grid = $('#heatGrid'); if (!grid) return;
      let max = 0;
      for(let d=0; d<7; d++) for(let h=0; h<24; h++) max = Math.max(max, sales[d]?.[h]||0);
      grid.innerHTML = '';
      for(let d=0; d<7; d++){
        for(let h=0; h<24; h++){
          const v = sales[d]?.[h]||0;
          const alpha = max ? (0.08 + 0.62*(v/max)) : 0.10; // 0.10..0.70
          const cell = document.createElement('div');
          cell.className = 'heat-cell';
          cell.title = `Day ${d}, ${h}:00 -- ${v}`;
          cell.style.background = `rgba(110,168,254,${alpha})`;
          grid.appendChild(cell);
        }
      }
    }

    /* ---------- A11Y keyboard click for key UI buttons ---------- */
    $$('.btn,.add,.ghost,.primary,.tab,.subtab').forEach(el=>{
      el.tabIndex = 0;
      el.addEventListener('keydown', e=>{
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          el.click();
        }
      });
    });

    /* ---------- INITIALIZE UI ---------- */
    // Ensure admin panels reflect current lock state
    function isUnlocked(){ return localStorage.getItem(UNLOCK_KEY)==='1'; }
    function setUnlocked(v){ localStorage.setItem(UNLOCK_KEY, v?'1':'0'); }

    // Optional: start locked on first load
    if (localStorage.getItem(UNLOCK_KEY) == null) setUnlocked(false);

    // First render
    renderCart();
    refreshBadge();
    renderOrders();
    // Inventory/Heat are behind Admin; they‚Äôll render when unlocked, but safe to pre-render:
    try{ renderInventory(); }catch{}
    try{ renderHeat(); }catch{}

    // Clicking outside a sheet closes it (basic UX)
    document.addEventListener('click', (e)=>{
      const ov = e.target.classList?.contains('overlay') ? e.target : null;
      if (!ov) return;
      if (ov.id==='productSheet') closeProductSheet();
      if (ov.id==='cartOverlay')  closeCart();
      if (ov.id==='checkoutOverlay') $('#checkoutOverlay').classList.remove('show');
      if (ov.id==='settingsOverlay') closeSettings();
    });

    // Escape key to close top-most overlay
    document.addEventListener('keydown', (e)=>{
      if (e.key !== 'Escape') return;
      // close any visible in priority order
      if ($('#productSheet')?.classList.contains('show')) { closeProductSheet(); return; }
      if ($('#checkoutOverlay')?.classList.contains('show')) { $('#checkoutOverlay').classList.remove('show'); return; }
      if ($('#cartOverlay')?.classList.contains('show')) { closeCart(); return; }
      if ($('#settingsOverlay')?.classList.contains('show')) { closeSettings(); return; }
    });
    </script>
  </body>
</html>
    
    