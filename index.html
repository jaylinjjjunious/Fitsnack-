<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>FitSnacks</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0b0d">

<!-- Prefetch carousel images -->
<link rel="preload" as="image" href="assets/carousel-1.jpg">
<link rel="preload" as="image" href="assets/carousel-2.jpg">
<link rel="preload" as="image" href="assets/carousel-3.jpg">

<style>
  :root{
    --bg:#0b0b0d; --card:rgba(20,20,24,0.6); --text:#e9e9ec; --muted:#a9a9b1;
    --accent:#6ea8fe; --good:#3cd27f; --warn:#ffb020; --badge:#ff3b30;
    --radius:18px; --blur:18px; --snap-gap:12px;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
  .app{max-width:393px;min-height:100svh;margin:0 auto;padding:12px 12px 64px;box-sizing:border-box}

  /* Glass */
  .card,.sheet,.btn,.search,.chip,.tab,.ghost,.primary,.field{
    backdrop-filter:blur(var(--blur)); -webkit-backdrop-filter:blur(var(--blur));
    background:var(--card); border:1px solid rgba(255,255,255,.08);
    box-shadow:0 4px 24px rgba(0,255,0,.08);
  }

  /* Header */
  .row{display:flex;align-items:center;gap:12px}
  .search-wrap{position:relative;flex:1;min-width:0}
  .icon-rights{display:flex;gap:10px;flex-shrink:0;justify-content:flex-end;flex:0 0 160px}
  .search{width:100%;border-radius:999px;padding:12px 44px;color:var(--text);outline:0;border:1px solid #2a2a2e}
  .search::placeholder{color:#6c6c70}
  .icon-left{position:absolute;left:12px;top:50%;transform:translateY(-50%)}
  .btn{border-radius:14px;width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
  #cartBtn{position:relative}
  .badge{position:absolute;top:-6px;right:-8px;background:var(--badge);color:#fff;border-radius:999px;padding:1px 6px;font-size:12px;font-weight:700;display:none}

  .greet{margin:8px 2px 2px;color:#c7c7cc;font-size:14px}

  /* Carousel */
  .carousel{margin:10px 0 6px}
  .snapper{height:100px;display:flex;align-items:stretch;gap:var(--snap-gap);overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding:0 var(--snap-gap)}
  .snapper::-webkit-scrollbar{display:none}
  .snap-spacer{flex:0 0 7.5%}
  .snap-card{position:relative;flex:0 0 85%;scroll-snap-align:center;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center}
  .banner{width:100%;height:100%;object-fit:cover}
  .snap-meta{position:absolute;left:10px;bottom:8px;right:10px;display:flex;justify-content:space-between;gap:8px;pointer-events:none}
  .snap-title{font-weight:800;text-shadow:0 1px 6px rgba(0,0,0,.6)}
  .snap-cta{pointer-events:auto}
  .snap-dots{display:flex;justify-content:center;gap:6px;margin-top:6px}
  .snap-dot{width:6px;height:6px;border-radius:999px;background:#2c3447;border:1px solid rgba(255,255,255,.18)}
  .snap-dot.active{background:#7fb1ff}

  /* Chips */
  .chips{display:flex;gap:10px;margin:6px 0 12px;flex-wrap:wrap}
  .chip{padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
  .chip.active{outline:2px solid rgba(110,168,254,.5)}

  /* Grid */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .card{border-radius:var(--radius);padding:12px;position:relative;display:flex;flex-direction:column;min-height:190px}
  .thumb{height:90px;border-radius:12px;overflow:hidden;margin-bottom:8px;display:flex;align-items:center;justify-content:center;background:#0e0e12}
  .thumb img{width:100%;height:100%;object-fit:contain}
  .title{font-weight:700;margin:4px 0 2px}
  .price{color:var(--muted);font-weight:600;margin-top:auto}
  .add{position:absolute;right:12px;bottom:12px;background:var(--accent);border:0;color:#001230;border-radius:14px;width:42px;height:42px;font-size:22px;display:flex;align-items:center;justify-content:center;font-weight:800;cursor:pointer}
  .fav{position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:12px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);cursor:pointer}
  .fav.active{background:rgba(255,215,0,.15);box-shadow:0 0 0 1px rgba(255,215,0,.35) inset}

  /* Overlays basics */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
  .overlay.show{display:flex}
</style>
</head>
<body>
<div class="app" role="application">

  <!-- Header -->
  <div class="row">
    <div class="search-wrap">
      <span class="icon-left" aria-hidden="true">üîç</span>
      <input id="search" class="search" placeholder="Search snacks‚Ä¶" autocomplete="off">
    </div>
    <div class="icon-rights">
      <button type="button" class="btn" id="cartBtn" aria-label="Open cart">
        üõí <span id="cartBadge" class="badge">0</span>
      </button>
      <button type="button" class="btn" id="settingsBtn" aria-label="Open settings">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- Greeting -->
  <div id="greet" class="greet">Welcome üëã</div>

  <!-- Promo carousel -->
  <div class="carousel" aria-label="Promotions">
    <div id="snapper" class="snapper" aria-roledescription="carousel">
      <div class="snap-spacer" aria-hidden="true"></div>
      <!-- JS injects promo cards here -->
      <div class="snap-spacer" aria-hidden="true"></div>
    </div>
    <div id="snapDots" class="snap-dots" aria-hidden="true"></div>
  </div>

  <!-- Chips -->
  <div class="chips" id="chips">
    <div class="chip" data-filter="">all</div>
    <div class="chip" data-filter="vegan">vegan</div>
    <div class="chip" data-filter="gluten-free">gluten-free</div>
    <div class="chip" data-filter="protein">protein</div>
    <div class="chip" data-filter="favorites">favorites</div>
  </div>

  <!-- Products Grid -->
  <div id="grid" class="grid" role="list">
    <div class="card" role="listitem" data-name="Potato Chips" data-price="2.50" data-img="assets/product-funyuns.jpg" data-tags="snack">
      <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
      <div class="thumb"><img src="assets/product-funyuns.jpg" alt="Potato Chips" loading="lazy"></div>
      <div class="title">Potato Chips</div>
      <div class="price">$2.50</div>
      <button class="add" aria-label="Add Potato Chips">+</button>
    </div>

    <div class="card" role="listitem" data-name="Protein Bar" data-price="2.99" data-img="assets/product-chesters.jpg" data-tags="protein">
      <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
      <div class="thumb"><img src="assets/product-chesters.jpg" alt="Protein Bar" loading="lazy"></div>
      <div class="title">Protein Bar</div>
      <div class="price">$2.99</div>
      <button class="add" aria-label="Add Protein Bar">+</button>
    </div>

    <div class="card" role="listitem" data-name="Trail Mix" data-price="3.49" data-img="assets/product-cheetos.jpg" data-tags="vegan,gluten-free">
      <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
      <div class="thumb"><img src="assets/product-cheetos.jpg" alt="Trail Mix" loading="lazy"></div>
      <div class="title">Trail Mix</div>
      <div class="price">$3.49</div>
      <button class="add" aria-label="Add Trail Mix">+</button>
    </div>

    <div class="card" role="listitem" data-name="Granola Bar" data-price="1.99" data-img="assets/product-granola.jpg" data-tags="vegan,protein">
      <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
      <div class="thumb"><img src="assets/product-granola.jpg" alt="Granola Bar" loading="lazy"></div>
      <div class="title">Granola Bar</div>
      <div class="price">$1.99</div>
      <button class="add" aria-label="Add Granola Bar">+</button>
    </div>
        <!-- 5 Doritos -->
    <div class="card" role="listitem" data-name="Doritos Flamin‚Äô Hot Nacho" data-price="2.00" data-img="assets/product-doritos.jpg" data-tags="snack">
      <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
      <div class="thumb"><img src="assets/product-doritos.jpg" alt="Doritos Flamin‚Äô Hot Nacho" loading="lazy"></div>
      <div class="title">Doritos Flamin‚Äô Hot Nacho</div>
      <div class="price">$2.00</div>
      <button class="add" aria-label="Add Doritos Flamin‚Äô Hot Nacho">+</button>
    </div>

    <!-- 6 Greek Yogurt (with fallback) -->
    <div class="card" role="listitem"
         data-name="Greek Yogurt"
         data-price="2.00"
         data-img="assets/greek-yogurt.jpeg"
         data-tags="protein">
      <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
      <div class="thumb">
        <img
          src="assets/greek-yogurt.jpeg?v=3"
          alt="Greek Yogurt"
          loading="lazy"
          onerror="if(!this.__triedJPEG){this.__triedJPEG=1;this.src='assets/greek-yogurt.jpg?v=3';}else{this.src='assets/product-yogurt.jpg';}"
        >
      </div>
      <div class="title">Greek Yogurt</div>
      <div class="price">$2.00</div>
      <button class="add" aria-label="Add Greek Yogurt">+</button>
    </div>

    <!-- 7 -->
    <div class="card" role="listitem" data-name="Mixed Nuts" data-price="3.20" data-img="assets/product-nuts.jpg" data-tags="vegan,protein">
      <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
      <div class="thumb"><img src="assets/product-nuts.jpg" alt="Mixed Nuts" loading="lazy"></div>
      <div class="title">Mixed Nuts</div>
      <div class="price">$3.20</div>
      <button class="add" aria-label="Add Mixed Nuts">+</button>
    </div>

    <!-- 8 -->
    <div class="card" role="listitem" data-name="Fruit Cup" data-price="2.19" data-img="assets/product-fruit.jpg" data-tags="vegan,gluten-free">
      <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
      <div class="thumb"><img src="assets/product-fruit.jpg" alt="Fruit Cup" loading="lazy"></div>
      <div class="title">Fruit Cup</div>
      <div class="price">$2.19</div>
      <button class="add" aria-label="Add Fruit Cup">+</button>
    </div>

    <!-- 9 -->
    <div class="card" role="listitem" data-name="Energy Drink" data-price="2.99" data-img="assets/product-energy.jpg" data-tags="snack">
      <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
      <div class="thumb"><img src="assets/product-energy.jpg" alt="Energy Drink" loading="lazy"></div>
      <div class="title">Energy Drink</div>
      <div class="price">$2.99</div>
      <button class="add" aria-label="Add Energy Drink">+</button>
    </div>

    <!-- 10 -->
    <div class="card" role="listitem" data-name="Chocolate Bar" data-price="1.75" data-img="assets/product-chocolate.jpg" data-tags="snack">
      <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
      <div class="thumb"><img src="assets/product-chocolate.jpg" alt="Chocolate Bar" loading="lazy"></div>
      <div class="title">Chocolate Bar</div>
      <div class="price">$1.75</div>
      <button class="add" aria-label="Add Chocolate Bar">+</button>
    </div>
  </div> <!-- /#grid -->

  <!-- Product mini sheet -->
  <div id="productSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Add item">
    <div class="sheet" role="document" style="width:92%;max-width:480px;border-radius:20px;padding:16px">
      <div class="row-between">
        <h3 id="sheetTitle">Item</h3>
        <button class="ghost" id="sheetClose" type="button">Close</button>
      </div>
      <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
        <div style="width:88px;height:88px;border-radius:12px;overflow:hidden;border:1px solid #2a2a30;">
          <img id="sheetImg" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div style="flex:1">
          <div id="sheetPrice" class="price" style="font-size:18px;"></div>
          <div id="sheetStock" style="margin-top:6px;color:#c7c7cc;font-size:13px;">Stock: --</div>
          <div id="sheetLowWarn" style="display:none;margin-top:6px;color:#ff6b6b;font-weight:600;font-size:13px;">Low stock</div>
        </div>
      </div>
      <div class="row-between" style="margin-top:10px;">
        <div class="qty">
          <button id="qtyMinus" type="button">‚àí</button>
          <div id="qtyVal" aria-live="polite">1</div>
          <button id="qtyPlus" type="button">+</button>
        </div>
        <button class="primary" id="sheetAdd" type="button">Add</button>
      </div>
    </div>
  </div>

  <!-- Order details sheet (z-index above settings) -->
  <div id="orderSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Order details" style="z-index:10050">
    <div class="sheet" role="document" style="width:92%;max-width:480px;border-radius:20px;padding:16px">
      <div class="row-between">
        <h3>Order</h3>
        <button class="ghost" id="orderClose" type="button">Close</button>
      </div>
      <div id="orderMeta" style="margin-top:6px;color:#c7c7cc;font-size:13px">‚Äì</div>
      <div id="orderLines" class="admin-list" style="margin-top:8px">‚Äì</div>
      <div class="row-between" style="margin-top:10px;">
        <strong>Total</strong><strong id="orderTotal">$0.00</strong>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button class="ghost" id="orderCancel" type="button">Cancel</button>
        <button class="primary" id="orderDelivered" type="button">Mark Delivered</button>
      </div>
    </div>
  </div>

  <!-- Cart bottom-sheet -->
  <div id="cartOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Cart">
    <div class="sheet" role="document" style="width:100%;border-top-left-radius:24px;border-top-right-radius:24px;border-bottom-left-radius:0;border-bottom-right-radius:0;padding:16px 16px calc(16px + env(safe-area-inset-bottom));">
      <div class="row-between">
        <h3>Cart</h3>
        <button class="ghost" id="cartBack" type="button">Back</button>
      </div>
      <div id="cartContent" class="sheet-body" style="max-height:70svh;overflow:auto;padding-right:4px">Cart is empty</div>
      <div class="row-between" style="margin-top:10px;">
        <strong>Total</strong><strong id="cartTotal">$0.00</strong>
      </div>
      <div class="actions">
        <button class="ghost" id="reorderLast" type="button">Re-order last</button>
        <button class="primary" id="cartCheckout" type="button">Checkout</button>
      </div>
    </div>
  </div>

  <!-- Checkout bottom-sheet -->
  <div id="checkoutOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Checkout">
    <div class="sheet" role="document" style="width:100%;border-top-left-radius:24px;border-top-right-radius:24px;border-bottom-left-radius:0;border-bottom-right-radius:0;padding:16px 16px calc(16px + env(safe-area-inset-bottom));">
      <div class="row-between">
        <h3>Checkout</h3>
        <button class="ghost" id="checkoutClose" type="button">Close</button>
      </div>

      <div class="sheet-body" style="max-height:70svh;overflow:auto;padding-right:4px">
        <!-- Profile -->
        <div style="margin-top:6px;">Your name:</div>
        <input id="checkoutName" class="field" style="width:100%;padding:10px;border-radius:10px">
        <div style="margin-top:10px;">Where are you on campus?</div>
        <input id="checkoutLocation" class="field" style="width:100%;padding:10px;border-radius:10px">

        <!-- Promo (simple, optional) -->
        <div style="margin-top:12px;">Promo code</div>
        <input id="checkoutPromo" class="field" style="width:100%;padding:10px;border-radius:10px">
        <div id="promoStatus" style="margin-top:6px;color:#aaa;font-size:13px"></div>

        <!-- Tip -->
        <div style="margin-top:12px;">Tip (optional)</div>
        <div id="tipGroup">
          <button class="ghost tip-btn" data-tip="none" type="button">No tip</button>
          <button class="ghost tip-btn" data-tip="amount:1" type="button">$1</button>
          <button class="ghost tip-btn" data-tip="amount:2" type="button">$2</button>
          <button class="ghost tip-btn" data-tip="percent:10" type="button">10%</button>
        </div>

        <!-- Breakdown -->
        <div class="breakdown" style="margin-top:12px">
          <div class="break-row"><div class="muted">Subtotal</div><div id="ckSub">$0.00</div></div>
          <div class="break-row"><div class="muted">Discount</div><div id="ckDisc">-$0.00</div></div>
          <div class="break-row"><div class="muted">Tip</div><div id="ckTip">$0.00</div></div>
          <div class="break-row" style="font-weight:800"><div>Total</div><div id="ckTotal">$0.00</div></div>
        </div>

        <div id="checkoutError" style="display:none;color:#ff6b6b;margin-top:10px;">Please fill both fields.</div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="primary" id="checkoutSubmit" type="button">Place Order</button>
      </div>
    </div>
  </div>

  <!-- Settings bottom-sheet (starts in General). z-index below orderSheet -->
  <div id="settingsOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Settings" style="z-index:10000">
    <div class="sheet" role="document" style="width:100%;border-top-left-radius:24px;border-top-right-radius:24px;border-bottom-left-radius:0;border-bottom-right-radius:0;padding:16px 16px calc(16px + env(safe-area-inset-bottom));">
      <div class="row-between">
        <h3>Settings</h3>
        <button class="ghost" id="settingsClose" type="button">Close</button>
      </div>

      <div class="tabs" role="tablist" aria-label="Settings Tabs">
        <button id="tabGeneral" class="tab active" role="tab" aria-selected="true" aria-controls="panelGeneral" type="button">General</button>
        <button id="tabAdmin" class="tab" role="tab" aria-selected="false" aria-controls="panelAdmin" type="button">Admin</button>
      </div>

      <div class="sheet-body" style="max-height:70svh;overflow:auto;padding-right:4px">
        <!-- General -->
        <div id="panelGeneral" role="tabpanel" aria-labelledby="tabGeneral">
          <div class="ghost" aria-disabled="true">Dark Mode (disabled)</div>
          <div class="ghost" aria-disabled="true">Notifications (disabled)</div>
        </div>

        <!-- Admin -->
        <div id="panelAdmin" role="tabpanel" aria-labelledby="tabAdmin" style="display:none">
          <!-- Login -->
          <div id="adminLogin">
            <div style="margin-top:6px;">Admin password:</div>
            <input id="adminPassword" type="password" class="field" style="width:100%;padding:10px;border-radius:10px">
            <div id="adminError" style="display:none;color:#ff6b6b;margin-top:6px;">Wrong password.</div>
            <div class="actions" style="margin-top:12px;">
              <button class="primary" id="adminSubmit" type="button">Unlock</button>
            </div>
          </div>

          <!-- Content (locked until unlock) -->
          <div id="adminContent" style="display:none">
            <div class="admin-subtabs">
              <button class="subtab active" data-subtab="orders" type="button">Orders</button>
              <button class="subtab" data-subtab="inventory" type="button">Inventory</button>
              <button class="subtab" data-subtab="analytics" type="button">Analytics</button>
              <button class="subtab" data-subtab="heat" type="button">Heat Map</button>
              <button class="subtab" data-subtab="history" type="button">History</button>
            </div>

            <!-- Orders -->
            <div id="subtab-orders">
              <div id="ordersList" class="admin-list">No orders yet</div>
            </div>

            <!-- Inventory (with editable stock & low) -->
            <div id="subtab-inventory" style="display:none">
              <div style="margin-top:6px;font-weight:700">Inventory (Stock & Low)</div>
              <div id="inventoryList" class="admin-list">Loading‚Ä¶</div>
            </div>

            <!-- Analytics -->
            <div id="subtab-analytics" style="display:none">
              <div class="kpis" style="margin-top:8px">
                <div class="kpi"><div class="label">Revenue</div><div id="kpiRevenue" class="value">$0.00</div></div>
                <div class="kpi"><div class="label">Orders</div><div id="kpiOrders" class="value">0</div></div>
                <div class="kpi"><div class="label">AOV</div><div id="kpiAOV" class="value">$0.00</div></div>
                <div class="kpi"><div class="label">Items</div><div id="kpiItems" class="value">0</div></div>
              </div>
              <svg id="revSpark" class="spark" viewBox="0 0 100 40" preserveAspectRatio="none"></svg>
              <div id="topProducts" class="table" style="margin-top:8px"></div>
            </div>

            <!-- Heat Map -->
            <div id="subtab-heat" style="display:none">
              <div id="heatGridHM"></div>
            </div>

            <!-- History -->
            <div id="subtab-history" style="display:none">
              <div id="historyList" class="admin-list">No history yet</div>
              <button class="ghost" id="historyClear" type="button">Clear history</button>
            </div>
          </div> <!-- /#adminContent -->
        </div> <!-- /#panelAdmin -->
      </div> <!-- /.sheet-body -->
    </div>
  </div>

  <!-- Toast host -->
  <div id="toastHost"></div>
  <script>
/* ====== Shortcuts ====== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => '$'+Number(n||0).toFixed(2);

/* ====== Keys & Config ====== */
const CART_KEY='fitsnacks.cart.v1';
const ORDERS_KEY='fitsnacks.orders';
const DELIVERED_KEY='fitsnacks.orders.delivered';
const FAVORITES_KEY='fitsnacks.favorites';
const UNLOCK_KEY='fitsnacks.admin.unlocked';
const PROFILE_NAME_KEY='fitsnacks.profile.name';
const PROFILE_LOC_KEY='fitsnacks.profile.location';
const STOCK_KEY='fitsnacks.stock.qty';
const LOW_KEY='fitsnacks.stock.low';

const ADMIN_PASSWORD='8TSB077';
const IFTTT_EVENT='Fitsnack_order';
const IFTTT_KEY='fI-MGeBZrzbzW3CyUXlWVMpQkvI1bRVirGd0gkcYZiA';
const IFTTT_URL=`https://maker.ifttt.com/trigger/${IFTTT_EVENT}/with/key/${IFTTT_KEY}`;

/* ====== State ====== */
let cart=new Map(JSON.parse(localStorage.getItem(CART_KEY)||'[]'));
let favorites=new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY)||'[]'));
let stockQty = JSON.parse(localStorage.getItem(STOCK_KEY)||'{}');
let stockLow = JSON.parse(localStorage.getItem(LOW_KEY)||'{}');

/* ====== Utilities ====== */
function saveCart(){localStorage.setItem(CART_KEY,JSON.stringify(Array.from(cart.entries())));}
function saveFavs(){localStorage.setItem(FAVORITES_KEY,JSON.stringify(Array.from(favorites)));}

/* ====== Toast ====== */
function showToast(msg, ms=2000){
  const host=$('#toastHost'); if(!host) return;
  const el=document.createElement('div');
  el.className='toast'; el.textContent=msg;
  el.style.cssText='padding:10px 12px;margin:4px;background:rgba(30,30,30,.9);border-radius:12px;color:#fff;font-weight:600';
  host.appendChild(el);
  setTimeout(()=>{ el.remove(); },ms);
}

/* ====== Greeting ====== */
function updateGreeting(){
  const name=localStorage.getItem(PROFILE_NAME_KEY)||'';
  $('#greet').textContent=name?`Hi, ${name} üëã`:'Welcome üëã';
}

/* ====== Carousel ====== */
function buildPromos(){
  const snapper=$('#snapper'); if(!snapper) return;
  const promos=[
    {img:'assets/carousel-1.jpg',title:'Fuel your study grind',cta:'Shop snacks',action:'scrollGrid'},
    {img:'assets/carousel-2.jpg',title:'Protein picks',cta:'Filter: protein',action:'filter',value:'protein'},
    {img:'assets/carousel-3.jpg',title:'Need help?',cta:'Open settings',action:'openSettings'}
  ];
  snapper.querySelectorAll('.snap-card').forEach(n=>n.remove());
  const after=snapper.lastElementChild;
  promos.forEach(p=>{
    const c=document.createElement('div');
    c.className='snap-card';
    c.innerHTML=`<img class="banner" src="${p.img}" alt="${p.title}">
      <div class="snap-meta"><div class="snap-title">${p.title}</div>
      ${p.cta?`<button class="ghost snap-cta" type="button">${p.cta}</button>`:''}</div>`;
    snapper.insertBefore(c,after);
    c.querySelector('.snap-cta')?.addEventListener('click',e=>{
      e.stopPropagation();
      if(p.action==='filter') activateChip(p.value);
      if(p.action==='openSettings'){ $('#settingsOverlay').classList.add('show'); switchTab('general'); }
      if(p.action==='scrollGrid') $('#grid')?.scrollIntoView({behavior:'smooth'});
    });
  });
}

/* ====== Product Sheet ====== */
let currentProduct=null;
function openProductSheet(card){
  currentProduct={name:card.dataset.name,price:+card.dataset.price,img:card.dataset.img};
  $('#sheetTitle').textContent=currentProduct.name;
  $('#sheetImg').src=currentProduct.img;
  $('#sheetPrice').textContent=fmt(currentProduct.price);
  $('#qtyVal').textContent='1';
  $('#sheetAdd').textContent='Add ‚Ä¢ '+fmt(currentProduct.price);
  $('#productSheet').classList.add('show');
}
$('#sheetClose')?.addEventListener('click',()=>$('#productSheet').classList.remove('show'));
$('#qtyPlus')?.addEventListener('click',()=>{
  let n=(+$('#qtyVal').textContent)||1; n=Math.min(99,n+1);
  $('#qtyVal').textContent=n; $('#sheetAdd').textContent='Add ‚Ä¢ '+fmt(n*currentProduct.price);
});
$('#qtyMinus')?.addEventListener('click',()=>{
  let n=(+$('#qtyVal').textContent)||1; n=Math.max(1,n-1);
  $('#qtyVal').textContent=n; $('#sheetAdd').textContent='Add ‚Ä¢ '+fmt(n*currentProduct.price);
});
$('#sheetAdd')?.addEventListener('click',()=>{
  if(!currentProduct) return;
  const n=(+$('#qtyVal').textContent)||1;
  const entry=cart.get(currentProduct.name)||{price:currentProduct.price,qty:0};
  entry.qty+=n; cart.set(currentProduct.name,entry); saveCart();
  renderCart(); refreshBadge(); $('#productSheet').classList.remove('show'); $('#cartOverlay').classList.add('show');
});

/* ====== Cart ====== */
function refreshBadge(){
  let n=0; for(const v of cart.values()) n+=v.qty;
  const b=$('#cartBadge'); if(!b) return;
  if(n>0){ b.textContent=n; b.style.display='inline-flex'; }
  else { b.style.display='none'; }
}
function renderCart(){
  let total=0; let html='';
  for(const [name,info] of cart){
    const line=info.price*info.qty; total+=line;
    html+=`<div class="row-between" style="margin-top:6px">
      <div>${name} √ó ${info.qty}</div>
      <div>${fmt(line)}</div>
    </div>`;
  }
  $('#cartContent').innerHTML=html||'Cart is empty';
  $('#cartTotal').textContent=fmt(total);
}
$('#cartBtn')?.addEventListener('click',()=>$('#cartOverlay').classList.add('show'));
$('#cartBack')?.addEventListener('click',()=>$('#cartOverlay').classList.remove('show'));

/* ====== Search + Filters ====== */
function searchAndFilter(){
  const q=($('#search').value||'').toLowerCase();
  $$('.card').forEach(c=>{
    const name=c.dataset.name.toLowerCase();
    const tags=c.dataset.tags.toLowerCase();
    const inFav=favorites.has(c.dataset.name);
    let show=name.includes(q);
    const activeChip=$('#chips .chip.active');
    if(activeChip){
      const filter=activeChip.dataset.filter;
      if(filter==='favorites') show=show&&inFav;
      else if(filter) show=show&&tags.includes(filter);
    }
    c.style.display=show?'':'none';
  });
}
function activateChip(val){
  $$('#chips .chip').forEach(ch=>ch.classList.toggle('active',ch.dataset.filter===val));
  searchAndFilter();
}
$('#chips').addEventListener('click',e=>{
  const chip=e.target.closest('.chip'); if(chip) activateChip(chip.dataset.filter);
});
$('#search').addEventListener('input',searchAndFilter);

/* ====== Favorites ====== */
document.addEventListener('click',e=>{
  const fav=e.target.closest('.fav'); if(!fav) return;
  e.stopPropagation();
  const card=fav.closest('.card'); const name=card.dataset.name;
  if(favorites.has(name)) favorites.delete(name); else favorites.add(name);
  saveFavs(); syncFavStars();
});
function syncFavStars(){
  $$('.card').forEach(card=>{
    card.querySelector('.fav')?.classList.toggle('active',favorites.has(card.dataset.name));
  });
}

/* ====== Checkout ====== */
function computeTotals(){let subtotal=0; for(const v of cart.values()) subtotal+=v.price*v.qty; return{subtotal,total:subtotal};}
function updateCheckout(){const {subtotal,total}=computeTotals();$('#ckSub').textContent=fmt(subtotal);$('#ckTotal').textContent=fmt(total);}
$('#cartCheckout')?.addEventListener('click',()=>{updateCheckout();$('#cartOverlay').classList.remove('show');$('#checkoutOverlay').classList.add('show');});
$('#checkoutClose')?.addEventListener('click',()=>$('#checkoutOverlay').classList.remove('show'));
$('#checkoutSubmit')?.addEventListener('click',()=>{
  const name=$('#checkoutName').value.trim();
  const loc=$('#checkoutLocation').value.trim();
  if(!name||!loc){$('#checkoutError').style.display='block';return;}
  localStorage.setItem(PROFILE_NAME_KEY,name);
  localStorage.setItem(PROFILE_LOC_KEY,loc);
  const {total}=computeTotals();
  const lines=[...cart].map(([n,i])=>`${n} √ó ${i.qty} -- ${fmt(i.price*i.qty)}`).join('\\n');
  const order={when:new Date().toISOString(),name,location:loc,total,lines};
  const list=JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]'); list.unshift(order); localStorage.setItem(ORDERS_KEY,JSON.stringify(list));
  cart.clear(); saveCart(); renderCart(); refreshBadge(); updateGreeting(); showToast('Order placed üéâ');
  $('#checkoutOverlay').classList.remove('show');
  // IFTTT GET trigger
  const summary=`${order.name} @ ${order.location} ‚Ä¢ ${fmt(order.total)}`;
  fetch(`${IFTTT_URL}?value1=${encodeURIComponent(summary)}&value2=${encodeURIComponent(lines)}&value3=`,{method:'GET',mode:'no-cors'});
  renderOrders();
});

/* ====== Orders & Admin ====== */
function renderOrders(){
  const list=JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]');
  const box=$('#ordersList'); if(!box) return;
  if(!list.length){box.textContent='No orders yet';return;}
  box.innerHTML=list.map((o,i)=>`<div class="order-item" data-idx="${i}" style="padding:8px;border-bottom:1px solid #2a2a30;cursor:pointer">
    <div style="font-weight:700">${new Date(o.when).toLocaleString()}</div>
    <div>${o.name} @ ${o.location}</div>
    <div>Total ${fmt(o.total)}</div>
  </div>`).join('');
}
document.addEventListener('click',e=>{
  const row=e.target.closest('.order-item'); if(row) openOrderSheet(+row.dataset.idx);
});
function openOrderSheet(idx){
  const list=JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]'); const o=list[idx]; if(!o) return;
  $('#orderMeta').textContent=`${o.name} @ ${o.location} ‚Ä¢ ${new Date(o.when).toLocaleString()}`;
  $('#orderLines').textContent=o.lines;
  $('#orderTotal').textContent=fmt(o.total);
  $('#orderSheet').classList.add('show');
}
$('#orderClose')?.addEventListener('click',()=>$('#orderSheet').classList.remove('show'));

/* ====== Analytics, Inventory, Heat ====== */
function renderAnalytics(){/* simplified demo */$('#kpiOrders').textContent=JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]').length;}
function renderInventory(){
  const wrap=$('#inventoryList'); if(!wrap) return;
  const cards=$$('.card');
  wrap.innerHTML=[...cards].map(c=>{
    const n=c.dataset.name;
    return `<div data-prod="${n}">${n}: <input type="number" data-k="qty" value="${stockQty[n]||''}" placeholder="stock"> <input type="number" data-k="low" value="${stockLow[n]||''}" placeholder="low"></div>`;
  }).join('');
}
document.addEventListener('input',e=>{
  const row=e.target.closest('[data-prod]'); if(!row) return;
  const name=row.getAttribute('data-prod');
  if(e.target.dataset.k==='qty'){stockQty[name]=+e.target.value;localStorage.setItem(STOCK_KEY,JSON.stringify(stockQty));}
  if(e.target.dataset.k==='low'){stockLow[name]=+e.target.value;localStorage.setItem(LOW_KEY,JSON.stringify(stockLow));}
});
function renderHeat(){const grid=$('#heatGridHM');if(grid)grid.textContent='(demo heatmap)';}

/* ====== Settings & Admin Login ====== */
function switchTab(which){
  const g=$('#tabGeneral'),a=$('#tabAdmin'),pg=$('#panelGeneral'),pa=$('#panelAdmin');
  if(which==='admin'){g.classList.remove('active');pg.style.display='none';a.classList.add('active');pa.style.display='block';ensureAdminLogin();}
  else{a.classList.remove('active');pa.style.display='none';g.classList.add('active');pg.style.display='block';}
}
function ensureAdminLogin(){
  const logged=localStorage.getItem(UNLOCK_KEY)==='1';
  $('#adminLogin').style.display=logged?'none':'block';
  $('#adminContent').style.display=logged?'block':'none';
  if(logged){renderOrders();renderInventory();renderAnalytics();renderHeat();}
}
document.addEventListener('click',e=>{
  if(e.target.closest('#tabGeneral'))switchTab('general');
  if(e.target.closest('#tabAdmin'))switchTab('admin');
  if(e.target.closest('#adminSubmit')){
    const ok=$('#adminPassword').value===ADMIN_PASSWORD;
    if(ok){localStorage.setItem(UNLOCK_KEY,'1');$('#adminError').style.display='none';ensureAdminLogin();}
    else{$('#adminError').style.display='block';}
  }
  if(e.target.closest('.subtab')){
    $$('.subtab').forEach(s=>s.classList.remove('active'));
    e.target.classList.add('active');
    ['orders','inventory','analytics','heat','history'].forEach(k=>$('#subtab-'+k).style.display=(e.target.dataset.subtab===k)?'block':'none');
  }
});

/* ====== History ====== */
function renderHistory(){
  const list=JSON.parse(localStorage.getItem(DELIVERED_KEY)||'[]');
  $('#historyList').innerHTML=list.map(o=>`<div>${o.name} ${fmt(o.total)}</div>`).join('')||'No history';
}
$('#historyClear')?.addEventListener('click',()=>{localStorage.setItem(DELIVERED_KEY,'[]');renderHistory();});

/* ====== Init ====== */
updateGreeting();buildPromos();renderCart();refreshBadge();syncFavStars();renderOrders();renderInventory();renderAnalytics();renderHeat();renderHistory();
</script>
<script>
/* ================= Fix Kit & Safety Binders ================ */
/* 1) Keep overlays always closable (backdrop + Esc) */
(function ensureOverlayClosers(){
  const closeOverlay = (ov)=> ov && ov.classList.remove('show');

  // Backdrop click closes
  document.querySelectorAll('.overlay').forEach(ov=>{
    ov.addEventListener('click', e=>{
      if(e.target === ov) closeOverlay(ov);
    }, {passive:true});
  });

  // Esc closes top-most open overlay
  document.addEventListener('keydown', e=>{
    if(e.key !== 'Escape') return;
    const open = Array.from(document.querySelectorAll('.overlay.show'));
    if(open.length) closeOverlay(open.at(-1));
  });
})();

/* 2) Z-index ordering: ensure Order sheet shows above Settings */
(function fixZOrder(){
  const so = document.getElementById('settingsOverlay');
  const os = document.getElementById('orderSheet');
  if(so) so.style.zIndex = '10000';
  if(os) os.style.zIndex = '10050';
})();

/* 3) Core header button bindings (idempotent, safe to rerun) */
(function bindHeaderButtons(){
  const on = (sel, ev, fn) => {
    const el = document.querySelector(sel);
    if(!el) return;
    // remove previous to avoid doubles
    el.replaceWith(el.cloneNode(true));
    const fresh = document.querySelector(sel);
    fresh.addEventListener(ev, fn, {passive:true});
  };
  on('#settingsBtn','click', ()=>{ 
    document.getElementById('settingsOverlay')?.classList.add('show'); 
    // default to GENERAL on open (per your request)
    if (typeof switchTab === 'function') switchTab('general');
  });
  on('#settingsClose','click', ()=> document.getElementById('settingsOverlay')?.classList.remove('show'));
  on('#cartBtn','click',     ()=> document.getElementById('cartOverlay')?.classList.add('show'));
  on('#cartBack','click',    ()=> document.getElementById('cartOverlay')?.classList.remove('show'));
})();

/* 4) Make product cards always open the mini-sheet (even if DOM changed) */
(function cardOpeners(){
  document.addEventListener('click', (e)=>{
    // "+" on a card
    const plus = e.target.closest('.card .add');
    if(plus){
      e.stopPropagation();
      const card = plus.closest('.card');
      if(card && typeof openProductSheet === 'function') openProductSheet(card);
      return;
    }
    // click card (not fav / not +)
    const card = e.target.closest('.card');
    if(card && !e.target.closest('.fav') && !e.target.closest('.add')){
      if(typeof openProductSheet === 'function') openProductSheet(card);
    }
  }, {passive:true});
})();

/* 5) Orders list: always clickable ‚Üí open the order mini page */
(function ensureOrderClicks(){
  document.addEventListener('click', (e)=>{
    const row = e.target.closest('.order-item');
    if(!row) return;
    const idx = parseInt(row.dataset.idx, 10);
    if(Number.isFinite(idx) && typeof openOrderSheet === 'function'){
      openOrderSheet(idx);
    }
  }, {passive:true});
})();

/* 6) Admin login: show password prompt by default when switching to Admin */
(function adminLoginDefault(){
  // When user taps "Admin" tab, switchTab('admin') will call ensureAdminLogin()
  // ensureAdminLogin() already shows #adminLogin if not unlocked.
  // This just guarantees the function exists and runs at least once on load.
  if (typeof ensureAdminLogin === 'function') ensureAdminLogin();
})();

/* 7) Inventory inputs: keep editable & persisted */
(function ensureInventoryInputsLive(){
  // Already wired in Chunk 3 via 'input' listener.
  // This just repaints list once more after DOM settles.
  if (typeof renderInventory === 'function') renderInventory();
})();

/* 8) Search + Filters health check (so chips always filter, search always works) */
(function ensureSearchAndFilter(){
  // Rebind chips
  const chips = document.getElementById('chips');
  if(chips){
    chips.replaceWith(chips.cloneNode(true));
    const fresh = document.getElementById('chips');
    fresh.addEventListener('click', (e)=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      if (typeof activateChip === 'function') activateChip(chip.dataset.filter || '');
    }, {passive:true});
  }
  // Rebind search
  const search = document.getElementById('search');
  if(search){
    search.replaceWith(search.cloneNode(true));
    const freshS = document.getElementById('search');
    freshS.addEventListener('input', ()=>{
      if(typeof searchAndFilter === 'function') searchAndFilter();
    });
  }
  // Initial pass
  if(typeof searchAndFilter === 'function') searchAndFilter();
})();

/* 9) Last sanity refresh on load */
(function finalRefresh(){
  try{
    typeof updateGreeting==='function' && updateGreeting();
    typeof buildPromos==='function' && buildPromos();
    typeof renderCart==='function' && renderCart();
    typeof refreshBadge==='function' && refreshBadge();
    typeof renderOrders==='function' && renderOrders();
    typeof renderAnalytics==='function' && renderAnalytics();
    typeof renderInventory==='function' && renderInventory();
    typeof renderHeat==='function' && renderHeat();
  }catch(e){ console.error('[FitSnacks] final refresh error', e); }
})();
</script>
</body>
</html>