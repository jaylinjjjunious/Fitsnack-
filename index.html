<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>FitSnacks</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0d">

  <!-- Preload banners (optional but helps first paint) -->
  <link rel="preload" as="image" href="assets/carousel-1.jpg">
  <link rel="preload" as="image" href="assets/carousel-2.jpg">
  <link rel="preload" as="image" href="assets/carousel-3.jpg">

  <style>
    :root{
      --bg:#0b0b0d;
      --card:rgba(20,20,24,0.6);
      --text:#e9e9ec;
      --muted:#aaa;
      --accent:#6ea8fe;
      --badge:#ff3b30;
      --radius:18px;
      --blur:18px;

      /* ui bits */
      --chip-bg:#16161bcc;
      --border:rgba(255,255,255,.10);

      /* carousel (snap) */
      --snap-gap:12px;
    }

    html,body{
      margin:0; height:100%;
      background:var(--bg); color:var(--text);
      font:16px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;
    }
    .app{max-width:393px;min-height:100svh;margin:0 auto;padding:12px 12px 32px;box-sizing:border-box}

    /* Glass utility */
    .glass{
      background:var(--card);
      backdrop-filter:blur(var(--blur));
      -webkit-backdrop-filter:blur(var(--blur));
      border:1px solid var(--border);
      box-shadow:0 4px 24px rgba(0,0,0,.25);
    }

    /* Header */
    .row{position:relative;display:flex;align-items:center}
    .search-wrap{flex:1}
    .search{
      width:100%; padding:12px 44px; border-radius:999px;
      border:1px solid var(--border); outline:none; color:var(--text);
      background:rgba(18,18,22,.7); backdrop-filter:blur(10px);
    }
    .search::placeholder{color:#6c6c70}
    .icon-left{position:absolute;left:12px;top:50%;transform:translateY(-50%)}
    .icon-rights{display:flex; gap:10px; margin-left:10px}
    .btn{
      -webkit-appearance:none;appearance:none;cursor:pointer;
      width:44px;height:44px;border-radius:14px;border:1px solid var(--border);
      display:inline-flex;align-items:center;justify-content:center;
      background:rgba(22,22,27,.8);
    }
    #cartBtn{position:relative}
    .badge{
      position:absolute; top:-6px; right:-8px;
      display:none; align-items:center; justify-content:center;
      background:var(--badge); color:#fff; font-size:12px; font-weight:700;
      padding:1px 6px; border-radius:999px;
    }

    /* Greeting */
    .greet{margin:8px 2px 6px;color:#c7c7cc;font-size:14px}

    /* Promo (card-snap) */
    .carousel{margin:6px 0 10px}
    .snapper{
      height:100px; display:flex; align-items:stretch; gap:var(--snap-gap);
      overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch;
      padding:0 var(--snap-gap);
    }
    .snapper::-webkit-scrollbar{display:none}
    .snap-spacer{flex:0 0 7.5%}
    .snap-card{
      position:relative; flex:0 0 85%; height:100%;
      border-radius:14px; overflow:hidden; scroll-snap-align:center;
      border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25);
      display:flex; align-items:center; justify-content:center;
    }
    .banner{width:100%;height:100%;object-fit:contain;display:block}
    .snap-meta{
      position:absolute; left:10px; right:10px; bottom:8px;
      display:flex; justify-content:space-between; gap:8px; align-items:flex-end;
      pointer-events:none;
    }
    .snap-title{font-weight:800;text-shadow:0 1px 6px rgba(0,0,0,.6)}
    .snap-cta{pointer-events:auto}
    .snap-dots{display:flex;justify-content:center;gap:6px;margin-top:6px}
    .snap-dot{width:6px;height:6px;border-radius:999px;background:#2c3447;border:1px solid rgba(255,255,255,.18)}
    .snap-dot.active{background:#7fb1ff}

    /* Chips */
    .chips{display:flex;gap:10px;margin:6px 0 12px;flex-wrap:wrap}
    .chip{
      padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer;
      background:var(--chip-bg); border:1px solid var(--border);
    }
    .chip.active{outline:2px solid rgba(110,168,254,.45)}

    /* Grid */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{
      position:relative; min-height:190px; padding:12px; border-radius:var(--radius);
      border:1px solid var(--border); background:rgba(20,20,24,.6);
      backdrop-filter:blur(var(--blur));
    }
    .thumb{height:90px;border-radius:12px;overflow:hidden;margin-bottom:8px;display:flex;align-items:center;justify-content:center;background:#0e0e12}
    .thumb img{width:100%;height:100%;object-fit:contain}
    .title{font-weight:700;margin:4px 0 2px;letter-spacing:.2px}
    .price{color:#c7c7cc;font-weight:600;margin-top:auto}
    .add{
      position:absolute; right:12px; bottom:12px;
      width:42px;height:42px;border-radius:14px;border:0;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      background:var(--accent); color:#001230; font-size:22px; font-weight:800;
      box-shadow:0 8px 18px rgba(110,168,254,.25)
    }
    .fav{
      position:absolute; right:12px; top:12px;
      width:36px;height:36px;border-radius:12px; cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25)
    }
    .fav.active{background:rgba(255,215,0,.16); box-shadow:0 0 0 1px rgba(255,215,0,.35) inset}

    /* Overlays */
    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:20px; z-index:9999; background:rgba(0,0,0,.5)}
    .overlay.show{display:flex}
    .sheet{
      width:92%; max-width:480px; padding:16px; border-radius:20px;
      border:1px solid var(--border); background:rgba(20,20,24,.9);
      backdrop-filter:blur(16px);
    }
    /* bottom sheets */
    #cartOverlay,#checkoutOverlay,#settingsOverlay,#productSheet,#orderSheet{ align-items:flex-end }
    #cartOverlay .sheet,#checkoutOverlay .sheet,#settingsOverlay .sheet,#productSheet .sheet,#orderSheet .sheet{
      width:100%; border-top-left-radius:24px; border-top-right-radius:24px; border-bottom-left-radius:0; border-bottom-right-radius:0;
      padding-bottom:calc(16px + env(safe-area-inset-bottom));
      transform:translateY(100%); animation:slideUp 220ms ease-out forwards;
    }
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .ghost{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#1b1b20;color:#e7e7eb;cursor:pointer}
    .primary{border:0;border-radius:12px;padding:12px 14px;background:var(--accent);color:#081425;font-weight:800;cursor:pointer}
    .qty{display:flex;align-items:center;gap:10px}
    .qty button{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:#1c1c22;color:var(--text);font-size:20px;font-weight:700}

    /* Settings / Admin */
    .tabs{display:flex;gap:8px;margin:6px 0 12px}
    .tab{padding:8px 10px;border-radius:10px;cursor:pointer;border:1px solid var(--border);background:#18181d}
    .tab.active{background:#24242a}
    .sheet-body{max-height:70svh;overflow:auto;padding-right:4px}

    .admin-subtabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
    .subtab{padding:6px 10px;border-radius:10px;cursor:pointer;border:1px solid var(--border);background:#18181d;font-size:13px}
    .subtab.active{background:#24242a}

    .admin-list{border:1px solid var(--border);border-radius:12px;padding:8px;margin-top:8px}
    .field{display:flex;align-items:center;gap:8px;padding:8px;border-radius:12px;border:1px solid var(--border);background:#121216}
    .field input{width:72px;padding:8px;border-radius:10px;border:1px solid var(--border);background:#101014;color:#e9e9ec}

    /* Heat map */
    .heat-grid{display:grid;grid-template-columns:repeat(24, minmax(10px,1fr));gap:6px}
    .heat-cell{width:100%;aspect-ratio:1/1;border-radius:6px;background:rgba(110,168,254,0.10)}

    /* Toasts */
    #toastHost{position:fixed;left:0;right:0;bottom:calc(16px + env(safe-area-inset-bottom));display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;z-index:11000}
    .toast{pointer-events:auto;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(24,24,32,.9);font-weight:600;opacity:0;transform:translateY(8px);transition:opacity .22s ease,transform .22s ease}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <div class="app" role="application">
    <!-- Header -->
    <div class="row">
      <div class="search-wrap" style="position:relative">
        <span class="icon-left" aria-hidden="true">üîç</span>
        <input id="search" class="search" placeholder="Search snacks‚Ä¶" autocomplete="off">
      </div>
      <div class="icon-rights">
        <button type="button" class="btn" id="cartBtn" aria-label="Open cart">
          üõí <span id="cartBadge" class="badge">0</span>
        </button>
        <button type="button" class="btn" id="settingsBtn" aria-label="Open settings">‚öôÔ∏è</button>
      </div>
    </div>

    <!-- Greeting -->
    <div id="greet" class="greet">Welcome üëã</div>

    <!-- Promo (snap carousel; cards injected by JS) -->
    <div class="carousel" aria-label="Promotions">
      <div id="snapper" class="snapper" aria-roledescription="carousel">
        <div class="snap-spacer" aria-hidden="true"></div>
        <!-- cards injected -->
        <div class="snap-spacer" aria-hidden="true"></div>
      </div>
      <div id="snapDots" class="snap-dots" aria-hidden="true"></div>
    </div>

    <!-- Chips -->
    <div class="chips" id="chips">
      <div class="chip" data-filter="">all</div>
      <div class="chip" data-filter="vegan">vegan</div>
      <div class="chip" data-filter="gluten-free">gluten-free</div>
      <div class="chip" data-filter="protein">protein</div>
      <div class="chip" data-filter="favorites">favorites</div>
    </div>

    <!-- Product Grid -->
    <div id="grid" class="grid" role="list">
      <div class="card" role="listitem" data-name="Potato Chips" data-price="2.50" data-img="assets/product-funyuns.jpg" data-tags="snack">
        <button class="fav" aria-label="Favorite">‚≠ê</button>
        <div class="thumb"><img src="assets/product-funyuns.jpg" alt="Potato Chips" loading="lazy"></div>
        <div class="title">Potato Chips</div>
        <div class="price">$2.50</div>
        <button class="add" aria-label="Add Potato Chips">+</button>
      </div>
      <div class="card" role="listitem" data-name="Protein Bar" data-price="2.99" data-img="assets/product-chesters.jpg" data-tags="protein">
        <button class="fav" aria-label="Favorite">‚≠ê</button>
        <div class="thumb"><img src="assets/product-chesters.jpg" alt="Protein Bar" loading="lazy"></div>
        <div class="title">Protein Bar</div>
        <div class="price">$2.99</div>
        <button class="add" aria-label="Add Protein Bar">+</button>
      </div>
      <div class="card" role="listitem" data-name="Trail Mix" data-price="3.49" data-img="assets/product-cheetos.jpg" data-tags="vegan,gluten-free">
        <button class="fav" aria-label="Favorite">‚≠ê</button>
        <div class="thumb"><img src="assets/product-cheetos.jpg" alt="Trail Mix" loading="lazy"></div>
        <div class="title">Trail Mix</div>
        <div class="price">$3.49</div>
        <button class="add" aria-label="Add Trail Mix">+</button>
      </div>
    </div>
  </div>
    <!-- Product mini sheet -->
  <div id="productSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Add item">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3 id="sheetTitle">Item</h3>
        <button class="ghost" id="sheetClose">Close</button>
      </div>

      <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
        <div style="width:88px;height:88px;border-radius:12px;overflow:hidden;border:1px solid var(--border);">
          <img id="sheetImg" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div style="flex:1">
          <div id="sheetPrice" class="price" style="font-size:18px;">$0.00</div>
          <div id="sheetStock" style="margin-top:6px;color:#c7c7cc;font-size:13px;">Stock: --</div>
          <div id="sheetLowWarn" style="display:none;margin-top:6px;color:#ff6b6b;font-weight:600;font-size:13px;">Low stock</div>
        </div>
      </div>

      <div class="row-between" style="margin-top:10px;">
        <div class="qty">
          <button id="qtyMinus">‚àí</button>
          <div id="qtyVal">1</div>
          <button id="qtyPlus">+</button>
        </div>
        <button class="primary" id="sheetAdd">Add</button>
      </div>
    </div>
  </div>

  <!-- Order details sheet (admin) -->
  <div id="orderSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Order details">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Order</h3>
        <button class="ghost" id="orderClose">Close</button>
      </div>
      <div id="orderMeta" style="margin-top:6px;color:#c7c7cc;font-size:13px">‚Äì</div>
      <div id="orderLines" class="admin-list" style="margin-top:8px">‚Äì</div>
      <div class="row-between" style="margin-top:10px;">
        <strong>Total</strong><strong id="orderTotal">$0.00</strong>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button class="ghost" id="orderCancel">Cancel</button>
        <button class="primary" id="orderDelivered">Mark Delivered</button>
      </div>
    </div>
  </div>

  <!-- Cart bottom-sheet -->
  <div id="cartOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Cart">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Cart</h3>
        <button class="ghost" id="cartBack">Back</button>
      </div>

      <div id="cartContent" class="sheet-body">Cart is empty</div>

      <div class="row-between" style="margin-top:10px;">
        <strong>Total</strong><strong id="cartTotal">$0.00</strong>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="ghost" id="reorderLast">Re-order last</button>
        <button class="primary" id="cartCheckout">Checkout</button>
      </div>
    </div>
  </div>

  <!-- Checkout bottom-sheet -->
  <div id="checkoutOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Checkout">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Checkout</h3>
        <button class="ghost" id="checkoutClose">Close</button>
      </div>

      <div class="sheet-body">
        <!-- Profile -->
        <div style="margin-top:6px;">Your name:</div>
        <input id="checkoutName" class="field" style="width:100%;padding:10px;border-radius:10px" placeholder="e.g., Jordan">
        <div style="margin-top:10px;">Where are you on campus?</div>
        <input id="checkoutLocation" class="field" style="width:100%;padding:10px;border-radius:10px" placeholder="e.g., Library, 2nd floor">

        <!-- Promo -->
        <div style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div class="field" style="flex:1;min-width:0;display:flex;gap:8px;align-items:center">
            <input id="checkoutPromo" placeholder="Promo code" class="field" style="flex:1;min-width:0;padding:10px;border-radius:10px">
            <button class="ghost" id="checkoutApplyPromo">Apply</button>
          </div>
          <div id="promoStatus" class="toast" style="display:none"></div>
        </div>

        <!-- Tip -->
        <div style="margin-top:12px;">Tip (optional)</div>
        <div class="admin-subtabs" id="tipGroup" style="margin-top:6px">
          <button class="subtab" data-tip="none">No tip</button>
          <button class="subtab" data-tip="amount:1">$1</button>
          <button class="subtab" data-tip="amount:2">$2</button>
          <button class="subtab" data-tip="percent:10">10%</button>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <input id="tipCustomAmount" type="number" min="0" step="0.5" placeholder="Custom $" class="field" style="width:110px">
            <button class="ghost" id="tipApplyCustom">Set</button>
          </div>
        </div>

        <!-- Notes -->
        <div style="margin-top:12px;">Delivery notes (optional)</div>
        <textarea id="checkoutNotes" class="field" style="width:100%;min-height:64px" placeholder="e.g., Meet at main entrance."></textarea>

        <!-- Breakdown -->
        <div class="admin-list" style="margin-top:12px">
          <div class="row-between"><div>Subtotal</div><div id="ckSub">$0.00</div></div>
          <div class="row-between"><div>Discount</div><div id="ckDisc">-$0.00</div></div>
          <div class="row-between"><div>Tip</div><div id="ckTip">$0.00</div></div>
          <div class="row-between" style="font-weight:800;margin-top:6px"><div>Total</div><div id="ckTotal">$0.00</div></div>
        </div>

        <div id="checkoutError" style="display:none;color:#ff6b6b;margin-top:10px;">Please fill both fields.</div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="primary" id="checkoutSubmit">Place Order</button>
      </div>
    </div>
  </div>

  <!-- Settings bottom-sheet -->
  <div id="settingsOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Settings">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Settings</h3>
        <button class="ghost" id="settingsClose">Close</button>
      </div>

      <div class="tabs" role="tablist" aria-label="Settings Tabs">
        <button id="tabGeneral" class="tab active" role="tab" aria-selected="true" aria-controls="panelGeneral">General</button>
        <button id="tabAdmin" class="tab" role="tab" aria-selected="false" aria-controls="panelAdmin">Admin</button>
      </div>

      <div class="sheet-body">
        <!-- General -->
        <div id="panelGeneral" role="tabpanel" aria-labelledby="tabGeneral">
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div class="ghost" aria-disabled="true">Dark Mode (disabled)</div>
            <div class="ghost" aria-disabled="true">Notifications (disabled)</div>
          </div>
        </div>

        <!-- Admin -->
        <div id="panelAdmin" role="tabpanel" aria-labelledby="tabAdmin" style="display:none">
          <!-- Login -->
          <div id="adminLogin">
            <div style="margin-top:6px;">Admin password:</div>
            <input id="adminPassword" type="password" class="field" style="width:100%;padding:10px;border-radius:10px" placeholder="Enter password">
            <div id="adminError" style="display:none;color:#ff6b6b;margin-top:6px;">Wrong password.</div>
            <div class="actions" style="margin-top:12px;">
              <button class="primary" id="adminSubmit">Unlock</button>
            </div>
          </div>

          <!-- Content -->
          <div id="adminContent" style="display:none">
            <div class="admin-subtabs">
              <button class="subtab active" data-subtab="orders">Orders</button>
              <button class="subtab" data-subtab="inventory">Inventory</button>
              <button class="subtab" data-subtab="analytics">Analytics</button>
              <button class="subtab" data-subtab="history">History</button>
            </div>

            <!-- Orders -->
            <div id="subtab-orders">
              <div style="margin-top:6px;font-weight:700">Orders</div>
              <div id="ordersList" class="admin-list">No orders yet</div>
            </div>

            <!-- Inventory -->
            <div id="subtab-inventory" style="display:none">
              <div style="margin-top:6px;font-weight:700">Inventory (Stock & Low)</div>
              <div id="inventoryList" class="admin-list">Loading‚Ä¶</div>
            </div>

            <!-- Analytics -->
            <div id="subtab-analytics" style="display:none">
              <div style="margin-top:6px;font-weight:700">Analytics Overview</div>
              <div class="admin-list" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <div><div style="color:#c7c7cc;font-size:12px">Revenue</div><div id="kpiRevenue" style="font-weight:800;font-size:18px">$0.00</div></div>
                <div><div style="color:#c7c7cc;font-size:12px">Orders</div><div id="kpiOrders" style="font-weight:800;font-size:18px">0</div></div>
                <div><div style="color:#c7c7cc;font-size:12px">AOV</div><div id="kpiAOV" style="font-weight:800;font-size:18px">$0.00</div></div>
                <div><div style="color:#c7c7cc;font-size:12px">Items sold</div><div id="kpiItems" style="font-weight:800;font-size:18px">0</div></div>
              </div>

              <div style="margin-top:12px;font-weight:700">Top Products</div>
              <div class="admin-list" id="topProducts">‚Äì</div>

              <div style="margin-top:12px;font-weight:700">Funnel by Product</div>
              <div id="funnels" class="admin-list">‚Äì</div>

              <div style="margin-top:12px;font-weight:700">Checkouts by Hour (7√ó24)</div>
              <div id="heatGrid" class="heat-grid" style="margin-top:6px"></div>
            </div>

            <!-- History -->
            <div id="subtab-history" style="display:none">
              <div class="row-between" style="margin-top:6px;">
                <div style="font-weight:700">Delivered Orders (auto-clears after 3 days)</div>
                <button class="ghost" id="historyClear" style="padding:6px 10px">Clear now</button>
              </div>
              <div id="historyList" class="admin-list" style="margin-top:8px">No delivered orders</div>
            </div>
          </div> <!-- /#adminContent -->
        </div> <!-- /#panelAdmin -->
      </div> <!-- /.sheet-body -->
    </div>
  </div>

  <!-- Toast host -->
  <div id="toastHost"></div>
  <script>
/* ===== DOM helpers ===== */
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

/* ===== LocalStorage keys ===== */
const CART_KEY        = 'fitsnacks.cart.v1';
const ORDERS_KEY      = 'fitsnacks.orders';
const UNLOCK_KEY      = 'fitsnacks.admin.unlocked';
const STOCK_QTY_KEY   = 'fitsnacks.stock.qty';
const STOCK_LOW_KEY   = 'fitsnacks.stock.low';
const STOCK_SET_KEY   = 'fitsnacks.stock.set';
const FAVORITES_KEY   = 'fitsnacks.favorites';
const PROFILE_NAME_KEY= 'fitsnacks.profile.name';
const PROFILE_LOC_KEY = 'fitsnacks.profile.location';
const DELIVERED_KEY   = 'fitsnacks.orders.delivered';

/* ===== Constants ===== */
const ADMIN_PASSWORD = '8TSB077';
const fmt = n => '$' + (Number(n)||0).toFixed(2);

/* ===== Storage helpers ===== */
const loadMap = (k)=>{ try{ return new Map(JSON.parse(localStorage.getItem(k)||'[]')); }catch{ return new Map(); } };
const saveMap = (k,m)=>{ try{ localStorage.setItem(k, JSON.stringify(Array.from(m.entries())));}catch{} };
const loadObj = (k)=>{ try{ return JSON.parse(localStorage.getItem(k)||'{}'); }catch{ return {}; } };
const saveObj = (k,o)=>{ try{ localStorage.setItem(k, JSON.stringify(o||{})); }catch{} };
const loadArr = (k)=>{ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch{ return []; } };
const saveArr = (k,a)=>{ try{ localStorage.setItem(k, JSON.stringify(a||[])); }catch{} };

/* ===== Global state ===== */
let cart = loadMap(CART_KEY);
let favorites = new Set(loadArr(FAVORITES_KEY));
let stockQty  = loadObj(STOCK_QTY_KEY);
let stockLow  = loadObj(STOCK_LOW_KEY);
let stockSet  = loadObj(STOCK_SET_KEY);
let currentProduct = null; // for product mini sheet
let currentOrderIndex = null; // for order sheet

/* ===== Toasts ===== */
function toast(msg, ms=1600){
  const host = $('#toastHost'); if(!host) return;
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  host.appendChild(t);
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),220); }, ms);
}

/* ===== Cart badge + render ===== */
function refreshBadge(){
  let n=0; for(const v of cart.values()) n+=v.qty;
  const b=$('#cartBadge');
  if(!b) return;
  if(n>0){ b.textContent=n; b.style.display='inline-flex'; }
  else { b.style.display='none'; }
}

function renderCart(){
  let total=0, html='';
  for(const [name,info] of cart){
    const line=info.price*info.qty; total+=line;
    html += `<div class="row-between" style="margin-top:6px">
      <div style="display:flex;gap:10px;align-items:center">
        <button data-act="-" data-name="${name}" class="ghost" style="padding:4px 8px">‚àí</button>
        <div style="min-width:24px;text-align:center">${info.qty}</div>
        <button data-act="+" data-name="${name}" class="ghost" style="padding:4px 8px">+</button>
        <button data-act="x" data-name="${name}" class="ghost" title="Remove" style="padding:4px 8px">‚úï</button>
        <div style="font-weight:700;margin-left:8px">${name}</div>
      </div>
      <div style="font-weight:700">${fmt(line)}</div>
    </div>`;
  }
  const box = $('#cartContent');
  box.innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
  $('#cartTotal').textContent = fmt(total);
  saveMap(CART_KEY, cart);
  refreshBadge();
}

/* ===== Product helpers ===== */
function getProducts(){ return $$('.card').map(c=>({
  name:c.dataset.name, price:+c.dataset.price, img:c.dataset.img||'', tags:(c.dataset.tags||'').toLowerCase(), el:c
})); }

function updateStockBadges(){
  $$('.card').forEach(card=>{
    let wrap = card.querySelector('.badge-wrap');
    if(!wrap){ wrap = document.createElement('div'); wrap.className='badge-wrap'; card.appendChild(wrap); }
    wrap.innerHTML='';
    const name=card.dataset.name;
    if(!stockSet[name]) return; // only show if stock set
    const qty = Number(stockQty[name]||0), low = Number(stockLow[name]||0);
    const b = document.createElement('div');
    b.className='stock-badge'; b.textContent='Stock: '+qty;
    wrap.appendChild(b);
    if(low>0 && qty<=low){
      const l = document.createElement('div');
      l.className='stock-badge low-badge'; l.textContent=`Only ${qty} left`;
      wrap.appendChild(l);
    }
  });
}

function refreshMiniIfOpen(){
  const ov=$('#productSheet'); if(!ov || !ov.classList.contains('show') || !currentProduct) return;
  const name=currentProduct.name;
  if(stockSet[name]){
    const q=Number(stockQty[name]||0), l=Number(stockLow[name]||0);
    $('#sheetStock').textContent='Stock: '+q;
    const lw=$('#sheetLowWarn');
    if(l>0 && q<=l){ lw.style.display='block'; lw.textContent=`Low stock (${q} ‚â§ ${l})`; }
    else { lw.style.display='none'; }
  }else{
    $('#sheetStock').textContent='Stock: --';
    $('#sheetLowWarn').style.display='none';
  }
}

/* ===== Overlays ===== */
function openOverlay(id){ $(id).classList.add('show'); }
function closeOverlay(id){ $(id).classList.remove('show'); }

/* ===== Product Sheet ===== */
function openProductSheet(card){
  currentProduct = {name:card.dataset.name, price:+card.dataset.price, img:card.dataset.img||''};
  $('#sheetTitle').textContent = currentProduct.name;
  $('#sheetImg').src = currentProduct.img; $('#sheetImg').alt = currentProduct.name;
  $('#sheetPrice').textContent = fmt(currentProduct.price);
  $('#qtyVal').textContent = '1';
  $('#sheetAdd').textContent = 'Add';
  refreshMiniIfOpen();
  openOverlay('#productSheet');
}
function closeProductSheet(){ closeOverlay('#productSheet'); }

/* ===== Orders store ===== */
function loadOrders(){ return loadArr(ORDERS_KEY); }
function saveOrders(v){ saveArr(ORDERS_KEY, v||[]); }
function loadDelivered(){ return loadArr(DELIVERED_KEY); }
function saveDelivered(v){ saveArr(DELIVERED_KEY,v||[]); }

function renderOrders(){
  const list=loadOrders(), box=$('#ordersList'); if(!box) return;
  if(!list.length){ box.innerHTML='No orders yet'; return; }
  box.innerHTML = list.map((o,i)=>{
    const when = new Date(o.when).toLocaleString();
    const items = o.lines.map(l=>`${l.name} √ó ${l.qty} -- ${fmt(l.line)}`).join('<br>');
    return `<div class="order-item" data-idx="${i}" role="button" tabindex="0"
              style="padding:8px;border-bottom:1px solid rgba(255,255,255,.12);cursor:pointer">
              <div class="row-between">
                <div>
                  <div style="font-weight:700">${when}</div>
                  <div style="color:#bbb;margin-top:4px">${o.name} @ ${o.location}</div>
                </div>
                <div style="font-weight:700">${fmt(o.total)}</div>
              </div>
              <div style="margin-top:6px">${items}</div>
              ${o.notes?`<div style="margin-top:6px;color:#c7c7cc;font-size:12px">üìù ${o.notes}</div>`:''}
            </div>`;
  }).join('');
}

/* ===== Admin lock ===== */
function isUnlocked(){ return localStorage.getItem(UNLOCK_KEY)==='1'; }
function setUnlocked(v){ localStorage.setItem(UNLOCK_KEY, v?'1':'0'); }
function ensureAdminLoginVisible(){
  const logged = isUnlocked();
  $('#adminLogin').style.display  = logged?'none':'block';
  $('#adminContent').style.display= logged?'block':'none';
  if(logged){ renderOrders(); renderInventory(); updateStockBadges(); renderHistory(); }
}

/* ===== Inventory render & inputs ===== */
function renderInventory(){
  const wrap=$('#inventoryList'); if(!wrap) return;
  const products=getProducts();
  if(!products.length){ wrap.textContent='No products'; return; }
  wrap.innerHTML = products.map(p=>{
    const hasQ = Object.prototype.hasOwnProperty.call(stockQty,p.name);
    const hasL = Object.prototype.hasOwnProperty.call(stockLow,p.name);
    const q = hasQ ? Number(stockQty[p.name]||0) : '';
    const l = hasL ? Number(stockLow[p.name]||0) : '';
    return `<div class="field" data-prod="${p.name}">
      <div style="flex:1;font-weight:600">${p.name}</div>
      <label style="font-size:12px;color:#c7c7cc">Stock</label>
      <input type="number" min="0" value="${q}" data-k="qty" placeholder="--">
      <label style="font-size:12px;color:#c7c7cc">Low</label>
      <input type="number" min="0" value="${l}" data-k="low" placeholder="--">
    </div>`;
  }).join('');
}

/* ===== History (auto-prune 72h) ===== */
function pruneDelivered(hours=72){
  const list=loadDelivered();
  const cutoff=Date.now()-hours*3600*1000;
  const keep = list.filter(o=>{
    const t = Date.parse(o.deliveredWhen||o.when||0);
    return isFinite(t) && t>=cutoff;
  });
  if(keep.length!==list.length) saveDelivered(keep);
}
function renderHistory(){
  pruneDelivered(72);
  const box=$('#historyList'); if(!box) return;
  const list=loadDelivered();
  if(!list.length){ box.textContent='No delivered orders'; return; }
  box.innerHTML = list.map(o=>{
    const placed = new Date(o.when).toLocaleString();
    const del = o.deliveredWhen?new Date(o.deliveredWhen).toLocaleString():'--';
    const items = o.lines.map(l=>`${l.name} √ó ${l.qty} -- ${fmt(l.line)}`).join('<br>');
    return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,.12)">
      <div class="row-between">
        <div>
          <div style="font-weight:700">Delivered: ${del}</div>
          <div style="color:#bbb;margin-top:2px">Placed: ${placed}</div>
          <div style="color:#bbb;margin-top:2px">${o.name} @ ${o.location}</div>
        </div>
        <div style="font-weight:700">${fmt(o.total)}</div>
      </div>
      <div style="margin-top:6px">${items}</div>
      ${o.notes?`<div style="margin-top:6px;color:#c7c7cc;font-size:12px">üìù ${o.notes}</div>`:''}
    </div>`;
  }).join('');
}

/* ===== Favorites stars ===== */
function syncFavStars(){
  $$('.card').forEach(c=>{
    c.querySelector('.fav')?.classList.toggle('active', favorites.has(c.dataset.name));
  });
}

/* ===== Search & chip filter ===== */
function activateChip(val){
  $$('#chips .chip').forEach(ch=>ch.classList.toggle('active', ch.dataset.filter===val));
  const prods=getProducts();
  let any=false;
  prods.forEach(p=>{
    const hit = !val || val==='' || (val==='favorites' ? favorites.has(p.name) : p.tags.includes(val));
    p.el.style.display = hit ? '' : 'none';
    if(hit) any=true;
  });
  let msg = $('#noResultsMsg');
  if(!msg){
    msg = document.createElement('div');
    msg.id='noResultsMsg';
    msg.style.cssText='margin:8px 2px;color:#c7c7cc;font-size:14px;display:none';
    $('#grid').insertAdjacentElement('beforebegin', msg);
  }
  msg.textContent = 'No results found';
  msg.style.display = any ? 'none' : 'block';
}

/* ===== Checkout math ===== */
let activePromo=null;
let activeTip={kind:'none', amount:0};

const PROMO_TABLE = {
  'SAVE10': {type:'percent', value:0.10, label:'10% off'},
  'BAR1':   {type:'amount',  value:1.00,  label:'$1 off protein', rule:'tag:protein'}
};

function cartSubtotal(){
  let s=0; for(const[,it] of cart) s+=it.price*it.qty; return s;
}

function evalPromoDiscount(code){
  code=(code||'').trim().toUpperCase();
  if(!code || !PROMO_TABLE[code]) return null;
  const p = PROMO_TABLE[code];
  const subtotal = cartSubtotal(); if(subtotal<=0) return null;
  let discount=0;
  if(p.rule && p.rule.startsWith('tag:')){
    const tag = p.rule.slice(4).toLowerCase();
    let eligible=0;
    $$('.card').forEach(c=>{
      const nm=c.dataset.name, tags=(c.dataset.tags||'').toLowerCase();
      const entry=cart.get(nm); if(!entry) return;
      if(tags.includes(tag)) eligible += entry.price*entry.qty;
    });
    if(eligible<=0) return {code,label:`No eligible items`,type:'none',value:0,discount:0,ok:false};
    discount = p.type==='percent'? eligible*p.value : Math.min(p.value, eligible);
  }else{
    discount = p.type==='percent'? subtotal*p.value : Math.min(p.value, subtotal);
  }
  return {code,type:p.type,value:p.value,label:p.label,rule:p.rule||'',discount:Math.max(0,discount),ok:true};
}

function computeTotals(){
  const sub = cartSubtotal();
  const disc = activePromo?.discount || 0;
  const tip  = Math.max(0, activeTip.amount||0);
  const total = Math.max(0, sub - disc) + tip;
  return {sub, disc, tip, total};
}
function updateCheckoutBreakdown(){
  const {sub,disc,tip,total} = computeTotals();
  $('#ckSub').textContent  = fmt(sub);
  $('#ckDisc').textContent = '-' + fmt(disc);
  $('#ckTip').textContent  = fmt(tip);
  $('#ckTotal').textContent= fmt(total);
}

/* ===== Place order (includes webhook trigger) ===== */
async function sendOrderWebhook(order){
  // If you use IFTTT, set your Maker URL here.
  // Example: const URL = 'https://maker.ifttt.com/trigger/Fitsnack_order/with/key/XXXXXXXX';
  const URL = ''; // <<< set to your real URL; if blank, skip silently
  if(!URL) return;
  try{
    await fetch(URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        value1: `${order.name} @ ${order.location}`,
        value2: order.lines.map(l=>`${l.name}√ó${l.qty}`).join(', '),
        value3: `Total ${fmt(order.total)} ‚Ä¢ Notes: ${order.notes||'-'}`
      }),
      keepalive:true // helps on page unload
    });
  }catch(e){ console.warn('Webhook failed:', e); }
}

/* ===== Init & Event binding ===== */
document.addEventListener('DOMContentLoaded', ()=>{

  /* Header buttons */
  $('#cartBtn')?.addEventListener('click', ()=>openOverlay('#cartOverlay'));
  $('#settingsBtn')?.addEventListener('click', ()=>{ openOverlay('#settingsOverlay'); switchTab('general'); ensureAdminLoginVisible(); });

  /* Search */
  $('#search')?.addEventListener('input', e=>{
    const q=(e.target.value||'').toLowerCase();
    $$('.card').forEach(c=> c.style.display = c.dataset.name.toLowerCase().includes(q) ? '' : 'none');
    const any = $$('.card').some(c=>c.style.display!=='none');
    let msg=$('#noResultsMsg');
    if(!msg){ msg=document.createElement('div'); msg.id='noResultsMsg'; msg.style.cssText='margin:8px 2px;color:#c7c7cc;font-size:14px'; $('#grid').insertAdjacentElement('beforebegin', msg); }
    msg.textContent='No results found';
    msg.style.display = any ? 'none' : 'block';
  });

  /* Chips */
  $('#chips')?.addEventListener('click', e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    activateChip(chip.dataset.filter||'');
  });
  activateChip('');

  /* Product cards: open sheet */
  $$('.card').forEach(card=>{
    // open details when clicking anywhere except the "+" or star
    card.addEventListener('click', e=>{
      if(e.target.closest('.add')||e.target.closest('.fav')) return;
      openProductSheet(card);
    });
    // big + button
    card.querySelector('.add')?.addEventListener('click', e=>{
      e.stopPropagation();
      openProductSheet(card);
    });
    // favorite star
    card.querySelector('.fav')?.addEventListener('click', e=>{
      e.stopPropagation();
      const name=card.dataset.name;
      favorites.has(name) ? favorites.delete(name) : favorites.add(name);
      saveArr(FAVORITES_KEY, Array.from(favorites));
      syncFavStars();
      toast(favorites.has(name)?`‚òÖ Added to favorites`:`‚òÜ Removed from favorites`);
    });
  });
  syncFavStars();

  /* Product sheet qty & add */
  $('#qtyPlus')?.addEventListener('click', ()=>{
    if(!currentProduct) return;
    const n=Math.min(99, parseInt($('#qtyVal').textContent||'1',10)+1);
    $('#qtyVal').textContent=n;
  });
  $('#qtyMinus')?.addEventListener('click', ()=>{
    if(!currentProduct) return;
    const n=Math.max(1, parseInt($('#qtyVal').textContent||'1',10)-1);
    $('#qtyVal').textContent=n;
  });
  $('#sheetAdd')?.addEventListener('click', ()=>{
    if(!currentProduct) return;
    const n = parseInt($('#qtyVal').textContent||'1',10);
    const entry = cart.get(currentProduct.name)||{price:currentProduct.price, qty:0};
    entry.price = currentProduct.price;
    entry.qty += n;
    cart.set(currentProduct.name, entry);
    saveMap(CART_KEY, cart);
    renderCart();
    refreshBadge();
    closeProductSheet();
    openOverlay('#cartOverlay');
    toast(`Added ${n} √ó ${currentProduct.name}`);
  });
  $('#sheetClose')?.addEventListener('click', closeProductSheet);

  /* Cart overlay */
  $('#cartBack')?.addEventListener('click', ()=>closeOverlay('#cartOverlay'));
  document.addEventListener('click', (e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    if(!btn.hasAttribute('data-act')||!btn.hasAttribute('data-name')) return;
    const name=btn.getAttribute('data-name'); const act=btn.getAttribute('data-act');
    const entry=cart.get(name); if(!entry) return;
    if(act==='+') entry.qty = Math.min(99, entry.qty+1);
    if(act==='-') entry.qty = Math.max(1, entry.qty-1);
    if(act==='x') cart.delete(name);
    if(act!=='x') cart.set(name,entry);
    renderCart();
  });

  /* Re-order last */
  $('#reorderLast')?.addEventListener('click', ()=>{
    const active = loadOrders();
    const delivered = loadDelivered();
    const src = active[0] || delivered[0];
    if(!src) return toast('No previous orders');
    cart = new Map();
    for(const line of src.lines){ cart.set(line.name, {price:line.price, qty:line.qty}); }
    saveMap(CART_KEY, cart);
    renderCart();
    openOverlay('#cartOverlay');
  });

  /* Checkout open/close */
  $('#cartCheckout')?.addEventListener('click', ()=>{
    const sub = cartSubtotal();
    if(sub<=0) return toast('Your cart is empty');
    const nm = localStorage.getItem(PROFILE_NAME_KEY)||'';
    const lc = localStorage.getItem(PROFILE_LOC_KEY)||'';
    $('#checkoutName').value = nm;
    $('#checkoutLocation').value = lc;
    $('#checkoutPromo').value='';
    activePromo=null; activeTip={kind:'none',amount:0};
    $('#checkoutError').style.display='none';
    updateCheckoutBreakdown();
    closeOverlay('#cartOverlay');
    openOverlay('#checkoutOverlay');
  });
  $('#checkoutClose')?.addEventListener('click', ()=>closeOverlay('#checkoutOverlay'));

  /* Promo */
  $('#checkoutApplyPromo')?.addEventListener('click', ()=>{
    const res=evalPromoDiscount($('#checkoutPromo').value);
    const badge=document.createElement('div');
    const host=$('#promoStatus');
    host.style.display='block';
    host.textContent='';
    if(res && res.ok){ activePromo=res; host.textContent = `${res.code} ‚Ä¢ -${fmt(res.discount)}`; }
    else { activePromo=null; host.textContent = res ? (res.label||'Not eligible') : 'Invalid code'; }
    updateCheckoutBreakdown();
  });

  /* Tip quick */
  $('#tipGroup')?.addEventListener('click', e=>{
    const b=e.target.closest('.subtab'); if(!b) return;
    $$('#tipGroup .subtab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const spec=b.getAttribute('data-tip');
    if(spec==='none'){ activeTip={kind:'none',amount:0}; updateCheckoutBreakdown(); return; }
    const [k,v]=spec.split(':');
    const {sub,disc}=computeTotals(); // disc uses old tip, but it‚Äôs fine for quick tip
    if(k==='percent'){ const base=Math.max(0, sub - (activePromo?.discount||0)); activeTip={kind:'percent',amount:base*(+v/100)}; }
    if(k==='amount'){ activeTip={kind:'amount',amount:+v}; }
    updateCheckoutBreakdown();
  });
  $('#tipApplyCustom')?.addEventListener('click', ()=>{
    const v = Math.max(0, +($('#tipCustomAmount').value||0));
    activeTip={kind:'amount',amount:v};
    $$('#tipGroup .subtab').forEach(x=>x.classList.remove('active'));
    updateCheckoutBreakdown();
  });

  /* Place order */
  $('#checkoutSubmit')?.addEventListener('click', async ()=>{
    const name = $('#checkoutName').value.trim();
    const loc  = $('#checkoutLocation').value.trim();
    const notes= $('#checkoutNotes').value.trim();
    if(!name || !loc){ $('#checkoutError').style.display='block'; return; }
    localStorage.setItem(PROFILE_NAME_KEY,name); localStorage.setItem(PROFILE_LOC_KEY,loc);

    // build order
    const lines=[]; let sub=0;
    for(const [n,info] of cart){ const line=info.price*info.qty; lines.push({name:n, price:info.price, qty:info.qty, line}); sub+=line; }
    const disc = activePromo?.discount||0;
    const tip  = Math.max(0, activeTip.amount||0);
    const total = Math.max(0, sub - disc) + tip;
    const order = {when:new Date().toISOString(), name, location:loc, notes, lines, total, discount:disc, tip};

    const list=loadOrders(); list.unshift(order); saveOrders(list);

    // optional webhook (IFTTT)
    await sendOrderWebhook(order);

    // clear cart & close
    cart.clear(); saveMap(CART_KEY, cart); renderCart();
    closeOverlay('#checkoutOverlay');
    toast('Order placed üéâ');
  });

  /* Settings close */
  $('#settingsClose')?.addEventListener('click', ()=>closeOverlay('#settingsOverlay'));

  /* Admin tabs top */
  document.addEventListener('click', (e)=>{
    if(e.target.closest('#tabGeneral')) switchTab('general');
    if(e.target.closest('#tabAdmin'))   switchTab('admin');
  });
  function switchTab(which){
    const tabG=$('#tabGeneral'), tabA=$('#tabAdmin'),
          panG=$('#panelGeneral'), panA=$('#panelAdmin');
    if(which==='admin'){
      tabG.classList.remove('active'); tabG.setAttribute('aria-selected','false');
      tabA.classList.add('active');    tabA.setAttribute('aria-selected','true');
      panG.style.display='none'; panA.style.display='block';
      ensureAdminLoginVisible();
    } else {
      tabA.classList.remove('active'); tabA.setAttribute('aria-selected','false');
      tabG.classList.add('active');    tabG.setAttribute('aria-selected','true');
      panA.style.display='none'; panG.style.display='block';
    }
  }

  /* Admin unlock + actions */
  $('#adminSubmit')?.addEventListener('click', ()=>{
    const ok = ($('#adminPassword').value||'')===ADMIN_PASSWORD;
    if(ok){ setUnlocked(true); $('#adminError').style.display='none'; ensureAdminLoginVisible(); }
    else { $('#adminError').style.display='block'; }
  });
  $('#historyClear')?.addEventListener('click', ()=>{ saveDelivered([]); renderHistory(); });

  /* Admin subtabs */
  document.addEventListener('click', (e)=>{
    const btn=e.target.closest('.subtab'); if(!btn) return;
    if(!btn.parentElement.classList.contains('admin-subtabs')) return;
    $$('.admin-subtabs .subtab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const id=btn.getAttribute('data-subtab');
    $('#subtab-orders').style.display    = (id==='orders')?'block':'none';
    $('#subtab-inventory').style.display = (id==='inventory')?'block':'none';
    $('#subtab-analytics').style.display = (id==='analytics')?'block':'none';
    $('#subtab-history').style.display   = (id==='history')?'block':'none';
    if(id==='orders') renderOrders();
    if(id==='inventory'){ renderInventory(); updateStockBadges(); }
    if(id==='history') renderHistory();
  });

  /* Inventory input changes */
  document.addEventListener('input', (e)=>{
    const row=e.target.closest('.field[data-prod]'); if(!row) return;
    const name=row.getAttribute('data-prod');
    if(e.target.matches('input[data-k="qty"]')){
      const v=(e.target.value||'').trim();
      if(v===''){ delete stockQty[name]; delete stockSet[name]; }
      else { stockQty[name]=Number(v); stockSet[name]=1; }
      saveObj(STOCK_QTY_KEY, stockQty); saveObj(STOCK_SET_KEY, stockSet);
      updateStockBadges(); refreshMiniIfOpen();
    }
    if(e.target.matches('input[data-k="low"]')){
      const v2=(e.target.value||'').trim();
      if(v2===''){ delete stockLow[name]; }
      else { stockLow[name]=Number(v2); }
      saveObj(STOCK_LOW_KEY, stockLow);
      updateStockBadges(); refreshMiniIfOpen();
    }
  });

  /* Order sheet open + deliver */
  document.addEventListener('click', e=>{
    const row=e.target.closest('.order-item'); if(!row) return;
    const idx=+row.getAttribute('data-idx');
    const orders=loadOrders(); const o=orders[idx]; if(!o) return;
    currentOrderIndex=idx;
    $('#orderMeta').textContent = `${new Date(o.when).toLocaleString()} ‚Ä¢ ${o.name} @ ${o.location}`;
    $('#orderLines').innerHTML = o.lines.map(l=>`<div class="row-between" style="padding:6px 0"><div>${l.name} √ó ${l.qty}</div><div style="font-weight:700">${fmt(l.line)}</div></div>`).join('');
    $('#orderTotal').textContent = fmt(o.total);
    // ensure on top of settings
    document.body.appendChild($('#orderSheet'));
    openOverlay('#orderSheet');
  });
  $('#orderClose')?.addEventListener('click', ()=>closeOverlay('#orderSheet'));
  $('#orderCancel')?.addEventListener('click', ()=>closeOverlay('#orderSheet'));
  $('#orderDelivered')?.addEventListener('click', ()=>{
    const idx=currentOrderIndex; if(idx==null) return;
    const active=loadOrders();
    if(idx>=0 && idx<active.length){
      const delivered=active.splice(idx,1)[0];
      delivered.deliveredWhen=new Date().toISOString();
      const hist=loadDelivered(); hist.unshift(delivered);
      saveDelivered(hist); saveOrders(active);
      renderOrders(); renderHistory();
    }
    closeOverlay('#orderSheet');
  });

  /* a11y: make all core buttons keyboard-clickable */
  $$('.btn,.add,.ghost,.primary,.tab,.subtab').forEach(el=>{
    el.tabIndex = el.tabIndex || 0;
    el.addEventListener('keydown', e=>{
      if(e.key==='Enter'||e.key===' '){ e.preventDefault(); el.click(); }
    });
  });

  /* initial draws */
  renderCart();
  refreshBadge();
  updateStockBadges();
  ensureAdminLoginVisible();
});
</script>
<script>
/* ===== Overlay UX helpers (click-outside & ESC to close) ===== */
(function(){
  const closers = new Map([
    ['#productSheet',  ()=>{ const el=document.querySelector('#productSheet .sheet'); return el; }],
    ['#cartOverlay',   ()=>{ const el=document.querySelector('#cartOverlay .sheet'); return el; }],
    ['#checkoutOverlay',()=>{ const el=document.querySelector('#checkoutOverlay .sheet'); return el; }],
    ['#settingsOverlay',()=>{ const el=document.querySelector('#settingsOverlay .sheet'); return el; }],
    ['#orderSheet',    ()=>{ const el=document.querySelector('#orderSheet .sheet'); return el; }]
  ]);

  // click outside to close
  document.addEventListener('mousedown', (e)=>{
    for(const [id, getSheet] of closers.entries()){
      const ov = document.querySelector(id);
      if(!ov || !ov.classList.contains('show')) continue;
      const sheet = getSheet();
      if(sheet && !sheet.contains(e.target) && !e.target.closest('[aria-label="Open cart"]') ){
        ov.classList.remove('show');
      }
    }
  });

  // ESC to close topmost shown overlay
  document.addEventListener('keydown', (e)=>{
    if(e.key!=='Escape') return;
    const open = ['#orderSheet','#checkoutOverlay','#cartOverlay','#settingsOverlay','#productSheet']
      .map(id=>document.querySelector(id))
      .filter(el=>el && el.classList.contains('show'));
    if(open.length){ open[0].classList.remove('show'); }
  });
})();

/* ===== Guard: show console error source clearly (no blank screens) ===== */
window.addEventListener('error', (ev)=>{
  try{
    const msg = (ev?.message||'Error') + (ev?.filename?` @ ${ev.filename}:${ev.lineno||''}`:'');
    console.warn('[FitSnacks]', msg);
  }catch{}
});
</script>
<script>
/* ===== Core selectors & small helpers (idempotent) ===== */
(function(){
  if (window.__fitsnacks_core_bound__) return; // prevent double-binding
  window.__fitsnacks_core_bound__ = true;

  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const fmt = n => '$' + (Number(n)||0).toFixed(2);

  /* ===== LocalStorage keys (soft read; don‚Äôt overwrite other chunks) ===== */
  const CART_KEY   = 'fitsnacks.cart.v1';
  const ORDERS_KEY = 'fitsnacks.orders';
  const UNLOCK_KEY = 'fitsnacks.admin.unlocked';

  /* ===== Cart state ===== */
  function loadCart(){
    try { return new Map(JSON.parse(localStorage.getItem(CART_KEY)||'[]')); }
    catch { return new Map(); }
  }
  function saveCart(map){
    try { localStorage.setItem(CART_KEY, JSON.stringify(Array.from(map.entries()))); }
    catch {}
  }
  let cart = loadCart();

  /* ===== Badge + totals + cart DOM render ===== */
  function refreshBadge(){
    let n=0; for (const v of cart.values()) n += (v?.qty||0);
    const badge = $('#cartBadge');
    if (!badge) return;
    if (n>0) { badge.style.display='inline-flex'; badge.textContent = n; }
    else { badge.style.display='none'; badge.textContent = '0'; }
  }

  function renderCart(){
    const box   = $('#cartContent');
    const total = $('#cartTotal');
    if (!box || !total) return;

    let html = '';
    let sum  = 0;

    for (const [name, info] of cart){
      const qty = Math.max(1, Number(info.qty||0));
      const pr  = Number(info.price||0);
      const line= pr * qty;
      sum += line;

      html += `
        <div class="row-between" style="margin-top:6px">
          <div style="display:flex;gap:10px;align-items:center">
            <button class="ghost" style="padding:4px 8px" data-act="-" data-name="${name}">‚àí</button>
            <div style="min-width:24px;text-align:center">${qty}</div>
            <button class="ghost" style="padding:4px 8px" data-act="+" data-name="${name}">+</button>
            <div style="font-weight:700;margin-left:8px">${name}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="ghost" style="padding:4px 8px" data-act="rm" data-name="${name}" title="Remove">‚úï</button>
            <div style="font-weight:700">${fmt(line)}</div>
          </div>
        </div>`;
    }

    if (!html){
      box.innerHTML = '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
      total.textContent = fmt(0);
    } else {
      box.innerHTML = html;
      total.textContent = fmt(sum);
    }

    saveCart(cart);
    refreshBadge();
  }

  /* ===== Open/close overlays ===== */
  function openCart(){ $('#cartOverlay')?.classList.add('show'); }
  function closeCart(){ $('#cartOverlay')?.classList.remove('show'); }
  function openCheckout(){ 
    // ensure totals reflect cart
    try {
      const sub = [...cart.values()].reduce((s, it)=>s + (Number(it.price||0)*Number(it.qty||0)), 0);
      $('#ckSub') && ($('#ckSub').textContent = fmt(sub));
      $('#ckDisc') && ($('#ckDisc').textContent = '-$0.00');
      $('#ckTip') && ($('#ckTip').textContent = '$0.00');
      $('#ckTotal') && ($('#ckTotal').textContent = fmt(sub));
    }catch{}
    $('#checkoutOverlay')?.classList.add('show');
  }
  function closeCheckout(){ $('#checkoutOverlay')?.classList.remove('show'); }
  function openSettings(defaultToAdmin=false){
    const el = $('#settingsOverlay'); if (!el) return;
    el.classList.add('show');
    switchTab(defaultToAdmin ? 'admin' : 'general');
  }
  function closeSettings(){ $('#settingsOverlay')?.classList.remove('show'); }
  function openProductSheetFor(cardEl){
    if(!cardEl) return;
    const name  = cardEl.dataset.name;
    const price = Number(cardEl.dataset.price||0);
    const img   = cardEl.dataset.img || '';
    const qEl = $('#qtyVal');
    $('#sheetTitle') && ($('#sheetTitle').textContent = name||'Item');
    const sImg = $('#sheetImg'); if(sImg){ sImg.src = img; sImg.alt = name||''; }
    $('#sheetPrice') && ($('#sheetPrice').textContent = fmt(price));
    if(qEl){ qEl.textContent = '1'; }
    $('#sheetAdd') && ($('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmt(price));
    $('#productSheet')?.classList.add('show');
    // keep a lightweight pointer for add action
    window.__fs_current = {name, price};
  }
  function closeProductSheet(){ $('#productSheet')?.classList.remove('show'); }

  /* ===== Safe switchTab (Admin/General) ===== */
  function switchTab(which){
    const tabG=$('#tabGeneral'), tabA=$('#tabAdmin'),
          panG=$('#panelGeneral'), panA=$('#panelAdmin');
    if(!tabG || !tabA || !panG || !panA) return;

    if(which==='admin'){
      tabG.classList.remove('active'); tabG.setAttribute('aria-selected','false');
      tabA.classList.add('active');    tabA.setAttribute('aria-selected','true');
      panG.style.display='none';       panA.style.display='block';
    }else{
      tabA.classList.remove('active'); tabA.setAttribute('aria-selected','false');
      tabG.classList.add('active');    tabG.setAttribute('aria-selected','true');
      panA.style.display='none';       panG.style.display='block';
    }
  }
  window.switchTab = window.switchTab || switchTab; // expose if not already

  /* ===== Global click delegation (buttons come alive) ===== */
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button, .add, .fav');
    if(!btn) return;

    // Header buttons
    if(btn.id === 'cartBtn')   { e.preventDefault(); openCart(); return; }
    if(btn.id === 'settingsBtn'){ e.preventDefault(); openSettings(false); return; }
    if(btn.id === 'cartBack')  { e.preventDefault(); closeCart(); return; }
    if(btn.id === 'settingsClose'){ e.preventDefault(); closeSettings(); return; }

    // Product card "+" opens mini sheet
    if(btn.classList.contains('add')){
      e.preventDefault();
      const card = btn.closest('.card');
      openProductSheetFor(card);
      return;
    }

    // Product mini sheet controls
    if(btn.id === 'qtyPlus'){
      e.preventDefault();
      const cur = Number(($('#qtyVal')?.textContent)||'1') + 1;
      $('#qtyVal') && ($('#qtyVal').textContent = Math.min(99, cur));
      const c = window.__fs_current; if(c && $('#sheetAdd')) $('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmt(c.price * Number($('#qtyVal').textContent));
      return;
    }
    if(btn.id === 'qtyMinus'){
      e.preventDefault();
      const cur = Math.max(1, Number(($('#qtyVal')?.textContent)||'1') - 1);
      $('#qtyVal') && ($('#qtyVal').textContent = cur);
      const c = window.__fs_current; if(c && $('#sheetAdd')) $('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmt(c.price * cur);
      return;
    }
    if(btn.id === 'sheetAdd'){
      e.preventDefault();
      const c = window.__fs_current; if(!c) return;
      const qty = Math.max(1, Number(($('#qtyVal')?.textContent)||'1'));
      const entry = cart.get(c.name) || {price:c.price, qty:0};
      entry.qty += qty;
      cart.set(c.name, entry);
      saveCart(cart);
      refreshBadge();
      renderCart();
      closeProductSheet();
      openCart();
      return;
    }
    if(btn.id === 'sheetClose'){ e.preventDefault(); closeProductSheet(); return; }

    // Cart +/-/remove
    if(btn.hasAttribute('data-act') && btn.hasAttribute('data-name')){
      e.preventDefault();
      const act  = btn.getAttribute('data-act');
      const name = btn.getAttribute('data-name');
      const entry= cart.get(name);
      if(!entry){ renderCart(); return; }

      if(act === '+') entry.qty = Math.min(99, Number(entry.qty||0) + 1);
      if(act === '-') entry.qty = Math.max(1,  Number(entry.qty||0) - 1);
      if(act === 'rm'){ cart.delete(name); renderCart(); saveCart(cart); refreshBadge(); return; }

      cart.set(name, entry);
      saveCart(cart);
      renderCart();
      return;
    }

    // Cart -> Checkout
    if(btn.id === 'cartCheckout'){
      e.preventDefault();
      if(cart.size === 0){ // no items
        openCart();
        return;
      }
      closeCart();
      openCheckout();
      return;
    }

    // Checkout close
    if(btn.id === 'checkoutClose'){
      e.preventDefault();
      closeCheckout();
      return;
    }

    // Settings tabs
    if(btn.id === 'tabGeneral'){ e.preventDefault(); switchTab('general'); return; }
    if(btn.id === 'tabAdmin')  { e.preventDefault(); switchTab('admin');   return; }

    // Favorites (star)
    if(btn.classList.contains('fav')){
      e.preventDefault();
      btn.classList.toggle('active');
      return;
    }
  });

  /* ===== Card click opens mini sheet (but ignore when clicking .add or .fav) ===== */
  document.addEventListener('click', (e)=>{
    const card = e.target.closest('.card');
    if(!card) return;
    if(e.target.closest('.add') || e.target.closest('.fav')) return;
    // Allow tapping the image/title/price to open
    if(card.contains(e.target)){ openProductSheetFor(card); }
  });

  /* ===== Search filter (show empty state when no results) ===== */
  const searchInput = $('#search');
  if (searchInput){
    searchInput.addEventListener('input', (e)=>{
      const q = (e.target.value||'').toLowerCase().trim();
      let shown = 0;
      $$('.card').forEach(c=>{
        const hit = (c.dataset.name||'').toLowerCase().includes(q) || (c.dataset.tags||'').toLowerCase().includes(q);
        c.style.display = hit ? '' : 'none';
        if(hit) shown++;
      });
      let empty = $('#searchEmpty');
      if(!empty){
        empty = document.createElement('div');
        empty.id='searchEmpty';
        empty.style.cssText='color:#aaa;margin:8px 2px;display:none';
        empty.textContent='No results found';
        const grid = $('#grid');
        grid && grid.parentNode.insertBefore(empty, grid);
      }
      empty.style.display = shown ? 'none' : 'block';
    });
  }

  /* ===== Safe init on load ===== */
  document.addEventListener('DOMContentLoaded', ()=>{
    refreshBadge();
    renderCart();
  });

  // Expose minimal API some earlier chunks might call
  window.__fs_renderCart   = renderCart;
  window.__fs_refreshBadge = refreshBadge;
  window.__fs_openSettings = openSettings;
})();
</script>
<script>
(function(){
  if (window.__fitsnacks_orders_bound__) return;
  window.__fitsnacks_orders_bound__ = true;

  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const fmt = n => '$' + (Number(n)||0).toFixed(2);

  const ORDERS_KEY   = 'fitsnacks.orders';
  const DELIVERED_KEY= 'fitsnacks.orders.delivered';

  function loadArr(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch{ return []; } }
  function saveArr(k,a){ try{ localStorage.setItem(k, JSON.stringify(a||[])); }catch{} }

  function loadOrders(){ return loadArr(ORDERS_KEY); }
  function saveOrders(v){ saveArr(ORDERS_KEY, v); }
  function loadDelivered(){ return loadArr(DELIVERED_KEY); }
  function saveDelivered(v){ saveArr(DELIVERED_KEY, v); }

  /* ===== Orders rendering ===== */
  function renderOrders(){
    const list = loadOrders();
    const box = $('#ordersList');
    if(!box) return;
    if(!list.length){ box.innerHTML = 'No orders yet'; return; }

    box.innerHTML = list.map((o,i)=>{
      const items = o.lines.map(l=>`${l.name} √ó ${l.qty} -- ${fmt(l.line)}`).join('<br>');
      const when  = new Date(o.when).toLocaleString();
      return `<div class="order-item" data-idx="${i}" role="button" tabindex="0"
                 style="padding:8px;border-bottom:1px solid #2a2a30;cursor:pointer">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
                  <div>
                    <div style="font-weight:700">${when}</div>
                    <div style="color:#bbb;margin-top:4px">${o.name} @ ${o.location}</div>
                  </div>
                  <div style="font-weight:700">${fmt(o.total)}</div>
                </div>
                <div style="margin-top:6px">${items}</div>
                ${o.notes?`<div style="margin-top:6px;color:#c7c7cc;font-size:12px">üìù ${o.notes}</div>`:''}
              </div>`;
    }).join('');
  }
  window.__fs_renderOrders = renderOrders;

  function renderHistory(){
    const list = loadDelivered();
    const box = $('#historyList');
    if(!box) return;
    if(!list.length){ box.textContent = 'No delivered orders'; return; }

    box.innerHTML = list.map(o=>{
      const items=o.lines.map(l=>`${l.name} √ó ${l.qty} -- ${fmt(l.line)}`).join('<br>');
      const placed=new Date(o.when).toLocaleString();
      const del=o.deliveredWhen?new Date(o.deliveredWhen).toLocaleString():'--';
      return `<div style="padding:8px;border-bottom:1px solid #2a2a30">
        <div style="font-weight:700">Delivered: ${del}</div>
        <div style="color:#bbb;margin-top:2px">Placed: ${placed}</div>
        <div style="color:#bbb;margin-top:2px">${o.name} @ ${o.location}</div>
        <div style="margin-top:6px">${items}</div>
        ${o.notes?`<div style="margin-top:6px;color:#c7c7cc;font-size:12px">üìù ${o.notes}</div>`:''}
      </div>`;
    }).join('');
  }
  window.__fs_renderHistory = renderHistory;

  /* ===== Checkout submit ‚Üí add order ===== */
  function addOrderFromCart(name, location, notes){
    const cart = new Map(JSON.parse(localStorage.getItem('fitsnacks.cart.v1')||'[]'));
    const lines = [];
    let total=0;
    for(const [n,info] of cart){
      const line=info.price*info.qty;
      lines.push({name:n, price:info.price, qty:info.qty, line});
      total += line;
    }
    const order={when:new Date().toISOString(), name, location, notes, lines, total};
    const orders=loadOrders();
    orders.unshift(order);
    saveOrders(orders);
    return order;
  }

  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('button');
    if(!btn) return;

    if(btn.id==='checkoutSubmit'){
      e.preventDefault();
      const name=$('#checkoutName')?.value.trim();
      const loc =$('#checkoutLocation')?.value.trim();
      const notes=$('#checkoutNotes')?.value.trim();
      if(!name||!loc){
        $('#checkoutError').style.display='block';
        return;
      }
      $('#checkoutError').style.display='none';
      const order=addOrderFromCart(name, loc, notes);

      // clear cart
      localStorage.setItem('fitsnacks.cart.v1','[]');
      window.__fs_renderCart && window.__fs_renderCart();

      // save & refresh
      renderOrders();

      // close overlay
      $('#checkoutOverlay')?.classList.remove('show');
      alert('Order placed üéâ');
    }

    if(btn.id==='historyClear'){
      saveDelivered([]);
      renderHistory();
    }
  });

  // Init render on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', ()=>{
    renderOrders();
    renderHistory();
  });
})();
</script>
<script>
(function(){
  if (window.__fitsnacks_order_sheet_bound__) return;
  window.__fitsnacks_order_sheet_bound__ = true;

  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const fmt = n => '$' + (Number(n)||0).toFixed(2);

  const ORDERS_KEY    = 'fitsnacks.orders';
  const DELIVERED_KEY = 'fitsnacks.orders.delivered';

  function loadArr(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch{ return []; } }
  function saveArr(k,a){ try{ localStorage.setItem(k, JSON.stringify(a||[])); }catch{} }
  function loadOrders(){ return loadArr(ORDERS_KEY); }
  function saveOrders(v){ saveArr(ORDERS_KEY, v); }
  function loadDelivered(){ return loadArr(DELIVERED_KEY); }
  function saveDelivered(v){ saveArr(DELIVERED_KEY, v); }

  let currentOrderIndex = null;

  function openOrderSheet(idx){
    const orders = loadOrders();
    const o = orders[idx];
    if(!o) return;

    currentOrderIndex = idx;

    // Fill content
    $('#orderMeta')  && ($('#orderMeta').textContent =
      `${new Date(o.when).toLocaleString()} ‚Ä¢ ${o.name} @ ${o.location}`);
    $('#orderLines') && ($('#orderLines').innerHTML =
      o.lines.map(l=>`<div class="row-between" style="padding:6px 0">
                        <div>${l.name} √ó ${l.qty}</div>
                        <div style="font-weight:700">${fmt(l.line)}</div>
                      </div>`).join(''));
    $('#orderTotal') && ($('#orderTotal').textContent = fmt(o.total));

    // Make sure it renders above Settings
    const sheet = $('#orderSheet');
    if(sheet){
      document.body.appendChild(sheet);  // lift to <body> top
      sheet.classList.add('show');
      $('#orderClose')?.focus();
    }
  }

  function closeOrderSheet(){
    $('#orderSheet')?.classList.remove('show');
    currentOrderIndex = null;
  }

  // Click an order row ‚Üí open mini-sheet
  document.addEventListener('click', (e)=>{
    const row = e.target.closest('.order-item');
    if(!row) return;
    const idx = Number(row.getAttribute('data-idx'));
    if(Number.isFinite(idx)) openOrderSheet(idx);
  });

  // Keyboard open (Enter/Space) on focused row
  document.addEventListener('keydown', (e)=>{
    if(e.key!=='Enter' && e.key!==' ') return;
    const row = e.target.closest('.order-item');
    if(!row) return;
    e.preventDefault();
    const idx = Number(row.getAttribute('data-idx'));
    if(Number.isFinite(idx)) openOrderSheet(idx);
  });

  // Mini-sheet buttons
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;

    if(btn.id === 'orderClose' || btn.id === 'orderCancel'){
      e.preventDefault();
      closeOrderSheet();
      return;
    }

    if(btn.id === 'orderDelivered'){
      e.preventDefault();
      if(currentOrderIndex==null) return;

      const active = loadOrders();
      if(currentOrderIndex < 0 || currentOrderIndex >= active.length) { closeOrderSheet(); return; }

      const delivered = active.splice(currentOrderIndex, 1)[0];
      delivered.deliveredWhen = new Date().toISOString();

      const history = loadDelivered();
      history.unshift(delivered);

      saveOrders(active);
      saveDelivered(history);

      // Re-render lists if helper hooks exist (from Chunk 6)
      window.__fs_renderOrders && window.__fs_renderOrders();
      window.__fs_renderHistory && window.__fs_renderHistory();

      closeOrderSheet();
    }
  });

  // Ensure Order sheet always has highest stacking context
  document.addEventListener('DOMContentLoaded', ()=>{
    const os = $('#orderSheet');
    if(os){ os.style.zIndex = '10050'; }
  });
})();
</script>
<script>
(function(){
  if (window.__fitsnacks_polish_bound__) return;
  window.__fitsnacks_polish_bound__ = true;

  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

  /* ===== Admin tabs fix ===== */
  document.addEventListener('click', (e)=>{
    const btn=e.target.closest('#tabGeneral, #tabAdmin');
    if(!btn) return;
    e.preventDefault();

    const tabGeneral=$('#tabGeneral'), tabAdmin=$('#tabAdmin');
    const panGeneral=$('#panelGeneral'), panAdmin=$('#panelAdmin');

    if(btn.id==='tabGeneral'){
      tabGeneral.classList.add('active'); tabGeneral.setAttribute('aria-selected','true');
      tabAdmin.classList.remove('active'); tabAdmin.setAttribute('aria-selected','false');
      panGeneral.style.display='block'; panAdmin.style.display='none';
    }
    if(btn.id==='tabAdmin'){
      tabAdmin.classList.add('active'); tabAdmin.setAttribute('aria-selected','true');
      tabGeneral.classList.remove('active'); tabGeneral.setAttribute('aria-selected','false');
      panAdmin.style.display='block'; panGeneral.style.display='none';
    }
  });

  /* ===== Search empty feedback ===== */
  const searchInput = $('#search');
  if(searchInput){
    searchInput.addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase();
      const cards = $$('.card');
      let matches = 0;
      cards.forEach(c=>{
        const ok = c.dataset.name.toLowerCase().includes(q);
        c.style.display = ok ? '' : 'none';
        if(ok) matches++;
      });
      let emptyMsg = $('#searchEmptyMsg');
      if(!emptyMsg){
        emptyMsg=document.createElement('div');
        emptyMsg.id='searchEmptyMsg';
        emptyMsg.style.color='#aaa';
        emptyMsg.style.marginTop='10px';
        searchInput.parentElement.appendChild(emptyMsg);
      }
      emptyMsg.textContent = matches? '' : 'No results found';
    });
  }

  /* ===== Overlay universal close with Esc ===== */
  document.addEventListener('keydown', (e)=>{
    if(e.key!=='Escape') return;
    const overlays=['#orderSheet','#checkoutOverlay','#cartOverlay','#settingsOverlay','#productSheet']
      .map(id=>$(id)).filter(el=>el && el.classList.contains('show'));
    if(overlays.length){
      overlays[0].classList.remove('show');
    }
  });
})();
</script>