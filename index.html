<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>FitSnacks</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0d">

  <!-- Prefetch carousel images -->
  <link rel="preload" as="image" href="assets/carousel-1.jpg">
  <link rel="preload" as="image" href="assets/carousel-2.jpg">
  <link rel="preload" as="image" href="assets/carousel-3.jpg">

  <style>
    :root{
      --bg:#0b0b0d; --card:rgba(20,20,24,0.6); --text:#e9e9ec; --muted:#a9a9b1;
      --accent:#6ea8fe; --good:#3cd27f; --warn:#ffb020; --badge:#ff3b30;
      --radius:18px; --blur:18px; --snap-gap:12px;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    .app{max-width:393px;min-height:100svh;margin:0 auto;padding:12px 12px 64px;box-sizing:border-box}

    /* Glass */
    .card,.sheet,.btn,.search,.chip,.tab,.ghost,.primary,.field{
      -webkit-backdrop-filter:blur(var(--blur));backdrop-filter:blur(var(--blur));
      background:var(--card);border:1px solid rgba(255,255,255,.08);
      box-shadow:0 4px 24px rgba(0,0,0,.18);
    }

    /* Header */
    .row{display:flex;align-items:center;gap:12px;position:relative}
    .search-wrap{flex:0 0 160px;min-width:0}
    .search{width:100%;border-radius:999px;padding:12px 44px 12px 36px;color:var(--text);outline:0;border:1px solid #2a2a2e}
    .search::placeholder{color:#6c6c70}
    .icon-left{position:absolute;left:12px;top:50%;transform:translateY(-50%);pointer-events:none}
    .icon-rights{ margin-left:auto;display:flex;gap:10px;flex-shrink:0; position:relative;z-index:10060; }
    .btn{border-radius:14px;width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    #cartBtn,#settingsBtn{position:relative;z-index:10060!important}
    #cartBtn .badge{position:absolute;top:-6px;right:-8px;background:var(--badge);color:#fff;border-radius:999px;padding:1px 6px;font-size:12px;font-weight:700;display:none}

    .greet{margin:8px 2px 2px;color:#c7c7cc;font-size:14px}

    /* Carousel */
    .carousel{margin:10px 0 6px;position:relative;z-index:1}
    .snapper{height:100px;display:flex;align-items:stretch;gap:var(--snap-gap);overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding:0 var(--snap-gap)}
    .snapper::-webkit-scrollbar{display:none}
    .snap-spacer{flex:0 0 7.5%}
    .snap-card{position:relative;flex:0 0 85%;scroll-snap-align:center;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center}
    .banner{width:100%;height:100%;object-fit:cover}
    .snap-meta{position:absolute;left:10px;bottom:8px;right:10px;display:flex;justify-content:space-between;gap:8px;pointer-events:none}
    .snap-title{font-weight:800;text-shadow:0 1px 6px rgba(0,0,0,.6)}
    .snap-cta{pointer-events:auto}
    .snap-dots{display:flex;justify-content:center;gap:6px;margin-top:6px}
    .snap-dot{width:6px;height:6px;border-radius:999px;background:#2c3447;border:1px solid rgba(255,255,255,.18)}
    .snap-dot.active{background:#7fb1ff}

    /* Chips */
    .chips{display:flex;gap:10px;margin:6px 0 12px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
    .chip.active{outline:2px solid rgba(110,168,254,.5)}

    /* Grid */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{border-radius:16px;padding:10px;position:relative;display:flex;flex-direction:column;min-height:190px}
    .thumb{height:90px;border-radius:12px;overflow:hidden;margin-bottom:8px;display:flex;align-items:center;justify-content:center;background:#0e0e12}
    .thumb img{width:100%;height:100%;object-fit:contain}
    .title{font-weight:700;margin:4px 0 2px}
    .price{color:#c7c7cc;font-weight:600;margin-top:auto}
    .add{position:absolute;right:10px;bottom:10px;background:var(--accent);border:0;color:#001230;border-radius:14px;width:42px;height:42px;font-size:22px;display:flex;align-items:center;justify-content:center;font-weight:800;cursor:pointer}
    .fav{position:absolute;right:10px;top:10px;width:36px;height:36px;border-radius:12px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);cursor:pointer}
    .fav.active{background:rgba(255,215,0,.15);box-shadow:0 0 0 1px rgba(255,215,0,.35) inset}

    /* Overlays */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px;z-index:9990}
    .overlay.show{display:flex}
    .sheet{width:92%;max-width:480px;border-radius:20px;padding:16px}
    #cartOverlay,#checkoutOverlay,#settingsOverlay,#orderSheet,#productSheet{align-items:flex-end}
    #cartOverlay .sheet,#checkoutOverlay .sheet,#settingsOverlay .sheet,#orderSheet .sheet,#productSheet .sheet{
      width:100%;border-top-left-radius:24px;border-top-right-radius:24px;border-bottom-left-radius:0;border-bottom-right-radius:0;
      padding-bottom:calc(16px + env(safe-area-inset-bottom));
      transform:translateY(100%);animation:slideUp 220ms ease-out forwards;
      -webkit-transform:translateY(100%);-webkit-animation:slideUp 220ms ease-out forwards;
      will-change: transform;
    }
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    /* iOS/Safari fallback: ensure sheet appears even if animation is skipped */
    .overlay.show .sheet { transform: translateY(0) !important; -webkit-transform: translateY(0) !important; }
    @-webkit-keyframes slideUp { from { -webkit-transform: translateY(100%); } to { -webkit-transform: translateY(0); } }

    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .qty{display:flex;align-items:center;gap:10px}
    .qty button{width:36px;height:36px;border-radius:10px;border:1px solid #2a2a30;background:#1c1c22;color:var(--text);font-size:20px;font-weight:700}
    .primary{background:var(--accent);border:0;color:#081425;font-weight:800;border-radius:12px;padding:12px 14px}
    .ghost{border:1px solid #2a2a30;color:#e7e7eb;border-radius:12px;padding:10px 12px;background:#1b1b20}
    .actions{display:flex;gap:10px;margin-top:12px}

    /* Admin */
    .tabs{display:flex;gap:8px;margin:6px 0 12px}
    .tab{padding:8px 10px;border-radius:10px;cursor:pointer;border:1px solid #2a2a30;background:#18181d}
    .tab.active{background:#24242a}
    .sheet-body{max-height:70svh;overflow:auto;padding-right:4px}
    .admin-subtabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
    .subtab{padding:6px 10px;border-radius:10px;cursor:pointer;border:1px solid #2a2a30;background:#18181d;font-size:13px}
    .subtab.active{background:#24242a}
    .admin-list{border:1px solid #2a2a30;border-radius:12px;padding:8px;margin-top:8px}

    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1)}
    .kpi .label{color:#c7c7cc;font-size:12px}
    .kpi .value{font-weight:800;font-size:18px;margin-top:4px}
    .table{margin-top:8px;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
    .rowh,.rowd{display:grid;grid-template-columns:1fr 70px 70px 70px;gap:8px;padding:8px}
    .rowh{background:rgba(255,255,255,.05);font-weight:700}
    .rowd{border-top:1px solid rgba(255,255,255,.06)}

    /* Heat map cells */
    #heatGridHM .heat-cell{width:12px;height:12px;display:inline-block;margin:1px;border-radius:3px}

    /* Sticky cart bar */
    #cartBar{
      position:fixed;left:12px;right:12px;bottom:12px;display:none;align-items:center;justify-content:space-between;
      gap:10px;padding:10px 12px;border-radius:14px;z-index:1000;
      -webkit-backdrop-filter:blur(var(--blur));backdrop-filter:blur(var(--blur));
      background:rgba(20,20,24,0.7);border:1px solid rgba(255,255,255,.08);
      box-shadow:0 6px 24px rgba(0,0,0,.25);
    }
    #cartBar.show{display:flex}

    /* Toasts */
    #toastHost{position:fixed;left:0;right:0;bottom:calc(16px + env(safe-area-inset-bottom));display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;z-index:11000}
    .toast{pointer-events:auto;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:rgba(24,24,32,.9);font-weight:600;opacity:0;transform:translateY(8px);transition:opacity .22s ease,transform .22s ease}
    .toast.show{opacity:1;transform:translateY(0)}

    /* Z fix: detail sheet above settings */
    #settingsOverlay{ z-index: 10000; }
    #orderSheet{ z-index: 10050; }

    /* Reduced motion safety */
    @media (prefers-reduced-motion: reduce) {
      .overlay .sheet { animation: none !important; -webkit-animation: none !important; transform: translateY(0) !important; -webkit-transform: translateY(0) !important; }
    }
  </style>
</head>
<body>
  <div class="app" role="application">
    <!-- Header -->
    <div class="row">
      <div class="search-wrap">
        <span class="icon-left" aria-hidden="true">üîç</span>
        <input id="search" class="search" placeholder="Search snacks‚Ä¶" autocomplete="off">
      </div>
      <div class="icon-rights">
        <button type="button" class="btn" id="cartBtn" aria-label="Open cart">
          üõí <span id="cartBadge" class="badge">0</span>
        </button>
        <button type="button" class="btn" id="settingsBtn" aria-label="Open settings">‚öôÔ∏è</button>
      </div>
    </div>

    <!-- Greeting -->
    <div id="greet" class="greet">Welcome üëã</div>

    <!-- Promo carousel -->
    <div class="carousel" aria-label="Promotions">
      <div id="snapper" class="snapper" aria-roledescription="carousel">
        <div class="snap-spacer" aria-hidden="true"></div>
        <!-- JS injects promo cards here -->
        <div class="snap-spacer" aria-hidden="true"></div>
      </div>
      <div id="snapDots" class="snap-dots" aria-hidden="true"></div>
    </div>

    <!-- Chips -->
    <div class="chips" id="chips">
      <div class="chip" data-filter="">all</div>
      <div class="chip" data-filter="vegan">vegan</div>
      <div class="chip" data-filter="gluten-free">gluten-free</div>
      <div class="chip" data-filter="protein">protein</div>
      <div class="chip" data-filter="favorites">favorites</div>
      <div class="chip" data-filter="stock">stock</div>
    </div>

    <!-- Products Grid -->
    <div id="grid" class="grid" role="list">
      <!-- Product 1 -->
      <div class="card" role="listitem" data-name="Potato Chips" data-price="2.50" data-img="assets/product-funyuns.jpg" data-tags="snack">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-funyuns.jpg" alt="Potato Chips" loading="lazy"></div>
        <div class="title">Potato Chips</div>
        <div class="price">$2.50</div>
        <button class="add" aria-label="Add Potato Chips">+</button>
      </div>
      <!-- Product 2 -->
      <div class="card" role="listitem" data-name="Protein Bar" data-price="2.99" data-img="assets/product-chesters.jpg" data-tags="protein">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-chesters.jpg" alt="Protein Bar" loading="lazy"></div>
        <div class="title">Protein Bar</div>
        <div class="price">$2.99</div>
        <button class="add" aria-label="Add Protein Bar">+</button>
      </div>
      <!-- Product 3 -->
      <div class="card" role="listitem" data-name="Trail Mix" data-price="3.49" data-img="assets/product-cheetos.jpg" data-tags="vegan,gluten-free">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-cheetos.jpg" alt="Trail Mix" loading="lazy"></div>
        <div class="title">Trail Mix</div>
        <div class="price">$3.49</div>
        <button class="add" aria-label="Add Trail Mix">+</button>
      </div>
      <!-- Product 4 -->
      <div class="card" role="listitem" data-name="Granola Bar" data-price="1.99" data-img="assets/product-granola.jpg" data-tags="vegan,protein">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-granola.jpg" alt="Granola Bar" loading="lazy"></div>
        <div class="title">Granola Bar</div>
        <div class="price">$1.99</div>
        <button class="add" aria-label="Add Granola Bar">+</button>
      </div>
      <!-- Product 5 -->
      <div class="card" role="listitem" data-name="Doritos Flamin‚Äô Hot Nacho" data-price="2.00" data-img="assets/product-doritos.jpg" data-tags="snack">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-doritos.jpg" alt="Doritos Flamin‚Äô Hot Nacho" loading="lazy"></div>
        <div class="title">Doritos Flamin‚Äô Hot Nacho</div>
        <div class="price">$2.00</div>
        <button class="add" aria-label="Add Doritos Flamin‚Äô Hot Nacho">+</button>
      </div>
      <!-- Product 6 -->
      <div class="card" role="listitem" data-name="Greek Yogurt" data-price="2.00" data-img="assets/greek-yogurt.jpeg" data-tags="protein">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb">
          <img
            src="assets/greek-yogurt.jpeg?v=3"
            alt="Greek Yogurt"
            loading="lazy"
            onerror="if(!this.__triedJPG){this.__triedJPG=1;this.src='assets/greek-yogurt.jpg?v=3';}else{this.src='assets/product-yogurt.jpg';}"
          >
        </div>
        <div class="title">Greek Yogurt</div>
        <div class="price">$2.00</div>
        <button class="add" aria-label="Add Greek Yogurt">+</button>
      </div>
      <!-- Product 7 -->
      <div class="card" role="listitem" data-name="Mixed Nuts" data-price="3.20" data-img="assets/product-nuts.jpg" data-tags="vegan,protein">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-nuts.jpg" alt="Mixed Nuts" loading="lazy"></div>
        <div class="title">Mixed Nuts</div>
        <div class="price">$3.20</div>
        <button class="add" aria-label="Add Mixed Nuts">+</button>
      </div>
      <!-- Product 8 -->
      <div class="card" role="listitem" data-name="Fruit Cup" data-price="2.19" data-img="assets/product-fruit.jpg" data-tags="vegan,gluten-free">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-fruit.jpg" alt="Fruit Cup" loading="lazy"></div>
        <div class="title">Fruit Cup</div>
        <div class="price">$2.19</div>
        <button class="add" aria-label="Add Fruit Cup">+</button>
      </div>
      <!-- Product 9 -->
      <div class="card" role="listitem" data-name="Energy Drink" data-price="2.99" data-img="assets/product-energy.jpg" data-tags="snack">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-energy.jpg" alt="Energy Drink" loading="lazy"></div>
        <div class="title">Energy Drink</div>
        <div class="price">$2.99</div>
        <button class="add" aria-label="Add Energy Drink">+</button>
      </div>
      <!-- Product 10 -->
      <div class="card" role="listitem" data-name="Chocolate Bar" data-price="1.75" data-img="assets/product-chocolate.jpg" data-tags="snack">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-chocolate.jpg" alt="Chocolate Bar" loading="lazy"></div>
        <div class="title">Chocolate Bar</div>
        <div class="price">$1.75</div>
        <button class="add" aria-label="Add Chocolate Bar">+</button>
      </div>
    </div>

    <!-- Product mini sheet -->
    <div id="productSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Add item">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3 id="sheetTitle">Item</h3>
          <button class="ghost" id="sheetClose" type="button">Close</button>
        </div>
        <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
          <div style="width:88px;height:88px;border-radius:12px;overflow:hidden;border:1px solid #2a2a30;">
            <img id="sheetImg" alt="" style="width:100%;height:100%;object-fit:cover">
          </div>
          <div style="flex:1">
            <div id="sheetPrice" class="price" style="font-size:18px;"></div>
            <div id="sheetStock" style="margin-top:6px;color:#c7c7cc;font-size:13px;">Stock: --</div>
            <div id="sheetLowWarn" style="display:none;margin-top:6px;color:#ff6b6b;font-weight:600;font-size:13px;">Low stock</div>
          </div>
        </div>
        <div class="row-between" style="margin-top:10px;">
          <div class="qty">
            <button id="qtyMinus" type="button">‚àí</button>
            <div id="qtyVal" aria-live="polite">1</div>
            <button id="qtyPlus" type="button">+</button>
          </div>
          <button class="primary" id="sheetAdd" type="button">Add</button>
        </div>
      </div>
    </div>

    <!-- Order details sheet -->
    <div id="orderSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Order details">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Order</h3>
          <button class="ghost" id="orderClose" type="button">Close</button>
        </div>
        <div id="orderMeta" style="margin-top:6px;color:#c7c7cc;font-size:13px">‚Äì</div>
        <div id="orderLines" class="admin-list" style="margin-top:8px">‚Äì</div>
        <div class="row-between" style="margin-top:10px;">
          <strong>Total</strong><strong id="orderTotal">$0.00</strong>
        </div>
        <div class="actions" style="margin-top:12px;">
          <button class="ghost" id="orderCancel" type="button">Cancel</button>
          <button class="primary" id="orderDelivered" type="button">Mark Delivered</button>
        </div>
      </div>
    </div>

    <!-- Cart -->
    <div id="cartOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Cart">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Cart</h3>
          <button class="ghost" id="cartBack" type="button">Back</button>
        </div>
        <div id="cartContent" class="sheet-body">Cart is empty</div>
        <div class="row-between" style="margin-top:10px;">
          <strong>Total</strong><strong id="cartTotal">$0.00</strong>
        </div>
        <div class="actions">
          <button class="ghost" id="reorderLast" type="button">Re-order last</button>
          <button class="primary" id="cartCheckout" type="button">Checkout</button>
        </div>
      </div>
    </div>

    <!-- Checkout -->
    <div id="checkoutOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Checkout">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Checkout</h3>
          <button class="ghost" id="checkoutClose" type="button">Close</button>
        </div>
        <div class="sheet-body">
          <div style="margin-top:6px;">Your name:</div>
          <input id="checkoutName" class="field" style="width:100%;padding:10px;border-radius:10px">
          <div style="margin-top:10px;">Where are you on campus?</div>
          <input id="checkoutLocation" class="field" style="width:100%;padding:10px;border-radius:10px">

          <div style="margin-top:12px;">Promo code</div>
          <input id="checkoutPromo" class="field" style="width:100%;padding:10px;border-radius:10px" placeholder="e.g. SAVE10 or OFF2">
          <div id="promoStatus" style="margin-top:6px;color:#aaa;font-size:13px"></div>

          <div style="margin-top:12px;">Tip (optional)</div>
          <div id="tipGroup">
            <button class="ghost tip-btn" data-tip="none" type="button">No tip</button>
            <button class="ghost tip-btn" data-tip="amount:1" type="button">$1</button>
            <button class="ghost tip-btn" data-tip="amount:2" type="button">$2</button>
            <button class="ghost tip-btn" data-tip="percent:10" type="button">10%</button>
          </div>

          <div class="breakdown" style="margin-top:12px">
            <div class="break-row"><div class="muted">Subtotal</div><div id="ckSub">$0.00</div></div>
            <div class="break-row"><div class="muted">Discount</div><div id="ckDisc">-$0.00</div></div>
            <div class="break-row"><div class="muted">Tip</div><div id="ckTip">$0.00</div></div>
            <div class="break-row" style="font-weight:800"><div>Total</div><div id="ckTotal">$0.00</div></div>
          </div>

          <div id="checkoutError" style="display:none;color:#ff6b6b;margin-top:10px;">Please fill both fields.</div>
        </div>
        <div class="actions" style="margin-top:12px;">
          <button class="primary" id="checkoutSubmit" type="button">Place Order</button>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div id="settingsOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Settings">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Settings</h3>
          <button class="ghost" id="settingsClose" type="button">Close</button>
        </div>
        <div class="tabs" role="tablist" aria-label="Settings Tabs">
          <button id="tabGeneral" class="tab active" role="tab" aria-selected="true" aria-controls="panelGeneral" type="button">General</button>
          <button id="tabAdmin" class="tab" role="tab" aria-selected="false" aria-controls="panelAdmin" type="button">Admin</button>
        </div>
        <div class="sheet-body">
          <!-- General -->
          <div id="panelGeneral" role="tabpanel" aria-labelledby="tabGeneral">
            <div class="ghost" aria-disabled="true">Dark Mode (disabled)</div>
            <div class="ghost" aria-disabled="true">Notifications (disabled)</div>
          </div>
          <!-- Admin -->
          <div id="panelAdmin" role="tabpanel" aria-labelledby="tabAdmin" style="display:none">
            <div id="adminLogin">
              <div style="margin-top:6px;">Admin password:</div>
              <input id="adminPassword" type="password" class="field" style="width:100%;padding:10px;border-radius:10px">
              <div id="adminError" style="display:none;color:#ff6b6b;margin-top:6px;">Wrong password.</div>
              <div class="actions" style="margin-top:12px;">
                <button class="primary" id="adminSubmit" type="button">Unlock</button>
              </div>
            </div>
            <div id="adminContent" style="display:none">
              <div class="admin-subtabs">
                <button class="subtab active" data-subtab="orders" type="button">Orders</button>
                <button class="subtab" data-subtab="inventory" type="button">Inventory</button>
                <button class="subtab" data-subtab="analytics" type="button">Analytics</button>
                <button class="subtab" data-subtab="heat" type="button">Heat Map</button>
                <button class="subtab" data-subtab="history" type="button">History</button>
              </div>
              <div id="subtab-orders"> <div id="ordersList" class="admin-list">No orders yet</div></div>
              <div id="subtab-inventory" style="display:none"><div id="inventoryList" class="admin-list">Loading‚Ä¶</div></div>
              <div id="subtab-analytics" style="display:none">
                <div class="kpis" style="margin-top:8px">
                  <div class="kpi"><div class="label">Revenue</div><div id="kpiRevenue" class="value">$0.00</div></div>
                  <div class="kpi"><div class="label">Orders</div><div id="kpiOrders" class="value">0</div></div>
                  <div class="kpi"><div class="label">AOV</div><div id="kpiAOV" class="value">$0.00</div></div>
                  <div class="kpi"><div class="label">Items</div><div id="kpiItems" class="value">0</div></div>
                </div>
                <svg id="revSpark" class="spark" viewBox="0 0 100 40" preserveAspectRatio="none"></svg>
                <div id="topProducts"></div>
              </div>
              <div id="subtab-heat" style="display:none"><div id="heatGridHM"></div></div>
              <div id="subtab-history" style="display:none">
                <div id="historyList" class="admin-list">No history yet</div>
                <button class="ghost" id="historyClear" type="button">Clear history</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sticky Cart Bar -->
    <div id="cartBar">
      <div id="cartBarTotal">$0.00</div>
      <button class="ghost" id="cartBarView" type="button">View</button>
      <button class="primary" id="cartBarCheckout" type="button">Checkout</button>
    </div>

    <!-- Toast Host -->
    <div id="toastHost"></div>
        <!-- Firebase + Firestore -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore, collection, addDoc, serverTimestamp,
        onSnapshot, query, orderBy, updateDoc, doc
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAdjxpOK1ir5y-sHCh4PodIxe8TkEYBAsY",
        authDomain: "fitsnack-bd51d.firebaseapp.com",
        projectId: "fitsnack-bd51d",
        storageBucket: "fitsnack-bd51d.firebasestorage.app",
        messagingSenderId: "978231518137",
        appId: "1:978231518137:web:528c32d35d5b4f22038c68"
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      window.__fs = { db }; // expose for debugging
    </script>

    <script>
    /* ========= Boot ========= */
    const APP_SCHEMA_VERSION = 4, SCHEMA_KEY = 'fitsnacks.schema';
    try{
      const cur = JSON.parse(localStorage.getItem(SCHEMA_KEY)||'0')||0;
      if(cur < APP_SCHEMA_VERSION) localStorage.setItem(SCHEMA_KEY, JSON.stringify(APP_SCHEMA_VERSION));
    }catch{ localStorage.setItem(SCHEMA_KEY, JSON.stringify(APP_SCHEMA_VERSION)); }
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js')); }

    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    /* Keys & constants */
    const CART_KEY='fitsnacks.cart.v1';
    const ORDERS_KEY='fitsnacks.orders';
    const UNLOCK_KEY='fitsnacks.admin.unlocked';
    const FAVORITES_KEY='fitsnacks.favorites';
    const PROMOS_KEY='fitsnacks.promos';
    const DELIVERED_KEY='fitsnacks.orders.delivered';
    const PROFILE_NAME_KEY='fitsnacks.profile.name';
    const PROFILE_LOC_KEY='fitsnacks.profile.location';
    const STOCK_KEY='fitsnacks.stock.v1';
    const IFTTT_EVENT='Fitsnack_order';
    const IFTTT_KEY='fI-MGeBZrzbzW3CyUXlWVMpQkvI1bRVirGd0gkcYZiA';
    const IFTTT_URL=`https://maker.ifttt.com/trigger/${IFTTT_EVENT}/with/key/${IFTTT_KEY}`;
    const ADMIN_PASSWORD='8TSB077';
    const fmt=n=>'$'+n.toFixed(2);

    /* State */
    let cart=new Map(JSON.parse(localStorage.getItem(CART_KEY)||'[]'));
    let favorites=new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY)||'[]'));
    let stock=JSON.parse(localStorage.getItem(STOCK_KEY)||'{}');
    let promo=null; // {type:'percent'|'amount', value:number}
    let tip={type:'none', value:0};

    // Default stock if empty
    if(!Object.keys(stock).length){
      stock={
        'Potato Chips': 20,
        'Protein Bar': 18,
        'Trail Mix': 15,
        'Granola Bar': 24,
        'Doritos Flamin‚Äô Hot Nacho': 30,
        'Greek Yogurt': 12,
        'Mixed Nuts': 14,
        'Fruit Cup': 10,
        'Energy Drink': 16,
        'Chocolate Bar': 22
      };
      localStorage.setItem(STOCK_KEY, JSON.stringify(stock));
    }

    function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(Array.from(cart.entries()))); }
    function saveFavs(){ localStorage.setItem(FAVORITES_KEY, JSON.stringify(Array.from(favorites))); }
    function saveStock(){ localStorage.setItem(STOCK_KEY, JSON.stringify(stock)); }

    /* Greeting */
    function updateGreeting(){
      const name=localStorage.getItem(PROFILE_NAME_KEY)||'';
      $('#greet').textContent = name ? `Hi, ${name} üëã` : 'Welcome üëã';
    }

    /* Toast */
    function showToast(msg, ms=1800){
      const host=$('#toastHost'); const el=document.createElement('div');
      el.className='toast'; el.textContent=msg; host.appendChild(el);
      requestAnimationFrame(()=>el.classList.add('show'));
      setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),250); }, ms);
    }

    /* Carousel build with autoplay + dots */
    function buildPromos(){
      const snapper=$('#snapper'); if(!snapper) return;
      let data=[]; try{ data=JSON.parse(localStorage.getItem(PROMOS_KEY)||'[]'); }catch{}
      if(!data.length){
        data = [
          {img:'assets/carousel-1.jpg', title:'Fuel your study grind', cta:'Shop snacks', action:'scrollGrid'},
          {img:'assets/carousel-2.jpg', title:'Protein picks', cta:'Filter: protein', action:'filter', value:'protein'},
          {img:'assets/carousel-3.jpg', title:'Need help?', cta:'Open settings', action:'openSettings'}
        ];
        localStorage.setItem(PROMOS_KEY, JSON.stringify(data));
      }
      snapper.querySelectorAll('.snap-card').forEach(n=>n.remove());
      const after=snapper.lastElementChild;
      data.forEach(p=>{
        const c=document.createElement('div');
        c.className='snap-card';
        c.innerHTML=`<img class="banner" src="${p.img}" alt="${p.title}">
          <div class="snap-meta"><div class="snap-title">${p.title}</div>
          ${p.cta?`<button class="ghost snap-cta" type="button">${p.cta}</button>`:''}</div>`;
        snapper.insertBefore(c, after);
        c.addEventListener('click', e=>{
          if(e.target.closest('.snap-cta')) return;
          if(p.action==='scrollGrid') $('#grid')?.scrollIntoView({behavior:'smooth'});
          if(p.action==='filter') activateChip(p.value||'');
          if(p.action==='openSettings'){ $('#settingsOverlay').classList.add('show'); switchTab('general'); }
        }, {passive:true});
        c.querySelector('.snap-cta')?.addEventListener('click', e=>{
          e.stopPropagation();
          if(p.action==='filter') activateChip(p.value||'');
          if(p.action==='openSettings'){ $('#settingsOverlay').classList.add('show'); switchTab('general'); }
          if(p.action==='scrollGrid') $('#grid')?.scrollIntoView({behavior:'smooth'});
        });
      });

      // dots + autoplay (hold then slide)
      const cards = $$('.snap-card');
      const dotsWrap = $('#snapDots'); dotsWrap.innerHTML = cards.map(()=>'<div class="snap-dot"></div>').join('');
      const dots = $$('.snap-dot'); const setDot=i=>dots.forEach((d,k)=>d.classList.toggle('active',k===i)); setDot(0);

      let idx=0, hold=5000, slide=3000, start=null, phase='hold', from=0, to=0;
      let userInteracting=false,lastInteract=0,inView=true; const INTERACT_COOLDOWN=3500;
      const spacerLeft = snapper.firstElementChild;

      const scrollToCardIdx = (i, smooth=true)=>{
        const targetLeft = cards[i].offsetLeft - spacerLeft.offsetLeft;
        if(smooth) snapper.scrollTo({left:targetLeft, behavior:'smooth'}); else snapper.scrollLeft=targetLeft;
        setDot(i);
      };

      ['pointerdown','wheel','touchstart','mousedown','scroll'].forEach(ev=>snapper.addEventListener(ev,()=>{userInteracting=true;lastInteract=Date.now();},{passive:true}));
      const obs=new IntersectionObserver((ents)=>{inView=ents.some(e=>e.isIntersecting);},{threshold:0.2}); obs.observe(snapper);

      function step(ts){
        if(!cards.length || !inView) return requestAnimationFrame(step);
        if(userInteracting && (Date.now()-lastInteract)<INTERACT_COOLDOWN) { start=ts; return requestAnimationFrame(step); }
        if(!start) start=ts;

        const elapsed = ts - start;
        if(phase==='hold'){
          if(elapsed >= hold){
            phase='slide'; start=ts; from = snapper.scrollLeft; idx=(idx+1)%cards.length;
            to = cards[idx].offsetLeft - spacerLeft.offsetLeft;
          }
        }else{
          const t = Math.min(1, (ts-start)/slide);
          const e = t<.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,8)/2; // easeInOutCubic
          snapper.scrollLeft = from + (to - from) * e;
          if(t>=1){ phase='hold'; start=ts; setDot(idx); }
        }
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);

      // sync dots after manual scroll
      let dotTimer=null;
      snapper.addEventListener('scroll', ()=>{
        clearTimeout(dotTimer);
        dotTimer=setTimeout(()=>{
          let nearest=0, best=1e9;
          cards.forEach((c,i)=>{
            const center = snapper.scrollLeft + snapper.clientWidth/2;
            const cc = c.offsetLeft + c.clientWidth/2;
            const d = Math.abs(center-cc);
            if(d<best){best=d; nearest=i;}
          });
          setDot(nearest);
        },150);
      }, {passive:true});
    }

    /* Product Sheet (with stock/low stock) */
    let currentProduct=null;
    function getStock(name){ return stock[name] ?? 0; }
    function openProductSheet(card){
      currentProduct={ name:card.dataset.name, price:+card.dataset.price, img:card.dataset.img };
      $('#sheetTitle').textContent=currentProduct.name;
      $('#sheetImg').src=currentProduct.img||'';
      $('#sheetImg').alt=currentProduct.name||'';
      $('#sheetPrice').textContent=fmt(currentProduct.price);
      const s=getStock(currentProduct.name);
      $('#sheetStock').textContent='Stock: '+s;
      $('#sheetLowWarn').style.display = s>0 && s<=3 ? 'block':'none';
      $('#qtyVal').textContent='1';
      $('#sheetAdd').textContent='Add ‚Ä¢ '+fmt(currentProduct.price);
      $('#productSheet').classList.add('show'); // iOS fallback CSS ensures visibility
    }
    function closeProductSheet(){ $('#productSheet').classList.remove('show'); }
    $('#sheetClose')?.addEventListener('click', closeProductSheet);
    $('#qtyPlus')?.addEventListener('click', ()=>{ let n=(+$('#qtyVal').textContent)||1; n=Math.min(99,n+1); $('#qtyVal').textContent=n; $('#sheetAdd').textContent='Add ‚Ä¢ '+fmt(n*(currentProduct?.price||0)); });
    $('#qtyMinus')?.addEventListener('click', ()=>{ let n=(+$('#qtyVal').textContent)||1; n=Math.max(1,n-1); $('#qtyVal').textContent=n; $('#sheetAdd').textContent='Add ‚Ä¢ '+fmt(n*(currentProduct?.price||0)); });
    $('#sheetAdd')?.addEventListener('click', ()=>{
      if(!currentProduct) return;
      const n=(+$('#qtyVal').textContent)||1;
      const s=getStock(currentProduct.name);
      if(s<=0){ showToast('Out of stock'); return; }
      if(n>s){ showToast('Not enough stock'); return; }
      const entry=cart.get(currentProduct.name)||{price:currentProduct.price,qty:0};
      entry.qty+=n; cart.set(currentProduct.name,entry); saveCart();
      renderCart(); refreshBadge(); closeProductSheet(); openCart();
      showToast(`Added ${n} √ó ${currentProduct.name}`);
    });

    // open on card click (except star/add direct taps)
    document.addEventListener('click', e=>{
      const card=e.target.closest('.card'); if(!card) return;
      if(e.target.closest('.fav') || e.target.closest('.add')) return;
      openProductSheet(card);
    }, {passive:true});
    document.addEventListener('click', e=>{
      const btn=e.target.closest('.card .add'); if(!btn) return;
      e.stopPropagation(); openProductSheet(btn.closest('.card'));
    }, {passive:true});
        /* Cart */
    function refreshBadge(){
      let n=0; for(const v of cart.values()) n+=v.qty;
      const b=$('#cartBadge'); if(!b) return;
      if(n>0){ b.textContent=String(n); b.style.display='inline-flex'; }
      else { b.style.display='none'; }
    }
    function renderCart(){
      let total=0, html='';
      for(const [name,info] of cart){
        const line=info.price*info.qty; total+=line;
        html += `<div class="row-between" style="margin-top:6px">
          <div style="display:flex;gap:10px;align-items:center">
            <button data-act="-" data-name="${name}" class="ghost" type="button">‚àí</button>
            <div style="min-width:24px;text-align:center">${info.qty}</div>
            <button data-act="+" data-name="${name}" class="ghost" type="button">+</button>
            <div style="font-weight:700;margin-left:8px">${name}</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            <div style="font-weight:700">${fmt(line)}</div>
            <button data-remove="${name}" class="ghost" type="button" style="padding:2px 6px;font-size:12px">x</button>
          </div>
        </div>`;
      }
      $('#cartContent').innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
      $('#cartTotal').textContent = fmt(total);
      updateCartBar();
    }
    document.addEventListener('click', (e)=>{
      const b=e.target.closest('button[data-act][data-name]');
      if(b){
        const name=b.getAttribute('data-name'); const act=b.getAttribute('data-act');
        const entry=cart.get(name); if(!entry) return;
        entry.qty=Math.max( (act==='+')?entry.qty+1:entry.qty-1 ,0);
        if(entry.qty===0) cart.delete(name);
        saveCart(); renderCart(); refreshBadge(); return;
      }
      const rm=e.target.closest('button[data-remove]');
      if(rm){ const name=rm.getAttribute('data-remove'); cart.delete(name); saveCart(); renderCart(); refreshBadge(); return; }
    }, {passive:true});
    function openCart(){ $('#cartOverlay')?.classList.add('show'); }
    function closeCart(){ $('#cartOverlay')?.classList.remove('show'); }
    $('#cartBtn')?.addEventListener('click', openCart);
    $('#cartBack')?.addEventListener('click', closeCart);

    /* Sticky cart bar */
    function updateCartBar(){
      const bar=$('#cartBar'); if(!bar) return;
      let total=0, count=0; for(const [,info] of cart){ total+=info.price*info.qty; count+=info.qty; }
      if(count>0){ $('#cartBarTotal').textContent=fmt(total); bar.classList.add('show'); }
      else { bar.classList.remove('show'); }
    }
    $('#cartBarView')?.addEventListener('click', openCart);
    $('#cartBarCheckout')?.addEventListener('click', ()=>{
      let count=0; for(const v of cart.values()) count+=v.qty;
      if(count===0){ showToast('Your cart is empty'); return; }
      $('#checkoutError').style.display='none'; updateCheckoutBreakdown();
      $('#checkoutOverlay').classList.add('show');
    });

    /* Search + Filters */
    function searchAndFilter(){
      const q = ($('#search').value||'').toLowerCase();
      $$('.card').forEach(c=>{
        const hitsName=c.dataset.name.toLowerCase().includes(q);
        const visible = c.style.display !== 'none-filter' && hitsName;
        c.style.display = visible ? '' : 'none';
      });
    }
    function shouldShowForChip(val, card){
      if(!val) return true;
      if(val==='favorites') return favorites.has(card.dataset.name);
      if(val==='stock') return getStock(card.dataset.name) > 0;
      const tags=(card.dataset.tags||'').toLowerCase();
      return tags.includes(val);
    }
    function activateChip(val){
      $$('#chips .chip').forEach(ch=>ch.classList.toggle('active', ch.dataset.filter===val));
      $$('.card').forEach(c=>{
        const show = shouldShowForChip(val,c);
        if(show) c.style.removeProperty('display');
        else c.style.display='none-filter';
      });
      searchAndFilter();
    }
    $('#chips')?.addEventListener('click', e=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      activateChip(chip.dataset.filter||'');
    });
    $('#search')?.addEventListener('input', searchAndFilter);

    /* Favorites */
    function syncFavStars(){ $$('.card').forEach(card=>card.querySelector('.fav')?.classList.toggle('active', favorites.has(card.dataset.name))); }
    document.addEventListener('click', e=>{
      const fav=e.target.closest('.fav'); if(!fav) return;
      e.stopPropagation();
      const card=fav.closest('.card'); const name=card.dataset.name;
      if(favorites.has(name)) favorites.delete(name); else favorites.add(name);
      saveFavs(); syncFavStars();
      const favChipActive = $('#chips .chip.active')?.dataset.filter === 'favorites';
      if(favChipActive && !favorites.has(name)){ card.style.display='none-filter'; searchAndFilter(); }
    }, {passive:true});

    /* Promo + Tip */
    function parsePromo(code){
      code=(code||'').trim().toUpperCase();
      if(!code) return null;
      // Patterns: SAVE10 / PCT10 => 10% ; OFF2 / $2 => $2 off
      const mPct = code.match(/(SAVE|PCT)(\d{1,2})/);
      if(mPct) return {type:'percent', value:Math.min(50, parseInt(mPct[2],10))};
      const mAmt = code.match(/(OFF|\$)(\d{1,3})/);
      if(mAmt) return {type:'amount', value:Math.min(50, parseInt(mAmt[2],10))};
      return null;
    }
    function computeTotals(){
      let subtotal=0; for(const[,i] of cart) subtotal+=i.price*i.qty;
      let disc=0;
      if(promo){
        if(promo.type==='percent') disc = subtotal * (promo.value/100);
        else if(promo.type==='amount') disc = Math.min(subtotal, promo.value);
      }
      let tipVal=0;
      if(tip.type==='amount') tipVal = tip.value;
      else if(tip.type==='percent') tipVal = (subtotal - disc) * (tip.value/100);
      const total = Math.max(0, subtotal - disc) + tipVal;
      return {subtotal,disc,tip:tipVal,total};
    }
    function updateCheckoutBreakdown(){
      const {subtotal,disc,tip:tipVal,total}=computeTotals();
      $('#ckSub').textContent=fmt(subtotal);
      $('#ckDisc').textContent=`-${fmt(disc)}`;
      $('#ckTip').textContent=fmt(tipVal);
      $('#ckTotal').textContent=fmt(total);
    }
    $('#checkoutPromo')?.addEventListener('input', (e)=>{
      promo = parsePromo(e.target.value);
      $('#promoStatus').textContent = promo ? (promo.type==='percent' ? `Applying ${promo.value}% off` : `Applying $${promo.value} off`) : '';
      updateCheckoutBreakdown();
    });
    document.querySelectorAll('.tip-btn').forEach(b=>b.addEventListener('click', ()=>{
      const v=b.getAttribute('data-tip');
      if(v==='none') tip={type:'none',value:0};
      else if(v.startsWith('amount')) tip={type:'amount', value:parseFloat(v.split(':')[1])||0};
      else if(v.startsWith('percent')) tip={type:'percent', value:parseFloat(v.split(':')[1])||0};
      updateCheckoutBreakdown();
      showToast('Tip updated');
    }));

    /* Checkout */
    $('#cartCheckout')?.addEventListener('click', ()=>{ $('#checkoutError').style.display='none'; updateCheckoutBreakdown(); closeCart(); $('#checkoutOverlay').classList.add('show'); });
    $('#checkoutClose')?.addEventListener('click', ()=>$('#checkoutOverlay')?.classList.remove('show'));

    async function writeOrderToFirestore(order){
      try{
        if(!window.__fs || !window.__fs.db) return null;
        const { db } = window.__fs;
        const ref = await addDoc(collection(db, 'orders'), {
          when: serverTimestamp(),
          name: order.name,
          location: order.location,
          notes: '',
          lines: order.lines,
          total: order.total,
          status: 'active'
        });
        return ref.id;
      }catch(e){ console.warn('Firestore write failed', e); return null; }
    }

    function subscribeOrdersRealtime(){
      try{
        if(!window.__fs || !window.__fs.db) return;
        const { db } = window.__fs;
        const q = query(collection(db, 'orders'), orderBy('when','desc'));
        onSnapshot(q, (snap)=>{
          const list = [];
          snap.forEach(docSnap=>{
            const o = docSnap.data();
            list.push({ id: docSnap.id, when: (o.when?.toDate?.()||new Date()), name:o.name, location:o.location, lines:o.lines||[], total:o.total||0, status:o.status||'active' });
          });
          renderOrders(list);
        });
      }catch(e){ console.warn('Realtime subscribe failed', e); }
    }

    function checkoutClearUI(){
      cart.clear(); saveCart(); renderCart(); refreshBadge(); updateGreeting(); showToast('Order placed üéâ');
      $('#checkoutOverlay').classList.remove('show');
      updateCartBar();
    }

    $('#checkoutSubmit')?.addEventListener('click', async ()=>{
      const name=$('#checkoutName').value.trim();
      const loc=$('#checkoutLocation').value.trim();
      if(!name||!loc){ $('#checkoutError').style.display='block'; return; }
      localStorage.setItem(PROFILE_NAME_KEY,name);
      localStorage.setItem(PROFILE_LOC_KEY,loc);

      const {total}=computeTotals();
      const lines=[...cart].map(([n,i])=>({name:n,qty:i.qty,price:i.price,line:i.price*i.qty}));
      const order={when:new Date().toISOString(),name,location:loc,lines,total,status:'active'};

      // Local orders mirror
      const list=JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]'); list.unshift(order);
      localStorage.setItem(ORDERS_KEY, JSON.stringify(list));

      // Decrement stock
      lines.forEach(l=>{ stock[l.name]=(stock[l.name]||0)-l.qty; if(stock[l.name]<0) stock[l.name]=0; }); saveStock();

      // IFTTT GET trigger
      const summary = `${order.name} @ ${order.location} ‚Ä¢ ${fmt(order.total)}`;
      const lineItems = order.lines.map(l=>`${l.name} √ó ${l.qty} -- ${fmt(l.line)}`).join('\n');
      try{ fetch(`${IFTTT_URL}?value1=${encodeURIComponent(summary)}&value2=${encodeURIComponent(lineItems)}&value3=`, {method:'GET', mode:'no-cors'}); }catch{}

      // Firestore write
      const fsId = await writeOrderToFirestore(order);
      if(fsId) order.id = fsId;

      checkoutClearUI();
      renderOrders(); // local refresh
      renderInventory(); // reflect stock
      renderAnalytics();
    });
        /* Orders (admin list) */
    function renderOrders(externalList){
      const list = externalList || JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]');
      const box=$('#ordersList'); if(!box) return;
      if(!list.length){ box.textContent='No orders yet'; return; }
      box.innerHTML=list.map((o,i)=>`
        <div class="order-item" data-idx="${i}" data-id="${o.id||''}" style="padding:8px;border-bottom:1px solid #2a2a30;cursor:pointer">
          <div style="font-weight:700">${new Date(o.when).toLocaleString()}</div>
          <div>${o.name} @ ${o.location}</div>
          <div style="font-weight:700">Total ${fmt(o.total)}</div>
          <div class="muted">Status: ${o.status||'active'}</div>
        </div>
      `).join('');
      // keep a mirror for selection
      box.__list = list;
    }
    function openOrderSheetByIndex(idx){
      const box=$('#ordersList'); const list=box?.__list || JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]');
      const o=list[idx]; if(!o) return;
      $('#orderMeta').textContent=`${new Date(o.when).toLocaleString()} ‚Ä¢ ${o.name} @ ${o.location}`;
      $('#orderLines').innerHTML=o.lines.map(l=>`<div class="row-between" style="padding:6px 0">
        <div>${l.name} √ó ${l.qty}</div><div style="font-weight:700">${fmt(l.line)}</div></div>`).join('');
      $('#orderTotal').textContent=fmt(o.total);
      $('#orderSheet').dataset.id = o.id||'';
      $('#orderSheet').dataset.idx = idx;
      document.body.appendChild($('#orderSheet'));
      $('#orderSheet').classList.add('show');
    }
    document.addEventListener('click', e=>{
      const row=e.target.closest('.order-item'); if(row) openOrderSheetByIndex(parseInt(row.dataset.idx,10));
    }, {passive:true});
    $('#orderClose')?.addEventListener('click', ()=>$('#orderSheet').classList.remove('show'));
    $('#orderCancel')?.addEventListener('click', ()=>$('#orderSheet').classList.remove('show'));
    $('#orderDelivered')?.addEventListener('click', async ()=>{
      const idx = parseInt($('#orderSheet').dataset.idx||'-1',10);
      const box=$('#ordersList'); const list=box?.__list || JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]');
      const o=list[idx]; if(!o) return;
      o.status='delivered';
      // local delivered history
      const hist=JSON.parse(localStorage.getItem(DELIVERED_KEY)||'[]'); hist.unshift(o); localStorage.setItem(DELIVERED_KEY, JSON.stringify(hist));
      // persist local orders status when using local mirror
      if(!box?.__list){ localStorage.setItem(ORDERS_KEY, JSON.stringify(list)); }
      // try Firestore status update
      try{
        if(o.id && window.__fs?.db){
          const { db } = window.__fs;
          await updateDoc(doc(db,'orders',o.id), { status:'delivered' });
        }
      }catch(e){ console.warn('Failed to update Firestore status', e); }
      renderHistory();
      renderOrders(box?.__list ? list : undefined);
      $('#orderSheet').classList.remove('show');
      showToast('Marked delivered');
    });

    /* Analytics */
    function renderAnalytics(){
      const all = ($('#ordersList').__list) || JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]');
      let rev=0, items=0; all.forEach(o=>{ rev+=o.total; o.lines.forEach(l=>items+=l.qty); });
      const cnt=all.length, aov=cnt?rev/cnt:0;
      $('#kpiRevenue').textContent=fmt(rev); $('#kpiOrders').textContent=cnt; $('#kpiAOV').textContent=fmt(aov); $('#kpiItems').textContent=items;

      const days=Array(7).fill(0), now=Date.now();
      all.forEach(o=>{ const d=new Date(o.when); const diff=Math.floor((now-d)/86400000); if(diff>=0 && diff<7) days[6-diff]+=o.total; });
      const svg=$('#revSpark'); if(svg){ const max=Math.max(1,...days), step=100/(days.length-1||1); const pts=days.map((v,i)=>`${i*step},${40-(v/max)*36-2}`).join(' '); svg.innerHTML=`<polyline points="${pts}" fill="none" stroke="#6ea8fe" stroke-width="2"/>`; }

      const agg={}; all.forEach(o=>o.lines.forEach(l=>{ agg[l.name]=agg[l.name]||{qty:0,rev:0}; agg[l.name].qty+=l.qty; agg[l.name].rev+=l.line; }));
      const sorted=Object.entries(agg).sort((a,b)=>b[1].rev-a[1].rev).slice(0,8);
      $('#topProducts').innerHTML = sorted.length
        ? `<div class="table"><div class="rowh"><div>Product</div><div>Qty</div><div>Revenue</div><div>-</div></div>${
            sorted.map(([n,v])=>`<div class="rowd"><div>${n}</div><div>${v.qty}</div><div>${fmt(v.rev)}</div><div>-</div></div>`).join('')
          }</div>`
        : '<div class="admin-list">No sales yet</div>';
    }

    /* Inventory (read-only summary + stock values) */
    function renderInventory(){
      const wrap=$('#inventoryList'); if(!wrap) return;
      const cards=$$('.card');
      wrap.innerHTML=[...cards].map(c=>`<div class="field" style="display:flex;justify-content:space-between;gap:8px;margin:4px 0;">
        <div style="font-weight:600">${c.dataset.name}</div><div class="muted">${fmt(+c.dataset.price)} ‚Ä¢ Stock: ${getStock(c.dataset.name)}</div></div>`).join('');
    }

    /* Heat Map (demo) */
    function renderHeat(){
      const grid=$('#heatGridHM'); if(!grid) return; grid.innerHTML='';
      const total=7*24;
      for(let i=0;i<total;i++){
        const cell=document.createElement('div'); cell.className='heat-cell';
        const a=0.15+0.65*Math.random(); cell.style.background=`rgba(110,168,254,${a})`;
        grid.appendChild(cell); if((i%24)===23) grid.appendChild(document.createElement('br'));
      }
    }

    /* History */
    function renderHistory(){
      const list=JSON.parse(localStorage.getItem(DELIVERED_KEY)||'[]');
      const box=$('#historyList'); if(!box) return;
      if(!list.length){ box.textContent='No delivered orders'; return; }
      box.innerHTML=list.map(o=>`
        <div style="padding:8px;border-bottom:1px solid #2a2a30">
          <div style="font-weight:700">Delivered ${new Date(o.when).toLocaleString()}</div>
          <div>${o.name} @ ${o.location}</div>
          <div>Total ${fmt(o.total)}</div>
        </div>
      `).join('');
    }
    $('#historyClear')?.addEventListener('click',()=>{ localStorage.setItem(DELIVERED_KEY,'[]'); renderHistory(); });
        /* Overlay close on backdrop & ESC */
    document.querySelectorAll('.overlay').forEach(ov=>{
      ov.addEventListener('click', (e)=>{ if(e.target===ov) ov.classList.remove('show'); }, {passive:true});
    });
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'){
        document.querySelectorAll('.overlay.show').forEach(ov=>ov.classList.remove('show'));
      }
    });

    /* Admin Tabs & Login */
    function switchTab(which){
      const g=$('#tabGeneral'), a=$('#tabAdmin'), pg=$('#panelGeneral'), pa=$('#panelAdmin');
      if(which==='admin'){
        g.classList.remove('active'); g.setAttribute('aria-selected','false');
        a.classList.add('active');    a.setAttribute('aria-selected','true');
        pg.style.display='none'; pa.style.display='block';
        ensureAdminLoginVisible();
      }else{
        a.classList.remove('active'); a.setAttribute('aria-selected','false');
        g.classList.add('active');    g.setAttribute('aria-selected','true');
        pa.style.display='none'; pg.style.display='block';
      }
    }
    function ensureAdminLoginVisible(){
      const logged=localStorage.getItem(UNLOCK_KEY)==='1';
      $('#adminLogin').style.display=logged?'none':'block';
      $('#adminContent').style.display=logged?'block':'none';
      if(logged){
        renderOrders(); renderInventory(); renderAnalytics(); renderHeat(); renderHistory();
        subscribeOrdersRealtime();
      }
    }
    document.addEventListener('click', e=>{
      if(e.target.closest('#tabGeneral')) switchTab('general');
      if(e.target.closest('#tabAdmin'))   switchTab('admin');
      if(e.target.closest('#adminSubmit')){
        const ok=$('#adminPassword').value===ADMIN_PASSWORD;
        if(ok){
          localStorage.setItem(UNLOCK_KEY,'1');
          $('#adminError').style.display='none';
          ensureAdminLoginVisible();
        }
        else { $('#adminError').style.display='block'; }
      }
      const sub=e.target.closest('.subtab');
      if(sub){
        $$('.subtab').forEach(s=>s.classList.remove('active'));
        sub.classList.add('active');
        const id=sub.dataset.subtab;
        ['orders','inventory','analytics','heat','history'].forEach(k=>{
          $('#subtab-'+k).style.display = (k===id)?'block':'none';
        });
      }
    }, {passive:true});

    /* Init */
    updateGreeting(); buildPromos(); renderCart(); refreshBadge(); updateCartBar(); syncFavStars();
    renderOrders(); renderInventory(); renderAnalytics(); renderHeat(); renderHistory(); activateChip('');
    (function(){
      $('#settingsBtn')?.addEventListener('click',()=>{ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); });
      $('#settingsClose')?.addEventListener('click',()=>$('#settingsOverlay')?.classList.remove('show'));
      $('#cartBtn')?.addEventListener('click',()=>$('#cartOverlay')?.classList.add('show'));
      $('#cartBack')?.addEventListener('click',()=>$('#cartOverlay')?.classList.remove('show'));
    })();
    </script>
  </div>
</body>
</html>
    
    