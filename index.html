<script>
/* ================================
   FitSnacks -- Chunk 1/8 (Cart core)
   Purpose: fix add-to-cart, totals, badge, persistence
   Safe: yes (guards + overrides only)
==================================*/
(function(){
  if (window.__FS_CART_CORE_FIXED__) return;
  window.__FS_CART_CORE_FIXED__ = true;

  /* ---- Utilities ---- */
  const fmt = window.fmt || (n => '$' + Number(n||0).toFixed(2));
  const CART_KEY = window.CART_KEY || 'fitsnacks.cart.v1';

  function ensureCart(){
    // hydrate from localStorage into a Map
    if (!(window.cart instanceof Map)) {
      try {
        const raw = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
        window.cart = new Map(Array.isArray(raw) ? raw : []);
      } catch { window.cart = new Map(); }
    }
    return window.cart;
  }
  function saveCart(){
    try {
      localStorage.setItem(CART_KEY, JSON.stringify(Array.from(ensureCart().entries())));
    } catch {}
  }
  function cartTotals(){
    let count = 0, total = 0;
    for (const [,it] of ensureCart()){
      const q = Math.max(0, Number(it.qty||0));
      const p = Number(it.price||0);
      count += q;
      total += p*q;
    }
    return {count,total};
  }

  /* ---- Badge + "empty cart" message ---- */
  function refreshBadge(){
    const b = document.getElementById('cartBadge');
    if (!b) return;
    const {count} = cartTotals();
    if (count > 0){
      b.textContent = count;
      b.style.display = 'inline-flex';
    } else {
      b.textContent = '0';
      b.style.display = 'none';
    }
  }
  function ensureEmptyMessage(){
    const box = document.getElementById('cartContent');
    if (!box) return;
    const hasLine = !!box.querySelector('[data-cart-line]');
    if (!hasLine){
      box.innerHTML = '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
    }
  }

  /* ---- Render cart lines (canonical) ---- */
  function renderCart(){
    const box = document.getElementById('cartContent');
    const totalEl = document.getElementById('cartTotal');
    if (!box){ saveCart(); refreshBadge(); return; }

    let html = '';
    let total = 0;
    for (const [name, info] of ensureCart()){
      const price = Number(info.price||0);
      const qty   = Math.max(0, Number(info.qty||0));
      const line  = price * qty;
      total += line;
      html += `
        <div class="row-between" data-cart-line data-name="${name}" style="margin-top:6px">
          <div style="display:flex;gap:10px;align-items:center">
            <button data-act="-" data-name="${name}" class="ghost" style="padding:4px 8px">−</button>
            <div style="min-width:24px;text-align:center">${qty}</div>
            <button data-act="+" data-name="${name}" class="ghost" style="padding:4px 8px">+</button>
            <div style="font-weight:700;margin-left:8px">${name}</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div style="font-weight:700">${fmt(line)}</div>
            <button data-act="remove" data-name="${name}" class="ghost" title="Remove" aria-label="Remove" style="padding:4px 8px">×</button>
          </div>
        </div>`;
    }
    box.innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';

    if (totalEl) totalEl.textContent = fmt(total);
    saveCart();
    refreshBadge();
    if (typeof window.updateCartBar === 'function') window.updateCartBar();
  }
  window.renderCart = renderCart; // make global (overrides any broken one)

  /* ---- Mutators ---- */
  function addToCart(name, price, qty){
    if (!name) return;
    const cart = ensureCart();
    const entry = cart.get(name) || {price:Number(price||0), qty:0};
    entry.price = Number(price||entry.price||0);
    entry.qty   = Math.max(0, Number(entry.qty||0)) + Math.max(1, Number(qty||1));
    cart.set(name, entry);
    saveCart(); renderCart();
  }
  function changeQty(name, delta){
    const cart = ensureCart();
    const entry = cart.get(name); if (!entry) return;
    const newQty = Math.max(1, Number(entry.qty||0) + Number(delta||0));
    entry.qty = newQty; cart.set(name, entry);
    saveCart(); renderCart();
  }
  function removeFromCart(name){
    const cart = ensureCart(); cart.delete(name);
    saveCart(); renderCart();
  }
  window.__FS_addToCart = addToCart;

  /* ---- Delegate clicks: + / − / × in cart ---- */
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if (!btn) return;
    if (!btn.hasAttribute('data-act') || !btn.hasAttribute('data-name')) return;
    const act  = btn.getAttribute('data-act');
    const name = btn.getAttribute('data-name');

    if (act === '+') { changeQty(name, +1); }
    if (act === '-') { changeQty(name, -1); }
    if (act === 'remove') { removeFromCart(name); }
  }, {passive:true});

  /* ---- Blue "+" card button → open sheet OR quick-add ----
     - Click = open product sheet (if you use that flow)
     - Long-press (≥520ms) = quick add 1 item (no sheet)
     This just ensures add works either way. */
  document.querySelectorAll('.card .add').forEach(btn=>{
    let tId=null, long=false;
    const start=()=>{ long=false; clearTimeout(tId); tId=setTimeout(()=>{ long=true; quick(); },520); };
    const cancel=()=>clearTimeout(tId);
    const quick=()=>{
      const card = btn.closest('.card'); if (!card) return;
      const name = card.dataset.name; const price = Number(card.dataset.price||0);
      addToCart(name, price, 1);
      // optional toast
      try{ window.showToast?.(`Added 1 × ${name}`); }catch{}
    };
    btn.addEventListener('touchstart', start, {passive:true});
    btn.addEventListener('mousedown', start);
    ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>btn.addEventListener(ev,cancel));
    btn.addEventListener('click', (e)=>{
      if (long){ e.preventDefault(); e.stopPropagation(); return; }
      // open sheet flow (if present)
      const card = btn.closest('.card');
      const open = window.openProductSheet;
      if (typeof open === 'function' && card){ open(card); }
      else { // fallback: just add 1 if no sheet
        const name = card?.dataset?.name; const price = Number(card?.dataset?.price||0);
        addToCart(name, price, 1);
      }
    });
  });

  /* ---- Product sheet "Add" button ---- */
  (function bindSheetAdd(){
    const addBtn = document.getElementById('sheetAdd');
    if (!addBtn) return;
    addBtn.addEventListener('click', ()=>{
      // Expect a global "current" or data on the sheet title/img price
      const title = document.getElementById('sheetTitle')?.textContent?.trim() || '';
      const priceText = document.getElementById('sheetPrice')?.textContent || '';
      const qtyText = document.getElementById('qtyVal')?.textContent || '1';
      // parse price from "$2.50" or accept cached current
      let price = NaN;
      const m = priceText.match(/[\d.]+/g);
      if (m) price = Number(m.join(''));
      if (!isFinite(price)) { price = Number(window.__FS_CURRENT?.price||0); }

      const qty = Math.max(1, parseInt(qtyText, 10) || 1);
      addToCart(title, price, qty);

      // open cart & close sheet if present
      document.getElementById('productSheet')?.classList.remove('show');
      document.getElementById('cartOverlay')?.classList.add('show');
    }, {passive:true});
  })();

  /* ---- Opening checkout must show live totals ---- */
  function openCheckoutOverlay(){
    const ck = document.getElementById('checkoutOverlay');
    if (!ck) return;
    ck.classList.add('show');
    if (typeof window.updateCheckoutBreakdown === 'function'){ window.updateCheckoutBreakdown(); }
  }
  // harden both entry points
  document.getElementById('cartCheckout')?.addEventListener('click', ()=>{
    document.getElementById('cartOverlay')?.classList.remove('show');
    openCheckoutOverlay();
  }, {passive:true});
  document.getElementById('cartBarCheckout')?.addEventListener('click', openCheckoutOverlay, {passive:true});

  /* ---- Boot sync once ---- */
  renderCart();        // draw lines & total from storage
  refreshBadge();      // show correct badge state
  ensureEmptyMessage();// safety message if nothing inside
})();
</script>

<script>
/* ================================
   FitSnacks -- Chunk 2/8 (Overlays close)
   Purpose: close on backdrop, ESC, and wire all close buttons
   Safe: yes (guards + no visual changes)
==================================*/
(function(){
  if (window.__FS_OVERLAYS_FIXED__) return;
  window.__FS_OVERLAYS_FIXED__ = true;

  const OVERLAYS = [
    { id:'orderSheet',     z:10050 },
    { id:'checkoutOverlay',z:10020 },
    { id:'cartOverlay',    z:10010 },
    { id:'settingsOverlay',z:10000 },
    { id:'productSheet',   z:9999  }
  ];

  function getEl(id){ return document.getElementById(id); }
  function isOpen(id){ const el=getEl(id); return !!(el && el.classList.contains('show')); }
  function openOverlay(id){ const el=getEl(id); if(el) el.classList.add('show'); }
  function closeOverlay(id){ const el=getEl(id); if(el) el.classList.remove('show'); }

  /* ---- Close on backdrop click ---- */
  OVERLAYS.forEach(({id})=>{
    const el = getEl(id); if (!el) return;
    if (!el.__fs_backdropBound){
      el.addEventListener('mousedown', (e)=>{
        // If click lands on the overlay background (not inside .sheet), close
        if (e.target === el || (e.target.classList && e.target.classList.contains('overlay'))){
          closeOverlay(id);
        }
      });
      el.__fs_backdropBound = true;
    }
  });

  /* ---- ESC key closes the topmost open overlay ---- */
  if (!window.__FS_ESC_BOUND__){
    window.__FS_ESC_BOUND__ = true;
    document.addEventListener('keydown', (e)=>{
      if (e.key !== 'Escape') return;
      // pick highest z-index open overlay
      const open = OVERLAYS
        .filter(o=>isOpen(o.id))
        .sort((a,b)=>b.z-a.z);
      if (open.length){
        e.preventDefault();
        closeOverlay(open[0].id);
      }
    });
  }

  /* ---- Wire all explicit close buttons (with guards) ---- */
  function bind(btnId, overlayId){
    const btn = document.getElementById(btnId);
    if (!btn) return;
    if (btn.__fs_closeBound) return;
    btn.addEventListener('click', ()=> closeOverlay(overlayId), {passive:true});
    btn.__fs_closeBound = true;
  }
  bind('sheetClose',     'productSheet');
  bind('cartBack',       'cartOverlay');
  bind('checkoutClose',  'checkoutOverlay');
  bind('settingsClose',  'settingsOverlay');
  bind('orderClose',     'orderSheet');
  bind('orderCancel',    'orderSheet');

  /* ---- Safety: when opening one overlay, optionally close others that conflict ---- */
  function hardenOpeners(){
    const cartBtn = document.getElementById('cartBtn');
    if (cartBtn && !cartBtn.__fs_openBound){
      cartBtn.addEventListener('click', ()=>{
        closeOverlay('checkoutOverlay');
        closeOverlay('settingsOverlay');
        openOverlay('cartOverlay');
      }, {passive:true});
      cartBtn.__fs_openBound = true;
    }

    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn && !settingsBtn.__fs_openBound){
      settingsBtn.addEventListener('click', ()=>{
        closeOverlay('cartOverlay');
        closeOverlay('checkoutOverlay');
        openOverlay('settingsOverlay');
        // default to General tab if tab logic exists
        if (typeof window.switchTab === 'function') window.switchTab('general');
      }, {passive:true});
      settingsBtn.__fs_openBound = true;
    }

    const checkoutBtn = document.getElementById('cartCheckout');
    if (checkoutBtn && !checkoutBtn.__fs_openBound){
      checkoutBtn.addEventListener('click', ()=>{
        closeOverlay('cartOverlay');
        openOverlay('checkoutOverlay');
        // recompute totals if function exists (Chunk 1 exposes it)
        try { window.updateCheckoutBreakdown?.(); } catch {}
      }, {passive:true});
      checkoutBtn.__fs_openBound = true;
    }
  }
  hardenOpeners();

  /* ---- Public helpers (optional reuse) ---- */
  window.__fsCloseOverlay   = closeOverlay;
  window.__fsOpenOverlay    = openOverlay;
  window.__fsOverlayIsOpen  = isOpen;

})();
</script>

<script>
/* ================================
   FitSnacks -- Chunk 3/8 (Checkout integration)
   Purpose: hook cart → checkout totals and form
==================================*/
(function(){
  if (window.__FS_CHECKOUT_FIXED__) return;
  window.__FS_CHECKOUT_FIXED__ = true;

  const PROFILE_NAME_KEY = 'fitsnacks.profile.name';
  const PROFILE_LOC_KEY  = 'fitsnacks.profile.location';
  const fmt = window.fmt || (n => '$' + Number(n||0).toFixed(2));

  function loadProfile(){
    return {
      name: localStorage.getItem(PROFILE_NAME_KEY) || '',
      loc:  localStorage.getItem(PROFILE_LOC_KEY)  || ''
    };
  }
  function saveProfile(n,l){
    try {
      localStorage.setItem(PROFILE_NAME_KEY, n||'');
      localStorage.setItem(PROFILE_LOC_KEY,  l||'');
    }catch{}
  }

  /* --- compute totals from cart --- */
  let activePromo = null;   // {discount,label,...} if you want to add promos later
  let activeTip   = 0;      // flat tip amount

  function computeTotals(){
    const cart = window.cart || new Map();
    let subtotal = 0;
    for (const [,it] of cart){
      subtotal += Number(it.price||0) * Number(it.qty||0);
    }
    const disc = activePromo?.discount || 0;
    const tip  = activeTip||0;
    const total = Math.max(0, subtotal - disc) + tip;
    return {subtotal, disc, tip, total};
  }

  function updateCheckoutBreakdown(){
    const {subtotal, disc, tip, total} = computeTotals();
    document.getElementById('ckSub')?.textContent = fmt(subtotal);
    document.getElementById('ckDisc')?.textContent = `-${fmt(disc)}`;
    document.getElementById('ckTip')?.textContent = fmt(tip);
    document.getElementById('ckTotal')?.textContent = fmt(total);
  }
  window.updateCheckoutBreakdown = updateCheckoutBreakdown;

  /* --- open checkout from cart --- */
  function openCheckout(){
    const p = loadProfile();
    const n = document.getElementById('checkoutName');
    const l = document.getElementById('checkoutLocation');
    if (n) n.value = p.name;
    if (l) l.value = p.loc;

    document.getElementById('checkoutError')?.style.setProperty('display','none');
    updateCheckoutBreakdown();
    document.getElementById('checkoutOverlay')?.classList.add('show');
  }
  window.__fsOpenCheckout = openCheckout;

  /* --- bind Place Order --- */
  const submitBtn = document.getElementById('checkoutSubmit');
  if (submitBtn && !submitBtn.__fs_bound){
    submitBtn.addEventListener('click', ()=>{
      const name = document.getElementById('checkoutName')?.value.trim();
      const loc  = document.getElementById('checkoutLocation')?.value.trim();
      if (!name || !loc){
        document.getElementById('checkoutError')?.style.setProperty('display','block');
        return;
      }
      saveProfile(name,loc);

      // optional: send to webhook here if configured
      try {
        if (typeof window.__FS_onOrderPlaced === 'function'){
          window.__FS_onOrderPlaced({name,location:loc,cart:Array.from(window.cart||[])});
        }
      } catch(e){ console.warn('order hook error', e); }

      // clear cart + close
      if (window.cart){ window.cart.clear(); }
      window.renderCart?.();
      document.getElementById('checkoutOverlay')?.classList.remove('show');

      window.showToast?.('Order placed 🎉');
    }, {passive:true});
    submitBtn.__fs_bound = true;
  }

  /* --- bind checkout openers (safety) --- */
  document.getElementById('cartCheckout')?.addEventListener('click', (e)=>{
    e.preventDefault();
    document.getElementById('cartOverlay')?.classList.remove('show');
    openCheckout();
  }, {passive:true});
  document.getElementById('cartBarCheckout')?.addEventListener('click', openCheckout, {passive:true});

})();
</script>

<style>
/* ============ Chunk 4/8 -- Favourites UX ============ */
/* Make the tap target larger without changing your card layout */
.fav {
  position:absolute; right:12px; top:12px;
  width:40px; height:40px;                   /* larger */
  border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
  cursor:pointer;
  touch-action: manipulation;
}
.fav > span {
  pointer-events:none;                        /* keep events on the button */
  font-size:18px; line-height:1;
}
.fav:active { transform: scale(0.96); }
.fav.active{
  background:rgba(255,215,0,.18);
  box-shadow:0 0 0 1px rgba(255,215,0,.35) inset;
}
</style>

<script>
/* ================================
   FitSnacks -- Chunk 4/8 (Favourites)
   Purpose: reliable toggle + filter sync + bigger hit target
==================================*/
(function(){
  if (window.__FS_FAV_FIXED__) return;
  window.__FS_FAV_FIXED__ = true;

  const FAVORITES_KEY = 'fitsnacks.favorites';

  function loadFavs(){
    try { return new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY)||'[]')); }
    catch { return new Set(); }
  }
  function saveFavs(set){
    try { localStorage.setItem(FAVORITES_KEY, JSON.stringify(Array.from(set||[]))); } catch {}
  }

  // hydrate (reuse existing if project already created it)
  window.favorites = (window.favorites instanceof Set) ? window.favorites : loadFavs();

  function syncFavStars(){
    document.querySelectorAll('.card').forEach(card=>{
      const name = card.dataset.name;
      const btn  = card.querySelector('.fav');
      if (!btn) return;
      btn.classList.toggle('active', window.favorites.has(name));
      // Ensure a star glyph exists once
      if (!btn.querySelector('span')) {
        const s=document.createElement('span'); s.textContent='⭐';
        btn.appendChild(s);
      }
    });
  }
  window.syncFavStars = window.syncFavStars || syncFavStars;

  // Core toggle that also respects current filter
  function toggleFavorite(name){
    if (!name) return;
    if (window.favorites.has(name)) window.favorites.delete(name);
    else window.favorites.add(name);
    saveFavs(window.favorites);
    syncFavStars();

    // If we are inside "favorites" filter, hide cards that were just un-favourited
    const chips = document.getElementById('chips');
    const activeChip = chips?.querySelector('.chip.active');
    const filter = activeChip?.getAttribute('data-filter') || '';
    if (filter === 'favorites'){
      document.querySelectorAll('.card').forEach(c=>{
        const n=c.dataset.name;
        c.style.display = window.favorites.has(n) ? '' : 'none';
      });
    }
  }
  window.__FS_toggleFavorite = toggleFavorite;

  // Single delegated handler: prevent bubbling so the card doesn't open its modal
  if (!window.__FS_FAV_DELEGATE__){
    window.__FS_FAV_DELEGATE__ = true;
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.fav'); if (!btn) return;
      e.preventDefault(); e.stopPropagation();    // block card click
      const card = btn.closest('.card'); if (!card) return;
      toggleFavorite(card.dataset.name);
    }, {passive:false});
  }

  // Ensure star buttons exist on each card (if some templates missed it)
  document.querySelectorAll('.card').forEach(card=>{
    if (!card.querySelector('.fav')){
      const b=document.createElement('button');
      b.className='fav'; b.setAttribute('aria-label','Favorite');
      const s=document.createElement('span'); s.textContent='⭐';
      b.appendChild(s);
      card.appendChild(b);
    }
  });

  // Initial paint
  syncFavStars();
})();
</script>

<script>
/* ============================================
   FitSnacks -- Chunk 5/8 (Settings/Admin tabs)
   Purpose: make Settings open, tabs switch, Admin unlock flow
   Safe/idempotent: yes
============================================ */
(function(){
  if (window.__FS_SETTINGS_FIXED__) return;
  window.__FS_SETTINGS_FIXED__ = true;

  const UNLOCK_KEY = window.UNLOCK_KEY || 'fitsnacks.admin.unlocked';
  const ADMIN_PASSWORD = window.ADMIN_PASSWORD || '8TSB077';

  // helpers
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  function isUnlocked(){ return localStorage.getItem(UNLOCK_KEY) === '1'; }
  function setUnlocked(v){ try{ localStorage.setItem(UNLOCK_KEY, v?'1':'0'); }catch{} }

  // Panels
  const tabGeneral = $('#tabGeneral');
  const tabAdmin   = $('#tabAdmin');
  const panelGeneral = $('#panelGeneral');
  const panelAdmin   = $('#panelAdmin');

  function switchTab(which){
    if (!tabGeneral || !tabAdmin || !panelGeneral || !panelAdmin) return;

    if (which === 'admin'){
      tabGeneral.classList.remove('active'); tabGeneral.setAttribute('aria-selected','false');
      tabAdmin.classList.add('active');      tabAdmin.setAttribute('aria-selected','true');
      panelGeneral.style.display='none'; panelAdmin.style.display='block';
      ensureAdminLoginVisible();
    } else {
      tabAdmin.classList.remove('active');   tabAdmin.setAttribute('aria-selected','false');
      tabGeneral.classList.add('active');    tabGeneral.setAttribute('aria-selected','true');
      panelAdmin.style.display='none'; panelGeneral.style.display='block';
    }
  }
  window.switchTab = window.switchTab || switchTab;

  function ensureAdminLoginVisible(){
    const login  = $('#adminLogin');
    const content= $('#adminContent');
    const stateEl= $('#adminStateVal');

    const unlocked = isUnlocked();
    if (login)   login.style.display   = unlocked ? 'none'  : 'block';
    if (content) content.style.display = unlocked ? 'block' : 'none';
    if (stateEl) stateEl.textContent   = unlocked ? 'Unlocked' : 'Locked';

    if (unlocked){
      // lazy-refresh admin panels if your app exposes these
      try{ window.renderOrders?.(); }catch{}
      try{ window.renderInventory?.(); }catch{}
      try{ window.renderHeat?.(); }catch{}
      try{ window.renderAnalytics?.(); }catch{}
      try{ window.updateStockBadges?.(); }catch{}
    } else {
      // focus password field for convenience
      const pw = $('#adminPassword'); if (pw){ setTimeout(()=>{ pw.focus(); pw.select?.(); }, 0); }
    }
  }
  window.ensureAdminLoginVisible = window.ensureAdminLoginVisible || ensureAdminLoginVisible;

  // Bind gear opens Settings (default to General)
  (function bindGear(){
    const btn = $('#settingsBtn');
    if (!btn || btn.__fs_bindGear) return;
    btn.addEventListener('click', ()=>{
      $('#cartOverlay')?.classList.remove('show');
      $('#checkoutOverlay')?.classList.remove('show');
      $('#settingsOverlay')?.classList.add('show');
      switchTab('general');
    }, {passive:true});
    btn.__fs_bindGear = true;
  })();

  // Bind main tabs
  (function bindMainTabs(){
    if (tabGeneral && !tabGeneral.__fs_bind){
      tabGeneral.addEventListener('click', ()=>switchTab('general'), {passive:true});
      tabGeneral.__fs_bind = true;
    }
    if (tabAdmin && !tabAdmin.__fs_bind){
      tabAdmin.addEventListener('click', ()=>switchTab('admin'), {passive:true});
      tabAdmin.__fs_bind = true;
    }
  })();

  // Bind Admin unlock form
  (function bindUnlock(){
    const submit = $('#adminSubmit');
    if (!submit || submit.__fs_bind) return;
    submit.addEventListener('click', ()=>{
      const input = $('#adminPassword');
      const err   = $('#adminError');
      const ok = (input?.value || '') === ADMIN_PASSWORD;
      if (ok){
        setUnlocked(true);
        if (err) err.style.display='none';
        ensureAdminLoginVisible();
      } else {
        if (err) err.style.display='block';
      }
    }, {passive:true});
    submit.__fs_bind = true;
  })();

  // Bind Admin lock button (optional element)
  (function bindLock(){
    const lock = $('#adminLock');
    if (!lock || lock.__fs_bind) return;
    lock.addEventListener('click', ()=>{
      setUnlocked(false);
      ensureAdminLoginVisible();
    }, {passive:true});
    lock.__fs_bind = true;
  })();

  // Subtabs switching (Orders / Inventory / Analytics / History)
  (function bindSubtabs(){
    const container = $('#adminContent');
    if (!container || container.__fs_subtabs) return;
    container.addEventListener('click', (e)=>{
      const btn = e.target.closest('.subtab'); if (!btn) return;
      $$('.subtab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-subtab');

      const show = (el, on)=>{ if (el) el.style.display = on ? 'block' : 'none'; };
      show($('#subtab-orders'),    id==='orders');
      show($('#subtab-inventory'), id==='inventory');
      show($('#subtab-analytics'), id==='analytics');
      show($('#subtab-history'),   id==='history');

      // lazy-render panel content
      if (id==='orders')    { try{ window.renderOrders?.(); }catch{} }
      if (id==='inventory') { try{ window.renderInventory?.(); window.updateStockBadges?.(); }catch{} }
      if (id==='analytics') { try{ window.renderAnalytics?.(); }catch{} }
      if (id==='history')   { try{ window.renderHistory?.(); }catch{} }
    }, {passive:true});
    container.__fs_subtabs = true;
  })();

  // If Settings is open on load, ensure correct section visibility
  ensureAdminLoginVisible();
})();
</script>

<script>
/* ============================================
   FitSnacks -- Chunk 6/8 (Search UX + Slider arrows)
   Purpose: show 'No results' & arrow controls for promo slider
============================================ */
(function(){
  if (window.__FS_SEARCH_SLIDER_FIXED__) return;
  window.__FS_SEARCH_SLIDER_FIXED__ = true;

  const $  = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));

  /* --- SEARCH --- */
  const searchInput = $('#search');
  if (searchInput && !searchInput.__fs_bind){
    searchInput.addEventListener('input', e=>{
      const q = e.target.value.toLowerCase();
      let matches = 0;
      $$('.card').forEach(c=>{
        const hit = c.dataset.name.toLowerCase().includes(q);
        c.style.display = hit ? '' : 'none';
        if (hit) matches++;
      });
      // Show "no results"
      let msg = document.getElementById('searchEmptyMsg');
      if (!msg){
        msg = document.createElement('div');
        msg.id='searchEmptyMsg';
        msg.style.cssText = 'margin-top:12px;color:#aaa;font-style:italic';
        searchInput.insertAdjacentElement('afterend', msg);
      }
      msg.textContent = matches ? '' : 'No results found';
    });
    searchInput.__fs_bind = true;
  }

  /* --- SLIDER ARROWS --- */
  function addSliderArrows(){
    const dots = $('#snapDots');
    const snapper = $('#snapper');
    if (!dots || !snapper) return;
    if (dots.__fs_arrows) return;

    const wrap = document.createElement('div');
    wrap.style.cssText='display:flex;justify-content:space-between;gap:20px;margin-top:6px';
    const left=document.createElement('button');
    left.textContent='←'; left.className='ghost';
    const right=document.createElement('button');
    right.textContent='→'; right.className='ghost';
    wrap.appendChild(left); wrap.appendChild(right);
    dots.insertAdjacentElement('afterend', wrap);

    left.addEventListener('click', ()=>{
      try{ window.__fsSliderSnap?.(-1); }catch{}
    });
    right.addEventListener('click', ()=>{
      try{ window.__fsSliderSnap?.(+1); }catch{}
    });

    dots.__fs_arrows = true;
  }
  addSliderArrows();

})();
</script>

<style>
/* ==========================
   Chunk 7/8 – Overlay polish
   Ensure overlays only eat clicks when shown
========================== */
.overlay{ pointer-events:none; }
.overlay.show{ pointer-events:auto; }
.overlay .sheet{ position:relative; }
</style>

<script>
/* ============================================
   FitSnacks -- Chunk 7/8 (Overlay close polish)
   Purpose: you can ALWAYS exit overlays
   Safe/idempotent: yes
============================================ */
(function(){
  if (window.__FS_CLOSE_POLISH__) return;
  window.__FS_CLOSE_POLISH__ = true;

  const STACK = [
    { id:'orderSheet',      z:10050 },
    { id:'checkoutOverlay', z:10020 },
    { id:'cartOverlay',     z:10010 },
    { id:'settingsOverlay', z:10000 },
    { id:'productSheet',    z: 9999 }
  ];

  const byId = id => document.getElementById(id);
  const isOpen = id => !!(byId(id)?.classList.contains('show'));
  const open   = id => byId(id)?.classList.add('show');
  const close  = id => byId(id)?.classList.remove('show');

  // Expose helpers once
  window.__fsOverlay = window.__fsOverlay || { open, close, isOpen };

  // Backdrop close (click outside .sheet)
  STACK.forEach(({id})=>{
    const el = byId(id); if (!el || el.__fs_backdrop2) return;
    el.addEventListener('mousedown', (e)=>{
      if (e.target === el) close(id);
    });
    el.__fs_backdrop2 = true;
  });

  // ESC closes the topmost open overlay (works even if others bound earlier)
  if (!window.__FS_ESC_TOPMOST__){
    window.__FS_ESC_TOPMOST__ = true;
    document.addEventListener('keydown', (e)=>{
      if (e.key !== 'Escape') return;
      const openTop = STACK.filter(o=>isOpen(o.id)).sort((a,b)=>b.z-a.z)[0];
      if (openTop){ e.preventDefault(); close(openTop.id); }
    });
  }

  // Universal [data-close] hooks (e.g., <button data-close="checkoutOverlay">Close</button>)
  if (!window.__FS_DATA_CLOSE__){
    window.__FS_DATA_CLOSE__ = true;
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-close]'); if (!btn) return;
      const target = btn.getAttribute('data-close');
      if (target === 'topmost'){
        const top = STACK.filter(o=>isOpen(o.id)).sort((a,b)=>b.z-a.z)[0];
        if (top) close(top.id);
      } else {
        close(target);
      }
    }, {passive:true});
  }

  // Make sure the known close buttons definitely work
  function bind(idBtn, idOverlay){
    const b = document.getElementById(idBtn); if (!b || b.__fs_bindClose) return;
    b.addEventListener('click', ()=> close(idOverlay), {passive:true});
    b.__fs_bindClose = true;
  }
  bind('sheetClose',    'productSheet');
  bind('cartBack',      'cartOverlay');
  bind('checkoutClose', 'checkoutOverlay');
  bind('settingsClose', 'settingsOverlay');
  bind('orderClose',    'orderSheet');
  bind('orderCancel',   'orderSheet');

  // Safety: force-close other overlays when opening checkout/cart/settings
  function guardOpeners(){
    const safeOpen = (want) => {
      // Close all others first
      STACK.forEach(o=>{ if (o.id !== want) close(o.id); });
      open(want);
    };
    const cartBtn = document.getElementById('cartBtn');
    if (cartBtn && !cartBtn.__fs_safeOpen){
      cartBtn.addEventListener('click', ()=> safeOpen('cartOverlay'), {passive:true});
      cartBtn.__fs_safeOpen = true;
    }
    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn && !settingsBtn.__fs_safeOpen){
      settingsBtn.addEventListener('click', ()=>{
        safeOpen('settingsOverlay');
        // default to General tab if your tab code is present
        try{ window.switchTab?.('general'); }catch{}
      }, {passive:true});
      settingsBtn.__fs_safeOpen = true;
    }
    const chk = document.getElementById('cartCheckout');
    if (chk && !chk.__fs_safeOpen){
      chk.addEventListener('click', ()=>{
        close('cartOverlay');
        open('checkoutOverlay');
        try{ window.updateCheckoutBreakdown?.(); }catch{}
      }, {passive:true});
      chk.__fs_safeOpen = true;
    }
  }
  guardOpeners();

})();
</script>

<script>
/* ============================================================
   FitSnacks -- Chunk 8/8 (Cart + Totals + Badge + Reorder)
   Purpose: make cart reliable and prevent stale totals forever
   Safe/idempotent: yes
============================================================ */
(function(){
  if (window.__FS_CART_CORE_FIXED__) return;
  window.__FS_CART_CORE_FIXED__ = true;

  /* ----- Keys / helpers (reuse existing if present) ----- */
  const CART_KEY       = window.CART_KEY       || 'fitsnacks.cart.v1';
  const ORDERS_KEY     = window.ORDERS_KEY     || 'fitsnacks.orders';
  const DELIVERED_KEY  = window.DELIVERED_KEY  || 'fitsnacks.orders.delivered';

  const fmt = window.fmt || (n => '$' + Number(n || 0).toFixed(2));
  const $   = s => document.querySelector(s);
  const $$  = s => Array.from(document.querySelectorAll(s));

  function loadOrders(){ try{ return JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]'); }catch{ return []; } }
  function saveOrders(list){ try{ localStorage.setItem(ORDERS_KEY, JSON.stringify(list||[])); }catch{} }
  function loadDelivered(){ try{ return JSON.parse(localStorage.getItem(DELIVERED_KEY)||'[]'); }catch{ return []; } }

  function loadCartMap(){
    try {
      const raw = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
      return new Map(Array.isArray(raw) ? raw : []);
    } catch { return new Map(); }
  }
  function saveCartMap(map){
    try { localStorage.setItem(CART_KEY, JSON.stringify(Array.from(map.entries()))); } catch {}
  }

  /* ----- Global cart Map (hydrate or reuse) ----- */
  window.cart = (window.cart instanceof Map) ? window.cart : loadCartMap();

  /* ----- Core totals from cart (single source of truth) ----- */
  function cartTotals(){
    let count = 0, subtotal = 0;
    for (const [, it] of window.cart){
      const q = Number(it.qty||0);
      const p = Number(it.price||0);
      count += q;
      subtotal += p * q;
    }
    return { count, subtotal };
  }

  /* ----- Badge + drawer render ----- */
  function refreshBadge(){
    const { count } = cartTotals();
    const b = $('#cartBadge'); if (!b) return;
    if (count > 0){
      b.textContent = String(count);
      b.style.display = 'inline-flex';
    } else {
      b.style.display = 'none';
    }
  }
  window.refreshBadge = window.refreshBadge || refreshBadge;

  function renderCart(){
    const content = $('#cartContent');
    const totalEl = $('#cartTotal');

    // Always compute fresh
    const lines = [];
    for (const [name, info] of window.cart){
      const line = Number(info.price||0) * Number(info.qty||0);
      lines.push({ name, price:Number(info.price||0), qty:Number(info.qty||0), line });
    }

    if (content){
      if (!lines.length){
        content.innerHTML = '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
      } else {
        content.innerHTML = lines.map(l => `
          <div class="row-between" style="margin-top:6px">
            <div style="display:flex;gap:10px;align-items:center">
              <button data-act="-" data-name="${l.name}" class="ghost" style="padding:4px 8px">−</button>
              <div style="min-width:24px;text-align:center">${l.qty}</div>
              <button data-act="+" data-name="${l.name}" class="ghost" style="padding:4px 8px">+</button>
              <button data-act="x" data-name="${l.name}" class="ghost" style="padding:4px 8px" title="Remove">✕</button>
              <div style="font-weight:700;margin-left:8px">${l.name}</div>
            </div>
            <div style="font-weight:700">${fmt(l.line)}</div>
          </div>
        `).join('');
      }
    }

    const total = lines.reduce((s,l)=>s+l.line,0);
    if (totalEl) totalEl.textContent = fmt(total);

    saveCartMap(window.cart);
    refreshBadge();
    syncStickyBar();
  }
  window.renderCart = window.renderCart || renderCart;

  /* ----- Sticky cart bar (optional if present) ----- */
  function syncStickyBar(){
    const bar = $('#cartBar');
    if (!bar) return;
    const { count, subtotal } = cartTotals();
    if (count > 0){
      $('#cartBarTotal') && ($('#cartBarTotal').textContent = fmt(subtotal));
      bar.classList.add('show');
    } else {
      bar.classList.remove('show');
    }
  }

  /* ----- Quantity +/-/remove (single delegated handler) ----- */
  if (!window.__FS_QTY_BOUND__){
    window.__FS_QTY_BOUND__ = true;
    document.addEventListener('click', (e)=>{
      const b = e.target.closest('button'); if (!b) return;
      if (!b.hasAttribute('data-act') || !b.hasAttribute('data-name')) return;

      const name = b.getAttribute('data-name');
      const act  = b.getAttribute('data-act');
      const row  = window.cart.get(name); if (!row) return;

      if (act === '+') row.qty = Math.min(99, Number(row.qty||0) + 1);
      if (act === '-') row.qty = Math.max(1, Number(row.qty||0) - 1);
      if (act === 'x') { window.cart.delete(name); }

      renderCart();
    }, {passive:true});
  }

  /* ----- Add buttons (card + product sheet) with guards ----- */
  function openProductSheetFromCard(card){
    // relies on your existing sheet code; just dispatch the click safely
    const title = card?.dataset?.name || 'Item';
    const price = Number(card?.dataset?.price || 0);
    const img   = card?.dataset?.img || '';
    // Fill fields if your app uses these:
    const t = $('#sheetTitle'), p = $('#sheetPrice'), i = $('#sheetImg');
    if (t) t.textContent = title;
    if (p) p.textContent = fmt(price);
    if (i){ i.src = img; i.alt = title; }
    $('#qtyVal') && ($('#qtyVal').textContent = '1');
    $('#sheetAdd') && ($('#sheetAdd').textContent = 'Add • ' + fmt(price));
    $('#productSheet')?.classList.add('show');
  }

  function bindCardAddButtons(){
    $$('.card .add').forEach(btn=>{
      if (btn.__fs_add_bound) return;
      btn.__fs_add_bound = true;

      // Short click opens product sheet (quantity picker)
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        const card = btn.closest('.card');
        if (!card) return;
        openProductSheetFromCard(card);
      });
    });
  }
  bindCardAddButtons();

  // Product sheet +/- and Add
  (function bindSheetQty(){
    const plus = $('#qtyPlus'), minus = $('#qtyMinus'), add = $('#sheetAdd');
    const qtyEl = $('#qtyVal'), priceEl = $('#sheetPrice');

    if (plus && !plus.__fs_bound){
      plus.addEventListener('click', ()=>{
        const cur = Math.max(1, parseInt(qtyEl?.textContent||'1',10));
        const next = Math.min(99, cur+1);
        if (qtyEl) qtyEl.textContent = String(next);
        const unit = Number((priceEl?.textContent||'$0').replace(/[^0-9.]/g,'')||0);
        if (add) add.textContent = 'Add • ' + fmt(unit * next);
      }, {passive:true});
      plus.__fs_bound = true;
    }
    if (minus && !minus.__fs_bound){
      minus.addEventListener('click', ()=>{
        const cur = Math.max(1, parseInt(qtyEl?.textContent||'1',10));
        const next = Math.max(1, cur-1);
        if (qtyEl) qtyEl.textContent = String(next);
        const unit = Number((priceEl?.textContent||'$0').replace(/[^0-9.]/g,'')||0);
        if (add) add.textContent = 'Add • ' + fmt(unit * next);
      }, {passive:true});
      minus.__fs_bound = true;
    }
    if (add && !add.__fs_bound){
      add.addEventListener('click', ()=>{
        // read the current item from the sheet title/price
        const name = $('#sheetTitle')?.textContent?.trim() || '';
        const unit = Number((priceEl?.textContent||'$0').replace(/[^0-9.]/g,'')||0);
        const qty  = Math.max(1, parseInt(qtyEl?.textContent||'1',10));
        if (!name || !unit) return;

        const entry = window.cart.get(name) || { price: unit, qty: 0 };
        entry.price = unit;               // keep price current
        entry.qty   = Math.min(99, Number(entry.qty||0) + qty);
        window.cart.set(name, entry);

        saveCartMap(window.cart);
        renderCart();

        // open cart to show result
        $('#productSheet')?.classList.remove('show');
        $('#cartOverlay')?.classList.add('show');
        window.showToast?.(`Added ${qty} × ${name}`);
      }, {passive:true});
      add.__fs_bound = true;
    }
  })();

  /* ----- ‘Re-order last’ reliability ----- */
  (function bindReorder(){
    const btn = $('#reorderLast');
    if (!btn || btn.__fs_bound) return;
    btn.addEventListener('click', ()=>{
      const active   = loadOrders();
      const delivered= loadDelivered();
      const src = active[0] || delivered[0];
      if (!src){ window.showToast?.('No previous orders'); return; }
      // replace cart contents with last order
      window.cart = new Map();
      for (const line of (src.lines||[])){
        window.cart.set(line.name, { price:Number(line.price||0), qty:Number(line.qty||0) });
      }
      saveCartMap(window.cart);
      renderCart();
      $('#cartOverlay')?.classList.add('show');
    }, {passive:true});
    btn.__fs_bound = true;
  })();

  /* ----- Cart openers/closers safety (in case earlier code missed) ----- */
  (function guardCartOpeners(){
    const cb = $('#cartBtn');
    if (cb && !cb.__fs_guard){
      cb.addEventListener('click', ()=>{
        $('#checkoutOverlay')?.classList.remove('show');
        $('#settingsOverlay')?.classList.remove('show');
        $('#cartOverlay')?.classList.add('show');
      }, {passive:true});
      cb.__fs_guard = true;
    }
  })();

  /* ----- Observe dynamic card changes and (re)bind add buttons ----- */
  const grid = $('#grid');
  if (grid && !grid.__fs_observer){
    const obs = new MutationObserver(()=> bindCardAddButtons());
    obs.observe(grid, { childList:true, subtree:true });
    grid.__fs_observer = obs;
  }

  /* ----- Initial paint ensures no stale totals or badges ----- */
  renderCart();
})();
</script>