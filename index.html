<script>
  /* ===== PWA (service worker) ===== */
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }

  /* ===== Helpers ===== */
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmt = n => '$' + n.toFixed(2);

  /* ===== Search filter ===== */
  $('#search').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    $$('.card').forEach(c => c.style.display = c.dataset.name.toLowerCase().includes(q) ? '' : 'none');
  });

  /* ===== Carousel pause/resume on interaction ===== */
  const track = document.querySelector('.track');
  ['touchstart','mousedown','pointerdown'].forEach(ev =>
    track.addEventListener(ev, ()=>track.style.animationPlayState='paused', {passive:true})
  );
  ['touchend','mouseup','pointerup','mouseleave'].forEach(ev =>
    track.addEventListener(ev, ()=>track.style.animationPlayState='running')
  );

  /* ===== Persistent Cart ===== */
  const CART_KEY = 'fitsnacks.cart.v1';

  function loadCart(){
    try { return new Map(JSON.parse(localStorage.getItem(CART_KEY) || '[]')); }
    catch(e){ return new Map(); }
  }
  function saveCart(map){
    try { localStorage.setItem(CART_KEY, JSON.stringify(Array.from(map.entries()))); }
    catch(e){}
  }

  let cart = loadCart();

  function refreshBadge(){
    let n = 0; for (const v of cart.values()) n += v.qty;
    const badge = $('#cartBadge');
    if (!badge) return;
    if (n > 0) { badge.textContent = n; badge.style.display = 'inline-flex'; }
    else { badge.style.display = 'none'; }
  }

  function renderCart(){
    let total = 0, html = '';
    for (const [name,info] of cart){
      const line = info.price * info.qty; total += line;
      html += `<div class="row-between" style="margin-top:6px">
        <div style="display:flex;gap:10px;align-items:center">
          <button data-act="-" data-name="${name}" class="ghost" style="padding:4px 8px">−</button>
          <div style="min-width:24px;text-align:center">${info.qty}</div>
          <button data-act="+" data-name="${name}" class="ghost" style="padding:4px 8px">+</button>
          <div style="font-weight:700;margin-left:8px">${name}</div>
        </div>
        <div style="font-weight:700">${fmt(line)}</div>
      </div>`;
    }
    const itemsContainer = $('#cartContent');
    itemsContainer.innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
    $('#cartTotal').textContent = fmt(total);
    saveCart(cart);
    refreshBadge();
  }

  /* +/- quantity inside cart overlay */
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    if (b.matches('[data-act][data-name]')) {
      const name = b.getAttribute('data-name');
      const act  = b.getAttribute('data-act');
      const entry = cart.get(name); if(!entry) return;
      entry.qty = Math.max( act==='+' ? entry.qty+1 : entry.qty-1, 1 );
      renderCart();
    }
  }, {passive:true});

  /* ===== Product quick-add sheet ===== */
  let current = null;
  $$('.add').forEach(b => b.addEventListener('click', e => {
    const card = e.target.closest('.card');
    current = { name: card.dataset.name, price: parseFloat(card.dataset.price) };
    $('#sheetTitle').textContent = current.name;
    $('#sheetPrice').textContent = fmt(current.price);
    $('#qtyVal').textContent = 1;
    $('#sheetAdd').textContent = 'Add • ' + fmt(current.price);
    $('#productSheet').classList.add('show');
  }));

  $('#qtyPlus').addEventListener('click', ()=>{
    let n = Math.min(99, parseInt($('#qtyVal').textContent) + 1);
    $('#qtyVal').textContent = n;
    $('#sheetAdd').textContent = 'Add • ' + fmt(current.price * n);
  });
  $('#qtyMinus').addEventListener('click', ()=>{
    let n = Math.max(1, parseInt($('#qtyVal').textContent) - 1);
    $('#qtyVal').textContent = n;
    $('#sheetAdd').textContent = 'Add • ' + fmt(current.price * n);
  });

  function closeSheet(){ $('#productSheet').classList.remove('show'); }
  $('#sheetCancel').addEventListener('click', closeSheet);
  $('#sheetClose').addEventListener('click', closeSheet);

  $('#sheetAdd').addEventListener('click', ()=>{
    const n = parseInt($('#qtyVal').textContent);
    const e = cart.get(current.name) || { price: current.price, qty: 0 };
    e.qty += n; cart.set(current.name, e);
    closeSheet();
    renderCart();
    $('#cartOverlay').classList.add('show');
  });

  /* ===== Overlays open/close ===== */
  function openCart(){ $('#cartOverlay')?.classList.add('show'); }
  function closeCart(){ $('#cartOverlay')?.classList.remove('show'); }
  function openSettings(goAdmin){
    $('#settingsOverlay').classList.add('show');
    const unlocked = localStorage.getItem('fitsnacks.admin.unlocked') === '1';
    if (goAdmin || unlocked) {
      $('#tabGeneral').classList.remove('active'); $('#tabAdmin').classList.add('active');
      $('#panelGeneral').style.display='none'; $('#panelAdmin').style.display='block';
      if (unlocked){ $('#adminLogin').style.display='none'; $('#adminContent').style.display='block'; loadAdminPanel(); }
    } else {
      $('#tabGeneral').classList.add('active'); $('#tabAdmin').classList.remove('active');
      $('#panelGeneral').style.display='block'; $('#panelAdmin').style.display='none';
    }
  }
  function closeSettings(){ $('#settingsOverlay').classList.remove('show'); }

  document.addEventListener('click', (e)=>{
    if (e.target.closest('#cartBtn')) openCart();
    if (e.target.closest('#cartClose')) closeCart();
    if (e.target.closest('#settingsBtn')) openSettings(false);
    if (e.target.closest('#settingsClose')) closeSettings();
  }, {passive:true});

  /* ===== Admin state & panel ===== */
  function adminKey(){ return 'fitsnacks.admin'; }
  function getAdmin(){ try{return JSON.parse(localStorage.getItem(adminKey())||'{}');}catch(e){return {};} }
  function saveAdmin(obj){ localStorage.setItem(adminKey(), JSON.stringify(obj||{})); }
  function setUnlocked(v){ localStorage.setItem('fitsnacks.admin.unlocked', v?'1':'0'); }

  $('#adminSubmit').addEventListener('click', ()=>{
    if ($('#adminPassword').value === '8TSB077') {
      setUnlocked(true);
      $('#adminLogin').style.display='none';
      $('#adminContent').style.display='block';
      $('#adminError').style.display='none';
      loadAdminPanel();
    } else {
      $('#adminError').style.display='block';
    }
  });
  $('#adminName').addEventListener('input', e=>{ const a=getAdmin(); a.name=e.target.value; saveAdmin(a); });
  $('#meetSpot').addEventListener('input', e=>{ const a=getAdmin(); a.spot=e.target.value; saveAdmin(a); });

  function loadAdminPanel(){
    const a = getAdmin();
    $('#adminName').value = a.name||'';
    $('#meetSpot').value = a.spot||'';
    renderOrders(); // show orders whenever Admin is opened
  }

  /* ===== Orders storage + rendering (Admin) ===== */
  function ordersKey(){ return 'fitsnacks.orders.v1'; }
  function loadOrders(){
    try { return JSON.parse(localStorage.getItem(ordersKey()) || '[]'); }
    catch(e){ return []; }
  }
  function saveOrders(list){
    localStorage.setItem(ordersKey(), JSON.stringify(list || []));
  }
  function renderOrders(){
    const box = $('#ordersList'); if(!box) return;
    const list = loadOrders();
    if (!list.length){ box.textContent = 'No orders yet'; return; }
    box.innerHTML = list.map(o=>{
      const items = o.lines.map(l => `${l.name} × ${l.qty} -- ${fmt(l.price * l.qty)}`).join('<br>');
      const when = new Date(o.when).toLocaleString();
      return `<div style="padding:8px;border-bottom:1px solid #2a2a30">
        <div style="font-weight:700">${when}</div>
        <div style="color:#bbb;margin-top:4px">${o.name} @ ${o.location}</div>
        <div style="margin-top:6px">${items}</div>
        <div style="margin-top:6px;font-weight:700">Total: ${fmt(o.total)}</div>
      </div>`;
    }).join('');
  }

  /* ===== Toast helper ===== */
  function showToast(msg='Order placed!'){
    const el = $('#toast'); if(!el) return;
    el.textContent = msg;
    el.style.opacity = '1';
    el.style.transform = 'translateX(-50%) translateY(-4px)';
    setTimeout(()=>{
      el.style.opacity = '0';
      el.style.transform = 'translateX(-50%) translateY(0)';
    }, 1600);
  }

  /* ===== Checkout flow (keep form, stay on main after submit) ===== */

  // Open Checkout form from Cart
  $('#cartCheckout').addEventListener('click', ()=>{
    $('#checkoutName').value = '';
    $('#checkoutLocation').value = '';
    $('#checkoutError').style.display = 'none';
    closeCart();
    $('#checkoutOverlay').classList.add('show');
  });

  // Close Checkout form
  $('#checkoutClose').addEventListener('click', ()=>{
    $('#checkoutOverlay').classList.remove('show');
  });

  // Submit Checkout form: save order -> clear cart -> close form -> stay on main page
  $('#checkoutSubmit').addEventListener('click', ()=>{
    const name = $('#checkoutName').value.trim();
    const loc  = $('#checkoutLocation').value.trim();
    const err  = $('#checkoutError');

    if (!name || !loc) { err.style.display='block'; return; }
    err.style.display='none';

    // Build order from cart
    const lines = []; let total = 0;
    for (const [n, info] of cart){
      lines.push({ name:n, price:info.price, qty:info.qty });
      total += info.price * info.qty;
    }

    const order = {
      id: Date.now(),
      when: new Date().toISOString(),
      name,
      location: loc,
      lines,
      total
    };

    const list = loadOrders(); list.unshift(order); saveOrders(list);

    cart.clear(); renderCart();
    $('#checkoutOverlay').classList.remove('show');
    showToast('Order placed!');
    // Note: We intentionally DO NOT open Admin automatically.
  });

  /* ===== Accessibility: enter/space activates buttons ===== */
  $$('.btn,.add,.ghost,.primary,.tab').forEach(el=>{
    el.tabIndex = 0;
    el.addEventListener('keydown', e=>{
      if (e.key==='Enter' || e.key===' ') { e.preventDefault(); el.click(); }
    });
  });

  /* ===== Initial render ===== */
  renderCart();
</script>