<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>FitSnacks</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0d">
  <link rel="preload" as="image" href="assets/carousel-1.jpg">
  <link rel="preload" as="image" href="assets/carousel-2.jpg">
  <link rel="preload" as="image" href="assets/carousel-3.jpg">

  <style>
    :root {
      --bg:#0b0b0d;
      --card:rgba(20,20,24,0.6);
      --text:#e9e9ec;
      --muted:#aaa;
      --accent:#6ea8fe;
      --badge:#ff3b30;
      --good:#3cd27f;
      --warn:#ffb020;
      --radius:18px;
      --blur:18px;
      --grid-gap:6px;
      --snap-gap:12px;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    .app{max-width:393px;min-height:100svh;margin:0 auto;padding:12px 12px 32px;box-sizing:border-box}

    /* Glass look + glow */
    .card, .sheet, .btn, .search, .chip, .tab, .ghost, .primary, .field{
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      background: var(--card);
      border:1px solid rgba(255,255,255,0.08);
      box-shadow: 0 4px 24px rgba(0,255,0,0.08);
    }

    /* Header */
    .row{position:relative;display:flex;align-items:center;gap:0}
    .search-wrap{flex:none;width:calc(100% - 200px);}
    .search{width:100%;border-radius:999px;padding:12px 44px;color:var(--text);outline:none;border:1px solid #2a2a2e}
    .search::placeholder{color:#6c6c70}
    .icon-left{position:absolute;left:12px;top:50%;transform:translateY(-50%)}
    .icon-rights{position:absolute; right:8px; top:50%; transform:translateY(-50%); display:flex; gap:10px; margin-left:0}
    .btn{-webkit-appearance:none;appearance:none;border-radius:14px;width:44px;height:44px;padding:0;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    #cartBtn{position:relative;display:flex;align-items:center;justify-content:center}
    .badge{position:absolute;top:-6px;right:-8px;background:var(--badge);color:#fff;border-radius:999px;padding:1px 6px;font-size:12px;font-weight:700;display:none;align-items:center;justify-content:center}
    #cartBtn.bump{animation:bump 300ms ease}
    @keyframes bump{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}

    /* Greeting */
    .greet{margin:8px 2px 2px;color:#c7c7cc;font-size:14px}

    /* Promo – card-snap carousel */
    .carousel{margin:10px 0 6px}
    .snapper{
      height:100px;display:flex;align-items:stretch;gap:var(--snap-gap);
      overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;
      padding:0 var(--snap-gap)
    }
    .snapper::-webkit-scrollbar{display:none}
    .snap-spacer{flex:0 0 7.5%}
    .snap-card{
      position:relative;flex:0 0 85%;scroll-snap-align:center;border-radius:14px;overflow:hidden;
      border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;height:100%
    }
    .banner{width:100%;height:100%;object-fit:contain;display:block}
    .snap-meta{position:absolute;left:10px;bottom:8px;right:10px;display:flex;justify-content:space-between;align-items:end;gap:8px;pointer-events:none}
    .snap-title{font-weight:800;text-shadow:0 1px 6px rgba(0,0,0,.6)}
    .snap-cta{pointer-events:auto}
    .snap-dots{display:flex;justify-content:center;gap:6px;margin-top:6px}
    .snap-dot{width:6px;height:6px;border-radius:999px;background:#2c3447;border:1px solid rgba(255,255,255,.18)}
    .snap-dot.active{background:#7fb1ff}

    /* Chips */
    .chips{display:flex;gap:10px;margin:6px 0 12px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
    .chip.active{outline:2px solid rgba(110,168,254,.5)}

    /* Grid */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{border-radius:var(--radius);padding:12px;position:relative;display:flex;flex-direction:column;min-height:190px}
    .thumb{height:90px;border-radius:12px;overflow:hidden;margin-bottom:8px;display:flex;align-items:center;justify-content:center;background:#0e0e12}
    .thumb img{width:100%;height:100%;object-fit:contain}
    .title{font-weight:700;margin:4px 0 2px;letter-spacing:0.2px}
    .price{color:#c7c7cc;font-weight:600;margin-top:auto}
    .add{position:absolute;right:12px;bottom:12px;background:var(--accent);border:none;color:#001230;border-radius:14px;width:42px;height:42px;font-size:22px;display:flex;align-items:center;justify-content:center;font-weight:800;cursor:pointer}
    .fav{position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:12px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);cursor:pointer}
    .fav.active{background:rgba(255,215,0,.15);box-shadow:0 0 0 1px rgba(255,215,0,.35) inset}

    /* Overlays */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .overlay.show{display:flex}
    .sheet{width:92%;max-width:480px;border-radius:20px;padding:16px}
    #cartOverlay,#checkoutOverlay,#settingsOverlay,#orderSheet{align-items:flex-end}
    #cartOverlay .sheet,#checkoutOverlay .sheet,#settingsOverlay .sheet,#orderSheet .sheet{
      width:100%;border-top-left-radius:24px;border-top-right-radius:24px;border-bottom-left-radius:0;border-bottom-right-radius:0;
      padding-bottom:calc(16px + env(safe-area-inset-bottom));
      transform:translateY(100%);animation:slideUp 220ms ease-out forwards
    }
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .qty{display:flex;align-items:center;gap:10px}
    .qty button{width:36px;height:36px;border-radius:10px;border:1px solid #2a2a30;background:#1c1c22;color:var(--text);font-size:20px;font-weight:700}
    .primary{background:var(--accent);border:0;color:#081425;font-weight:800;border-radius:12px;padding:12px 14px}
    .ghost{border:1px solid #2a2a30;color:#e7e7eb;border-radius:12px;padding:10px 12px;background:#1b1b20}
    .actions{display:flex;gap:10px;margin-top:12px}

    /* Settings + admin */
    .tabs{display:flex;gap:8px;margin:6px 0 12px}
    .tab{padding:8px 10px;border-radius:10px;cursor:pointer;border:1px solid #2a2a30;background:#18181d}
    .tab.active{background:#24242a}
    .sheet-body{max-height:70svh;overflow:auto;padding-right:4px}
    .admin-subtabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
    .subtab{padding:6px 10px;border-radius:10px;cursor:pointer;border:1px solid #2a2a30;background:#18181d;font-size:13px}
    .subtab.active{background:#24242a}
    .admin-list{border:1px solid #2a2a30;border-radius:12px;padding:8px;margin-top:8px}
    .field{display:flex;align-items:center;gap:8px;padding:8px;border-radius:12px}
    .field input{width:72px;padding:8px;border-radius:10px;border:1px solid #2a2a30;background:#101014;color:#e9e9ec}

    /* Heat map */
    .heat-wrap{margin-top:8px}
    .heat-grid{display:grid;grid-template-columns:repeat(24, minmax(10px,1fr));gap:var(--grid-gap)}
    .heat-cell{width:100%;aspect-ratio:1/1;border-radius:6px;background:rgba(110,168,254,0.08)}

    /* Stock badges */
    .badge-wrap{position:absolute;left:12px;bottom:12px;display:flex;gap:6px;align-items:center}
    .stock-badge{background:#0f172acc;color:#dbeafe;border:1px solid #1f2a44;padding:4px 8px;border-radius:10px;font-size:12px}
    .low-badge{background:#2a1a10cc;color:#ffd8b0;border:1px solid #3b2412}

    /* Order sheet priority */
    #orderSheet{z-index:10050}

    /* Analytics UI */
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1)}
    .kpi .label{color:#c7c7cc;font-size:12px}
    .kpi .value{font-weight:800;font-size:18px;margin-top:4px}
    .bar{height:8px;border-radius:6px;background:rgba(255,255,255,.08);overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,#6ea8fe,#3cd27f)}
    .table{margin-top:8px;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
    .rowh,.rowd{display:grid;grid-template-columns:1fr 70px 70px 70px;gap:8px;padding:8px}
    .rowh{background:rgba(255,255,255,.05);font-weight:700}
    .rowd{border-top:1px solid rgba(255,255,255,.06)}
    .spark{width:100%;height:42px;display:block}

    /* Toasts */
    #toastHost{position:fixed;left:0;right:0;bottom:calc(16px + env(safe-area-inset-bottom));display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;z-index:11000}
    .toast{pointer-events:auto;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:rgba(24,24,32,.9);font-weight:600;opacity:0;transform:translateY(8px);transition:opacity .22s ease,transform .22s ease}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <div class="app" role="application">
    <!-- Header -->
    <div class="row">
      <div class="search-wrap">
        <span class="icon-left" aria-hidden="true">🔍</span>
        <input id="search" class="search" placeholder="Search snacks…" autocomplete="off">
      </div>
      <div class="icon-rights">
        <button type="button" class="btn" id="cartBtn" aria-label="Open cart">
          🛒 <span id="cartBadge" class="badge">0</span>
        </button>
        <button type="button" class="btn" id="settingsBtn" aria-label="Open settings">⚙️</button>
      </div>
    </div>

    <!-- Greeting -->
    <div id="greet" class="greet">Welcome 👋</div>

    <!-- Promo (card-snap carousel) -->
    <div class="carousel" aria-label="Promotions">
      <div id="snapper" class="snapper" aria-roledescription="carousel">
        <div class="snap-spacer" aria-hidden="true"></div>
        <!-- promo cards injected by JS -->
        <div class="snap-spacer" aria-hidden="true"></div>
      </div>
      <div id="snapDots" class="snap-dots" aria-hidden="true"></div>
    </div>

    <!-- Chips -->
    <div class="chips" id="chips">
      <div class="chip" data-filter="">all</div>
      <div class="chip" data-filter="vegan">vegan</div>
      <div class="chip" data-filter="gluten-free">gluten-free</div>
      <div class="chip" data-filter="protein">protein</div>
      <div class="chip" data-filter="favorites">favorites</div>
    </div>

    <!-- Products -->
    <div id="grid" class="grid" role="list">
      <div class="card" role="listitem" data-name="Potato Chips" data-price="2.50" data-img="assets/product-funyuns.jpg" data-tags="snack">
        <button class="fav" aria-label="Favorite"><span>⭐</span></button>
        <div class="thumb"><img src="assets/product-funyuns.jpg" alt="Potato Chips" loading="lazy"></div>
        <div class="title">Potato Chips</div>
        <div class="price">$2.50</div>
        <button class="add" aria-label="Add Potato Chips">+</button>
      </div>

      <div class="card" role="listitem" data-name="Protein Bar" data-price="2.99" data-img="assets/product-chesters.jpg" data-tags="protein">
        <button class="fav" aria-label="Favorite"><span>⭐</span></button>
        <div class="thumb"><img src="assets/product-chesters.jpg" alt="Protein Bar" loading="lazy"></div>
        <div class="title">Protein Bar</div>
        <div class="price">$2.99</div>
        <button class="add" aria-label="Add Protein Bar">+</button>
      </div>

      <div class="card" role="listitem" data-name="Trail Mix" data-price="3.49" data-img="assets/product-cheetos.jpg" data-tags="vegan,gluten-free">
        <button class="fav" aria-label="Favorite"><span>⭐</span></button>
        <div class="thumb"><img src="assets/product-cheetos.jpg" alt="Trail Mix" loading="lazy"></div>
        <div class="title">Trail Mix</div>
        <div class="price">$3.49</div>
        <button class="add" aria-label="Add Trail Mix">+</button>
      </div>
    </div>
  </div> <!-- /.app -->

  <!-- Product mini sheet -->
  <div id="productSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Add item">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3 id="sheetTitle">Item</h3>
        <div class="ghost" id="sheetClose">Close</div>
      </div>
      <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
        <div style="width:88px;height:88px;border-radius:12px;overflow:hidden;border:1px solid #2a2a30;">
          <img id="sheetImg" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div style="flex:1">
          <div id="sheetPrice" class="price" style="font-size:18px;"></div>
          <div id="sheetStock" style="margin-top:6px;color:#c7c7cc;font-size:13px;">Stock: --</div>
          <div id="sheetLowWarn" style="display:none;margin-top:6px;color:#ff6b6b;font-weight:600;font-size:13px;">Low stock</div>
        </div>
      </div>
      <div class="row-between" style="margin-top:10px;">
        <div class="qty">
          <button id="qtyMinus">−</button>
          <div id="qtyVal">1</div>
          <button id="qtyPlus">+</button>
        </div>
        <button class="primary" id="sheetAdd">Add</button>
      </div>
    </div>
  </div>

  <!-- Order details sheet -->
  <div id="orderSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Order details">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Order</h3>
        <div class="ghost" id="orderClose">Close</div>
      </div>
      <div id="orderMeta" style="margin-top:6px;color:#c7c7cc;font-size:13px">–</div>
      <div id="orderLines" class="admin-list" style="margin-top:8px">–</div>
      <div class="row-between" style="margin-top:10px;">
        <strong>Total</strong><strong id="orderTotal">$0.00</strong>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button class="ghost" id="orderCancel">Cancel</button>
        <button class="primary" id="orderDelivered">Mark Delivered</button>
      </div>
    </div>
  </div>

  <!-- Cart bottom-sheet -->
  <div id="cartOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Cart">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Cart</h3>
        <div class="ghost" id="cartBack">Back</div>
      </div>
      <div id="cartContent" class="sheet-body">Cart is empty</div>
      <div class="row-between" style="margin-top:10px;">
        <strong>Total</strong><strong id="cartTotal">$0.00</strong>
      </div>
      <div class="actions">
        <button class="ghost" id="reorderLast">Re-order last</button>
        <button class="primary" id="cartCheckout">Checkout</button>
      </div>
    </div>
  </div>

  <!-- Checkout bottom-sheet (with Promo, Tips, Notes) -->
  <div id="checkoutOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Checkout">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Checkout</h3>
        <div class="ghost" id="checkoutClose">Close</div>
      </div>

      <div class="sheet-body">
        <!-- Profile -->
        <div style="margin-top:6px;">Your name:</div>
        <input id="checkoutName" class="field" style="width:100%;padding:10px;border-radius:10px">
        <div style="margin-top:10px;">Where are you on campus?</div>
        <input id="checkoutLocation" class="field" style="width:100%;padding:10px;border-radius:10px">

        <!-- Promo -->
        <div style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div class="field-inline" style="flex:1">
            <input id="checkoutPromo" placeholder="Promo code" class="field" style="flex:1;min-width:0;padding:10px;border-radius:10px">
            <button class="ghost" id="checkoutApplyPromo">Apply</button>
          </div>
          <div id="promoStatus" class="badge-pill" style="display:none"></div>
        </div>

        <!-- Tip -->
        <div style="margin-top:12px;">Tip (optional)</div>
        <div class="tip-group" id="tipGroup">
          <button class="tip-btn" data-tip="none">No tip</button>
          <button class="tip-btn" data-tip="amount:1">$1</button>
          <button class="tip-btn" data-tip="amount:2">$2</button>
          <button class="tip-btn" data-tip="percent:10">10%</button>
          <div class="field-inline" style="margin-left:auto">
            <input id="tipCustomAmount" type="number" min="0" step="0.5" placeholder="Custom $" class="field" style="width:110px">
            <button class="ghost" id="tipApplyCustom">Set</button>
          </div>
        </div>

        <!-- Notes -->
        <div style="margin-top:12px;">Delivery notes (optional)</div>
        <textarea id="checkoutNotes" class="notes" placeholder="e.g., Meet at library entrance, 2nd floor."></textarea>

        <!-- Breakdown -->
        <div class="breakdown" style="margin-top:12px">
          <div class="break-row"><div class="muted">Subtotal</div><div id="ckSub">$0.00</div></div>
          <div class="break-row"><div class="muted">Discount</div><div id="ckDisc">-$0.00</div></div>
          <div class="break-row"><div class="muted">Tip</div><div id="ckTip">$0.00</div></div>
          <div class="break-row" style="font-weight:800"><div>Total</div><div id="ckTotal">$0.00</div></div>
        </div>

        <div id="checkoutError" style="display:none;color:#ff6b6b;margin-top:10px;">Please fill both fields.</div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="primary" id="checkoutSubmit">Place Order</button>
      </div>
    </div>
  </div>

  <!-- Settings bottom-sheet -->
  <div id="settingsOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Settings">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Settings</h3>
        <div class="ghost" id="settingsClose">Close</div>
      </div>

      <div class="tabs" role="tablist" aria-label="Settings Tabs">
        <button id="tabGeneral" class="tab active" role="tab" aria-selected="true" aria-controls="panelGeneral">General</button>
        <button id="tabAdmin" class="tab" role="tab" aria-selected="false" aria-controls="panelAdmin">Admin</button>
      </div>

      <div class="sheet-body">
        <!-- General -->
        <div id="panelGeneral" role="tabpanel" aria-labelledby="tabGeneral">
          <div style="display:flex;gap:12px">
            <div class="ghost">Dark Mode (disabled)</div>
            <div class="ghost">Notifications (disabled)</div>
          </div>
        </div>

        <!-- Admin -->
        <div id="panelAdmin" role="tabpanel" aria-labelledby="tabAdmin" style="display:none">
          <!-- Login -->
          <div id="adminLogin">
            <div style="margin-top:6px;">Admin password:</div>
            <input id="adminPassword" type="password" class="field" style="width:100%;padding:10px;border-radius:10px">
            <div id="adminError" style="display:none;color:#ff6b6b;margin-top:6px;">Wrong password.</div>
            <div class="actions" style="margin-top:12px;">
              <button class="primary" id="adminSubmit">Unlock</button>
            </div>
          </div>

          <!-- Content (locked until unlock) -->
          <div id="adminContent" style="display:none">
            <div class="admin-subtabs">
              <button class="subtab active" data-subtab="orders">Orders</button>
              <button class="subtab" data-subtab="inventory">Inventory</button>
              <button class="subtab" data-subtab="analytics">Analytics</button>
              <button class="subtab" data-subtab="history">History</button>
            </div>

            <div style="margin:4px 0 8px;display:flex;gap:8px;align-items:center;">
              <button class="ghost" id="adminLock" style="padding:6px 10px">Lock Admin</button>
              <div id="adminState" style="font-size:12px;color:#c7c7cc">
                State: <strong id="adminStateVal">unknown</strong>
              </div>
            </div>

            <!-- Orders -->
            <div id="subtab-orders">
              <div style="margin-top:6px;font-weight:700">Orders</div>
              <div id="ordersList" class="admin-list">No orders yet</div>
            </div>

            <!-- Inventory -->
            <div id="subtab-inventory" style="display:none">
              <div style="margin-top:6px;font-weight:700">Inventory (Stock & Low)</div>
              <div id="inventoryList" class="admin-list">Loading…</div>
            </div>

            <!-- Analytics -->
            <div id="subtab-analytics" style="display:none">
              <div style="margin-top:6px;font-weight:700">Analytics Overview</div>
              <div class="kpis" style="margin-top:8px">
                <div class="kpi"><div class="label">Revenue</div><div id="kpiRevenue" class="value">$0.00</div></div>
                <div class="kpi"><div class="label">Orders</div><div id="kpiOrders" class="value">0</div></div>
                <div class="kpi"><div class="label">AOV</div><div id="kpiAOV" class="value">$0.00</div></div>
                <div class="kpi"><div class="label">Items sold</div><div id="kpiItems" class="value">0</div></div>
              </div>
              <div style="margin-top:12px">
                <div class="label" style="margin-bottom:6px">Revenue (last 7 days)</div>
                <svg id="revSpark" class="spark" viewBox="0 0 100 40" preserveAspectRatio="none" aria-label="Revenue last 7 days"></svg>
              </div>
              <div style="margin-top:12px;font-weight:700">Top Products</div>
              <div class="table">
                <div class="rowh"><div>Product</div><div>Qty</div><div>Revenue</div><div>Conv%</div></div>
                <div id="topProducts"></div>
              </div>
              <div style="margin-top:12px;font-weight:700">Funnel by Product</div>
              <div id="funnels" class="admin-list"></div>
            </div>

            <!-- History -->
            <div id="subtab-history" style="display:none">
              <div class="row-between" style="margin-top:6px;">
                <div style="font-weight:700">Delivered Orders (auto-clears after 3 days)</div>
                <button class="ghost" id="historyClear" style="padding:6px 10px">Clear history now</button>
              </div>
              <div id="historyList" class="admin-list" style="margin-top:8px">No delivered orders</div>
            </div>
          </div> <!-- /#adminContent -->
        </div> <!-- /#panelAdmin -->
      </div> <!-- /.sheet-body -->
    </div>
  </div>

  <!-- Toast host (kept) -->
  <div id="toastHost"></div>

  <script>
    /* Schema + SW */
    const APP_SCHEMA_VERSION=3, SCHEMA_KEY='fitsnacks.schema';
    try{
      const cur=JSON.parse(localStorage.getItem(SCHEMA_KEY)||'0')||0;
      if(cur<APP_SCHEMA_VERSION) localStorage.setItem(SCHEMA_KEY,JSON.stringify(APP_SCHEMA_VERSION));
    }catch{
      localStorage.setItem(SCHEMA_KEY,JSON.stringify(APP_SCHEMA_VERSION));
    }
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'));
    }

    const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));

    /* Keys */
    const CART_KEY='fitsnacks.cart.v1';
    const ORDERS_KEY='fitsnacks.orders';
    const UNLOCK_KEY='fitsnacks.admin.unlocked';
    const STOCK_KEY='fitsnacks.stock.qty';
    const LOW_KEY='fitsnacks.stock.low';
    const STOCK_SET_KEY='fitsnacks.stock.set';
    const SALES_KEY='fitsnacks.sales.buckets';
    const DELIVERED_KEY='fitsnacks.orders.delivered';
    const FAVORITES_KEY='fitsnacks.favorites';
    const PROMOS_KEY='fitsnacks.promos';
    const ANALYTICS_KEY='fitsnacks.analytics.products';
    const PROFILE_NAME_KEY='fitsnacks.profile.name';
    const PROFILE_LOC_KEY='fitsnacks.profile.location';

    const ADMIN_PASSWORD='8TSB077';
    const fmt=n=>'$'+n.toFixed(2);

    /* Load/save helpers */
    function loadCart(){try{return new Map(JSON.parse(localStorage.getItem(CART_KEY)||'[]'))}catch{return new Map()}}
    function saveCart(m){try{localStorage.setItem(CART_KEY,JSON.stringify(Array.from(m.entries())))}catch{}}
    function loadObj(k){try{return JSON.parse(localStorage.getItem(k)||'{}')}catch{return{}}}
    function saveObj(k,o){localStorage.setItem(k,JSON.stringify(o||{}))}
    function loadArr(k){try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return[]}}
    function saveArr(k,a){localStorage.setItem(k,JSON.stringify(a||[]))}
    function loadOrders(){try{return JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]')}catch{return[]}}
    function saveOrders(v){localStorage.setItem(ORDERS_KEY,JSON.stringify(v||[]))}
    function loadDelivered(){try{return JSON.parse(localStorage.getItem(DELIVERED_KEY)||'[]')}catch{return[]}}
    function saveDelivered(v){localStorage.setItem(DELIVERED_KEY,JSON.stringify(v||[]))}
    function loadSales(){
      try{
        const raw=JSON.parse(localStorage.getItem(SALES_KEY)||'null');
        if(raw&&raw.length===7&&raw[0].length===24) return raw;
      }catch{}
      return Array.from({length:7},()=>Array(24).fill(0));
    }
    function saveSales(m){localStorage.setItem(SALES_KEY,JSON.stringify(m))}
    function loadProfile(){return {name:localStorage.getItem(PROFILE_NAME_KEY)||'',loc:localStorage.getItem(PROFILE_LOC_KEY)||''}}
    function saveProfile(n,l){try{localStorage.setItem(PROFILE_NAME_KEY,n||'');localStorage.setItem(PROFILE_LOC_KEY,l||'')}catch{}}

    /* State */
    let cart=loadCart();
    let stockQty=loadObj(STOCK_KEY);
    let stockLow=loadObj(LOW_KEY);
    let stockSet=loadObj(STOCK_SET_KEY); if(!Object.keys(stockSet).length){stockSet={};saveObj(STOCK_SET_KEY,stockSet)}
    let sales=loadSales();
    let favorites=new Set(loadArr(FAVORITES_KEY));
    let prodAnalytics=loadObj(ANALYTICS_KEY);

    function isUnlocked(){return localStorage.getItem(UNLOCK_KEY)==='1'}
    function setUnlocked(v){localStorage.setItem(UNLOCK_KEY,v?'1':'0')}
    setUnlocked(false); // locked by default

    /* Seed promos once */
    if(!localStorage.getItem(PROMOS_KEY)){
      saveArr(PROMOS_KEY, [
        {img:'assets/carousel-1.jpg', title:'Fuel your study grind', cta:'Shop snacks', action:'scrollGrid'},
        {img:'assets/carousel-2.jpg', title:'Protein picks', cta:'Filter: protein', action:'filter', value:'protein'},
        {img:'assets/carousel-3.jpg', title:'Need help?', cta:'Open settings', action:'openSettings'}
      ]);
    }

    /* Utils */
    function haptic(ms=15){try{if(navigator.vibrate)navigator.vibrate(ms)}catch{}}
    function fmtTotal(){let t=0;for(const[,info]of cart)t+=info.price*info.qty;return t}
    function cartItemCount(){let n=0;for(const v of cart.values()) n+=v.qty;return n}
    function showToast(msg,ms=1800){
      const host=$('#toastHost');
      const el=document.createElement('div');
      el.className='toast'; el.textContent=msg;
      host.appendChild(el);
      requestAnimationFrame(()=>el.classList.add('show'));
      setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),250)},ms);
    }
    function updateGreeting(){
      const g=$('#greet'); const p=loadProfile();
      if(g) g.textContent = p.name ? `Hi, ${p.name} 👋` : 'Welcome 👋';
    }
    function updateCartBar(){
      /* Sticky cart bar removed -- keep no-op to avoid breaking calls */
    }

    /* ----- Promos (card-snap carousel) ----- */
    function buildPromos(){
      const data=loadArr(PROMOS_KEY), snapper=$('#snapper'); if(!snapper) return;
      snapper.querySelectorAll('.snap-card').forEach(n=>n.remove());
      const after=snapper.lastElementChild;
      data.forEach(p=>{
        const c=document.createElement('div');
        c.className='snap-card';
        c.innerHTML = `
          <img class="banner" src="${p.img}" alt="${p.title||'promo'}">
          <div class="snap-meta">
            <div class="snap-title">${p.title||''}</div>
            ${p.cta?`<button class="ghost snap-cta">${p.cta}</button>`:''}
          </div>`;
        snapper.insertBefore(c, after);
        if(p.action){
          c.addEventListener('click',e=>{
            if(e.target.closest('.snap-cta')) return;
            promoAction(p);
          }, {passive:true});
          c.querySelector('.snap-cta')?.addEventListener('click',e=>{
            e.stopPropagation(); promoAction(p);
          }, {passive:true});
        }
      });
    }
    function promoAction(p){
      if(p.action==='openSettings'){ $('#settingsOverlay').classList.add('show'); switchTab('general'); }
      if(p.action==='filter'){ activateChip(p.value||''); }
      if(p.action==='scrollGrid'){ document.getElementById('grid')?.scrollIntoView({behavior:'smooth',block:'start'}); }
    }
    function initCarousel(){
      const snapper=$('#snapper'); if(!snapper) return;
      const cards=$$('.snap-card'), dotsWrap=$('#snapDots');
      dotsWrap.innerHTML = cards.map(()=>'<div class="snap-dot"></div>').join('');
      const dots=$$('.snap-dot'), banners=$$('.banner');
      function setDot(i){ dots.forEach((d,k)=>d.classList.toggle('active',k===i)); }
      let idx=0, holdMs=5000, slideMs=3000, paused=false, af=null, tId=null, loaded=0;

      function centerOf(el){ const r=el.getBoundingClientRect(); return r.left+r.width/2; }
      function containerCenter(){ const r=snapper.getBoundingClientRect(); return r.left+r.width/2; }

      function snapTo(i,dur){
        i=(i+cards.length)%cards.length; idx=i; setDot(idx);
        const target=cards[i].offsetLeft-(snapper.clientWidth-cards[i].clientWidth)/2;
        if(dur<=0){ snapper.scrollLeft=target; return; }
        const start=performance.now(), from=snapper.scrollLeft, dist=target-from;
        cancelAnimationFrame(af);
        function step(now){
          const t=Math.min(1,(now-start)/dur);
          const eased = t<.5 ? 4*t*t*t : (t-1)*(2*t-2)*(2*t-2)+1;
          snapper.scrollLeft = from+dist*eased;
          if(t<1 && !paused) af=requestAnimationFrame(step);
        }
        af=requestAnimationFrame(step);
      }
      function autoLoop(){
        if(paused) return;
        tId=setTimeout(()=>{
          if(paused) return;
          snapTo(idx+1, slideMs);
          autoLoop();
        }, holdMs+slideMs);
      }
      function start(){ paused=false; clearTimeout(tId); autoLoop(); }
      function stop(){ paused=true; clearTimeout(tId); cancelAnimationFrame(af); }

      banners.forEach(img=>{
        img.addEventListener('load',mark,{once:true});
        img.addEventListener('error',mark,{once:true});
      });
      function mark(){ loaded++; if(loaded>=banners.length){ start(); } }

      ['pointerdown','touchstart','mousedown','mouseenter'].forEach(ev=>snapper.addEventListener(ev,()=>stop()));
      ['pointerup','touchend','mouseup','mouseleave'].forEach(ev=>snapper.addEventListener(ev,()=>start()));
      snapper.addEventListener('scroll',()=>{
        const c=containerCenter(); let best=Infinity,bestI=0;
        const now=$$('.snap-card');
        now.forEach((card,i)=>{ const d=Math.abs(c-centerOf(card)); if(d<best){best=d;bestI=i} });
        if(bestI!==idx){ idx=bestI; setDot(idx); }
      });
      dots.forEach((dot,i)=>dot.addEventListener('click',()=>{ stop(); snapTo(i,400); start(); }));
      setDot(0); snapTo(0,0);
    }

    /* ----- Search ----- */
    $('#search').addEventListener('input', e=>{
      const q=e.target.value.toLowerCase();
      $$('.card').forEach(c=>c.style.display = c.dataset.name.toLowerCase().includes(q) ? '' : 'none');
    });

    /* ----- Chips + Favorites filter ----- */
    function activateChip(val){
      $$('#chips .chip').forEach(ch=>ch.classList.toggle('active',ch.dataset.filter===val));
      $$('.card').forEach(c=>{
        const tags=(c.dataset.tags||'').toLowerCase();
        const name=c.dataset.name;
        const hit = !val || val==='' || (val==='favorites' ? favorites.has(name) : tags.includes(val));
        c.style.display = hit ? '' : 'none';
      });
    }
    document.getElementById('chips').addEventListener('click', e=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      activateChip(chip.dataset.filter||'');
    }, {passive:true});
    activateChip('');

    /* ----- Cart ----- */
    function refreshBadge(){
      let n=0; for(const v of cart.values()) n+=v.qty;
      const b=$('#cartBadge'); if(!b) return;
      if(n>0){ b.textContent=n; b.style.display='inline-flex'; }
      else { b.style.display='none'; }
    }
    function renderCart(){
      let total=0, html='';
      for(const [name,info] of cart){
        const line=info.price*info.qty; total+=line;
        html += `<div class="row-between" style="margin-top:6px">
          <div style="display:flex;gap:10px;align-items:center">
            <button data-act="-" data-name="${name}" class="ghost" style="padding:4px 8px">−</button>
            <div style="min-width:24px;text-align:center">${info.qty}</div>
            <button data-act="+" data-name="${name}" class="ghost" style="padding:4px 8px">+</button>
            <button data-act="del" data-name="${name}" class="ghost" style="padding:4px 8px" title="Remove"><span aria-hidden="true">🗑️</span></button>
            <div style="font-weight:700;margin-left:8px">${name}</div>
          </div>
          <div style="font-weight:700">${fmt(line)}</div>
        </div>`;
      }
      $('#cartContent').innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
      $('#cartTotal').textContent = fmt(total);
      saveCart(cart); refreshBadge(); updateCartBar();
    }

    document.addEventListener('click', (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      if(b.matches('[data-act][data-name]')){
        const name=b.getAttribute('data-name');
        const act=b.getAttribute('data-act');
        const entry=cart.get(name); if(!entry) return;
        if(act==='+') entry.qty = Math.min(99, entry.qty+1);
        if(act==='-') entry.qty = Math.max(1, entry.qty-1);
        if(act==='del') { cart.delete(name); renderCart(); return; }
        cart.set(name, entry);
        renderCart();
      }
    });

    /* ----- Favorites toggle ----- */
    function syncFavStars(){
      $$('.card').forEach(c=>{
        const f=c.querySelector('.fav'); if(!f) return;
        f.classList.toggle('active', favorites.has(c.dataset.name));
      });
    }
    document.addEventListener('click', e=>{
      const btn=e.target.closest('.fav'); if(!btn) return;
      const card=btn.closest('.card'); if(!card) return;
      const name=card.dataset.name;
      favorites.has(name) ? favorites.delete(name) : favorites.add(name);
      saveArr(FAVORITES_KEY, Array.from(favorites));
      syncFavStars();
    }, {passive:true});

    /* ----- Product mini-sheet + analytics capture ----- */
    let current=null;
    function ensureMetrics(n){
      if(!prodAnalytics[n]) prodAnalytics[n]={opens:0,adds:0,addedQty:0,purchasedQty:0,revenue:0};
      return prodAnalytics[n];
    }
    function openProductSheet(card){
      current={name:card.dataset.name, price:parseFloat(card.dataset.price), img:card.dataset.img};
      $('#sheetTitle').textContent=current.name;
      $('#sheetImg').src=current.img||''; $('#sheetImg').alt=current.name||'';
      $('#sheetPrice').textContent=fmt(current.price);
      $('#qtyVal').textContent=1; $('#sheetAdd').textContent='Add • '+fmt(current.price);

      ensureMetrics(current.name).opens++; saveObj(ANALYTICS_KEY, prodAnalytics);

      if(stockSet[current.name]){
        const q=Number(stockQty[current.name]||0), l=Number(stockLow[current.name]||0);
        $('#sheetStock').textContent='Stock: '+q;
        const w=$('#sheetLowWarn');
        if(l>0 && q<=l){ w.style.display='block'; w.textContent='Low stock ('+q+' ≤ '+l+')'; }
        else { w.style.display='none'; }
      }else{
        $('#sheetStock').textContent='Stock: --'; $('#sheetLowWarn').style.display='none';
      }

      $('#productSheet').classList.add('show');
    }
    $$('.card').forEach(card=>{
      card.addEventListener('click', e=>{
        if(e.target.closest('.add') || e.target.closest('.fav')) return;
        openProductSheet(card);
      });
    });
    $$('.add').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const card=btn.closest('.card'); if(!card) return;
        openProductSheet(card);
      });
    });
    $('#qtyPlus').addEventListener('click', ()=>{
      const n=Math.min(99, parseInt($('#qtyVal').textContent)+1);
      $('#qtyVal').textContent=n; $('#sheetAdd').textContent='Add • '+fmt(current.price*n);
    });
    $('#qtyMinus').addEventListener('click', ()=>{
      const n=Math.max(1, parseInt($('#qtyVal').textContent)-1);
      $('#qtyVal').textContent=n; $('#sheetAdd').textContent='Add • '+fmt(current.price*n);
    });
    function closeProductSheet(){ $('#productSheet').classList.remove('show'); }
    $('#sheetClose').addEventListener('click', closeProductSheet);
    $('#sheetAdd').addEventListener('click', ()=>{
      const n=parseInt($('#qtyVal').textContent)||1;
      const m=ensureMetrics(current.name); m.adds++; m.addedQty+=n; saveObj(ANALYTICS_KEY, prodAnalytics);
      const e=cart.get(current.name)||{price:current.price,qty:0};
      e.qty+=n; cart.set(current.name,e);
      closeProductSheet(); renderCart(); $('#cartOverlay').classList.add('show'); haptic(12);
    });

    /* ----- Overlays open/close ----- */
    function openCart(){ $('#cartOverlay').classList.add('show'); }
    function closeCart(){ $('#cartOverlay').classList.remove('show'); }
    function openSettings(def=false){ $('#settingsOverlay').classList.add('show'); switchTab(def?'admin':'general'); if(def) ensureAdminLoginVisible(); }
    function closeSettings(){ $('#settingsOverlay').classList.remove('show'); }
    $('#cartBtn').addEventListener('click', openCart);
    $('#cartBack').addEventListener('click', closeCart);
    $('#settingsBtn').addEventListener('click', ()=>openSettings(false));
    $('#settingsClose').addEventListener('click', closeSettings);

    /* Re-order last */
    function reorderLast(){
      const active=loadOrders(), hist=loadDelivered();
      const src=active[0]||hist[0];
      if(!src){ showToast('No previous orders'); return; }
      cart=new Map();
      for(const line of src.lines){ cart.set(line.name, {price:line.price, qty:line.qty}); }
      saveCart(cart); renderCart(); openCart(); haptic(12);
    }
    $('#reorderLast').addEventListener('click', reorderLast);

    /* ----- Orders, Delivered/History, Sales ----- */
    function addOrderFromCart(name, location, notes, discount, tip){
      const lines=[]; let subtotal=0;
      for(const [n,info] of cart){
        const line=info.price*info.qty; subtotal+=line; lines.push({name:n, price:info.price, qty:info.qty, line});
        ensureMetrics(n).purchasedQty += info.qty;
        ensureMetrics(n).revenue += line;
      }
      saveObj(ANALYTICS_KEY, prodAnalytics);

      const total = Math.max(0, subtotal - (discount||0)) + (tip||0);

      const order={when:new Date().toISOString(), name, location, notes:notes||'', lines, total, discount:discount||0, tip:tip||0};
      const list=loadOrders(); list.unshift(order); saveOrders(list);

      const d=new Date(), dow=d.getDay(), hr=d.getHours();
      sales[dow][hr]=(sales[dow][hr]||0)+1; saveSales(sales);

      return order;
    }

    function renderOrders(){
      const list=loadOrders(), box=$('#ordersList'); if(!box) return;
      if(!list.length){ box.innerHTML='No orders yet'; return; }
      box.innerHTML = list.map((o,i)=>{
        const items = o.lines.map(l=>`${l.name} × ${l.qty} -- ${fmt(l.line)}`).join('<br>');
        const when = new Date(o.when).toLocaleString();
        return `<div class="order-item" data-idx="${i}" role="button" tabindex="0"
                  style="padding:8px;border-bottom:1px solid #2a2a30;cursor:pointer">
                  <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
                    <div>
                      <div style="font-weight:700">${when}</div>
                      <div style="color:#bbb;margin-top:4px">${o.name} @ ${o.location}</div>
                    </div>
                    <div style="font-weight:700">${fmt(o.total)}</div>
                  </div>
                  <div style="margin-top:6px">${items}</div>
                  ${o.notes?`<div style="margin-top:6px;color:#c7c7cc;font-size:12px">📝 ${o.notes}</div>`:''}
                </div>`;
      }).join('');
    }

    /* ----- Inventory + Badges ----- */
    function getProducts(){ return $$('.card').map(c=>({name:c.dataset.name, price:+c.dataset.price, img:c.dataset.img, tags:(c.dataset.tags||'').toLowerCase()})); }
    function ensureBadgeWrap(card){
      let w=card.querySelector('.badge-wrap');
      if(!w){ w=document.createElement('div'); w.className='badge-wrap'; card.appendChild(w); }
      return w;
    }
    function updateStockBadges(){
      $$('.card').forEach(card=>{
        const name=card.dataset.name, wrap=ensureBadgeWrap(card);
        wrap.innerHTML='';
        if(!stockSet[name]) return; // only show when stock set
        const qty=Number(stockQty[name]||0), low=Number(stockLow[name]||0);
        const b=document.createElement('div'); b.className='stock-badge'; b.textContent='Stock: '+qty; wrap.appendChild(b);
        if(low>0 && qty<=low){
          const l=document.createElement('div'); l.className='stock-badge low-badge'; l.textContent=`Only ${qty} left`; wrap.appendChild(l);
        }
      });
    }
    function refreshMiniIfOpen(){
      const ov=$('#productSheet'); if(!ov||!ov.classList.contains('show')||!current) return;
      const name=current.name;
      if(stockSet[name]){
        const q=Number(stockQty[name]||0), l=Number(stockLow[name]||0);
        $('#sheetStock').textContent='Stock: '+q;
        const lw=$('#sheetLowWarn');
        if(l>0 && q<=l){ lw.style.display='block'; lw.textContent='Low stock ('+q+' ≤ '+l+')'; }
        else { lw.style.display='none'; }
      }else{
        $('#sheetStock').textContent='Stock: --'; $('#sheetLowWarn').style.display='none';
      }
    }

    /* ----- Settings tabs + Admin lock ----- */
    function switchTab(which){
      const tabG=$('#tabGeneral'), tabA=$('#tabAdmin'),
            panG=$('#panelGeneral'), panA=$('#panelAdmin');
      if(which==='admin'){
        tabG.classList.remove('active'); tabG.setAttribute('aria-selected','false');
        tabA.classList.add('active');    tabA.setAttribute('aria-selected','true');
        panG.style.display='none'; panA.style.display='block';
        ensureAdminLoginVisible();
      }else{
        tabA.classList.remove('active'); tabA.setAttribute('aria-selected','false');
        tabG.classList.add('active');    tabG.setAttribute('aria-selected','true');
        panA.style.display='none'; panG.style.display='block';
      }
    }
    function showAdminState(){
      const el=$('#adminStateVal'); if(!el) return;
      el.textContent = isUnlocked() ? 'Unlocked (no password shown)' : 'Locked (password required)';
    }
    function focusAdminPassword(){ const el=$('#adminPassword'); if(el){ el.focus(); el.select && el.select(); } }
    function renderInventory(){
      const wrap=$('#inventoryList'); if(!wrap) return;
      const products=getProducts(); if(!products.length){ wrap.textContent='No products'; return; }
      wrap.innerHTML = products.map(p=>{
        const hasQ=Object.prototype.hasOwnProperty.call(stockQty,p.name);
        const hasL=Object.prototype.hasOwnProperty.call(stockLow,p.name);
        const qty = hasQ ? Number(stockQty[p.name]||0) : '';
        const low = hasL ? Number(stockLow[p.name]||0) : '';
        return `<div class="field" data-prod="${p.name}">
          <div style="flex:1;font-weight:600">${p.name}</div>
          <label style="font-size:12px;color:#c7c7cc">Stock</label>
          <input type="number" min="0" value="${qty}" data-k="qty" placeholder="--">
          <label style="font-size:12px;color:#c7c7cc">Low</label>
          <input type="number" min="0" value="${low}" data-k="low" placeholder="--">
        </div>`;
      }).join('');
    }
    function ensureAdminLoginVisible(){
      const logged=isUnlocked();
      $('#adminLogin').style.display = logged ? 'none' : 'block';
      $('#adminContent').style.display = logged ? 'block' : 'none';
      if(logged){
        renderOrders(); renderInventory(); updateStockBadges(); pruneDelivered(72); renderHistory(); renderAnalytics();
      }else{
        setTimeout(focusAdminPassword,0);
      }
      showAdminState();
    }
    // main tabs
    document.addEventListener('click',(e)=>{
      if(e.target.closest('#tabGeneral')) switchTab('general');
      if(e.target.closest('#tabAdmin'))   switchTab('admin');
    }, {passive:true});
    // admin auth + lock + history clear
    document.addEventListener('click',(e)=>{
      if(e.target.closest('#adminSubmit')){
        const ok = $('#adminPassword').value===ADMIN_PASSWORD;
        if(ok){ setUnlocked(true); $('#adminError').style.display='none'; ensureAdminLoginVisible(); }
        else { $('#adminError').style.display='block'; }
      }
      if(e.target && e.target.id==='adminLock'){ setUnlocked(false); ensureAdminLoginVisible(); }
      if(e.target && e.target.id==='historyClear'){ saveDelivered([]); renderHistory(); }
    }, {passive:true});

    /* ----- Order sheet open/deliver ----- */
    document.addEventListener('click', e=>{
      const row=e.target.closest('.order-item'); if(!row) return;
      openOrderSheet(parseInt(row.getAttribute('data-idx'),10));
    });
    document.addEventListener('keydown', e=>{
      if(e.key!=='Enter' && e.key!==' ') return;
      const row=e.target.closest('.order-item'); if(!row) return;
      e.preventDefault(); openOrderSheet(parseInt(row.getAttribute('data-idx'),10));
    });
    let currentOrderIndex=null;
    function openOrderSheet(idx){
      const orders=loadOrders(); const o=orders[idx]; if(!o) return;
      currentOrderIndex=idx;
      $('#orderMeta').textContent = `${new Date(o.when).toLocaleString()} • ${o.name} @ ${o.location}`;
      $('#orderLines').innerHTML = o.lines.map(l=>`<div class="row-between" style="padding:6px 0"><div>${l.name} × ${l.qty}</div><div style="font-weight:700">${fmt(l.line)}</div></div>`).join('');
      $('#orderTotal').textContent = fmt(o.total);
      const os=$('#orderSheet'); document.body.appendChild(os); os.classList.add('show'); $('#orderClose')?.focus();
    }
    function closeOrderSheet(){ $('#orderSheet').classList.remove('show'); currentOrderIndex=null; }
    $('#orderClose').addEventListener('click', closeOrderSheet);
    $('#orderCancel').addEventListener('click', closeOrderSheet);
    $('#orderDelivered').addEventListener('click', ()=>{
      const idx=currentOrderIndex; if(idx==null) return;
      const active=loadOrders();
      if(idx>=0 && idx<active.length){
        const delivered=active.splice(idx,1)[0];
        delivered.deliveredWhen=new Date().toISOString();
        const hist=loadDelivered(); hist.unshift(delivered);
        saveDelivered(hist); saveOrders(active);
        renderOrders(); renderHistory();
      }
      closeOrderSheet();
    });

    /* ===== Checkout (promos, tips, notes, totals) ===== */
    const PROMO_TABLE = {
      'SAVE10': {type:'percent', value:0.10, label:'10% off sitewide'},
      'BAR1':   {type:'amount',  value:1.00, label:'$1 off protein items', rule:'tag:protein'}
    };
    let activePromo = null;        // {code,type,value,label,rule,discount,ok}
    let activeTip   = {kind:'none', amount:0};
    function evalPromoDiscount(code){
      code=(code||'').trim().toUpperCase();
      if(!code || !PROMO_TABLE[code]) return null;
      const p = PROMO_TABLE[code];
      let subtotal = 0; for(const[,info] of cart) subtotal += info.price*info.qty;
      if(subtotal<=0) return null;
      let discount=0;
      if(p.rule && p.rule.startsWith('tag:')){
        const t = p.rule.slice(4).toLowerCase();
        let eligible = 0;
        $$('.card').forEach(c=>{
          const name=c.dataset.name;
          const tags=(c.dataset.tags||'').toLowerCase();
          const entry=cart.get(name);
          if(!entry) return;
          if(tags.includes(t)) eligible += entry.price*entry.qty;
        });
        if(eligible<=0) return {code, label:`No eligible items for ${code}`, type:'none', value:0, discount:0, ok:false};
        discount = p.type==='percent' ? eligible * p.value : Math.min(p.value, eligible);
      }else{
        discount = p.type==='percent' ? subtotal * p.value : Math.min(p.value, subtotal);
      }
      return {code, type:p.type, value:p.value, label:p.label, rule:p.rule||'', discount:Math.max(0,discount), ok:true};
    }
    function computeTotals(){
      let subtotal=0; for(const[,info] of cart) subtotal+=info.price*info.qty;
      const disc = activePromo?.discount || 0;
      const tip  = Math.max(0, activeTip.amount||0);
      const total = Math.max(0, subtotal - disc) + tip;
      return {subtotal, disc, tip, total};
    }
    function updateCheckoutBreakdown(){
      const {subtotal, disc, tip, total} = computeTotals();
      $('#ckSub').textContent  = fmt(subtotal);
      $('#ckDisc').textContent = `-${fmt(disc)}`;
      $('#ckTip').textContent  = fmt(tip);
      $('#ckTotal').textContent= fmt(total);
    }
    function setTip(kind, amount){
      activeTip = {kind, amount:Math.max(0, +amount||0)};
      $$('#tipGroup .tip-btn').forEach(b=>b.classList.remove('active'));
      if(kind==='none'){
        const btn=[...$('#tipGroup').children].find(el=>el.matches('.tip-btn[data-tip="none"]'));
        btn && btn.classList.add('active');
      }
      updateCheckoutBreakdown();
    }
    function selectQuickTip(btn){
      $$('#tipGroup .tip-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const spec=btn.getAttribute('data-tip')||'none';
      if(spec==='none'){ setTip('none',0); return; }
      const [k,v]=spec.split(':'); const {subtotal, disc}=computeTotals();
      if(k==='percent'){ const base=Math.max(0, subtotal - disc); setTip('percent', base*(+v/100)); }
      if(k==='amount'){ setTip('amount', +v); }
    }
    function openCheckoutWithPrefill(){
      const p=loadProfile();
      $('#checkoutName').value=p.name||'';
      $('#checkoutLocation').value=p.loc||'';
      $('#checkoutError').style.display='none';
      $('#checkoutPromo').value='';
      activePromo=null; const badge=$('#promoStatus'); badge.style.display='none'; badge.textContent='';
      setTip('none',0); $('#tipCustomAmount').value='';
      updateCheckoutBreakdown();
      $('#checkoutOverlay').classList.add('show');
    }
    $('#cartCheckout').addEventListener('click', ()=>{
      if(cartItemCount()<=0){ showToast('Your cart is empty'); return; }
      $('#cartOverlay').classList.remove('show');
      openCheckoutWithPrefill();
    });
    $('#checkoutClose').addEventListener('click', ()=>$('#checkoutOverlay').classList.remove('show'));
    $('#checkoutApplyPromo').addEventListener('click', ()=>{
      const code=$('#checkoutPromo').value;
      const res=evalPromoDiscount(code);
      const badge=$('#promoStatus');
      if(res && res.ok){
        activePromo = res;
        badge.textContent = `${res.code} • ${res.label} • -${fmt(res.discount)}`;
        badge.style.display='inline-flex'; badge.classList.remove('promo-bad'); badge.classList.add('promo-ok');
      }else{
        activePromo = null;
        badge.textContent = res ? (res.label||'Not eligible') : 'Invalid code';
        badge.style.display='inline-flex'; badge.classList.add('promo-bad'); badge.classList.remove('promo-ok');
      }
      updateCheckoutBreakdown();
    });
    document.getElementById('tipGroup').addEventListener('click', e=>{
      const btn=e.target.closest('.tip-btn'); if(!btn) return;
      selectQuickTip(btn);
    }, {passive:true});
    document.getElementById('tipApplyCustom').addEventListener('click', ()=>{
      const v=+($('#tipCustomAmount').value||0);
      setTip('amount', v);
      $$('#tipGroup .tip-btn').forEach(b=>b.classList.remove('active'));
    });
    $('#checkoutSubmit').addEventListener('click', ()=>{
      const name=$('#checkoutName').value.trim();
      const loc=$('#checkoutLocation').value.trim();
      const notes=$('#checkoutNotes').value.trim();
      if(!name || !loc){ $('#checkoutError').style.display='block'; return; }
      saveProfile(name, loc);
      const totals=computeTotals();
      addOrderFromCart(name, loc, notes, totals.disc, totals.tip);
      cart.clear(); renderCart();
      $('#checkoutOverlay').classList.remove('show');
      updateGreeting();
      showToast('Order placed 🎉');
    });

    /* ===== History (auto-prunes) ===== */
    function pruneDelivered(hours){
      const list=loadDelivered();
      const cutoff=Date.now()-hours*3600*1000;
      const keep=list.filter(o=>{
        const t=Date.parse(o.deliveredWhen||o.when||0);
        return isFinite(t) && t>=cutoff;
      });
      if(keep.length!==list.length) saveDelivered(keep);
    }
    function renderHistory(){
      const box=$('#historyList'); if(!box) return;
      pruneDelivered(72);
      const list=loadDelivered();
      if(!list.length){ box.textContent='No delivered orders'; return; }
      box.innerHTML = list.map(o=>{
        const items=o.lines.map(l=>`${l.name} × ${l.qty} -- ${fmt(l.line)}`).join('<br>');
        const placed=new Date(o.when).toLocaleString();
        const del=o.deliveredWhen?new Date(o.deliveredWhen).toLocaleString():'--';
        return `<div style="padding:8px;border-bottom:1px solid #2a2a30">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
            <div>
              <div style="font-weight:700">Delivered: ${del}</div>
              <div style="color:#bbb;margin-top:2px">Placed: ${placed}</div>
              <div style="color:#bbb;margin-top:2px">${o.name} @ ${o.location}</div>
            </div>
            <div style="font-weight:700">${fmt(o.total)}</div>
          </div>
          <div style="margin-top:6px">${items}</div>
          ${o.notes?`<div style="margin-top:6px;color:#c7c7cc;font-size:12px">📝 ${o.notes}</div>`:''}
        </div>`;
      }).join('');
    }

    /* ===== Analytics ===== */
    function fmtMoney(m){ return fmt(m||0); }
    function drawSpark(vals){
      const svg=$('#revSpark'); if(!svg) return;
      const max=Math.max(1,...vals), step=100/(vals.length-1||1);
      const pts=vals.map((v,i)=>`${i*step},${40-(v/max)*36-2}`).join(' ');
      svg.innerHTML = `
        <polyline points="${pts}" fill="none" stroke="url(#g)" stroke-width="2"/>
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0%" stop-color="#6ea8fe"/>
            <stop offset="100%" stop-color="#3cd27f"/>
          </linearGradient>
        </defs>`;
    }
    function renderAnalytics(){
      const orders=loadOrders(), delivered=loadDelivered(), all=orders.concat(delivered);
      let rev=0, items=0;
      all.forEach(o=>{ rev+=o.total; o.lines.forEach(l=>items+=l.qty); });
      const cnt=all.length, aov=cnt?(rev/cnt):0;
      $('#kpiRevenue').textContent=fmtMoney(rev);
      $('#kpiOrders').textContent=cnt;
      $('#kpiAOV').textContent=fmtMoney(aov);
      $('#kpiItems').textContent=items;

      const days=Array(7).fill(0), now=new Date();
      all.forEach(o=>{
        const d=new Date(o.when);
        const diff=Math.floor((now-d)/(24*3600*1000));
        if(diff>=0 && diff<7) days[6-diff]+=o.total;
      });
      drawSpark(days);

      getProducts().forEach(p=>{ if(!prodAnalytics[p.name]) prodAnalytics[p.name]={opens:0,adds:0,addedQty:0,purchasedQty:0,revenue:0}; });
      saveObj(ANALYTICS_KEY, prodAnalytics);

      const rows=Object.entries(prodAnalytics).map(([name,m])=>({
        name, opens:m.opens||0, adds:m.adds||0, addedQty:m.addedQty||0, purchasedQty:m.purchasedQty||0, revenue:m.revenue||0
      }));
      const top=rows.slice().sort((a,b)=>b.revenue-a.revenue).slice(0,8);
      const maxR=Math.max(1,...top.map(r=>r.revenue));
      const maxQ=Math.max(1,...top.map(r=>r.purchasedQty));
      $('#topProducts').innerHTML = top.length ? top.map(r=>{
        const conv = r.opens ? Math.round((r.purchasedQty/r.opens)*100) : 0;
        return `<div class="rowd">
                  <div>${r.name}</div><div>${r.purchasedQty}</div><div>${fmtMoney(r.revenue)}</div><div>${conv}%</div>
                </div>
                <div style="padding:0 8px 8px">
                  <div class="bar"><i style="width:${(r.revenue/maxR)*100}%"></i></div>
                  <div class="bar" style="margin-top:6px"><i style="width:${(r.purchasedQty/maxQ)*100}%"></i></div>
                </div>`;
      }).join('') : '<div class="rowd"><div>No sales yet</div><div></div><div></div><div></div></div>';
      const funnelHtml = rows.map(r=>{
        const a=r.opens||0, b=r.adds||0, c=r.purchasedQty||0;
        const ab=a?Math.round((b/a)*100):0, bc=b?Math.round((c/b)*100):0, ac=a?Math.round((c/a)*100):0;
        return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">
          <div style="font-weight:700">${r.name}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:6px">
            <div>
              <div class="label">Opens</div>
              <div class="value">${a}</div>
              <div class="bar" style="margin-top:4px"><i style="width:${a?100:0}%"></i></div>
            </div>
            <div>
              <div class="label">Adds</div>
              <div class="value">${b} <span style="color:#c7c7cc;font-size:12px">(${ab}% of opens)</span></div>
              <div class="bar" style="margin-top:4px"><i style="width:${a?(b/a)*100:0}%"></i></div>
            </div>
            <div>
              <div class="label">Purchases</div>
              <div class="value">${c} <span style="color:#c7c7cc;font-size:12px">(${bc}% of adds • ${ac}% of opens)</span></div>
              <div class="bar" style="margin-top:4px"><i style="width:${a?(c/a)*100:0}%"></i></div>
            </div>
          </div>
        </div>`;
      }).join('');
      $('#funnels').innerHTML = funnelHtml || '<div>No funnel data yet</div>';
    }

    /* ===== Init ===== */
    function pruneDeliveredInit(){
      const list=loadDelivered();
      const cutoff=Date.now()-72*3600*1000; // 72h
      const keep=list.filter(o=>{
        const t=Date.parse(o.deliveredWhen||o.when||0);
        return isFinite(t)&&t>=cutoff;
      });
      if(keep.length!==list.length) saveDelivered(keep);
    }

    buildPromos();
    initCarousel();
    pruneDeliveredInit();
    renderCart(); refreshBadge(); updateStockBadges(); syncFavStars(); updateGreeting();
  </script>
</body>
</html>