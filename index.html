<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title></title>
  <meta name="theme-color" content="#0b0b0d">
  <!-- v26-restore -->
  <style>
    :root{
      --bg:#0b0b0d; --text:#e9e9ec;
      /* keep the right stop so the bar ends before the white line */
      --right-stop:120px;
    }
    html,body{
      margin:0;height:100%;
      background:var(--bg);color:var(--text);
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    }
    .hdr{padding:10px 0;background:#0b0b0d;position:sticky;top:0;z-index:1;}
    /* flush LEFT, hard stop on RIGHT (like your working v19) */
    .search{margin-left:max(0px, env(safe-area-inset-left));}
    .search input{
      width:calc(
        100vw
        - max(0px, env(safe-area-inset-left))
        - ( max(0px, env(safe-area-inset-right)) + var(--right-stop) )
      );
      display:block;border:0;outline:0;padding:8px 12px;
      color:#fff;background:rgba(255,255,255,.12);border-radius:20px;font-size:.95em;
      -webkit-appearance:none;appearance:none;
    }
    /* cart button next to search */
    .hdr{display:grid;grid-template-columns:1fr 48px;align-items:center;column-gap:12px;
         padding:10px max(0px, env(safe-area-inset-right)) 10px max(0px, env(safe-area-inset-left));}
    .search{margin-left:0;padding-left:0;}
    .search input{width:100%;}
    .cart{width:48px;height:36px;display:flex;align-items:center;justify-content:center;border:0;
          border-radius:18px;background:rgba(255,255,255,.12);color:#fff;font-size:18px;}
    .cart:active{transform:scale(.98);}
    /* mini cart modal */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:saturate(1.2) blur(4px);z-index:20;}
    .overlay.show{display:flex;}
    .sheet{width:min(88vw,420px);max-height:72vh;background:#16161a;color:#e9e9ec;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.45);display:flex;flex-direction:column;overflow:hidden;transform:translateY(10px);opacity:0;transition:transform .18s ease, opacity .18s ease;}
    .overlay.show .sheet{transform:translateY(0);opacity:1;}
    .sheet-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#1c1c21;border-bottom:1px solid rgba(255,255,255,.06);}
    .sheet-title{font-weight:600;}
    .sheet-close{border:0;border-radius:12px;padding:6px 10px;background:rgba(255,255,255,.12);color:#fff;font-size:14px;}
    .sheet-body{padding:14px;overflow:auto;}
    body.lock{overflow:hidden;}
    /* mini cart modal */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:saturate(1.2) blur(4px);z-index:20;}
    .overlay.show{display:flex;}
    .sheet{width:min(88vw,420px);max-height:72vh;background:#16161a;color:#e9e9ec;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.45);display:flex;flex-direction:column;overflow:hidden;transform:translateY(10px);opacity:0;transition:transform .18s ease,opacity .18s ease;}
    .overlay.show .sheet{transform:translateY(0);opacity:1;}
    .sheet-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#1c1c21;border-bottom:1px solid rgba(255,255,255,.06);}
    .sheet-title{font-weight:600;}
    .sheet-close{border:0;border-radius:12px;padding:6px 10px;background:rgba(255,255,255,.12);color:#fff;font-size:14px;}
    .sheet-body{padding:14px;overflow:auto;}
    body.lock{overflow:hidden;}
    /* v38: carousel */
    .carousel{margin:10px auto 0; max-width:680px; padding:0 12px;}
    .carousel-wrap{position:relative; border-radius:14px; overflow:hidden; background:#151515;}
    .track{display:flex; scroll-snap-type:x mandatory; overflow-x:auto; -webkit-overflow-scrolling:touch; scroll-behavior:smooth;}
    .slide{min-width:100%; height:200px; scroll-snap-align:center; position:relative;}
    .slide img{width:100%; height:100%; object-fit:cover; display:block;}
    .dots{display:flex; gap:6px; justify-content:center; padding:8px 0;}
    .dot{width:6px;height:6px;border-radius:50%;background:#5a5a5a;opacity:.6;}
    .dot.active{background:#cfcfcf;opacity:1;}
    @media (min-width:768px){ .slide{height:240px} }
    /* v39: carousel */
    .carousel{margin:10px auto 0;max-width:680px;padding:0 12px;}
    .carousel-wrap{position:relative;border-radius:14px;overflow:hidden;background:#151515;}
    .track{display:flex;scroll-snap-type:x mandatory;overflow-x:auto;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;}
    .slide{min-width:100%;height:200px;scroll-snap-align:center;position:relative;}
    .slide img{width:100%;height:100%;object-fit:cover;display:block;}
    .dots{display:flex;gap:6px;justify-content:center;padding:8px 0;}
    .dot{width:6px;height:6px;border-radius:50%;background:#5a5a5a;opacity:.6;}
    .dot.active{background:#cfcfcf;opacity:1;}
    @media (min-width:768px){.slide{height:240px}}
.prod-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:14px;}
.card{background:rgba(255,255,255,0.05);border-radius:18px;padding:10px 10px 14px;text-align:center;box-shadow:0 4px 14px rgba(0,0,0,0.3);min-height:220px;position:relative;}
.card h3{margin:8px 0 6px;font-size:17px;font-weight:600;}
.card p{color:#ccc;font-size:15px;margin-bottom:14px;}
.card button{background:#6ea8fe;color:white;border:none;border-radius:12px;padding:8px 14px;font-size:18px;box-shadow:0 3px 10px rgba(110,168,254,0.4);}
.card button:active{transform:scale(.96);}
.prod-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:12px;}
.card{background:rgba(255,255,255,0.05);border-radius:14px;padding:10px;text-align:center;}
.card button{background:#6ea8fe;color:#fff;border:none;border-radius:8px;padding:4px 10px;font-size:16px;}
.card h3{margin:6px 0 4px;font-size:16px;}
.card p{margin:0 0 8px;color:#ccc;}
  </style>

.pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:14px;}
.pcard{background:rgba(255,255,255,0.06);border-radius:18px;padding:12px 12px 16px;min-height:230px;box-shadow:0 4px 14px rgba(0,0,0,0.3);position:relative}
.pcard h3{margin:8px 0 6px;font-size:17px;font-weight:600}
.pcard p,.pcard .price{color:#ccc;font-size:15px;margin-bottom:14px}
.pcard button{background:#6ea8fe;color:#fff;border:0;border-radius:12px;padding:8px 14px;font-size:18px;box-shadow:0 3px 10px rgba(110,168,254,.4)}
</head>
<body>
  <header class="hdr">
    <form class="search" role="search" onsubmit="event.preventDefault();">
      <input type="search" name="q" placeholder="Searchâ€¦" autocomplete="off" enterkeyhint="search">
    </form>
    <button class="cart" id="cartBtn" aria-label="Cart">ðŸ›’</button>
  </header>
  <section class="carousel" aria-label="Promos">
    <div class="carousel-wrap">
      <div class="track" id="carTrack" aria-live="polite">
    <div class="slide"><img src="assets/carousel-1.jpg" alt="Cheer" loading="lazy"></div>
    <div class="slide"><img src="assets/carousel-2.jpg" alt="Front" loading="lazy"></div>
    <div class="slide"><img src="assets/carousel-3.jpg" alt="Aerial" loading="lazy"></div>
      </div>
    </div>
    <div class="dots" id="carDots" aria-hidden="true"></div>
  </section>
<section id="products" class="prod-grid">
<div class="card"><h3>Potato Chips</h3><p>$2.50</p><button>+</button></div>
<div class="card"><h3>Protein Bar</h3><p>$2.99</p><button>+</button></div>
<div class="card"><h3>Trail Mix</h3><p>$3.49</p><button>+</button></div>
<div class="card"><h3>Granola Bar</h3><p>$1.99</p><button>+</button></div>
<div class="card"><h3>Greek Yogurt</h3><p>$2.79</p><button>+</button></div>
</section>
  
  <div style="position:fixed;bottom:8px;left:8px;opacity:.35;font-size:12px">v35-trim</div>
  <div style="position:fixed;bottom:8px;left:8px;opacity:.35;font-size:12px">v36-bind</div>
  <script>(function(){var O=document.getElementById("overlay"),B=document.getElementById("cartBtn"),C=document.getElementById("closeBtn"),last=null;function openM(){last=document.activeElement;document.body.classList.add("lock");O.classList.add("show");O.setAttribute("aria-hidden","false");setTimeout(function(){(document.querySelector(".sheet-body")||O).focus();},0);}function closeM(){O.classList.remove("show");O.setAttribute("aria-hidden","true");document.body.classList.remove("lock");if(last&&last.focus)last.focus();}if(B)B.addEventListener("click",openM);if(C)C.addEventListener("click",closeM);if(O)O.addEventListener("click",function(e){if(e.target===O)closeM();});window.addEventListener("keydown",function(e){if(e.key==="Escape")closeM();});})();</script>
  <!-- v37-modal: add centered mini page back -->
  <style>
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:saturate(1.2) blur(4px);z-index:20;}
    .overlay.show{display:flex;}
    .sheet{width:min(88vw,420px);max-height:72vh;background:#16161a;color:#e9e9ec;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.45);display:flex;flex-direction:column;overflow:hidden;transform:translateY(10px);opacity:0;transition:transform .18s ease, opacity .18s ease;}
    .overlay.show .sheet{transform:translateY(0);opacity:1;}
    .sheet-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#1c1c21;border-bottom:1px solid rgba(255,255,255,.06);}
    .sheet-title{font-weight:600;}
    .sheet-close{border:0;border-radius:12px;padding:6px 10px;background:rgba(255,255,255,.12);color:#fff;font-size:14px;}
    .sheet-body{padding:14px;overflow:auto;}
    body.lock{overflow:hidden;}
    /* v38: carousel */
    .carousel{margin:10px auto 0; max-width:680px; padding:0 12px;}
    .carousel-wrap{position:relative; border-radius:14px; overflow:hidden; background:#151515;}
    .track{display:flex; scroll-snap-type:x mandatory; overflow-x:auto; -webkit-overflow-scrolling:touch; scroll-behavior:smooth;}
    .slide{min-width:100%; height:200px; scroll-snap-align:center; position:relative;}
    .slide img{width:100%; height:100%; object-fit:cover; display:block;}
    .dots{display:flex; gap:6px; justify-content:center; padding:8px 0;}
    .dot{width:6px;height:6px;border-radius:50%;background:#5a5a5a;opacity:.6;}
    .dot.active{background:#cfcfcf;opacity:1;}
    @media (min-width:768px){ .slide{height:240px} }
    
    .carousel{margin:10px auto 0;max-width:680px;padding:0 12px;}
    .carousel-wrap{position:relative;border-radius:14px;overflow:hidden;background:#151515;}
    .track{display:flex;scroll-snap-type:x mandatory;overflow-x:auto;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;}
    .slide{min-width:100%;height:200px;scroll-snap-align:center;position:relative;}
    .slide img{width:100%;height:100%;object-fit:cover;display:block;}
    .dots{display:flex;gap:6px;justify-content:center;padding:8px 0;}
    .dot{width:6px;height:6px;border-radius:50%;background:#5a5a5a;opacity:.6;}
    .dot.active{background:#cfcfcf;opacity:1;}
    @media (min-width:768px){.slide{height:240px}}
  </style>

.pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:14px;}
.pcard{background:rgba(255,255,255,0.06);border-radius:18px;padding:12px 12px 16px;min-height:230px;box-shadow:0 4px 14px rgba(0,0,0,0.3);position:relative}
.pcard h3{margin:8px 0 6px;font-size:17px;font-weight:600}
.pcard p,.pcard .price{color:#ccc;font-size:15px;margin-bottom:14px}
.pcard button{background:#6ea8fe;color:#fff;border:0;border-radius:12px;padding:8px 14px;font-size:18px;box-shadow:0 3px 10px rgba(110,168,254,.4)}
  <div class="overlay" id="overlay" aria-hidden="true">
    <section class="sheet" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
      <header class="sheet-head">
        <div class="sheet-title" id="cartTitle">Your Cart</div>
        <button class="sheet-close" id="closeBtn" type="button">Close</button>
      </header>
  
      <div class="sheet-body" tabindex="0"><p>Mini cart goes here.</p></div>
    </section>
  </div>
  <script>(function(){var O=document.getElementById("overlay"),B=document.getElementById("cartBtn"),C=null,last=null;
function bind(){C=document.getElementById("closeBtn"); if(B)B.addEventListener("click",openM); if(C)C.addEventListener("click",closeM);}
function openM(){last=document.activeElement; document.body.classList.add("lock"); O.classList.add("show"); O.setAttribute("aria-hidden","false"); setTimeout(function(){(document.querySelector(".sheet-body")||O).focus();},0);}
function closeM(){O.classList.remove("show"); O.setAttribute("aria-hidden","true"); document.body.classList.remove("lock"); if(last&&last.focus) last.focus();}
if(O&&B){ bind(); O.addEventListener("click",function(e){ if(e.target===O) closeM();}); window.addEventListener("keydown",function(e){ if(e.key==="Escape") closeM();}); }})();</script>
  <div style="position:fixed;bottom:8px;left:8px;opacity:.35;font-size:12px">v37-modal</div>
  <!-- v38-carousel -->
  <script>(function(){
    var t=document.getElementById(carTrack); if(!t) return;
    var slides=[].slice.call(t.querySelectorAll(.slide)); var dots=document.getElementById(carDots);
    slides.forEach(function(_,i){ var d=document.createElement(b); d.className=dot+(i?"":" active"); d.addEventListener(click,function(){ t.scrollTo({left:i*t.clientWidth,behavior:smooth}); }); dots.appendChild(d); });
    function setDot(){ var i=Math.round(t.scrollLeft/t.clientWidth); [].forEach.call(dots.children,function(n,k){ n.classList.toggle(active,k===i); }); }
    t.addEventListener(scroll, function(){ clearTimeout(t._z); t._z=setTimeout(setDot,60); });
    var a=setInterval(function(){ var i=Math.round(t.scrollLeft/t.clientWidth); var nx=(i+1)%slides.length; t.scrollTo({left:nx*t.clientWidth,behavior:smooth}); }, 5000);
    window.addEventListener(visibilitychange, function(){ if(document.hidden) clearInterval(a); });
  })();</script>
  <div style="position:fixed;bottom:8px;left:8px;opacity:.35;font-size:12px">v38-carousel</div>
  <style>.carousel .slide{height:84px}@media (min-width:768px){.carousel .slide{height:120px}}</style>

.pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:14px;}
.pcard{background:rgba(255,255,255,0.06);border-radius:18px;padding:12px 12px 16px;min-height:230px;box-shadow:0 4px 14px rgba(0,0,0,0.3);position:relative}
.pcard h3{margin:8px 0 6px;font-size:17px;font-weight:600}
.pcard p,.pcard .price{color:#ccc;font-size:15px;margin-bottom:14px}
.pcard button{background:#6ea8fe;color:#fff;border:0;border-radius:12px;padding:8px 14px;font-size:18px;box-shadow:0 3px 10px rgba(110,168,254,.4)}
  <!-- v45-height: 94px mobile / 120px tablet (slightly larger) -->
  <style>.carousel .slide{height:94px}@media (min-width:768px){.carousel .slide{height:120px}}</style>

.pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:14px;}
.pcard{background:rgba(255,255,255,0.06);border-radius:18px;padding:12px 12px 16px;min-height:230px;box-shadow:0 4px 14px rgba(0,0,0,0.3);position:relative}
.pcard h3{margin:8px 0 6px;font-size:17px;font-weight:600}
.pcard p,.pcard .price{color:#ccc;font-size:15px;margin-bottom:14px}
.pcard button{background:#6ea8fe;color:#fff;border:0;border-radius:12px;padding:8px 14px;font-size:18px;box-shadow:0 3px 10px rgba(110,168,254,.4)}
  <style>
  /* Edge-to-edge banner (kill inner padding/background) */
  .carousel, .track { padding:0; background:transparent; }
  .slide { margin:0; overflow:hidden; border-radius:16px; }
  .slide img { display:block; width:100%; height:100%; object-fit:cover; }
  </style>

.pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:14px;}
.pcard{background:rgba(255,255,255,0.06);border-radius:18px;padding:12px 12px 16px;min-height:230px;box-shadow:0 4px 14px rgba(0,0,0,0.3);position:relative}
.pcard h3{margin:8px 0 6px;font-size:17px;font-weight:600}
.pcard p,.pcard .price{color:#ccc;font-size:15px;margin-bottom:14px}
.pcard button{background:#6ea8fe;color:#fff;border:0;border-radius:12px;padding:8px 14px;font-size:18px;box-shadow:0 3px 10px rgba(110,168,254,.4)}
  <style>
  /* Fill the rounded card â€“ no inner gap */
  .carousel{padding:0; margin:16px auto; background:transparent; overflow:hidden; border-radius:16px;}
  .track{display:flex; align-items:stretch; gap:0; padding:0; margin:0;}
  .slide{flex:0 0 100%; height:170px; margin:0; overflow:hidden; border-radius:16px;}
  @media (min-width:768px){ .slide{height:200px;} }
  .slide img{display:block; width:100%; height:100%; object-fit:cover;}
  </style>

.pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:14px;}
.pcard{background:rgba(255,255,255,0.06);border-radius:18px;padding:12px 12px 16px;min-height:230px;box-shadow:0 4px 14px rgba(0,0,0,0.3);position:relative}
.pcard h3{margin:8px 0 6px;font-size:17px;font-weight:600}
.pcard p,.pcard .price{color:#ccc;font-size:15px;margin-bottom:14px}
.pcard button{background:#6ea8fe;color:#fff;border:0;border-radius:12px;padding:8px 14px;font-size:18px;box-shadow:0 3px 10px rgba(110,168,254,.4)}
  <style>
  /* FINAL OVERRIDES: kill inner gaps & baseline space */
  .carousel{padding:0!important; margin:16px auto; background:transparent!important; overflow:hidden!important; border-radius:16px!important; box-shadow:none!important;}
  .carousel::before, .carousel::after{display:none!important; content:none!important;}
  .track{display:flex; align-items:stretch; gap:0!important; padding:0!important; margin:0!important;}
  .slide{flex:0 0 100%; height:140px!important; margin:0!important; overflow:hidden!important; border-radius:16px!important; font-size:0!important; line-height:0!important;}
  @media (min-width:768px){ .slide{height:170px!important;} }
  .slide img{display:block!important; width:100%!important; height:100%!important; object-fit:cover!important;}
  </style>

.pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:14px;}
.pcard{background:rgba(255,255,255,0.06);border-radius:18px;padding:12px 12px 16px;min-height:230px;box-shadow:0 4px 14px rgba(0,0,0,0.3);position:relative}
.pcard h3{margin:8px 0 6px;font-size:17px;font-weight:600}
.pcard p,.pcard .price{color:#ccc;font-size:15px;margin-bottom:14px}
.pcard button{background:#6ea8fe;color:#fff;border:0;border-radius:12px;padding:8px 14px;font-size:18px;box-shadow:0 3px 10px rgba(110,168,254,.4)}
<script>(function(){try{var btns=Array.from(document.querySelectorAll("button")).filter(function(b){return b.textContent.trim()==="+";});if(!btns.length)return;var cards=btns.map(function(b){var el=b;while(el&&el.tagName.toLowerCase()!="div")el=el.parentElement;return el;}).filter(Boolean);cards.forEach(function(c){c.classList.add("pcard")});var container=cards[0]&&cards[0].parentElement;while(container&&!cards.every(function(c){return container.contains(c)})){container=container.parentElement}if(container)container.classList.add("pgrid");}catch(e){}})();</script>
</body>
  <!-- v52-autorotate7s-io: observer-based loop 1â†’2â†’3â†’1 -->
<script>(function(){
  var t=document.getElementById("carTrack"); if(!t) return;
  var slides=[].slice.call(t.querySelectorAll(":scope > .slide"));
  if(!slides.length) slides=[].slice.call(t.querySelectorAll(".slide"));
  var L=slides.length; if(!L) return;
  var cur=0;
  function go(i){slides[i].scrollIntoView({behavior:"smooth",inline:"start",block:"nearest"})}
  // Track the slide that is mostly in view using IntersectionObserver
  if("IntersectionObserver" in window){
    var io=new IntersectionObserver(function(es){
      var best=-1,bi=cur; es.forEach(function(e){
        var i=slides.indexOf(e.target); if(e.intersectionRatio>best){best=e.intersectionRatio;bi=i}
      }); cur=bi;
    },{root:t,threshold:[0.6]});
    slides.forEach(function(s){io.observe(s)});
  }else{
    // Fallback: snap from pixels if IO missing
    function W(){return t.clientWidth};
    t.addEventListener("scroll",function(){cur=Math.round(t.scrollLeft/W())},{passive:true});
  }
  function advance(){cur=(cur+1)%L; go(cur)}
  function start(){ stop(); t._auto=setInterval(advance,7000) }
  function stop(){ if(t._auto){clearInterval(t._auto); t._auto=null} }
  document.addEventListener("visibilitychange",function(){ if(document.hidden) stop(); else start() });
  window.addEventListener("resize",function(){ go(cur) });
  start();
})();</script>
<div style="position:fixed;bottom:8px;left:8px;opacity:.35;font-size:12px">v52-autorotate7s-io</div>
<script>(function(){try{var btns=Array.from(document.querySelectorAll("button")).filter(function(b){return b.textContent.trim()==="+";});if(!btns.length)return;var cards=btns.map(function(b){var el=b;while(el&&el.tagName.toLowerCase()!="div")el=el.parentElement;return el;}).filter(Boolean);cards.forEach(function(c){c.classList.add("pcard")});var container=cards[0]&&cards[0].parentElement;while(container&&!cards.every(function(c){return container.contains(c)})){container=container.parentElement}if(container)container.classList.add("pgrid");}catch(e){}})();</script>
</body>
rage Keys ---------- */
  const CART_KEY        = 'fitsnacks.cart.v1';
  const FAVORITES_KEY   = 'fitsnacks.favorites.v1';
  const PROMOS_KEY      = 'fitsnacks.promos.v1';
  const PROFILE_NAME_KEY= 'fitsnacks.profile.name';
  const PROFILE_LOC_KEY = 'fitsnacks.profile.location';
  const UNLOCK_KEY      = 'fitsnacks.admin.unlocked';
  const STOCK_KEY       = 'fitsnacks.stock.v1';
  const ORDERS_KEY      = 'fitsnacks.orders.v1';
  const LAST_ORDER_KEY  = 'fitsnacks.lastorder.v1';
  const DELIVERED_KEY   = 'fitsnacks.orders.delivered';

  /* ---------- External (optional) ---------- */
  const IFTTT_EVENT = 'Fitsnack_order';
  const IFTTT_KEY   = 'REPLACE_WITH_IFTTT_KEY';
  const IFTTT_URL   = `https://maker.ifttt.com/trigger/${IFTTT_EVENT}/with/key/${IFTTT_KEY}`;
  const ADMIN_PASSWORD = '8TSB077';

  /* ---------- Toasts ---------- */
  function showToast(msg, ms = 1800){
    const host = $('#toastHost'); if(!host) return;
    const el = document.createElement('div');
    el.className = 'toast'; el.textContent = msg;
    host.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 250); }, ms);
  }

  /* ---------- Persistent state ---------- */
  let cart      = new Map(JSON.parse(localStorage.getItem(CART_KEY) || '[]'));
  let favorites = new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]'));
  let promo     = null;
  let tip       = { type:'none', value:0 };
  let stock     = {};
  let orders    = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]');

  /* ---------- Stock ---------- */
  const DEFAULT_STOCK = {
    'Potato Chips': 20,'Protein Bar': 18,'Trail Mix': 15,'Granola Bar': 24,
    'Doritos Flaminâ€™ Hot Nacho': 30,'Greek Yogurt': 12,'Mixed Nuts': 14,
    'Fruit Cup': 10,'Energy Drink': 16,'Chocolate Bar': 22
  };
  (function seedStock(){
    try{
      const cur = JSON.parse(localStorage.getItem(STOCK_KEY) || 'null');
      stock = cur && typeof cur === 'object' ? cur : {...DEFAULT_STOCK};
    }catch{ stock = {...DEFAULT_STOCK}; }
    localStorage.setItem(STOCK_KEY, JSON.stringify(stock));
  })();
  function saveStock(){ localStorage.setItem(STOCK_KEY, JSON.stringify(stock)); }
  function getStock(name){ return stock[name] ?? 0; }
  function setStock(name, qty){ stock[name] = Math.max(0, qty|0); saveStock(); applyOOSClasses(); }

  function applyOOSClasses(){
    $$('.card').forEach(card => {
      const s = getStock(card.dataset.name);
      card.classList.toggle('oos', (s||0) <= 0);
      const add = card.querySelector('.add'); if(add) add.disabled = (s||0) <= 0;
    });
  }

  /* ---------- Greeting & Profile ---------- */
  function updateGreeting(){
    const name = (localStorage.getItem(PROFILE_NAME_KEY) || '').trim();
    $('#greet') && ($('#greet').textContent = name ? `Hi, ${name} ðŸ‘‹` : 'Welcome ðŸ‘‹');
  }
  /* ---------- Carousel ---------- */
  function buildPromos(){
    const snapper = $('#snapper'); if(!snapper) return;
    let data = [];
    try{ data = JSON.parse(localStorage.getItem(PROMOS_KEY) || '[]'); }catch{}
    if(!data.length){
      data = [
        {img:'assets/carousel-1.jpg', title:'Fuel your study grind', cta:'Shop snacks', action:'scrollGrid'},
        {img:'assets/carousel-2.jpg', title:'Protein picks',       cta:'Filter: protein', action:'filter', value:'protein'},
        {img:'assets/carousel-3.jpg', title:'Need help?',          cta:'Open settings', action:'openSettings'}
      ];
      localStorage.setItem(PROMOS_KEY, JSON.stringify(data));
    }
    snapper.querySelectorAll('.snap-card').forEach(n => n.remove());
    const after = snapper.lastElementChild;
    data.forEach(p => {
      const c = document.createElement('div');
      c.className = 'snap-card';
      c.innerHTML = `<img class="banner" src="${p.img}" alt="${p.title}">
        <div class="snap-meta"><div class="snap-title">${p.title}</div>
        ${p.cta ? `<button class="ghost snap-cta" type="button">${p.cta}</button>` : ''}</div>`;
      snapper.insertBefore(c, after);
      c.addEventListener('click', e => {
        if(e.target.closest('.snap-cta')) return;
        if(p.action === 'scrollGrid') $('#grid')?.scrollIntoView({behavior:'smooth'});
        if(p.action === 'filter') activateChip(p.value || '');
        if(p.action === 'openSettings'){ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); }
      }, {passive:true});
      c.querySelector('.snap-cta')?.addEventListener('click', e => {
        e.stopPropagation();
        if(p.action === 'filter') activateChip(p.value || '');
        if(p.action === 'openSettings'){ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); }
        if(p.action === 'scrollGrid') $('#grid')?.scrollIntoView({behavior:'smooth'});
      });
    });

    const cards = $$('.snap-card');
    const dotsWrap = $('#snapDots'); if(!dotsWrap) return;
    dotsWrap.innerHTML = cards.map(() => '<div class="snap-dot"></div>').join('');
    const dots = $$('.snap-dot');
    const spacerLeft = snapper.firstElementChild;
    function setDot(i){ dots.forEach((d, k) => d.classList.toggle('active', k === i)); }
    function scrollToCard(i, smooth = true){
      const targetLeft = cards[i].offsetLeft - spacerLeft.offsetLeft;
      if(smooth) snapper.scrollTo({ left: targetLeft, behavior:'smooth' }); else snapper.scrollLeft = targetLeft;
      setDot(i);
    }
    dots.forEach((d, i) => d.addEventListener('click', () => scrollToCard(i, true)));
    setDot(0);

    // autoplay with interaction guard
    let idx = 0, hold = 5000, slide = 3000, start = null, phase = 'hold';
    let userInteracting = false, lastInteract = 0, inView = true;
    const INTERACT_COOLDOWN = 3500;
    ['pointerdown','wheel','touchstart','mousedown','scroll'].forEach(ev =>
      snapper.addEventListener(ev, () => { userInteracting = true; lastInteract = Date.now(); }, {passive:true})
    );
    const obs = new IntersectionObserver((ents) => { inView = ents.some(e => e.isIntersecting); }, { threshold:0.2 });
    obs.observe(snapper);
    let from = 0, to = 0;
    function step(ts){
      if(!cards.length || !inView) return requestAnimationFrame(step);
      if(userInteracting && (Date.now() - lastInteract) < INTERACT_COOLDOWN){ start = ts; return requestAnimationFrame(step); }
      if(!start) start = ts;
      const elapsed = ts - start;
      if(phase === 'hold'){
        if(elapsed >= hold){
          phase = 'slide'; start = ts; from = snapper.scrollLeft;
          idx = (idx + 1) % cards.length; to = cards[idx].offsetLeft - spacerLeft.offsetLeft;
        }
      }else{
        const t = Math.min(1, (ts - start) / slide);
        const e = t < .5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 8) / 2;
        snapper.scrollLeft = from + (to - from) * e;
        if(t >= 1){ phase = 'hold'; start = ts; setDot(idx); }
      }
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }
  /* ---------- Cart ---------- */
  function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(Array.from(cart.entries()))); }
  function refreshBadge(){
    let n = 0; for(const v of cart.values()) n += (v?.qty || 0);
    const badge = $('#cartBadge'); if(!badge) return;
    if(n > 0){ badge.textContent = String(n); badge.style.display = 'inline-flex'; }
    else { badge.style.display = 'none'; }
  }
  function renderCart(){
    let total = 0, html = '';
    for(const [name, info] of cart){
      const line = (info.price || 0) * (info.qty || 0);
      total += line;
      html += `<div class="row-between" style="margin-top:6px">
        <div style="display:flex;gap:10px;align-items:center">
          <button data-act="-" data-name="${name}" class="ghost" type="button" aria-label="Decrease">âˆ’</button>
          <div style="min-width:24px;text-align:center">${info.qty}</div>
          <button data-act="+" data-name="${name}" class="ghost" type="button" aria-label="Increase">+</button>
          <div style="font-weight:700;margin-left:8px">${name}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <div style="font-weight:700">${fmt(line)}</div>
          <button data-remove="${name}" class="ghost" type="button" style="padding:2px 6px;font-size:12px">x</button>
        </div>
      </div>`;
    }
    $('#cartContent') && ($('#cartContent').innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>');
    $('#cartTotal') && ($('#cartTotal').textContent = fmt(total));
  }

  /* Delegate +/âˆ’ and remove in cart */
  document.addEventListener('click', e => {
    const b = e.target.closest('button[data-act][data-name]');
    if(b){
      const name = b.getAttribute('data-name');
      const act  = b.getAttribute('data-act');
      const entry = cart.get(name);
      if(entry){
        entry.qty = Math.max( (act === '+') ? entry.qty + 1 : entry.qty - 1, 0 );
        if(entry.qty === 0) cart.delete(name);
        saveCart(); renderCart(); refreshBadge();
      }
      return;
    }
    const rm = e.target.closest('button[data-remove]');
    if(rm){
      const name = rm.getAttribute('data-remove');
      if(cart.has(name)){ cart.delete(name); saveCart(); renderCart(); refreshBadge(); }
      return;
    }
  }, {passive:true});

  function openCart(){ $('#cartOverlay')?.classList.add('show'); }
  function closeCart(){ $('#cartOverlay')?.classList.remove('show'); }
  $('#cartBtn')?.addEventListener('click', openCart);
  $('#cartBack')?.addEventListener('click', closeCart);
  /* ---------- Favorites ---------- */
  function saveFavs(){ localStorage.setItem(FAVORITES_KEY, JSON.stringify(Array.from(favorites))); }
  function syncFavStars(){
    $$('.card').forEach(card => card.querySelector('.fav')?.classList.toggle('active', favorites.has(card.dataset.name)));
  }
  document.addEventListener('click', e => {
    const fav = e.target.closest('.fav'); if(!fav) return;
    e.stopPropagation();
    const card = fav.closest('.card'); if(!card) return;
    const name = card.dataset.name;
    if(favorites.has(name)) favorites.delete(name); else favorites.add(name);
    saveFavs(); syncFavStars();
    const activeFilter = $('#chips .chip.active')?.dataset.filter;
    if(activeFilter === 'favorites' && !favorites.has(name)){
      card.classList.add('hidden-by-filter'); searchAndFilter();
    }
  }, {passive:true});

  /* ---------- Search & Filter ---------- */
  function shouldShowForChip(val, card){
    if(!val) return true;
    if(val === 'favorites') return favorites.has(card.dataset.name);
    if(val === 'stock') return (getStock(card.dataset.name) || 0) > 0;
    const tags = (card.dataset.tags || '').toLowerCase();
    return tags.includes(val);
  }
  function activateChip(val){
    $$('#chips .chip').forEach(ch => ch.classList.toggle('active', ch.dataset.filter === val));
    $$('.card').forEach(c => c.classList.toggle('hidden-by-filter', !shouldShowForChip(val, c)));
    searchAndFilter();
  }
  function searchAndFilter(){
    const q = ($('#search')?.value || '').toLowerCase();
    $$('.card').forEach(c => {
      const hitsName = c.dataset.name.toLowerCase().includes(q);
      const visible = !c.classList.contains('hidden-by-filter') && hitsName;
      c.style.display = visible ? '' : 'none';
    });
  }
  $('#chips')?.addEventListener('click', e => {
    const chip = e.target.closest('.chip'); if(!chip) return;
    activateChip(chip.dataset.filter || '');
  });
  $('#search')?.addEventListener('input', searchAndFilter);

  /* ---------- Product Sheet ---------- */
  let currentProduct = null;
  function openProductSheet(card){
    currentProduct = { name: card.dataset.name, price: parseFloat(card.dataset.price), img: card.dataset.img };
    $('#sheetTitle') && ($('#sheetTitle').textContent = currentProduct.name);
    if($('#sheetImg')){ $('#sheetImg').src = currentProduct.img || ''; $('#sheetImg').alt = currentProduct.name || ''; }
    $('#sheetPrice') && ($('#sheetPrice').textContent = fmt(currentProduct.price));
    const s = getStock(currentProduct.name);
    $('#sheetStock') && ($('#sheetStock').textContent = 'Stock: ' + s);
    $('#sheetLowWarn') && ($('#sheetLowWarn').style.display = s > 0 && s <= 3 ? 'block' : 'none');
    $('#qtyVal') && ($('#qtyVal').textContent = '1');
    $('#sheetAdd') && ($('#sheetAdd').textContent = 'Add â€¢ ' + fmt(currentProduct.price));
    $('#productSheet')?.classList.add('show');
  }
  function closeProductSheet(){ $('#productSheet')?.classList.remove('show'); }
  $('#sheetClose')?.addEventListener('click', closeProductSheet);
  $('#qtyPlus')?.addEventListener('click', () => {
    let n = parseInt($('#qtyVal')?.textContent || '1', 10);
    n = Math.min(99, n + 1);
    $('#qtyVal') && ($('#qtyVal').textContent = n);
    $('#sheetAdd') && ($('#sheetAdd').textContent = 'Add â€¢ ' + fmt(n * (currentProduct?.price || 0)));
  });
  $('#qtyMinus')?.addEventListener('click', () => {
    let n = parseInt($('#qtyVal')?.textContent || '1', 10);
    n = Math.max(1, n - 1);
    $('#qtyVal') && ($('#qtyVal').textContent = n);
    $('#sheetAdd') && ($('#sheetAdd').textContent = 'Add â€¢ ' + fmt(n * (currentProduct?.price || 0)));
  });
  $('#sheetAdd')?.addEventListener('click', () => {
    if(!currentProduct) return;
    const qty = parseInt($('#qtyVal')?.textContent || '1', 10);
    const s = getStock(currentProduct.name);
    if(s <= 0){ showToast('Out of stock'); return; }
    if(qty > s){ showToast('Not enough stock'); return; }
    const entry = cart.get(currentProduct.name) || { price: currentProduct.price, qty:0 };
    entry.qty += qty; cart.set(currentProduct
  /* ---------- Promo & Tip ---------- */
  function parsePromo(code){
    code = (code || '').trim().toUpperCase();
    if(!code) return null;
    const mPct = code.match(/(SAVE|PCT)(\d{1,2})/);
    if(mPct) return { type:'percent', value: Math.min(50, parseInt(mPct[2],10)) };
    const mAmt = code.match(/(OFF|\$)(\d{1,3})/);
    if(mAmt) return { type:'amount', value: Math.min(50, parseInt(mAmt[2],10)) };
    return null;
  }
  function computeTotals(){
    let subtotal = 0;
    for(const [, i] of cart) subtotal += i.price * i.qty;
    let disc = 0;
    if(promo){
      if(promo.type === 'percent') disc = subtotal * (promo.value / 100);
      else if(promo.type === 'amount') disc = Math.min(subtotal, promo.value);
    }
    let tipVal = 0;
    if(tip.type === 'amount') tipVal = tip.value;
    else if(tip.type === 'percent') tipVal = (subtotal - disc) * (tip.value / 100);
    const total = Math.max(0, subtotal - disc) + tipVal;
    return { subtotal, disc, tip: tipVal, total };
  }
  function updateCheckoutBreakdown(){
    const { subtotal, disc, tip: tipVal, total } = computeTotals();
    $('#ckSub')  && ($('#ckSub').textContent  = fmt(subtotal));
    $('#ckDisc') && ($('#ckDisc').textContent = `-${fmt(disc)}`);
    $('#ckTip')  && ($('#ckTip').textContent  = fmt(tipVal));
    $('#ckTotal')&& ($('#ckTotal').textContent= fmt(total));
  }
  $('#checkoutPromo')?.addEventListener('input', e => {
    promo = parsePromo(e.target.value);
    $('#promoStatus') && ($('#promoStatus').textContent = promo ? (promo.type === 'percent' ? `Applying ${promo.value}% off` : `Applying $${promo.value} off`) : '');
    updateCheckoutBreakdown();
  });
  $$('.tip-btn').forEach(btn => btn.addEventListener('click', () => {
    const spec = btn.getAttribute('data-tip') || 'none';
    if(spec === 'none') tip = { type:'none', value:0 };
    else if(spec.startsWith('amount'))  tip = { type:'amount',  value: parseFloat(spec.split(':')[1]) || 0 };
    else if(spec.startsWith('percent')) tip = { type:'percent', value: parseFloat(spec.split(':')[1]) || 0 };
    updateCheckoutBreakdown(); showToast('Tip updated');
  }));

  /* ---------- Checkout Flow ---------- */
  function openCheckout(){
    const name = localStorage.getItem(PROFILE_NAME_KEY) || '';
    const loc  = localStorage.getItem(PROFILE_LOC_KEY) || '';
    $('#checkoutName') && ($('#checkoutName').value = name);
    $('#checkoutLocation') && ($('#checkoutLocation').value = loc);
    updateCheckoutBreakdown();
    $('#checkoutOverlay')?.classList.add('show');
  }
  function closeCheckout(){ $('#checkoutOverlay')?.classList.remove('show'); }
  $('#cartCheckout')?.addEventListener('click', () => {
    if(cart.size === 0){ showToast('Cart is empty'); return; }
    closeCart(); openCheckout();
  });
  $('#checkoutBack')?.addEventListener('click', () => { closeCheckout(); openCart(); });
  $('#checkoutClose')?.addEventListener('click', closeCheckout);

  async function writeOrderToFirestore(order){
    try{
      const { db } = window.__fs || {};
      if(!db) return null;
      const ref = await addDoc(collection(db, 'orders'), {
        when: serverTimestamp(),
        name: order.name,
        location: order.loc,
        lines: order.lines,
        total: order.total,
        status: 'active'
      });
      return ref.id;
    }catch(e){ console.warn('Firestore write failed', e); return null; }
  }
  async function placeOrder(){
    if(cart.size === 0){ showToast('Cart is empty'); return; }
    const name = ($('#checkoutName')?.value || '').trim();
    const loc  = ($('#checkoutLocation')?.value || '').trim();
    if(!name || !loc){ showToast('Add your name and location'); return; }

    localStorage.setItem(PROFILE_NAME_KEY, name);
    localStorage.setItem(PROFILE_LOC_KEY, loc);
    updateGreeting();

    const lines = Array.from(cart.entries()).map(([k,v]) => ({ name:k, qty:v.qty, price:v.price, line: v.qty*v.price }));
    const { subtotal, disc, tip: tipVal, total } = computeTotals();
    const order = {
      id: 'FS-' + Date.now(),
      at: new Date().toISOString(),
      name, loc, promo, tip, subtotal, discount: disc, total,
      lines
    };

    orders.push(order);
    localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
    localStorage.setItem(LAST_ORDER_KEY, JSON.stringify(order));

    // Optional IFTTT webhook (only if key is set)
    if(IFTTT_KEY && IFTTT_KEY !== 'REPLACE_WITH_IFTTT_KEY'){
      try{
        await fetch(IFTTT_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            value1: `${order.id} | ${name} @ ${loc} | ${fmt(total)}`,
            value2: lines.map(l => `${l.qty}Ã— ${l.name}`).join(', '),
            value3: promo ? (promo.type==='percent' ? `${promo.value}% off` : `$${promo.value} off`) : ''
          })
        });
      }catch(err){ console.warn('IFTTT post failed', err); }
    }

    cart.clear(); saveCart(); renderCart(); refreshBadge();
    closeCheckout(); showToast('Order placed ðŸŽ‰');

    if(isAdminUnlocked()){
      renderAdminOrders(); updateKpis(); buildHeatMap(); appendHistoryEvent(order);
    }
  }
  $('#checkoutPlace')?.addEventListener('click', placeOrder);

  /* Re-order last */
  $('#reorderLast')?.addEventListener('click', () => {
    const last = JSON.parse(localStorage.getItem(LAST_ORDER_KEY) || 'null');
    if(!last || !Array.isArray(last.lines) || !last.lines.length){ showToast('No previous order'); return; }
    for(const l of last.lines){
      const s = getStock(l.name);
      const qty = Math.min(l.qty, s);
      if(qty <= 0) continue;
      const entry = cart.get(l.name) || { price: l.price, qty:0 };
      entry.qty += qty; cart.set(l.name, entry);
      setStock(l.name, s - qty);
    }
    saveCart(); renderCart(); refreshBadge(); openCart(); showToast('Added last order items');
  });
  /* ---------- Settings & Admin ---------- */
  function switchTab(which){
    const gen = $('#settingsGeneral'), adm = $('#settingsAdmin');
    const tg = $('#tabGeneral'), ta = $('#tabAdmin');
    const isGen = which !== 'admin';
    gen && (gen.style.display = isGen ? '' : 'none');
    adm && (adm.style.display = isGen ? 'none' : '');
    tg && tg.classList.toggle('active', isGen);
    ta && ta.classList.toggle('active', !isGen);
  }
  $('#settingsBtn')?.addEventListener('click',()=>{ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); });
  $('#settingsClose')?.addEventListener('click',()=>$('#settingsOverlay')?.classList.remove('show'));
  $('#tabGeneral')?.addEventListener('click', ()=> switchTab('general'));
  $('#tabAdmin')?.addEventListener('click',   ()=> switchTab('admin'));
  $('#profileSave')?.addEventListener('click', ()=>{
    const n = ($('#profileName')?.value || '').trim();
    const l = ($('#profileLoc')?.value || '').trim();
    if(n) localStorage.setItem(PROFILE_NAME_KEY, n);
    if(l) localStorage.setItem(PROFILE_LOC_KEY, l);
    updateGreeting(); showToast('Saved');
  });

  function isAdminUnlocked(){ return localStorage.getItem(UNLOCK_KEY) === '1'; }
  function ensureAdminLoginVisible(){
    const area = $('#adminArea'); if(!area) return;
    area.style.display = isAdminUnlocked() ? '' : 'none';
  }
  $('#adminUnlock')?.addEventListener('click', ()=>{
    const pass = $('#adminPass')?.value || '';
    if(pass === ADMIN_PASSWORD){
      localStorage.setItem(UNLOCK_KEY,'1');
      ensureAdminLoginVisible(); buildAdminSubtabs(); buildAdminStockTable(); renderAdminOrders(); updateKpis(); buildHeatMap(); renderHistory();
      showToast('Admin unlocked');
    } else showToast('Wrong password');
  });
  $('#openSettingsFromPrompt')?.addEventListener('click', ()=>{
    $('#adminPrompt')?.classList.remove('show');
    $('#settingsOverlay')?.classList.add('show'); switchTab('admin');
  });

  /* ---- Admin Subtabs (fallbacks OK) ---- */
  const DEFAULT_SUBTABS = [
    { id:'stock',   label:'Stock',    panel:'adminStock'   },
    { id:'orders',  label:'Orders',   panel:'adminOrders'  },
    { id:'heat',    label:'Analytics (Heat Map)', panel:'adminHeat' },
    { id:'history', label:'History',  panel:'adminHistory' },
    { id:'promos',  label:'Promos',   panel:'adminPromos'  },
  ];
  async function loadSubtabsJSON(urls=[
    'assets/settings-tabs.json',
    'assets/admin.json',
    'assets/settings.json',
    'assets/ui.json'
  ]){
    for(const url of urls){
      try{
        const r = await fetch(url, {cache:'no-store'});
        if(!r.ok) continue;
        const j = await r.json();
        if(j?.admin?.subtabs?.length){
          return j.admin.subtabs.map(x => ({ id:x.id||x.panelId||x.label, label:x.label||x.id, panel:x.panelId||x.id }));
        }
        if(Array.isArray(j?.tabs)){
          const admin = j.tabs.find(t => String(t.id||t.label).toLowerCase().startsWith('admin'));
          if(admin?.subtabs?.length){
            return admin.subtabs.map(x => ({ id:x.id||x.panelId||x.label, label:x.label||x.id, panel:x.panelId||x.id }));
          }
        }
        if(Array.isArray(j?.adminSubtabs)) {
          return j.adminSubtabs.map(x => ({ id:x.id||x, label:x.label||x, panel:x.panelId||x.id||x }));
        }
      }catch{}
    }
    return DEFAULT_SUBTABS;
  }
  function setActiveSubtab(id){
    $$('.subtab').forEach(b => b.classList.toggle('active', b.dataset.sub === id));
    $('#adminStock')?.setAttribute('style','display:none;');
    $('#adminOrders')?.setAttribute('style','display:none;');
    $('#adminHeat')?.setAttribute('style','display:none;');
    $('#adminHistory')?.setAttribute('style','display:none;');
    $('#adminPromos')?.setAttribute('style','display:none;');
    if(id==='stock')   $('#adminStock').style.display='';
    if(id==='orders')  $('#adminOrders').style.display='';
    if(id==='heat')    $('#adminHeat').style.display='';
    if(id==='history') $('#adminHistory').style.display='';
    if(id==='promos')  $('#adminPromos').style.display='';
  }
  async function buildAdminSubtabs(){
    const bar = $('#adminSubtabs'); if(!bar) return;
    const tabs = await loadSubtabsJSON();
    bar.innerHTML = tabs.map((t,i)=>`<button class="subtab${i===0?' active':''}" data-sub="${t.id}" type="button">${t.label}</button>`).join('');
    bar.addEventListener('click', e=>{
      const b = e.target.closest('.subtab'); if(!b) return;
      setActiveSubtab(b.dataset.sub);
      if(b.dataset.sub==='orders') renderAdminOrders();
      if(b.dataset.sub==='stock')  buildAdminStockTable();
      if(b.dataset.sub==='heat')   buildHeatMap();
      if(b.dataset.sub==='history')renderHistory();
    }, {passive:true});
    setActiveSubtab(tabs[0]?.id || 'stock');
    showToast('Admin tabs: ' + tabs.map(t=>t.label).join(', '), 2200);
  }

  /* ---- Inventory helpers: pop-on-card ---- */
  function getCardByName(name){
    return [...document.querySelectorAll('.card')].find(c => c.dataset.name === name);
  }
  function flashCardNote(name, text = 'Saved'){
    const card = getCardByName(name);
    if(!card) return;
    const note = document.createElement('div');
    note.className = 'card-pop';
    note.textContent = text;
    card.appendChild(note);
    setTimeout(()=> note.remove(), 1000);
  }
  function pulseCard(name){
    const card = getCardByName(name);
    if(!card) return;
    card.classList.add('pulse');
    setTimeout(()=> card.classList.remove('pulse'), 400);
  }

  /* ---- Admin: Stock editor (editable list of products) ---- */
  function buildAdminStockTable(){
    const host = $('#adminStock'); if(!host) return;
    const names = Object.keys(stock).length ? Object.keys(stock) :
      [...$$('.card')].map(c => c.dataset.name);
    const rows = names.sort().map(n => `
      <div class="rowd" style="display:grid;grid-template-columns:1fr 90px 70px 70px;gap:8px;">
        <div>${n}</div>
        <div><input type="number" min="0" value="${getStock(n)}" data-stock="${n}" style="width:100%;padding:6px;border-radius:8px;background:#111;border:1px solid #2a2a30;color:#fff;"></div>
        <div><button class="ghost" data-stock-save="${n}" type="button">Save</button></div>
        <div><button class="ghost" data-stock-zero="${n}" type="button">Zero</button></div>
      </div>`).join('');
    host.innerHTML = `
      <div class="rowh" style="display:grid;grid-template-columns:1fr 90px 70px 70px;gap:8px;">
        <div>Item</div><div>Stock</div><div></div><div></div>
      </div>${rows}`;
  }
  /* Handle Save / Zero in Inventory and pop on card */
  document.addEventListener('click', e => {
    const s = e.target.closest('button[data-stock-save]');
    if(s){
      const name = s.getAttribute('data-stock-save');
      const input = $('#adminStock')?.querySelector(`[data-stock="${CSS.escape(name)}"]`);
      const val = parseInt(input?.value || '0', 10);
      setStock(name, isFinite(val) ? val : 0);
      showToast('Stock updated');

      // Pop on product card + pulse
      flashCardNote(name, `Stock: ${Math.max(0, val|0)}`);
      pulseCard(name);

      // Refresh dependent views
      renderAdminOrders(); updateKpis(); buildHeatMap();
      return;
    }
    const z = e.target.closest('button[data-stock-zero]');
    if(z){
      const name = z.getAttribute('data-stock-zero');
      setStock(name, 0);
      showToast('Stock zeroed');

      flashCardNote(name, 'Stock: 0');
      pulseCard(name);

      renderAdminOrders(); updateKpis(); buildHeatMap();
      return;
    }
  }, {passive:true});

  /* ---- Admin: Orders view (tap to detail) ---- */
  function renderAdminOrders(){
    const host = $('#adminOrders'); if(!host) return;
    if(!orders.length){
      host.innerHTML = '<div style="color:#c7c7cc;">No orders yet.</div>';
      return;
    }
    host.innerHTML = orders.slice().reverse().map((o,i) => `
      <div class="order-item" data-idx="${i}" data-id="${o.id||''}" style="padding:8px;border-bottom:1px solid #2a2a30;cursor:pointer">
        <div style="font-weight:700">${new Date(o.at||o.when).toLocaleString()}</div>
        <div>${o.name} @ ${o.loc||o.location}</div>
        <div style="font-weight:700">Total ${fmt(o.total)}</div>
        <div class="muted">Status: ${o.status||'active'}</div>
      </div>
    `).join('');
  }

  function openOrderSheetByIndex(idx){
    const o = orders.slice().reverse()[idx]; if(!o) return;
    $('#orderMeta').textContent=`${new Date(o.at||o.when).toLocaleString()} â€¢ ${o.name} @ ${o.loc||o.location}`;
    $('#orderLines').innerHTML=(o.lines||[]).map(l=>`
      <div class="row-between" style="padding:6px 0">
        <div>${l.name} Ã— ${l.qty}</div><div style="font-weight:700">${fmt(l.line || l.price*l.qty)}</div>
      </div>`).join('');
    $('#orderTotal').textContent=fmt(o.total||0);
    $('#orderSheet').dataset.id = o.id||'';
    $('#orderSheet').dataset.idx = String(idx);
    document.body.appendChild($('#orderSheet'));
    $('#orderSheet').classList.add('show');
  }

  document.addEventListener('click', e=>{
    const row=e.target.closest('.order-item');
    if(row) openOrderSheetByIndex(parseInt(row.dataset.idx,10));
  }, {passive:true});

  $('#orderClose')?.addEventListener('click', ()=>$('#orderSheet').classList.remove('show'));
  $('#orderCancel')?.addEventListener('click', ()=>$('#orderSheet').classList.remove('show'));

  $('#orderDelivered')?.addEventListener('click', async ()=>{
    const idx = parseInt($('#orderSheet').dataset.idx||'-1',10);
    const list = orders.slice().reverse();
    const o = list[idx]; if(!o) return;

    o.status='delivered';

    // Add to delivered history (local)
    const hist=JSON.parse(localStorage.getItem(DELIVERED_KEY)||'[]'); 
    hist.unshift(o);
    localStorage.setItem(DELIVERED_KEY, JSON.stringify(hist));

    // Write back to original order array (reverse mapping)
    orders = list.slice().reverse();
    localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));

    // Try Firestore status update (best-effort)
    try{
      if(o.id && window.__fs?.db){
        const { db } = window.__fs;
        await updateDoc(doc(db,'orders',o.id), { status:'delivered' });
      }
    }catch(e){ console.warn('Failed to update Firestore status', e); }

    renderHistory(); renderAdminOrders(); updateKpis();
    $('#orderSheet').classList.remove('show');
    showToast('Marked delivered');
  });

  /* ---- Admin: KPIs ---- */
  function updateKpis(){
    const openCount = orders.length;
    const revenue = orders.reduce((a,b)=>a+(b.total||0),0);
    $('#kpiOpen') && ($('#kpiOpen').textContent = String(openCount));
    $('#kpi
  /* ---------- Bootstrap ---------- */
  document.addEventListener('DOMContentLoaded', async () => {
    try{
      updateGreeting();
      buildPromos();
      renderCart(); refreshBadge();
      applyOOSClasses();
      activateChip('');
      ensureAdminLoginVisible();
      if(isAdminUnlocked()){
        await buildAdminSubtabs();
        buildAdminStockTable();
        renderAdminOrders();
        updateKpis();
        buildHeatMap();
        renderHistory();
      }

      // Overlay close on backdrop & ESC
      document.querySelectorAll('.overlay').forEach(ov=>{
        ov.addEventListener('click', (e)=>{ if(e.target===ov) ov.classList.remove('show'); }, {passive:true});
      });
      document.addEventListener('keydown', e=>{
        if(e.key==='Escape'){
          document.querySelectorAll('.overlay.show').forEach(ov=>ov.classList.remove('show'));
        }
      });

      // Safe binds
      $('#cartBtn')?.addEventListener('click',()=>$('#cartOverlay')?.classList.add('show'));
      $('#cartBack')?.addEventListener('click',()=>$('#cartOverlay')?.classList.remove('show'));
    }catch(e){
      console.error('Bootstrap error', e);
    }
  });
  </script-->
</body>
</html>
<!-- rebuild 1759556295 -->
html>
<!-- rebuild 1759556295 -->
<!-- deploy 1759818838 -->
<style id="headerStyles">
  .app-header{position:sticky;top:0;z-index:50;background:#0d0d10bf;
    -webkit-backdrop-filter:saturate(180%) blur(10px);backdrop-filter:saturate(180%) blur(10px);
    padding:12px 16px;display:flex;gap:12px;align-items:center}
  .search{flex:1;display:flex;align-items:center;border:1px solid #2a2a2e;border-radius:16px;padding:10px 14px}
  .search input{all:unset;flex:1;color:#fff}
  .btn{border:1px solid #2a2a2e;border-radius:16px;padding:10px 16px;color:#fff}
  /* modal */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none}
  .dialog{position:fixed;left:50%;top:18%;transform:translateX(-50%);
    background:#121217;border:1px solid #2a2a2e;border-radius:16px;padding:16px;min-width:320px;max-width:92vw}
  .show{display:block}
</style>
