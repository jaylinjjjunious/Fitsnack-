<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>FitSnacks</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0d">

  <!-- Prefetch carousel images -->
  <link rel="preload" as="image" href="assets/carousel-1.jpg">
  <link rel="preload" as="image" href="assets/carousel-2.jpg">
  <link rel="preload" as="image" href="assets/carousel-3.jpg">

  <style>
    :root{
      --bg:#0b0b0d; --card:rgba(20,20,24,0.6); --text:#e9e9ec; --muted:#a9a9b1;
      --accent:#6ea8fe; --good:#3cd27f; --warn:#ffb020; --badge:#ff3b30;
      --radius:14px; --blur:18px; --snap-gap:12px;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    .app{max-width:393px;min-height:100svh;margin:0 auto;padding:12px;box-sizing:border-box}

    /* Glass */
    .card,.sheet,.btn,.search,.chip,.tab,.ghost,.primary,.field{
      backdrop-filter:blur(var(--blur)); -webkit-backdrop-filter:blur(var(--blur));
      background:var(--card); border:1px solid rgba(255,255,255,.08);
    }

    /* Header */
    .row{display:flex;align-items:center;gap:10px}
    .search-wrap{flex:1;min-width:0;max-width:calc(100% - 160px);position:relative}
    .icon-rights{flex:0 0 160px;display:flex;gap:10px;justify-content:flex-end}
    .search{width:100%;border-radius:999px;padding:12px 44px;color:var(--text);outline:0;border:1px solid #2a2a2e}
    .search::placeholder{color:#6c6c70}
    .icon-left{position:absolute;left:12px;top:50%;transform:translateY(-50%)}
    .btn{border-radius:14px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    #cartBtn{position:relative}
    .badge{position:absolute;top:-6px;right:-8px;background:var(--badge);color:#fff;border-radius:999px;padding:1px 6px;font-size:12px;font-weight:700;display:none}
    .greet{margin:8px 2px;color:#c7c7cc;font-size:14px}

    /* Carousel */
    .carousel{margin:10px 0}
    .snapper{height:100px;display:flex;gap:var(--snap-gap);overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}
    .snapper::-webkit-scrollbar{display:none}
    .snap-spacer{flex:0 0 7.5%}
    .snap-card{flex:0 0 85%;scroll-snap-align:center;border-radius:14px;overflow:hidden;position:relative}
    .banner{width:100%;height:100%;object-fit:cover}
    .snap-meta{position:absolute;left:10px;bottom:8px;right:10px;display:flex;justify-content:space-between;pointer-events:none}
    .snap-title{font-weight:800;text-shadow:0 1px 6px rgba(0,0,0,.6)}
    .snap-cta{pointer-events:auto}
    .snap-dots{display:flex;justify-content:center;gap:6px;margin-top:6px}
    .snap-dot{width:6px;height:6px;border-radius:999px;background:#2c3447}
    .snap-dot.active{background:#7fb1ff}

    /* Chips */
    .chips{display:flex;gap:10px;margin:6px 0 12px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
    .chip.active{outline:2px solid var(--accent)}

    /* Grid */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border-radius:var(--radius);padding:10px;display:flex;flex-direction:column;min-height:170px;position:relative}
    .thumb{height:90px;border-radius:10px;overflow:hidden;margin-bottom:8px;display:flex;align-items:center;justify-content:center;background:#0e0e12}
    .thumb img{width:100%;height:100%;object-fit:contain}
    .title{font-weight:700}
    .price{color:#c7c7cc;font-weight:600;margin-top:auto}
    .add{position:absolute;right:10px;bottom:10px;background:var(--accent);border:0;color:#001230;border-radius:12px;width:38px;height:38px;font-size:20px;display:flex;align-items:center;justify-content:center}
    .fav{position:absolute;right:10px;top:10px;width:32px;height:32px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25)}
    .fav.active{background:rgba(255,215,0,.2)}

    /* Overlays */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .overlay.show{display:flex}
    .sheet{width:92%;max-width:480px;border-radius:20px;padding:16px}
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="row">
      <div class="search-wrap">
        <span class="icon-left">üîç</span>
        <input id="search" class="search" placeholder="Search snacks‚Ä¶" autocomplete="off">
      </div>
      <div class="icon-rights">
        <button class="btn" id="cartBtn">üõí<span id="cartBadge" class="badge">0</span></button>
        <button class="btn" id="settingsBtn">‚öôÔ∏è</button>
      </div>
    </div>

    <div id="greet" class="greet">Welcome üëã</div>

    <!-- Carousel -->
    <div class="carousel">
      <div id="snapper" class="snapper">
        <div class="snap-spacer"></div>
        <!-- JS injects promos -->
        <div class="snap-spacer"></div>
      </div>
      <div id="snapDots" class="snap-dots"></div>
    </div>

    <!-- Chips -->
    <div class="chips" id="chips">
      <div class="chip" data-filter="">all</div>
      <div class="chip" data-filter="vegan">vegan</div>
      <div class="chip" data-filter="protein">protein</div>
      <div class="chip" data-filter="favorites">favorites</div>
    </div>

    <!-- Products Grid -->
    <div id="grid" class="grid">
      <div class="card" data-name="Potato Chips" data-price="2.50" data-img="assets/product-funyuns.jpg" data-tags="snack">
        <button class="fav">‚≠ê</button>
        <div class="thumb"><img src="assets/product-funyuns.jpg" alt="Potato Chips"></div>
        <div class="title">Potato Chips</div>
        <div class="price">$2.50</div>
        <button class="add">+</button>
      </div>
      <!-- Add the rest of your 10 cards here (Protein Bar, Trail Mix, etc.) -->
    </div>
        <!-- Product mini sheet -->
    <div id="productSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Add item">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3 id="sheetTitle">Item</h3>
          <button class="ghost" id="sheetClose" type="button">Close</button>
        </div>
        <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
          <div style="width:88px;height:88px;border-radius:12px;overflow:hidden;border:1px solid #2a2a30;">
            <img id="sheetImg" alt="" style="width:100%;height:100%;object-fit:cover">
          </div>
          <div style="flex:1">
            <div id="sheetPrice" class="price" style="font-size:18px;"></div>
          </div>
        </div>
        <div class="row-between" style="margin-top:10px;">
          <div class="qty">
            <button id="qtyMinus" type="button">‚àí</button>
            <div id="qtyVal" aria-live="polite">1</div>
            <button id="qtyPlus" type="button">+</button>
          </div>
          <button class="primary" id="sheetAdd" type="button">Add</button>
        </div>
      </div>
    </div>

    <!-- Order details sheet -->
    <div id="orderSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Order details" style="z-index:10050">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Order</h3>
          <button class="ghost" id="orderClose" type="button">Close</button>
        </div>
        <div id="orderMeta" style="margin-top:6px;color:#c7c7cc;font-size:13px">‚Äì</div>
        <div id="orderLines" class="admin-list" style="margin-top:8px">‚Äì</div>
        <div class="row-between" style="margin-top:10px;">
          <strong>Total</strong><strong id="orderTotal">$0.00</strong>
        </div>
        <div class="actions" style="margin-top:12px;">
          <button class="ghost" id="orderCancel" type="button">Cancel</button>
          <button class="primary" id="orderDelivered" type="button">Mark Delivered</button>
        </div>
      </div>
    </div>

    <!-- Cart -->
    <div id="cartOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Cart">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Cart</h3>
          <button class="ghost" id="cartBack" type="button">Back</button>
        </div>
        <div id="cartContent" class="sheet-body">Cart is empty</div>
        <div class="row-between" style="margin-top:10px;">
          <strong>Total</strong><strong id="cartTotal">$0.00</strong>
        </div>
        <div class="actions">
          <button class="ghost" id="reorderLast" type="button">Re-order last</button>
          <button class="primary" id="cartCheckout" type="button">Checkout</button>
        </div>
      </div>
    </div>

    <!-- Checkout -->
    <div id="checkoutOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Checkout">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Checkout</h3>
          <button class="ghost" id="checkoutClose" type="button">Close</button>
        </div>
        <div class="sheet-body">
          <div style="margin-top:6px;">Your name:</div>
          <input id="checkoutName" class="field" style="width:100%;padding:10px;border-radius:10px">
          <div style="margin-top:10px;">Where are you on campus?</div>
          <input id="checkoutLocation" class="field" style="width:100%;padding:10px;border-radius:10px">

          <div style="margin-top:12px;">Promo code</div>
          <input id="checkoutPromo" class="field" style="width:100%;padding:10px;border-radius:10px">
          <div id="promoStatus" style="margin-top:6px;color:#aaa;font-size:13px"></div>

          <div class="breakdown" style="margin-top:12px">
            <div class="row-between"><div class="muted">Subtotal</div><div id="ckSub">$0.00</div></div>
            <div class="row-between"><div class="muted">Discount</div><div id="ckDisc">-$0.00</div></div>
            <div class="row-between" style="font-weight:800"><div>Total</div><div id="ckTotal">$0.00</div></div>
          </div>

          <div id="checkoutError" style="display:none;color:#ff6b6b;margin-top:10px;">Please fill both fields.</div>
        </div>
        <div class="actions" style="margin-top:12px;">
          <button class="primary" id="checkoutSubmit" type="button">Place Order</button>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div id="settingsOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Settings" style="z-index:10000">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Settings</h3>
          <button class="ghost" id="settingsClose" type="button">Close</button>
        </div>
        <div class="tabs" role="tablist" aria-label="Settings Tabs">
          <button id="tabGeneral" class="tab active" role="tab" aria-selected="true" aria-controls="panelGeneral" type="button">General</button>
          <button id="tabAdmin" class="tab" role="tab" aria-selected="false" aria-controls="panelAdmin" type="button">Admin</button>
        </div>
        <div class="sheet-body">
          <!-- General -->
          <div id="panelGeneral" role="tabpanel" aria-labelledby="tabGeneral">
            <div class="ghost" aria-disabled="true">Dark Mode (disabled)</div>
            <div class="ghost" aria-disabled="true" style="margin-top:6px;">Notifications (disabled)</div>
          </div>

          <!-- Admin -->
          <div id="panelAdmin" role="tabpanel" aria-labelledby="tabAdmin" style="display:none">
            <div id="adminLogin">
              <div style="margin-top:6px;">Admin password:</div>
              <input id="adminPassword" type="password" class="field" style="width:100%;padding:10px;border-radius:10px">
              <div id="adminError" style="display:none;color:#ff6b6b;margin-top:6px;">Wrong password.</div>
              <div class="actions" style="margin-top:12px;">
                <button class="primary" id="adminSubmit" type="button">Unlock</button>
              </div>
            </div>

            <div id="adminContent" style="display:none">
              <div class="admin-subtabs">
                <button class="subtab active" data-subtab="orders" type="button">Orders</button>
                <button class="subtab" data-subtab="inventory" type="button">Inventory</button>
                <button class="subtab" data-subtab="analytics" type="button">Analytics</button>
                <button class="subtab" data-subtab="heat" type="button">Heat Map</button>
                <button class="subtab" data-subtab="history" type="button">History</button>
              </div>

              <!-- Orders -->
              <div id="subtab-orders">
                <div id="ordersList" class="admin-list">No orders yet</div>
              </div>

              <!-- Inventory -->
              <div id="subtab-inventory" style="display:none">
                <div style="margin-top:6px;font-weight:700">Inventory (simple)</div>
                <div id="inventoryList" class="admin-list">Loading‚Ä¶</div>
              </div>

              <!-- Analytics -->
              <div id="subtab-analytics" style="display:none">
                <div class="kpis" style="margin-top:8px">
                  <div class="kpi"><div class="label">Revenue</div><div id="kpiRevenue" class="value">$0.00</div></div>
                  <div class="kpi"><div class="label">Orders</div><div id="kpiOrders" class="value">0</div></div>
                  <div class="kpi"><div class="label">AOV</div><div id="kpiAOV" class="value">$0.00</div></div>
                  <div class="kpi"><div class="label">Items</div><div id="kpiItems" class="value">0</div></div>
                </div>
                <div class="table" style="margin-top:10px">
                  <div class="rowh"><div>Product</div><div>Qty</div><div>Revenue</div><div>Conv%</div></div>
                  <div id="topProducts"></div>
                </div>
                <svg id="revSpark" class="spark" viewBox="0 0 100 40" preserveAspectRatio="none" style="margin-top:10px"></svg>
              </div>

              <!-- Heat Map -->
              <div id="subtab-heat" style="display:none">
                <div style="margin-top:6px;font-weight:700">Order Heat (demo)</div>
                <div id="heatGridHM" style="margin-top:8px"></div>
              </div>

              <!-- History -->
              <div id="subtab-history" style="display:none">
                <div id="historyList" class="admin-list">No history yet</div>
                <button class="ghost" id="historyClear" type="button" style="margin-top:8px">Clear history</button>
              </div>
            </div>
          </div> <!-- /panelAdmin -->
        </div> <!-- /.sheet-body -->
      </div>
    </div>

    <!-- Toast Host -->
    <div id="toastHost" aria-live="polite" aria-atomic="true"></div>
        <script>
    /* ========= Safe shorthands ========= */
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    /* ========= Constants / Storage keys ========= */
    const APP_SCHEMA_VERSION = 4, SCHEMA_KEY='fitsnacks.schema';
    const CART_KEY='fitsnacks.cart.v1';
    const ORDERS_KEY='fitsnacks.orders';
    const DELIVERED_KEY='fitsnacks.orders.delivered';
    const FAVORITES_KEY='fitsnacks.favorites';
    const PROMOS_KEY='fitsnacks.promos';

    const PROFILE_NAME_KEY='fitsnacks.profile.name';
    const PROFILE_LOC_KEY='fitsnacks.profile.location';

    const STOCK_KEY='fitsnacks.stock.qty';
    const LOW_KEY='fitsnacks.stock.low';

    const UNLOCK_KEY='fitsnacks.admin.unlocked';
    const ADMIN_PASSWORD='8TSB077';

    // IFTTT (GET form because that‚Äôs what works for you)
    const IFTTT_EVENT='Fitsnack_order';
    const IFTTT_KEY='fI-MGeBZrzbzW3CyUXlWVMpQkvI1bRVirGd0gkcYZiA';
    const IFTTT_URL=`https://maker.ifttt.com/trigger/${IFTTT_EVENT}/with/key/${IFTTT_KEY}`;

    const fmt = n => '$'+(Number(n)||0).toFixed(2);

    /* ========= App boot / schema ========= */
    try{
      const cur = JSON.parse(localStorage.getItem(SCHEMA_KEY)||'0')||0;
      if(cur < APP_SCHEMA_VERSION) localStorage.setItem(SCHEMA_KEY, JSON.stringify(APP_SCHEMA_VERSION));
    }catch{
      localStorage.setItem(SCHEMA_KEY, JSON.stringify(APP_SCHEMA_VERSION));
    }

    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    }

    /* ========= State ========= */
    let cart       = new Map(JSON.parse(localStorage.getItem(CART_KEY)||'[]'));
    let favorites  = new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY)||'[]'));
    let stockQty   = JSON.parse(localStorage.getItem(STOCK_KEY)||'{}');
    let stockLow   = JSON.parse(localStorage.getItem(LOW_KEY)||'{}');

    function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify([...cart.entries()])); }
    function saveFavs(){ localStorage.setItem(FAVORITES_KEY, JSON.stringify([...favorites])); }
    function saveObj(k,o){ localStorage.setItem(k, JSON.stringify(o||{})); }

    /* ========= Greeting ========= */
    function updateGreeting(){
      const g=$('#greet'); if(!g) return;
      const name=localStorage.getItem(PROFILE_NAME_KEY)||'';
      g.textContent = name ? `Hi, ${name} üëã` : 'Welcome üëã';
    }

    /* ========= Toast ========= */
    function showToast(msg, ms=1800){
      const host=$('#toastHost'); if(!host) return;
      const el=document.createElement('div');
      el.className='toast'; el.textContent=msg;
      host.appendChild(el);
      requestAnimationFrame(()=>el.classList.add('show'));
      setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),250); }, ms);
    }

    /* ========= Carousel / Promos ========= */
    function buildPromos(){
      const snapper=$('#snapper'); if(!snapper) return;
      let data=[];
      try{ data=JSON.parse(localStorage.getItem(PROMOS_KEY)||'[]'); }catch{}
      if(!data.length){
        data = [
          {img:'assets/carousel-1.jpg', title:'Fuel your study grind', cta:'Shop snacks', action:'scrollGrid'},
          {img:'assets/carousel-2.jpg', title:'Protein picks', cta:'Filter: protein', action:'filter', value:'protein'},
          {img:'assets/carousel-3.jpg', title:'Need help?', cta:'Open settings', action:'openSettings'}
        ];
        localStorage.setItem(PROMOS_KEY, JSON.stringify(data));
      }
      // clear existing
      snapper.querySelectorAll('.snap-card').forEach(n=>n.remove());
      const after=snapper.lastElementChild;
      data.forEach(p=>{
        const c=document.createElement('div');
        c.className='snap-card';
        c.innerHTML=`<img class="banner" src="${p.img}" alt="${p.title}">
          <div class="snap-meta"><div class="snap-title">${p.title}</div>
          ${p.cta?`<button class="ghost snap-cta" type="button">${p.cta}</button>`:''}</div>`;
        snapper.insertBefore(c, after);

        // actions
        c.addEventListener('click', e=>{
          if(e.target.closest('.snap-cta')) return;
          if(p.action==='scrollGrid') $('#grid')?.scrollIntoView({behavior:'smooth',block:'start'});
          if(p.action==='filter') activateChip(p.value||'');
          if(p.action==='openSettings'){ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); }
        }, {passive:true});
        c.querySelector('.snap-cta')?.addEventListener('click', e=>{
          e.stopPropagation();
          if(p.action==='filter') activateChip(p.value||'');
          if(p.action==='openSettings'){ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); }
          if(p.action==='scrollGrid') $('#grid')?.scrollIntoView({behavior:'smooth',block:'start'});
        });
      });

      // dots + safe auto-advance
      const cards=$$('.snap-card');
      const dotsWrap=$('#snapDots');
      dotsWrap.innerHTML=cards.map(()=>'<div class="snap-dot"></div>').join('');
      const dots=$$('.snap-dot');
      let idx=0, userInteracting=false, last=0, inView=true;
      const cooldown=3500;

      function setDot(i){ dots.forEach((d,k)=>d.classList.toggle('active',k===i)); }
      setDot(0);

      ['pointerdown','wheel','touchstart','scroll'].forEach(ev=>{
        snapper.addEventListener(ev, ()=>{ userInteracting=true; last=Date.now(); }, {passive:true});
      });

      const obs=new IntersectionObserver((entries)=>{
        inView = entries.some(e=>e.isIntersecting);
      },{threshold:0.2});
      obs.observe(snapper);

      setInterval(()=>{
        if(!cards.length || !inView) return;
        if(userInteracting && Date.now()-last<cooldown) return;
        idx=(idx+1)%cards.length;
        cards[idx].scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
        setDot(idx);
      }, 5000);
    }

    /* ========= Product modal ========= */
    let currentProduct=null;
    function openProductSheet(card){
      currentProduct={ name:card.dataset.name, price:+card.dataset.price, img:card.dataset.img };
      $('#sheetTitle').textContent=currentProduct.name;
      $('#sheetImg').src=currentProduct.img||'';
      $('#sheetImg').alt=currentProduct.name||'';
      $('#sheetPrice').textContent=fmt(currentProduct.price);
      $('#qtyVal').textContent='1';
      $('#sheetAdd').textContent='Add ‚Ä¢ '+fmt(currentProduct.price);
      $('#productSheet').classList.add('show');
    }
    function closeProductSheet(){ $('#productSheet')?.classList.remove('show'); }
    $('#sheetClose')?.addEventListener('click', closeProductSheet);
    $('#qtyPlus')?.addEventListener('click', ()=>{
      let n=(+$('#qtyVal').textContent)||1; n=Math.min(99,n+1);
      $('#qtyVal').textContent=n; $('#sheetAdd').textContent='Add ‚Ä¢ '+fmt(n*(currentProduct?.price||0));
    });
    $('#qtyMinus')?.addEventListener('click', ()=>{
      let n=(+$('#qtyVal').textContent)||1; n=Math.max(1,n-1);
      $('#qtyVal').textContent=n; $('#sheetAdd').textContent='Add ‚Ä¢ '+fmt(n*(currentProduct?.price||0));
    });
    $('#sheetAdd')?.addEventListener('click', ()=>{
      if(!currentProduct) return;
      const n=(+$('#qtyVal').textContent)||1;
      const entry=cart.get(currentProduct.name)||{price:currentProduct.price,qty:0};
      entry.qty+=n; cart.set(currentProduct.name,entry);
      saveCart(); renderCart(); refreshBadge();
      closeProductSheet(); openCart();
      showToast(`Added ${n} √ó ${currentProduct.name}`);
    });

    // open sheet on card click (except fav/+)
    document.addEventListener('click', e=>{
      const card=e.target.closest('.card'); if(!card) return;
      if(e.target.closest('.fav') || e.target.closest('.add')) return;
      openProductSheet(card);
    }, {passive:true});
    // short tap on + also opens sheet (for qty choice)
    document.addEventListener('click', e=>{
      const btn=e.target.closest('.card .add'); if(!btn) return;
      e.stopPropagation(); openProductSheet(btn.closest('.card'));
    }, {passive:true});

    /* ========= Cart ========= */
    function refreshBadge(){
      let n=0; for(const v of cart.values()) n+=v.qty;
      const b=$('#cartBadge'); if(!b) return;
      if(n>0){ b.textContent=String(n); b.style.display='inline-flex'; }
      else { b.style.display='none'; }
    }
    function renderCart(){
      let total=0, html='';
      for(const [name,info] of cart){
        const line=info.price*info.qty; total+=line;
        html += `<div class="row-between" style="margin-top:6px">
          <div style="display:flex;gap:8px;align-items:center">
            <button data-act="-" data-name="${name}" class="ghost" type="button">‚àí</button>
            <div style="min-width:24px;text-align:center">${info.qty}</div>
            <button data-act="+" data-name="${name}" class="ghost" type="button">+</button>
            <div style="font-weight:700;margin-left:8px">${name}</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            <div style="font-weight:700">${fmt(line)}</div>
            <button data-remove="${name}" class="ghost" type="button" style="padding:2px 6px;font-size:12px">x</button>
          </div>
        </div>`;
      }
      $('#cartContent').innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
      $('#cartTotal').textContent = fmt(total);
    }
    document.addEventListener('click', (e)=>{
      const b=e.target.closest('button[data-act][data-name]');
      if(b){
        const name=b.getAttribute('data-name'); const act=b.getAttribute('data-act');
        const entry=cart.get(name); if(!entry) return;
        entry.qty=Math.max( (act==='+')?entry.qty+1:entry.qty-1 , 0);
        if(entry.qty===0) cart.delete(name);
        saveCart(); renderCart(); refreshBadge(); return;
      }
      const rm=e.target.closest('button[data-remove]');
      if(rm){
        const name=rm.getAttribute('data-remove');
        if(cart.has(name)){ cart.delete(name); saveCart(); renderCart(); refreshBadge(); }
      }
    }, {passive:true});

    function openCart(){ $('#cartOverlay')?.classList.add('show'); }
    function closeCart(){ $('#cartOverlay')?.classList.remove('show'); }
    $('#cartBtn')?.addEventListener('click', openCart);
    $('#cartBack')?.addEventListener('click', closeCart);

    /* ========= Search + Filters ========= */
    function searchAndFilter(){
      const q = ($('#search').value||'').toLowerCase();
      $$('.card').forEach(c=>{
        const hiddenByFilter = c.style.display==='none-filter';
        const hitsName = c.dataset.name.toLowerCase().includes(q);
        c.style.display = (!hiddenByFilter && hitsName) ? '' : 'none';
      });
    }
    function activateChip(val){
      $$('#chips .chip').forEach(ch=>ch.classList.toggle('active', ch.dataset.filter===val));
      $$('.card').forEach(c=>{
        const tags=(c.dataset.tags||'').toLowerCase();
        const name=c.dataset.name;
        const pass = !val || val==='' || (val==='favorites' ? favorites.has(name) : tags.includes(val));
        if(pass) c.style.removeProperty('display');
        else c.style.display='none-filter';
      });
      searchAndFilter();
    }
    $('#chips')?.addEventListener('click', e=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      activateChip(chip.dataset.filter||'');
    }, {passive:true});
    $('#search')?.addEventListener('input', searchAndFilter);

    /* ========= Favorites ========= */
    function syncFavStars(){
      $$('.card').forEach(card=>{
        card.querySelector('.fav')?.classList.toggle('active', favorites.has(card.dataset.name));
      });
    }
    document.addEventListener('click', e=>{
      const fav=e.target.closest('.fav'); if(!fav) return;
      e.stopPropagation();
      const card=fav.closest('.card'); const name=card.dataset.name;
      if(favorites.has(name)) favorites.delete(name); else favorites.add(name);
      saveFavs(); syncFavStars();

      // if favorites chip is active, hide unfavorited immediately
      const favActive = $('#chips .chip.active')?.dataset.filter === 'favorites';
      if(favActive && !favorites.has(name)){ card.style.display='none-filter'; searchAndFilter(); }
    }, {passive:true});

    /* ========= Checkout ========= */
    function computeTotals(){
      let subtotal=0; for(const[,info] of cart) subtotal+=info.price*info.qty;
      return {subtotal,total:subtotal};
    }
    function updateCheckoutBreakdown(){
      const {subtotal,total}=computeTotals();
      $('#ckSub').textContent=fmt(subtotal);
      $('#ckDisc').textContent='-'+fmt(0);
      $('#ckTotal').textContent=fmt(total);
    }
    $('#cartCheckout')?.addEventListener('click', ()=>{
      let count=0; for(const v of cart.values()) count+=v.qty;
      if(count===0){ showToast('Your cart is empty'); return; }
      updateCheckoutBreakdown(); closeCart(); $('#checkoutOverlay')?.classList.add('show');
    });
    $('#checkoutClose')?.addEventListener('click', ()=>$('#checkoutOverlay')?.classList.remove('show'));

    $('#checkoutSubmit')?.addEventListener('click', ()=>{
      const name=($('#checkoutName').value||'').trim();
      const loc =($('#checkoutLocation').value||'').trim();
      if(!name || !loc){ $('#checkoutError').style.display='block'; return; }
      $('#checkoutError').style.display='none';

      // persist profile
      try{
        localStorage.setItem(PROFILE_NAME_KEY,name);
        localStorage.setItem(PROFILE_LOC_KEY,loc);
      }catch{}

      // build order
      let total=0; const lines=[];
      for(const [n,info] of cart){
        const line=info.price*info.qty; total+=line;
        lines.push({name:n,qty:info.qty,price:info.price,line});
      }
      const order={when:new Date().toISOString(),name,location:loc,lines,total};
      const list=JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]');
      list.unshift(order);
      localStorage.setItem(ORDERS_KEY, JSON.stringify(list));

      // Clear UI
      cart.clear(); saveCart(); renderCart(); refreshBadge();
      updateGreeting();
      $('#checkoutOverlay')?.classList.remove('show');
      showToast('Order placed üéâ');

      // IFTTT trigger via GET (your working method)
      const summary = `${order.name} @ ${order.location} ‚Ä¢ ${fmt(order.total)}`;
      const lineItems = order.lines.map(l=>`${l.name} √ó ${l.qty} -- ${fmt(l.line)}`).join('\n');
      const url = `${IFTTT_URL}?value1=${encodeURIComponent(summary)}&value2=${encodeURIComponent(lineItems)}&value3=`;
      try{ fetch(url, {method:'GET', mode:'no-cors'}); }catch{}

      renderOrders(); // refresh admin list if open
    });

    /* ========= Orders / Order sheet ========= */
    function renderOrders(){
      const list=JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]');
      const box=$('#ordersList'); if(!box) return;
      if(!list.length){ box.textContent='No orders yet'; return; }
      box.innerHTML=list.map((o,i)=>`
        <div class="order-item" data-idx="${i}" style="padding:8px;border-bottom:1px solid #2a2a30;cursor:pointer">
          <div style="font-weight:700">${new Date(o.when).toLocaleString()}</div>
          <div>${o.name} @ ${o.location}</div>
          <div style="font-weight:700">Total ${fmt(o.total)}</div>
        </div>
      `).join('');
    }
    function openOrderSheet(idx){
      const list=JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]');
      const o=list[idx]; if(!o) return;
      $('#orderMeta').textContent=`${new Date(o.when).toLocaleString()} ‚Ä¢ ${o.name} @ ${o.location}`;
      $('#orderLines').innerHTML=o.lines.map(l=>
        `<div class="row-between" style="padding:6px 0">
          <div>${l.name} √ó ${l.qty}</div><div style="font-weight:700">${fmt(l.line)}</div>
        </div>`
      ).join('');
      $('#orderTotal').textContent=fmt(o.total);

      // Make sure it's above settings
      const sheet=$('#orderSheet'); document.body.appendChild(sheet);
      sheet.classList.add('show');
    }
    document.addEventListener('click', e=>{
      const row=e.target.closest('.order-item'); if(row) openOrderSheet(parseInt(row.dataset.idx,10));
    }, {passive:true});
    $('#orderClose')?.addEventListener('click', ()=>$('#orderSheet')?.classList.remove('show'));
    $('#orderCancel')?.addEventListener('click', ()=>$('#orderSheet')?.classList.remove('show'));
    $('#orderDelivered')?.addEventListener('click', ()=>{
      // Minimal demo: move the most recent order to delivered
      const orders=JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]');
      const delivered=JSON.parse(localStorage.getItem(DELIVERED_KEY)||'[]');
      if(orders.length){
        const o=orders.shift();
        o.deliveredWhen=new Date().toISOString();
        delivered.unshift(o);
        localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
        localStorage.setItem(DELIVERED_KEY, JSON.stringify(delivered));
        renderOrders();
        showToast('Marked delivered');
      }
      $('#orderSheet')?.classList.remove('show');
    });

    /* ========= Analytics ========= */
    function renderAnalytics(){
      const all=JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]')
                 .concat(JSON.parse(localStorage.getItem(DELIVERED_KEY)||'[]'));
      let rev=0, items=0; all.forEach(o=>{ rev+=o.total; o.lines.forEach(l=>items+=l.qty); });
      const cnt=all.length, aov=cnt?rev/cnt:0;
      $('#kpiRevenue').textContent=fmt(rev);
      $('#kpiOrders').textContent=cnt;
      $('#kpiAOV').textContent=fmt(aov);
      $('#kpiItems').textContent=items;

      // top products
      const agg={};
      all.forEach(o=>o.lines.forEach(l=>{
        agg[l.name]=agg[l.name]||{qty:0,rev:0};
        agg[l.name].qty+=l.qty; agg[l.name].rev+=l.line;
      }));
      const sorted=Object.entries(agg).sort((a,b)=>b[1].rev-a[1].rev).slice(0,8);
      $('#topProducts').innerHTML = sorted.length
        ? sorted.map(([n,v])=>`<div class="rowd"><div>${n}</div><div>${v.qty}</div><div>${fmt(v.rev)}</div><div>-</div></div>`).join('')
        : '<div class="rowd"><div>No sales</div></div>';

      // simple 7-day spark
      const days=Array(7).fill(0), now=Date.now();
      all.forEach(o=>{
        const d=new Date(o.when);
        const diff=Math.floor((now - d)/86400000);
        if(diff>=0 && diff<7) days[6-diff]+=o.total;
      });
      const svg=$('#revSpark'); if(svg){
        const max=Math.max(1,...days), step=100/(days.length-1||1);
        const pts=days.map((v,i)=>`${i*step},${40-(v/max)*36-2}`).join(' ');
        svg.innerHTML=`<polyline points="${pts}" fill="none" stroke="#6ea8fe" stroke-width="2"/>`;
      }
    }

    /* ========= Inventory (editable) ========= */
    function getProducts(){
      return $$('.card').map(c=>({
        name: c.dataset.name, price: +c.dataset.price, img: c.dataset.img,
        tags: (c.dataset.tags||'').toLowerCase()
      }));
    }
    function renderInventory(){
      const wrap=$('#inventoryList'); if(!wrap) return;
      const products=getProducts();
      if(!products.length){ wrap.textContent='No products'; return; }
      wrap.innerHTML = products.map(p=>{
        const qty = Object.prototype.hasOwnProperty.call(stockQty, p.name) ? Number(stockQty[p.name]||0) : '';
        const low = Object.prototype.hasOwnProperty.call(stockLow, p.name) ? Number(stockLow[p.name]||0) : '';
        return `<div class="field" data-prod="${p.name}">
          <div style="flex:1;font-weight:600">${p.name}</div>
          <label style="font-size:12px;color:#c7c7cc">Stock</label>
          <input type="number" min="0" value="${qty}" data-k="qty" placeholder="--" style="width:72px">
          <label style="font-size:12px;color:#c7c7cc">Low</label>
          <input type="number" min="0" value="${low}" data-k="low" placeholder="--" style="width:72px">
        </div>`;
      }).join('');
    }
    document.addEventListener('input', (e)=>{
      const row=e.target.closest('.field[data-prod]'); if(!row) return;
      const name=row.getAttribute('data-prod');
      if(e.target.matches('input[data-k="qty"]')){
        const v=(e.target.value||'').trim();
        if(v===''){ delete stockQty[name]; } else { stockQty[name]=Number(v); }
        saveObj(STOCK_KEY, stockQty);
      }
      if(e.target.matches('input[data-k="low"]')){
        const v=(e.target.value||'').trim();
        if(v===''){ delete stockLow[name]; } else { stockLow[name]=Number(v); }
        saveObj(LOW_KEY, stockLow);
      }
    });

    /* ========= Heat map (demo cells) ========= */
    function renderHeat(){
      const grid=$('#heatGridHM'); if(!grid) return;
      grid.innerHTML='';
      for(let d=0; d<7; d++){
        for(let h=0; h<24; h++){
          const cell=document.createElement('span');
          cell.className='heat-cell';
          const a=0.10 + 0.70*Math.random(); // demo intensity
          cell.style.cssText=`display:inline-block;width:12px;height:12px;margin:1px;border-radius:3px;background:rgba(110,168,254,${a})`;
          grid.appendChild(cell);
        }
        grid.appendChild(document.createElement('br'));
      }
    }

    /* ========= Overlay helpers ========= */
    document.querySelectorAll('.overlay').forEach(ov=>{
      ov.addEventListener('click', (e)=>{ if(e.target===ov) ov.classList.remove('show'); }, {passive:true});
    });
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ $$('.overlay.show').forEach(ov=>ov.classList.remove('show')); }
    });

    /* ========= Settings & Admin ========= */
    function switchTab(which){
      const g=$('#tabGeneral'), a=$('#tabAdmin'), pg=$('#panelGeneral'), pa=$('#panelAdmin');
      if(which==='admin'){
        g.classList.remove('active'); g.setAttribute('aria-selected','false');
        a.classList.add('active');    a.setAttribute('aria-selected','true');
        pg.style.display='none'; pa.style.display='block';
        ensureAdminLoginVisible();
      }else{
        a.classList.remove('active'); a.setAttribute('aria-selected','false');
        g.classList.add('active');    g.setAttribute('aria-selected','true');
        pa.style.display='none'; pg.style.display='block';
      }
    }
    function ensureAdminLoginVisible(){
      const logged=localStorage.getItem(UNLOCK_KEY)==='1';
      $('#adminLogin').style.display=logged?'none':'block';
      $('#adminContent').style.display=logged?'block':'none';
      if(logged){ renderOrders(); renderInventory(); renderAnalytics(); renderHeat(); }
    }

    // Always ensure Settings opens
    $('#settingsBtn')?.addEventListener('click', ()=>{ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); });
    $('#settingsClose')?.addEventListener('click', ()=>$('#settingsOverlay')?.classList.remove('show'));

    // Tabs
    document.addEventListener('click', e=>{
      if(e.target.closest('#tabGeneral')) switchTab('general');
      if(e.target.closest('#tabAdmin'))   switchTab('admin');

      // Admin unlock
      if(e.target.closest('#adminSubmit')){
        const ok=$('#adminPassword').value===ADMIN_PASSWORD;
        if(ok){ localStorage.setItem(UNLOCK_KEY,'1'); $('#adminError').style.display='none'; ensureAdminLoginVisible(); }
        else { $('#adminError').style.display='block'; }
      }

      // Subtabs
      const sub=e.target.closest('.subtab');
      if(sub){
        $$('.subtab').forEach(s=>s.classList.remove('active'));
        sub.classList.add('active');
        const id=sub.dataset.subtab;
        ['orders','inventory','analytics','heat','history'].forEach(k=>{
          const el = $('#subtab-'+k);
          if(el) el.style.display = (k===id)?'block':'none';
        });
      }
    }, {passive:true});

    $('#historyClear')?.addEventListener('click', ()=>{
      localStorage.setItem(DELIVERED_KEY, '[]');
      const box=$('#historyList'); if(box) box.textContent='No history yet';
      showToast('History cleared');
    });

    /* ========= Init ========= */
    (function init(){
      try{
        updateGreeting();
        buildPromos();
        renderCart();
        refreshBadge();
        syncFavStars();
        activateChip('');  // default filter
        renderOrders();
        renderInventory();
        renderAnalytics();
        renderHeat();

        // Make sure z-indexes are correct
        $('#settingsOverlay')?.style.setProperty('z-index','10000');
        $('#orderSheet')?.style.setProperty('z-index','10050');
      }catch(err){
        console.error('Init error:', err);
        showToast('Init error: '+(err?.message||err), 2800);
      }
    })();
    </script>
        <!-- Firebase (your snippet) -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      // NOTE: We‚Äôre only initializing the core app here (no Firestore yet).
      // When you‚Äôre ready to sync orders across devices, we‚Äôll add:
      //   import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

      // Your web app's Firebase configuration (as you provided)
      const firebaseConfig = {
        apiKey: "AIzaSyAdjxpOK1ir5y-sHCh4PodIxe8TkEYBAsY",
        authDomain: "fitsnack-bd51d.firebaseapp.com",
        projectId: "fitsnack-bd51d",
        storageBucket: "fitsnack-bd51d.firebasestorage.app",
        messagingSenderId: "978231518137",
        appId: "1:978231518137:web:528c32d35d5b4f22038c68"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      // window.firebaseApp = app; // (optional) expose for debugging
    </script>

  </div> <!-- /.app -->
</body>
</html>