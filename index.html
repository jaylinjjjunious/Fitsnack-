<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>FitSnacks</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0d">

  <!-- PREFETCH PROMO IMAGES (optional) -->
  <link rel="preload" as="image" href="assets/carousel-1.jpg">
  <link rel="preload" as="image" href="assets/carousel-2.jpg">
  <link rel="preload" as="image" href="assets/carousel-3.jpg">

  <style>
    :root{
      --bg:#0b0b0d;
      --card:rgba(20,20,24,0.6);
      --text:#e9e9ec;
      --muted:#aaa;
      --accent:#6ea8fe;
      --badge:#ff3b30;
      --good:#3cd27f;
      --warn:#ffb020;
      --radius:18px;
      --blur:18px;
      --grid-gap:6px;
      --snap-gap:12px;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    .app{max-width:393px;min-height:100svh;margin:0 auto;padding:12px 12px 32px;box-sizing:border-box}

    /* Glass + glow */
    .card,.sheet,.btn,.search,.chip,.tab,.ghost,.primary,.field{
      backdrop-filter:blur(var(--blur));
      -webkit-backdrop-filter:blur(var(--blur));
      background:var(--card);
      border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 4px 24px rgba(0,255,0,0.08);
    }

    /* ===== Header (no overlap) ===== */
    .row{position:relative;display:flex;align-items:center;gap:12px}
    .search-wrap{flex:1 1 auto;min-width:0;position:relative}
    .search{width:100%;border-radius:999px;padding:12px 44px;color:var(--text);outline:none;border:1px solid #2a2a2e}
    .search::placeholder{color:#6c6c70}
    .icon-left{position:absolute;left:12px;top:50%;transform:translateY(-50%)}
    .icon-rights{position:static;display:flex;gap:10px;margin-left:0;flex:0 0 auto}
    .btn{-webkit-appearance:none;appearance:none;border-radius:14px;width:44px;height:44px;padding:0;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    #cartBtn{position:relative;display:flex;align-items:center;justify-content:center}
    .badge{position:absolute;top:-6px;right:-8px;background:var(--badge);color:#fff;border-radius:999px;padding:1px 6px;font-size:12px;font-weight:700;display:none;align-items:center;justify-content:center}
    #cartBtn.bump{animation:bump 300ms ease}
    @keyframes bump{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}

    .greet{margin:8px 2px 2px;color:#c7c7cc;font-size:14px}

    /* Promo carousel */
    .carousel{margin:10px 0 6px}
    .snapper{height:100px;display:flex;align-items:stretch;gap:var(--snap-gap);overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding:0 var(--snap-gap)}
    .snapper::-webkit-scrollbar{display:none}
    .snap-spacer{flex:0 0 7.5%}
    .snap-card{position:relative;flex:0 0 85%;scroll-snap-align:center;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;height:100%}
    .banner{width:100%;height:100%;object-fit:cover;display:block}
    .snap-meta{position:absolute;left:10px;bottom:8px;right:10px;display:flex;justify-content:space-between;align-items:end;gap:8px;pointer-events:none}
    .snap-title{font-weight:800;text-shadow:0 1px 6px rgba(0,0,0,.6)}
    .snap-cta{pointer-events:auto}
    .snap-dots{display:flex;justify-content:center;gap:6px;margin-top:6px}
    .snap-dot{width:6px;height:6px;border-radius:999px;background:#2c3447;border:1px solid rgba(255,255,255,.18)}
    .snap-dot.active{background:#7fb1ff}

    /* Chips */
    .chips{display:flex;gap:10px;margin:6px 0 12px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
    .chip.active{outline:2px solid rgba(110,168,254,.5)}

    /* Grid */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{border-radius:var(--radius);padding:12px;position:relative;display:flex;flex-direction:column;min-height:190px}
    .thumb{height:90px;border-radius:12px;overflow:hidden;margin-bottom:8px;display:flex;align-items:center;justify-content:center;background:#0e0e12}
    .thumb img{width:100%;height:100%;object-fit:contain}
    .title{font-weight:700;margin:4px 0 2px;letter-spacing:0.2px}
    .price{color:#c7c7cc;font-weight:600;margin-top:auto}
    .add{position:absolute;right:12px;bottom:12px;background:var(--accent);border:none;color:#001230;border-radius:14px;width:42px;height:42px;font-size:22px;display:flex;align-items:center;justify-content:center;font-weight:800;cursor:pointer}
    .fav{position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:12px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);cursor:pointer}
    .fav.active{background:rgba(255,215,0,.15);box-shadow:0 0 0 1px rgba(255,215,0,.35) inset}

    /* Overlays */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .overlay.show{display:flex}
    .sheet{width:92%;max-width:480px;border-radius:20px;padding:16px}
    #cartOverlay,#checkoutOverlay,#settingsOverlay,#orderSheet{align-items:flex-end}
    #cartOverlay .sheet,#checkoutOverlay .sheet,#settingsOverlay .sheet,#orderSheet .sheet{
      width:100%;border-top-left-radius:24px;border-top-right-radius:24px;border-bottom-left-radius:0;border-bottom-right-radius:0;
      padding-bottom:calc(16px + env(safe-area-inset-bottom));
      transform:translateY(100%);animation:slideUp 220ms ease-out forwards
    }
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .qty{display:flex;align-items:center;gap:10px}
    .qty button{width:36px;height:36px;border-radius:10px;border:1px solid #2a2a30;background:#1c1c22;color:var(--text);font-size:20px;font-weight:700}
    .primary{background:var(--accent);border:0;color:#081425;font-weight:800;border-radius:12px;padding:12px 14px}
    .ghost{border:1px solid #2a2a30;color:#e7e7eb;border-radius:12px;padding:10px 12px;background:#1b1b20}
    .actions{display:flex;gap:10px;margin-top:12px}

    /* Admin + analytics + history */
    .tabs{display:flex;gap:8px;margin:6px 0 12px}
    .tab{padding:8px 10px;border-radius:10px;cursor:pointer;border:1px solid #2a2a30;background:#18181d}
    .tab.active{background:#24242a}
    .sheet-body{max-height:70svh;overflow:auto;padding-right:4px}
    .admin-subtabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
    .subtab{padding:6px 10px;border-radius:10px;cursor:pointer;border:1px solid #2a2a30;background:#18181d;font-size:13px}
    .subtab.active{background:#24242a}
    .admin-list{border:1px solid #2a2a30;border-radius:12px;padding:8px;margin-top:8px}
    .field{display:flex;align-items:center;gap:8px;padding:8px;border-radius:12px}
    .field input{width:72px;padding:8px;border-radius:10px;border:1px solid #2a2a30;background:#101014;color:#e9e9ec}

    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1)}
    .kpi .label{color:#c7c7cc;font-size:12px}
    .kpi .value{font-weight:800;font-size:18px;margin-top:4px}
    .bar{height:8px;border-radius:6px;background:rgba(255,255,255,.08);overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,#6ea8fe,#3cd27f)}
    .table{margin-top:8px;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
    .rowh,.rowd{display:grid;grid-template-columns:1fr 70px 70px 70px;gap:8px;padding:8px}
    .rowh{background:rgba(255,255,255,.05);font-weight:700}
    .rowd{border-top:1px solid rgba(255,255,255,.06)}

    /* Toasts */
    #toastHost{position:fixed;left:0;right:0;bottom:calc(16px + env(safe-area-inset-bottom));display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;z-index:11000}
    .toast{pointer-events:auto;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:rgba(24,24,32,.9);font-weight:600;opacity:0;transform:translateY(8px);transition:opacity .22s ease,transform .22s ease}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <div class="app" role="application">
    <!-- Header -->
    <div class="row">
      <div class="search-wrap">
        <span class="icon-left" aria-hidden="true">üîç</span>
        <input id="search" class="search" placeholder="Search snacks‚Ä¶" autocomplete="off">
      </div>
      <div class="icon-rights">
        <button type="button" class="btn" id="cartBtn" aria-label="Open cart">
          üõí <span id="cartBadge" class="badge">0</span>
        </button>
        <button type="button" class="btn" id="settingsBtn" aria-label="Open settings">‚öôÔ∏è</button>
      </div>
    </div>

    <!-- Greeting -->
    <div id="greet" class="greet">Welcome üëã</div>

    <!-- Promo carousel -->
    <div class="carousel" aria-label="Promotions">
      <div id="snapper" class="snapper" aria-roledescription="carousel">
        <div class="snap-spacer" aria-hidden="true"></div>
        <!-- JS injects promo cards here -->
        <div class="snap-spacer" aria-hidden="true"></div>
      </div>
      <div id="snapDots" class="snap-dots" aria-hidden="true"></div>
    </div>

    <!-- Chips -->
    <div class="chips" id="chips">
      <div class="chip" data-filter="">all</div>
      <div class="chip" data-filter="vegan">vegan</div>
      <div class="chip" data-filter="gluten-free">gluten-free</div>
      <div class="chip" data-filter="protein">protein</div>
      <div class="chip" data-filter="favorites">favorites</div>
    </div>

    <!-- Products Grid -->
    <div id="grid" class="grid" role="list">
      <div class="card" role="listitem" data-name="Potato Chips" data-price="2.50" data-img="assets/product-funyuns.jpg" data-tags="snack">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-funyuns.jpg" alt="Potato Chips" loading="lazy"></div>
        <div class="title">Potato Chips</div>
        <div class="price">$2.50</div>
        <button class="add" aria-label="Add Potato Chips">+</button>
      </div>

      <div class="card" role="listitem" data-name="Protein Bar" data-price="2.99" data-img="assets/product-chesters.jpg" data-tags="protein">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-chesters.jpg" alt="Protein Bar" loading="lazy"></div>
        <div class="title">Protein Bar</div>
        <div class="price">$2.99</div>
        <button class="add" aria-label="Add Protein Bar">+</button>
      </div>

      <div class="card" role="listitem" data-name="Trail Mix" data-price="3.49" data-img="assets/product-cheetos.jpg" data-tags="vegan,gluten-free">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-cheetos.jpg" alt="Trail Mix" loading="lazy"></div>
        <div class="title">Trail Mix</div>
        <div class="price">$3.49</div>
        <button class="add" aria-label="Add Trail Mix">+</button>
      </div>
    </div>
  </div> <!-- /.app -->

  <!-- Product mini sheet -->
  <div id="productSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Add item">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3 id="sheetTitle">Item</h3>
        <button class="ghost" id="sheetClose" type="button">Close</button>
      </div>
      <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
        <div style="width:88px;height:88px;border-radius:12px;overflow:hidden;border:1px solid #2a2a30;">
          <img id="sheetImg" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div style="flex:1">
          <div id="sheetPrice" class="price" style="font-size:18px;"></div>
          <div id="sheetStock" style="margin-top:6px;color:#c7c7cc;font-size:13px;">Stock: --</div>
          <div id="sheetLowWarn" style="display:none;margin-top:6px;color:#ff6b6b;font-weight:600;font-size:13px;">Low stock</div>
        </div>
      </div>
      <div class="row-between" style="margin-top:10px;">
        <div class="qty">
          <button id="qtyMinus" type="button">‚àí</button>
          <div id="qtyVal" aria-live="polite">1</div>
          <button id="qtyPlus" type="button">+</button>
        </div>
        <button class="primary" id="sheetAdd" type="button">Add</button>
      </div>
    </div>
  </div>

  <!-- Order details sheet -->
  <div id="orderSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Order details">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Order</h3>
        <button class="ghost" id="orderClose" type="button">Close</button>
      </div>
      <div id="orderMeta" style="margin-top:6px;color:#c7c7cc;font-size:13px">‚Äì</div>
      <div id="orderLines" class="admin-list" style="margin-top:8px">‚Äì</div>
      <div class="row-between" style="margin-top:10px;">
        <strong>Total</strong><strong id="orderTotal">$0.00</strong>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button class="ghost" id="orderCancel" type="button">Cancel</button>
        <button class="primary" id="orderDelivered" type="button">Mark Delivered</button>
      </div>
    </div>
  </div>

  <!-- Cart bottom-sheet -->
  <div id="cartOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Cart">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Cart</h3>
        <button class="ghost" id="cartBack" type="button">Back</button>
      </div>
      <div id="cartContent" class="sheet-body">Cart is empty</div>
      <div class="row-between" style="margin-top:10px;">
        <strong>Total</strong><strong id="cartTotal">$0.00</strong>
      </div>
      <div class="actions">
        <button class="ghost" id="reorderLast" type="button">Re-order last</button>
        <button class="primary" id="cartCheckout" type="button">Checkout</button>
      </div>
    </div>
  </div>

  <!-- Checkout bottom-sheet -->
  <div id="checkoutOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Checkout">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Checkout</h3>
        <button class="ghost" id="checkoutClose" type="button">Close</button>
      </div>

      <div class="sheet-body">
        <!-- Profile -->
        <div style="margin-top:6px;">Your name:</div>
        <input id="checkoutName" class="field" style="width:100%;padding:10px;border-radius:10px">
        <div style="margin-top:10px;">Where are you on campus?</div>
        <input id="checkoutLocation" class="field" style="width:100%;padding:10px;border-radius:10px">

        <!-- Promo -->
        <div style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div class="field" style="flex:1;min-width:0;padding:6px">
            <input id="checkoutPromo" placeholder="Promo code" style="flex:1;min-width:0;padding:10px;border-radius:10px;border:1px solid #2a2a30;background:#101014;color:#e9e9ec">
            <button class="ghost" id="checkoutApplyPromo" type="button" style="margin-left:8px">Apply</button>
          </div>
          <div id="promoStatus" class="badge-pill" style="display:none"></div>
        </div>

        <!-- Tip -->
        <div style="margin-top:12px;">Tip (optional)</div>
        <div class="tip-group" id="tipGroup">
          <button class="ghost tip-btn" data-tip="none" type="button">No tip</button>
          <button class="ghost tip-btn" data-tip="amount:1" type="button">$1</button>
          <button class="ghost tip-btn" data-tip="amount:2" type="button">$2</button>
          <button class="ghost tip-btn" data-tip="percent:10" type="button">10%</button>
          <div class="field" style="margin-left:auto">
            <input id="tipCustomAmount" type="number" min="0" step="0.5" placeholder="Custom $" style="width:110px;padding:8px;border-radius:10px;border:1px solid #2a2a30;background:#101014;color:#e9e9ec">
            <button class="ghost" id="tipApplyCustom" type="button" style="margin-left:8px">Set</button>
          </div>
        </div>

        <!-- Breakdown -->
        <div class="breakdown" style="margin-top:12px">
          <div class="break-row"><div class="muted">Subtotal</div><div id="ckSub">$0.00</div></div>
          <div class="break-row"><div class="muted">Discount</div><div id="ckDisc">-$0.00</div></div>
          <div class="break-row"><div class="muted">Tip</div><div id="ckTip">$0.00</div></div>
          <div class="break-row" style="font-weight:800"><div>Total</div><div id="ckTotal">$0.00</div></div>
        </div>

        <div id="checkoutError" style="display:none;color:#ff6b6b;margin-top:10px;">Please fill both fields.</div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="primary" id="checkoutSubmit" type="button">Place Order</button>
      </div>
    </div>
  </div>

  <!-- Settings bottom-sheet -->
  <div id="settingsOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Settings">
    <div class="sheet" role="document">
      <div class="row-between">
        <h3>Settings</h3>
        <button class="ghost" id="settingsClose" type="button">Close</button>
      </div>

      <div class="tabs" role="tablist" aria-label="Settings Tabs">
        <button id="tabGeneral" class="tab active" role="tab" aria-selected="true" aria-controls="panelGeneral" type="button">General</button>
        <button id="tabAdmin" class="tab" role="tab" aria-selected="false" aria-controls="panelAdmin" type="button">Admin</button>
      </div>

      <div class="sheet-body">
        <!-- General -->
        <div id="panelGeneral" role="tabpanel" aria-labelledby="tabGeneral">
          <div style="display:flex;gap:12px">
            <div class="ghost" aria-disabled="true">Dark Mode (disabled)</div>
            <div class="ghost" aria-disabled="true">Notifications (disabled)</div>
          </div>
        </div>

        <!-- Admin -->
        <div id="panelAdmin" role="tabpanel" aria-labelledby="tabAdmin" style="display:none">
          <!-- Login -->
          <div id="adminLogin">
            <div style="margin-top:6px;">Admin password:</div>
            <input id="adminPassword" type="password" class="field" style="width:100%;padding:10px;border-radius:10px">
            <div id="adminError" style="display:none;color:#ff6b6b;margin-top:6px;">Wrong password.</div>
            <div class="actions" style="margin-top:12px;">
              <button class="primary" id="adminSubmit" type="button">Unlock</button>
            </div>
          </div>

          <!-- Content (locked until unlock) -->
          <div id="adminContent" style="display:none">
            <div class="admin-subtabs">
              <button class="subtab active" data-subtab="orders" type="button">Orders</button>
              <button class="subtab" data-subtab="inventory" type="button">Inventory</button>
              <button class="subtab" data-subtab="analytics" type="button">Analytics</button>
              <button class="subtab" data-subtab="history" type="button">History</button>
            </div>

            <div style="margin:4px 0 8px;display:flex;gap:8px;align-items:center;">
              <button class="ghost" id="adminLock" type="button" style="padding:6px 10px">Lock Admin</button>
              <div id="adminState" style="font-size:12px;color:#c7c7cc">
                State: <strong id="adminStateVal">unknown</strong>
              </div>
            </div>

            <!-- Orders -->
            <div id="subtab-orders">
              <div style="margin-top:6px;font-weight:700">Orders</div>
              <div id="ordersList" class="admin-list">No orders yet</div>
            </div>

            <!-- Inventory -->
            <div id="subtab-inventory" style="display:none">
              <div style="margin-top:6px;font-weight:700">Inventory (Stock & Low)</div>
              <div id="inventoryList" class="admin-list">Loading‚Ä¶</div>
            </div>

            <!-- Analytics -->
            <div id="subtab-analytics" style="display:none">
              <div style="margin-top:6px;font-weight:700">Analytics Overview</div>
              <div class="kpis" style="margin-top:8px">
                <div class="kpi"><div class="label">Revenue</div><div id="kpiRevenue" class="value">$0.00</div></div>
                <div class="kpi"><div class="label">Orders</div><div id="kpiOrders" class="value">0</div></div>
                <div class="kpi"><div class="label">AOV</div><div id="kpiAOV" class="value">$0.00</div></div>
                <div class="kpi"><div class="label">Items sold</div><div id="kpiItems" class="value">0</div></div>
              </div>
              <div style="margin-top:12px">
                <div class="label" style="margin-bottom:6px">Revenue (last 7 days)</div>
                <svg id="revSpark" class="spark" viewBox="0 0 100 40" preserveAspectRatio="none" aria-label="Revenue last 7 days"></svg>
              </div>
              <div style="margin-top:12px;font-weight:700">Top Products</div>
              <div class="table">
                <div class="rowh"><div>Product</div><div>Qty</div><div>Revenue</div><div>Conv%</div></div>
                <div id="topProducts"></div>
              </div>
              <div style="margin-top:12px;font-weight:700">Funnel by Product</div>
              <div id="funnels" class="admin-list"></div>
            </div>

            <!-- History -->
            <div id="subtab-history" style="display:none">
              <div class="row-between" style="margin-top:6px;">
                <div style="font-weight:700">Delivered Orders (auto-clears after 3 days)</div>
                <button class="ghost" id="historyClear" type="button" style="padding:6px 10px">Clear history now</button>
              </div>
              <div id="historyList" class="admin-list" style="margin-top:8px">No delivered orders</div>
            </div>
          </div> <!-- /#adminContent -->
        </div> <!-- /#panelAdmin -->
      </div> <!-- /.sheet-body -->
    </div>
  </div>

  <!-- Toast host -->
  <div id="toastHost"></div>
    <script>
  /* ========= App boot & safe guards ========= */
  const APP_SCHEMA_VERSION = 3, SCHEMA_KEY = 'fitsnacks.schema';
  try{
    const cur = JSON.parse(localStorage.getItem(SCHEMA_KEY)||'0')||0;
    if(cur < APP_SCHEMA_VERSION) localStorage.setItem(SCHEMA_KEY, JSON.stringify(APP_SCHEMA_VERSION));
  }catch{
    localStorage.setItem(SCHEMA_KEY, JSON.stringify(APP_SCHEMA_VERSION));
  }
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js'));
  }

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  /* ========= Keys (storage) ========= */
  const CART_KEY        = 'fitsnacks.cart.v1';
  const ORDERS_KEY      = 'fitsnacks.orders';
  const UNLOCK_KEY      = 'fitsnacks.admin.unlocked';
  const STOCK_KEY       = 'fitsnacks.stock.qty';
  const LOW_KEY         = 'fitsnacks.stock.low';
  const STOCK_SET_KEY   = 'fitsnacks.stock.set';
  const SALES_KEY       = 'fitsnacks.sales.buckets';
  const DELIVERED_KEY   = 'fitsnacks.orders.delivered';
  const FAVORITES_KEY   = 'fitsnacks.favorites';
  const PROMOS_KEY      = 'fitsnacks.promos';
  const ANALYTICS_KEY   = 'fitsnacks.analytics.products';
  const PROFILE_NAME_KEY= 'fitsnacks.profile.name';
  const PROFILE_LOC_KEY = 'fitsnacks.profile.location';

  const ADMIN_PASSWORD='8TSB077';
  const fmt = n => '$'+n.toFixed(2);

  /* ========= Load/save helpers ========= */
  function loadCart(){ try{ return new Map(JSON.parse(localStorage.getItem(CART_KEY)||'[]')); }catch{ return new Map(); } }
  function saveCart(m){ try{ localStorage.setItem(CART_KEY, JSON.stringify(Array.from(m.entries())));}catch{} }
  function loadObj(k){ try{ return JSON.parse(localStorage.getItem(k)||'{}'); }catch{ return {}; } }
  function saveObj(k,o){ localStorage.setItem(k, JSON.stringify(o||{})); }
  function loadArr(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch{ return []; } }
  function saveArr(k,a){ localStorage.setItem(k, JSON.stringify(a||[])); }
  function loadOrders(){ try{ return JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]'); }catch{ return []; } }
  function saveOrders(v){ localStorage.setItem(ORDERS_KEY, JSON.stringify(v||[])); }
  function loadDelivered(){ try{ return JSON.parse(localStorage.getItem(DELIVERED_KEY)||'[]'); }catch{ return []; } }
  function saveDelivered(v){ localStorage.setItem(DELIVERED_KEY, JSON.stringify(v||[])); }
  function loadSales(){
    try{
      const raw=JSON.parse(localStorage.getItem(SALES_KEY)||'null');
      if(raw && raw.length===7 && raw[0].length===24) return raw;
    }catch{}
    return Array.from({length:7},()=>Array(24).fill(0));
  }
  function saveSales(m){ localStorage.setItem(SALES_KEY, JSON.stringify(m)); }
  function loadProfile(){ return {name:localStorage.getItem(PROFILE_NAME_KEY)||'', loc:localStorage.getItem(PROFILE_LOC_KEY)||''}; }
  function saveProfile(n,l){ try{ localStorage.setItem(PROFILE_NAME_KEY,n||''); localStorage.setItem(PROFILE_LOC_KEY,l||''); }catch{} }

  /* ========= App state ========= */
  let cart         = loadCart();
  let stockQty     = loadObj(STOCK_KEY);
  let stockLow     = loadObj(LOW_KEY);
  let stockSet     = loadObj(STOCK_SET_KEY); if(!Object.keys(stockSet).length){ stockSet={}; saveObj(STOCK_SET_KEY,stockSet); }
  let sales        = loadSales();
  let favorites    = new Set(loadArr(FAVORITES_KEY));
  let prodAnalytics= loadObj(ANALYTICS_KEY);

  function isUnlocked(){ return localStorage.getItem(UNLOCK_KEY)==='1'; }
  function setUnlocked(v){ localStorage.setItem(UNLOCK_KEY, v?'1':'0'); }
  setUnlocked(false);

  /* ========= Seed promos once ========= */
  if(!localStorage.getItem(PROMOS_KEY)){
    saveArr(PROMOS_KEY, [
      {img:'assets/carousel-1.jpg', title:'Fuel your study grind', cta:'Shop snacks', action:'scrollGrid'},
      {img:'assets/carousel-2.jpg', title:'Protein picks', cta:'Filter: protein', action:'filter', value:'protein'},
      {img:'assets/carousel-3.jpg', title:'Need help?', cta:'Open settings', action:'openSettings'}
    ]);
  }

  /* ========= Utils ========= */
  function haptic(ms=15){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch{} }
  function fmtTotal(){ let t=0; for(const[,info] of cart) t+=info.price*info.qty; return t; }
  function showToast(msg, ms=1800){
    const host=$('#toastHost'); if(!host) return;
    const el=document.createElement('div');
    el.className='toast'; el.textContent=msg;
    host.appendChild(el);
    requestAnimationFrame(()=>el.classList.add('show'));
    setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),250); }, ms);
  }
  function updateGreeting(){
    const g=$('#greet'); const p=loadProfile();
    if(g) g.textContent = p.name ? `Hi, ${p.name} üëã` : 'Welcome üëã';
  }

  /* ========= Carousel ========= */
  function buildPromos(){
    const data=loadArr(PROMOS_KEY), snapper=$('#snapper'); if(!snapper) return;
    snapper.querySelectorAll('.snap-card').forEach(n=>n.remove());
    const after=snapper.lastElementChild;
    data.forEach(p=>{
      const c=document.createElement('div');
      c.className='snap-card';
      c.innerHTML=`<img class="banner" src="${p.img}" alt="${p.title||'promo'}">
                   <div class="snap-meta"><div class="snap-title">${p.title||''}</div>
                   ${p.cta?`<button class="ghost snap-cta" type="button">${p.cta}</button>`:''}</div>`;
      snapper.insertBefore(c, after);
      if(p.action){
        c.addEventListener('click',e=>{
          if(e.target.closest('.snap-cta')) return;
          promoAction(p);
        },{passive:true});
        c.querySelector('.snap-cta')?.addEventListener('click',e=>{
          e.stopPropagation(); promoAction(p);
        },{passive:true});
      }
    });
    const cards=$$('.snap-card'), dotsWrap=$('#snapDots');
    dotsWrap.innerHTML = cards.map(()=>'<div class="snap-dot"></div>').join('');
    const dots=$$('.snap-dot');
    function setDot(i){ dots.forEach((d,k)=>d.classList.toggle('active',k===i)); }
    setDot(0);
    let idx=0; setInterval(()=>{ if(!cards.length) return; idx=(idx+1)%cards.length; setDot(idx); cards[idx].scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'}); }, 5000);
  }
  function promoAction(p){
    if(p.action==='openSettings'){ $('#settingsOverlay').classList.add('show'); switchTab('general'); }
    if(p.action==='filter'){ activateChip(p.value||''); }
    if(p.action==='scrollGrid'){ document.getElementById('grid')?.scrollIntoView({behavior:'smooth',block:'start'}); }
  }

  /* ========= Search ========= */
  $('#search').addEventListener('input', e=>{
    const q=(e.target.value||'').toLowerCase();
    let hits=0;
    $$('.card').forEach(c=>{
      const show = c.dataset.name.toLowerCase().includes(q);
      c.style.display = show ? '' : 'none';
      if(show) hits++;
    });
    if(q && !hits) showToast('No results found');
  });

  /* ========= Chips ========= */
  function activateChip(val){
    $$('#chips .chip').forEach(ch=>ch.classList.toggle('active', ch.dataset.filter===val));
    $$('.card').forEach(c=>{
      const tags=(c.dataset.tags||'').toLowerCase();
      const name=c.dataset.name;
      const show = !val || val==='' || (val==='favorites' ? favorites.has(name) : tags.includes(val));
      c.style.display = show ? '' : 'none';
    });
  }
  $('#chips').addEventListener('click', e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    activateChip(chip.dataset.filter||'');
  }, {passive:true});
  activateChip('');

  /* ========= Favorites ========= */
  function syncFavStars(){
    $$('.card').forEach(card=>{
      const favBtn=card.querySelector('.fav');
      if(favBtn) favBtn.classList.toggle('active', favorites.has(card.dataset.name));
    });
  }
  document.addEventListener('click', e=>{
    const fav=e.target.closest('.fav'); if(!fav) return;
    e.stopPropagation();
    const card=fav.closest('.card'); const name=card.dataset.name;
    if(favorites.has(name)) favorites.delete(name); else favorites.add(name);
    saveArr(FAVORITES_KEY, Array.from(favorites));
    syncFavStars();
  }, {passive:true});

  /* ========= Product Sheet ========= */
  let currentProduct=null;
  function ensureMetrics(name){
    if(!prodAnalytics[name]){
      prodAnalytics[name]={opens:0,adds:0,addedQty:0,purchasedQty:0,revenue:0};
    }
    return prodAnalytics[name];
  }
  function openProductSheet(card){
    currentProduct = {
      name: card.dataset.name,
      price: parseFloat(card.dataset.price),
      img: card.dataset.img
    };
    $('#sheetTitle').textContent = currentProduct.name;
    $('#sheetImg').src = currentProduct.img||'';
    $('#sheetImg').alt = currentProduct.name||'';
    $('#sheetPrice').textContent = fmt(currentProduct.price);
    $('#qtyVal').textContent = '1';
    $('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmt(currentProduct.price);

    const q = Number(stockQty[currentProduct.name] ?? NaN);
    const l = Number(stockLow[currentProduct.name] ?? NaN);
    if(Number.isFinite(q)){
      $('#sheetStock').textContent = 'Stock: ' + q;
      if(Number.isFinite(l) && q<=l){ $('#sheetLowWarn').style.display='block'; }
      else { $('#sheetLowWarn').style.display='none'; }
    }else{
      $('#sheetStock').textContent = 'Stock: --';
      $('#sheetLowWarn').style.display='none';
    }

    ensureMetrics(currentProduct.name).opens++;
    saveObj(ANALYTICS_KEY, prodAnalytics);

    $('#productSheet').classList.add('show');
  }
  function closeProductSheet(){ $('#productSheet').classList.remove('show'); }
  $$('.card').forEach(card=>{
    card.addEventListener('click', e=>{
      if(e.target.closest('.fav') || e.target.closest('.add')) return;
      openProductSheet(card);
    });
  });
  $$('.card .add').forEach(btn=>{
    const card=btn.closest('.card');
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      openProductSheet(card);
    });
  });
  $('#qtyPlus').addEventListener('click', ()=>{
    const n = Math.min(99, parseInt($('#qtyVal').textContent)||1 + 1);
    $('#qtyVal').textContent=n;
    $('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmt(n*(currentProduct?.price||0));
  });
  $('#qtyMinus').addEventListener('click', ()=>{
    const n = Math.max(1, parseInt($('#qtyVal').textContent)||1 - 1);
    $('#qtyVal').textContent=n;
    $('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmt(n*(currentProduct?.price||0));
  });
  $('#sheetClose').addEventListener('click', closeProductSheet);

  /* ========= Cart ========= */
  function refreshBadge(){
    let n=0; for(const v of cart.values()) n+=v.qty;
    const b=$('#cartBadge'); if(!b) return;
    if(n>0){ b.textContent=String(n); b.style.display='inline-flex'; }
    else { b.style.display='none'; }
  }
  function renderCart(){
    let total=0, html='';
    for(const [name,info] of cart){
      const line=info.price*info.qty; total+=line;
      html += `<div class="row-between" style="margin-top:6px">
        <div style="display:flex;gap:10px;align-items:center">
          <button data-act="-" data-name="${name}" class="ghost" type="button" style="padding:4px 8px">‚àí</button>
          <div style="min-width:24px;text-align:center">${info.qty}</div>
          <button data-act="+" data-name="${name}" class="ghost" type="button" style="padding:4px 8px">+</button>
          <div style="font-weight:700;margin-left:8px">${name}</div>
        </div>
        <div style="font-weight:700">${fmt(line)}</div>
      </div>`;
    }
    $('#cartContent').innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>';
    $('#cartTotal').textContent = fmt(total);
    saveCart(cart);
    refreshBadge();
  }
  document.addEventListener('click', (e)=>{
    const b=e.target.closest('button[data-act][data-name]'); if(!b) return;
    const name=b.getAttribute('data-name'); const act=b.getAttribute('data-act');
    const entry=cart.get(name); if(!entry) return;
    entry.qty = Math.max( (act==='+') ? entry.qty+1 : entry.qty-1 , 0);
    if(entry.qty===0) cart.delete(name);
    renderCart();
  });
  $('#sheetAdd').addEventListener('click', ()=>{
    const n = Math.max(1, parseInt($('#qtyVal').textContent)||1);
    if(!currentProduct) return;
    const entry = cart.get(currentProduct.name) || {price: currentProduct.price, qty:0};
    entry.qty += n;
    cart.set(currentProduct.name, entry);

    const m=ensureMetrics(currentProduct.name);
    m.adds = (m.adds||0)+1; m.addedQty=(m.addedQty||0)+n;
    saveObj(ANALYTICS_KEY, prodAnalytics);

    closeProductSheet();
    renderCart(); haptic(12);
    $('#cartOverlay').classList.add('show');
    showToast(`Added ${n} √ó ${currentProduct.name}`);
  });

  /* ========= Overlay helpers ========= */
  function openCart(){ $('#cartOverlay').classList.add('show'); }
  function closeCart(){ $('#cartOverlay').classList.remove('show'); }
  function openSettings(defToAdmin=false){
    $('#settingsOverlay').classList.add('show');
    switchTab(defToAdmin?'admin':'general');
    ensureAdminLoginVisible();
  }
  function closeSettings(){ $('#settingsOverlay').classList.remove('show'); }
  $('#cartBtn').addEventListener('click', openCart);
  $('#cartBack').addEventListener('click', closeCart);
  $('#settingsBtn').addEventListener('click', ()=>openSettings(false));
  $('#settingsClose').addEventListener('click', closeSettings);
  document.querySelectorAll('.overlay').forEach(ov=>{
    ov.addEventListener('click', (e)=>{ if(e.target===ov) ov.classList.remove('show'); });
  });
  document.addEventListener('keydown', e=>{
    if(e.key!=='Escape') return;
    ['productSheet','cartOverlay','checkoutOverlay','settingsOverlay','orderSheet']
      .forEach(id=>document.getElementById(id)?.classList.remove('show'));
  });

  /* ========= Initial paint ========= */
  buildPromos();
  renderCart();
  refreshBadge();
  updateGreeting();
    /* ========= Promo / Tip / Totals ========= */
  const PROMO_TABLE = {
    'SAVE10': {type:'percent', value:0.10, label:'10% off sitewide'},
    'BAR1':   {type:'amount',  value:1.00, label:'$1 off protein items', rule:'tag:protein'}
  };
  let activePromo=null;
  let activeTip={kind:'none', amount:0};

  function evalPromoDiscount(code){
    code=(code||'').trim().toUpperCase();
    if(!code || !PROMO_TABLE[code]) return null;
    const p = PROMO_TABLE[code];
    let subtotal=0; for(const[,info] of cart) subtotal+=info.price*info.qty;
    if(subtotal<=0) return null;
    let discount=0;
    if(p.rule && p.rule.startsWith('tag:')){
      const tag=p.rule.slice(4).toLowerCase(); let eligible=0;
      $$('.card').forEach(c=>{
        const entry=cart.get(c.dataset.name); if(!entry) return;
        if((c.dataset.tags||'').toLowerCase().includes(tag)){
          eligible+=entry.price*entry.qty;
        }
      });
      if(eligible<=0) return {code, label:`No eligible items for ${code}`, discount:0, ok:false};
      discount = p.type==='percent'? eligible*p.value : Math.min(p.value,eligible);
    }else{
      discount = p.type==='percent'? subtotal*p.value : Math.min(p.value,subtotal);
    }
    return {code,label:p.label,discount,ok:true};
  }

  function computeTotals(){
    let subtotal=0; for(const[,info] of cart) subtotal+=info.price*info.qty;
    const disc=activePromo?.discount||0;
    const tip = Math.max(0, activeTip.amount||0);
    const total = Math.max(0, subtotal-disc) + tip;
    return {subtotal, disc, tip, total};
  }

  function updateCheckoutBreakdown(){
    const {subtotal,disc,tip,total}=computeTotals();
    $('#ckSub').textContent=fmt(subtotal);
    $('#ckDisc').textContent=`-${fmt(disc)}`;
    $('#ckTip').textContent=fmt(tip);
    $('#ckTotal').textContent=fmt(total);
  }

  /* ========= Checkout open/close ========= */
  $('#cartCheckout').addEventListener('click', ()=>{
    const p=loadProfile();
    $('#checkoutName').value=p.name||''; $('#checkoutLocation').value=p.loc||'';
    $('#checkoutError').style.display='none';
    $('#checkoutPromo').value=''; activePromo=null;
    activeTip={kind:'none',amount:0}; $('#tipCustomAmount').value='';
    updateCheckoutBreakdown();
    $('#cartOverlay').classList.remove('show');
    $('#checkoutOverlay').classList.add('show');
  });
  $('#checkoutClose').addEventListener('click', ()=>$('#checkoutOverlay').classList.remove('show'));

  /* ========= Promo + Tip bindings ========= */
  $('#checkoutApplyPromo').addEventListener('click', ()=>{
    const res=evalPromoDiscount($('#checkoutPromo').value);
    const badge=$('#promoStatus');
    if(res && res.ok){ activePromo=res; badge.textContent=`${res.code} ‚Ä¢ -${fmt(res.discount)}`; badge.style.display='inline-flex'; }
    else if(res){ activePromo=null; badge.textContent=res.label||'Invalid'; badge.style.display='inline-flex'; }
    else { activePromo=null; badge.style.display='none'; }
    updateCheckoutBreakdown();
  });
  $('#tipGroup').addEventListener('click', e=>{
    const btn=e.target.closest('.tip-btn'); if(!btn) return;
    $$('#tipGroup .tip-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const spec=btn.getAttribute('data-tip')||'none';
    const [k,v='0']=spec.split(':');
    const {subtotal,disc}=computeTotals();
    if(k==='percent'){ const base=Math.max(0, subtotal-disc); activeTip={kind:'percent',amount:base*(+v/100)}; }
    else if(k==='amount'){ activeTip={kind:'amount',amount:+v}; }
    else { activeTip={kind:'none',amount:0}; }
    updateCheckoutBreakdown();
  });
  $('#tipApplyCustom').addEventListener('click', ()=>{
    const v=+($('#tipCustomAmount').value||0);
    activeTip={kind:'amount',amount:Math.max(0,v)};
    updateCheckoutBreakdown();
  });

  /* ========= IFTTT (no-preflight POST + image GET fallback) ========= */
  const IFTTT_EVENT = 'Fitsnack_order';
  const IFTTT_KEY   = 'MGeBZrzbzW3CyUXlWVMpQkvI1bRVirGd0gkcYZiA';
  const IFTTT_POST  = `https://maker.ifttt.com/trigger/${IFTTT_EVENT}/with/key/${IFTTT_KEY}`; // x-www-form-urlencoded
  const IFTTT_GET   = `https://maker.ifttt.com/trigger/${IFTTT_EVENT}/with/key/${IFTTT_KEY}`;

  function buildOrderSummary(order){
    return `${order.name} @ ${order.location} ‚Ä¢ Total ${fmt(order.total)}`;
  }
  function buildOrderLineItems(order){
    return order.lines.map(l => `${l.name} √ó ${l.qty} -- ${fmt(l.line)}`).join('\n');
  }
  async function sendIftttOrder(order){
    const v1 = buildOrderSummary(order);
    const v2 = buildOrderLineItems(order);
    const v3 = order.notes || '';

    // 1) Form-POST (simple request, no OPTIONS preflight)
    try{
      const body = new URLSearchParams({ value1:v1, value2:v2, value3:v3 }).toString();
      await fetch(IFTTT_POST, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body
      });
    }catch(_){} // ignore; fallback covers us

    // 2) GET beacon fallback (works through strict blockers)
    try{
      const qs = new URLSearchParams({ value1:v1, value2:v2, value3:v3 }).toString();
      new Image().src = `${IFTTT_GET}?${qs}`;
    }catch(_){}
  }

  /* ========= Orders & History ========= */
  function addOrderFromCart(name,loc,notes,discount,tip){
    const lines=[]; let total=0;
    for(const [n,info] of cart){ const line=info.price*info.qty; total+=line; lines.push({name:n,price:info.price,qty:info.qty,line}); }
    total=Math.max(0,total-(discount||0))+(tip||0);
    const order={when:new Date().toISOString(),name,location:loc,notes:notes||'',lines,total};
    const list=loadOrders(); list.unshift(order); saveOrders(list);
    lines.forEach(l=>{ const m=(prodAnalytics[l.name] ||= {opens:0,adds:0,addedQty:0,purchasedQty:0,revenue:0}); m.purchasedQty+=l.qty; m.revenue+=l.line; });
    saveObj(ANALYTICS_KEY,prodAnalytics);
    const d=new Date(), dow=d.getDay(), hr=d.getHours();
    sales[dow][hr]=(sales[dow][hr]||0)+1; saveSales(sales);
    return order;
  }

  function renderOrders(){
    const list=loadOrders(), box=$('#ordersList'); if(!box) return;
    if(!list.length){ box.textContent='No orders yet'; return; }
    box.innerHTML=list.map((o,i)=>{
      const items=o.lines.map(l=>`${l.name} √ó ${l.qty} -- ${fmt(l.line)}`).join('<br>');
      const when=new Date(o.when).toLocaleString();
      return `<div class="order-item" data-idx="${i}" style="padding:8px;border-bottom:1px solid #2a2a30;cursor:pointer">
        <div style="font-weight:700">${when}</div>
        <div>${o.name} @ ${o.location}</div>
        <div>${items}</div>
        <div style="font-weight:700">Total ${fmt(o.total)}</div>
      </div>`;
    }).join('');
  }

  function renderHistory(){
    const list=loadDelivered(), box=$('#historyList'); if(!box) return;
    if(!list.length){ box.textContent='No delivered orders'; return; }
    box.innerHTML=list.map(o=>{
      const items=o.lines.map(l=>`${l.name} √ó ${l.qty} -- ${fmt(l.line)}`).join('<br>');
      const placed=new Date(o.when).toLocaleString();
      const del=o.deliveredWhen?new Date(o.deliveredWhen).toLocaleString():'--';
      return `<div style="padding:8px;border-bottom:1px solid #2a2a30">
        <div style="font-weight:700">Delivered: ${del}</div>
        <div style="color:#bbb;margin-top:2px">Placed: ${placed}</div>
        <div style="color:#bbb;margin-top:2px">${o.name} @ ${o.location}</div>
        <div style="margin-top:6px">${items}</div>
        <div style="font-weight:700;margin-top:6px">Total: ${fmt(o.total)}</div>
      </div>`;
    }).join('');
  }

  /* ========= Place order ========= */
  $('#checkoutSubmit').addEventListener('click', async ()=>{
    const name=$('#checkoutName').value.trim();
    const loc=$('#checkoutLocation').value.trim();
    const notes=''; // add a notes field if you expose one in UI
    if(!name||!loc){ $('#checkoutError').style.display='block'; return; }
    saveProfile(name,loc);

    const {disc,tip}=computeTotals();
    const order=addOrderFromCart(name,loc,notes,disc,tip);

    cart.clear(); renderCart();
    $('#checkoutOverlay').classList.remove('show');
    updateGreeting(); showToast('Order placed üéâ');

    await sendIftttOrder(order);
  });

  /* ========= Admin tabs + subtabs ========= */
  function switchTab(which){
    const g=$('#tabGeneral'), a=$('#tabAdmin'), pg=$('#panelGeneral'), pa=$('#panelAdmin');
    if(which==='admin'){
      g.classList.remove('active'); g.setAttribute('aria-selected','false');
      a.classList.add('active');    a.setAttribute('aria-selected','true');
      pg.style.display='none'; pa.style.display='block'; ensureAdminLoginVisible();
    }else{
      a.classList.remove('active'); a.setAttribute('aria-selected','false');
      g.classList.add('active');    g.setAttribute('aria-selected','true');
      pa.style.display='none'; pg.style.display='block';
    }
  }
  function ensureAdminLoginVisible(){
    const logged=(localStorage.getItem(UNLOCK_KEY)==='1');
    $('#adminLogin').style.display=logged?'none':'block';
    $('#adminContent').style.display=logged?'block':'none';
    if(logged){
      renderOrders(); renderHistory(); renderAnalytics(); renderInventory();
      document.querySelector('.admin-subtabs')?.querySelector('.subtab[data-subtab="orders"]')?.click();
    }
  }
  // Explicit bindings so they always work
  (function bindAdminTabs(){
    const g=document.getElementById('tabGeneral');
    const a=document.getElementById('tabAdmin');
    g?.addEventListener('click', ()=>switchTab('general'));
    a?.addEventListener('click', ()=>switchTab('admin'));

    document.getElementById('adminSubmit')?.addEventListener('click', ()=>{
      const ok=$('#adminPassword').value===ADMIN_PASSWORD;
      if(ok){ localStorage.setItem(UNLOCK_KEY,'1'); $('#adminError').style.display='none'; ensureAdminLoginVisible(); }
      else { $('#adminError').style.display='block'; }
    });
    document.getElementById('adminLock')?.addEventListener('click', ()=>{ localStorage.setItem(UNLOCK_KEY,'0'); ensureAdminLoginVisible(); });

    // Subtabs
    const wrap=document.querySelector('.admin-subtabs');
    if(!wrap) return;
    const sections={
      orders:    document.getElementById('subtab-orders'),
      inventory: document.getElementById('subtab-inventory'),
      analytics: document.getElementById('subtab-analytics'),
      history:   document.getElementById('subtab-history'),
    };
    function showSubtab(which){
      wrap.querySelectorAll('.subtab').forEach(b=>b.classList.toggle('active', b.dataset.subtab===which));
      Object.entries(sections).forEach(([k,el])=>{ if(el) el.style.display=(k===which)?'block':'none'; });
      if(which==='orders')    renderOrders();
      if(which==='inventory') renderInventory();
      if(which==='analytics') renderAnalytics();
      if(which==='history')   renderHistory();
    }
    wrap.addEventListener('click', e=>{
      const btn=e.target.closest('.subtab'); if(!btn) return;
      showSubtab(btn.dataset.subtab||'orders');
    }, {passive:true});
    showSubtab('orders'); // default
  })();

  /* ========= Inventory & stock UI ========= */
  function getProducts(){
    return $$('.card').map(c=>({
      name: c.dataset.name,
      price: +c.dataset.price,
      img: c.dataset.img,
      tags: (c.dataset.tags||'').toLowerCase()
    }));
  }
  function renderInventory(){
    const wrap = $('#inventoryList'); if(!wrap) return;
    const products = getProducts();
    if(!products.length){ wrap.textContent = 'No products'; return; }
    wrap.innerHTML = products.map(p=>{
      const hasQ = Object.prototype.hasOwnProperty.call(stockQty, p.name);
      const hasL = Object.prototype.hasOwnProperty.call(stockLow, p.name);
      const qty  = hasQ ? Number(stockQty[p.name]||0) : '';
      const low  = hasL ? Number(stockLow[p.name]||0) : '';
      return `<div class="field" data-prod="${p.name}">
        <div style="flex:1;font-weight:600">${p.name}</div>
        <label style="font-size:12px;color:#c7c7cc">Stock</label>
        <input type="number" min="0" value="${qty}" data-k="qty" placeholder="--">
        <label style="font-size:12px;color:#c7c7cc">Low</label>
        <input type="number" min="0" value="${low}" data-k="low" placeholder="--">
      </div>`;
    }).join('');
  }
  function ensureBadgeWrap(card){
    let w = card.querySelector('.badge-wrap');
    if(!w){ w = document.createElement('div'); w.className='badge-wrap'; card.appendChild(w); }
    return w;
  }
  function updateStockBadges(){
    $$('.card').forEach(card=>{
      const name = card.dataset.name;
      const wrap = ensureBadgeWrap(card);
      wrap.innerHTML = '';
      if(!Object.prototype.hasOwnProperty.call(stockQty,name)) return;
      const qty = Number(stockQty[name]||0);
      const low = Number(stockLow[name]||0);
      const b = document.createElement('div');
      b.className = 'stock-badge';
      b.textContent = 'Stock: ' + qty;
      wrap.appendChild(b);
      if(Number.isFinite(low) && low>0 && qty<=low){
        const l = document.createElement('div');
        l.className = 'stock-badge low-badge';
        l.textContent = `Only ${qty} left`;
        wrap.appendChild(l);
      }
    });
  }
  function refreshMiniIfOpen(){
    const ov=$('#productSheet');
    if(!ov || !ov.classList.contains('show') || !currentProduct) return;
    const name=currentProduct.name;
    if(Object.prototype.hasOwnProperty.call(stockQty,name)){
      const q=Number(stockQty[name]||0);
      const l=Number(stockLow[name]||0);
      $('#sheetStock').textContent='Stock: '+q;
      if(Number.isFinite(l) && l>0 && q<=l){
        $('#sheetLowWarn').style.display='block';
        $('#sheetLowWarn').textContent='Low stock ('+q+' ‚â§ '+l+')';
      }else{
        $('#sheetLowWarn').style.display='none';
      }
    }else{
      $('#sheetStock').textContent='Stock: --';
      $('#sheetLowWarn').style.display='none';
    }
  }
  document.addEventListener('input', (e)=>{
    const row=e.target.closest('.field[data-prod]'); if(!row) return;
    const name=row.getAttribute('data-prod');
    if(e.target.matches('input[data-k="qty"]')){
      const v=(e.target.value||'').trim();
      if(v===''){ delete stockQty[name]; } else { stockQty[name]=Number(v); }
      saveObj(STOCK_KEY, stockQty);
      updateStockBadges(); refreshMiniIfOpen();
    }
    if(e.target.matches('input[data-k="low"]')){
      const v2=(e.target.value||'').trim();
      if(v2===''){ delete stockLow[name]; } else { stockLow[name]=Number(v2); }
      saveObj(LOW_KEY, stockLow);
      updateStockBadges(); refreshMiniIfOpen();
    }
  });

  /* ========= Sales Heat Map & Analytics ========= */
  function renderHeat(){
    const grid=$('#heatGrid'); if(!grid) return;
    let max=0;
    for(let d=0; d<7; d++) for(let h=0; h<24; h++) if(sales[d][h]>max) max=sales[d][h];
    grid.innerHTML='';
    for(let d=0; d<7; d++){
      for(let h=0; h<24; h++){
        const v=sales[d][h];
        const alpha = max ? (0.08 + 0.62*(v/max)) : 0.10;
        const cell=document.createElement('div');
        cell.className='heat-cell';
        cell.title=`Day ${d}, ${h}:00 -- ${v}`;
        cell.style.background=`rgba(110,168,254,${alpha})`;
        grid.appendChild(cell);
      }
    }
  }
  function renderAnalytics(){
    const orders=loadOrders(), delivered=loadDelivered(), all=orders.concat(delivered);
    let rev=0, items=0; all.forEach(o=>{ rev+=o.total; o.lines.forEach(l=>items+=l.qty); });
    const cnt=all.length, aov=cnt?(rev/cnt):0;
    $('#kpiRevenue').textContent=fmt(rev);
    $('#kpiOrders').textContent=cnt;
    $('#kpiAOV').textContent=fmt(aov);
    $('#kpiItems').textContent=items;

    const days=Array(7).fill(0), now=new Date();
    all.forEach(o=>{
      const d=new Date(o.when); const diff=Math.floor((now-d)/(24*3600*1000));
      if(diff>=0 && diff<7) days[6-diff]+=o.total;
    });
    drawSpark(days);

    const rows={};
    all.forEach(o=>o.lines.forEach(l=>{
      if(!rows[l.name]) rows[l.name]={qty:0,rev:0};
      rows[l.name].qty+=l.qty; rows[l.name].rev+=l.line;
    }));
    const sorted=Object.entries(rows).sort((a,b)=>b[1].rev-a[1].rev).slice(0,8);
    $('#topProducts').innerHTML=sorted.length? sorted.map(([n,v])=>
      `<div class="rowd"><div>${n}</div><div>${v.qty}</div><div>${fmt(v.rev)}</div><div>-</div></div>`
    ).join('') : '<div class="rowd"><div>No sales</div></div>';

    const funnels=sorted.map(([n,v])=>(
      `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">
        <div style="font-weight:700">${n}</div>
        <div>Sold: ${v.qty} ‚Ä¢ Revenue: ${fmt(v.rev)}</div>
      </div>`
    )).join('');
    $('#funnels').innerHTML=funnels || '<div>No funnel data</div>';
  }
  function drawSpark(b){
    const svg=$('#revSpark'); if(!svg) return;
    const max=Math.max(1,...b), step=100/(b.length-1||1);
    const pts=b.map((v,i)=>`${i*step},${40-(v/max)*36-2}`).join(' ');
    svg.innerHTML=`<polyline points="${pts}" fill="none" stroke="url(#g)" stroke-width="2"/>
      <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="#6ea8fe"/><stop offset="100%" stop-color="#3cd27f"/>
      </linearGradient></defs>`;
  }

  /* ========= Delivered auto-prune ========= */
  function pruneDelivered(hours=72){
    const list=loadDelivered();
    const cutoff=Date.now()-hours*3600*1000;
    const keep=list.filter(o=>{
      const t=Date.parse(o.deliveredWhen||o.when||0);
      return isFinite(t) && t>=cutoff;
    });
    if(keep.length!==list.length) saveDelivered(keep);
  }

  /* ========= First paints for this chunk ========= */
  renderInventory();
  updateStockBadges();
  renderHeat();
  renderHistory();
  renderOrders();
  renderAnalytics();
  pruneDelivered(72);

  /* ========= Safety net ========= */
  window.addEventListener('error', (e)=>{
    try{ console.error('[FitSnacks] Uncaught error:', e.message, e.error); }catch{}
    try{ showToast && showToast('App error: '+e.message, 2800); }catch{}
  });
  </script>
</body>
</html>