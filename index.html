<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FitSnacks</title>
  <meta name="theme-color" content="#0b0b0d">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root { --bg:#0b0b0d; --text:#e9e9e9; --muted:#cfcfd6; --accent:#6ea8fe; --glass:rgba(30,30,36,.55); --line:rgba(255,255,255,.08); }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;display:flex;flex-direction:column}

    /* Header */
    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(8px);background:rgba(16,16,20,.55);border-bottom:1px solid var(--line)}
    .bar{max-width:960px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    form.search{flex:1;display:flex;align-items:center;gap:8px}
    .search input[type="search"]{
      width:100%; padding:10px 14px; border-radius:999px; border:1px solid var(--line);
      background:var(--glass); color:var(--text); outline:none;
    }
    .search button{
      border:1px solid var(--line); background:var(--glass); color:var(--text);
      border-radius:999px; padding:10px 14px; cursor:pointer;
    }

    /* Layout */
    main{flex:1;display:flex;justify-content:center;align-items:flex-start}
    .wrap{width:100%;max-width:960px;padding:28px 16px}
    .card{background:var(--glass);border:1px solid var(--line);border-radius:14px;padding:28px;box-shadow:0 6px 24px rgba(0,0,0,.28)}
    h1{margin:0 0 8px;font-size:28px}
    p{margin:0;color:var(--muted)}
    footer{opacity:.7;text-align:center;padding:24px 8px}
  </style>
  </header>

  <main>
    <div class="wrap">
      <section class="card">
        <h1>Clean start</h1>
        <p>Header now has a search bar. No brand text is shown.</p>
      </section>
    </div>
  </main>

  <footer>© 2025 FitSnacks</footer>

  <script>
    function handleSearch(e){
      e.preventDefault();
      const q = (document.getElementById('q')?.value || '').trim();
      if(!q){ alert('Type something to search.'); return false; }
      console.log('Search submitted:', q);
      // TODO: replace with real search later
      alert('Searching for: ' + q);
      return false;
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(r => console.log('SW registered:', r.scope))
          .catch(err => console.warn('SW registration failed:', err));
      });
    }
  </script>
<div id="cartModal" style="position:fixed;inset:0;display:none;z-index:9999;">
  <div onclick="openCart()" style="position:absolute;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(2px);"></div>
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
              width:90%;max-width:420px;background:#111827;color:#fff;border-radius:16px;
              padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.6);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h2 style="margin:0;font-size:22px;">Your Cart</h2>
      <button onclick="openCart()" style="background:transparent;border:0;color:#9ca3af;font-size:18px;">✕</button>
    </div>
    <div id="cartBody" style="color:#cbd5e1">Cart is empty</div>
  </div>
</div>
<script>function showCart(){var m=document.getElementById("cartModal"); if(m){m.style.display="block";}}
function hideCart(){var m=document.getElementById("cartModal"); if(m){m.style.display="none";}}</script>
<script>
(function(){
  function q(id){return document.getElementById(id);}
  window.showCart = function(){ var m=q("cartModal"); if(m){ m.style.display="block"; }};
  window.hideCart = function(){ var m=q("cartModal"); if(m){ m.style.display="none"; }};
  window.addEventListener("DOMContentLoaded", function(){
    // If multiple #cartModal exist, keep the first and remove the rest
    var mods = document.querySelectorAll("#cartModal");
    for (var i=1;i<mods.length;i++){ mods[i].remove(); }
    // Always start hidden
    if (mods[0]) { mods[0].style.display="none"; }
    // Close on ESC
    document.addEventListener("keydown", function(e){ if(e.key==="Escape"){ hideCart(); }});
  });
})();
</script>
<script id="cartModalFix">(function(){
  function $(s,root){return (root||document).querySelector(s);}
  function $all(s,root){return Array.from((root||document).querySelectorAll(s));}
  function modal(){return document.getElementById("cartModal");}
  window.showCart=function(){ var m=modal(); if(!m) return; m.classList.add("open"); m.style.display="flex"; };
  window.hideCart=function(){ var m=modal(); if(!m) return; m.classList.remove("open","show","visible"); m.style.display="none"; };
  window.addEventListener("DOMContentLoaded", function(){
    var mods=$all("#cartModal");
    for (var i=1;i<mods.length;i++){ mods[i].remove(); }
    var m=mods[0];
    if(!m){ return; }
    /* Strip any inline display or auto-open classes */
    m.classList.remove("open","show","visible","active");
    m.style.display="none";
    /* Overlay click to close */
    m.addEventListener("click", function(e){ if(e.target===m){ hideCart(); }});
    /* Close buttons inside */
    $all(".close-btn,[data-close]", m).forEach(function(btn){ btn.addEventListener("click", hideCart); });
    /* ESC to close */
    document.addEventListener("keydown", function(e){ if(e.key==="Escape") hideCart(); });
  });
})();</script>
  <div id="cartBackdrop" class="cart-backdrop" hidden></div>
  <div id="cartDialog" class="cart-dialog" hidden>
    <div class="cart-head"><div class="cart-title">Your cart</div><button id="cartClose" class="icon-btn" type="button">Close</button></div>
    <p class="muted" id="cartBody">Cart is empty.</p>
  </div>
  <script id="cartLogic">
  const $=s=>document.querySelector(s);
  const cartBtn=$("#cartBtn"); const dialog=$("#cartDialog"); const backdrop=$("#cartBackdrop"); const closeBtn=$("#cartClose");
  // Hide ANY stray old cart overlays that might be hard-coded
  document.querySelectorAll(".cart-dialog:not(#cartDialog)").forEach(el=>el.hidden=true);
  document.querySelectorAll(".cart-backdrop:not(#cartBackdrop)").forEach(el=>el.hidden=true);
  function openCart(){backdrop.hidden=false;dialog.hidden=false;document.body.style.overflow=hidden}
  function closeCart(){dialog.hidden=true;backdrop.hidden=true;document.body.style.overflow=}
  cartBtn&&cartBtn.addEventListener(click,openCart);
  closeBtn&&closeBtn.addEventListener(click,closeCart);
  backdrop&&backdrop.addEventListener(click,closeCart);
  window.addEventListener(keydown,e=>{if(e.key===Escape) closeCart()});
  </script>
<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const cartBtn = $("#cartBtn");
  const searchForm = document.getElementById("searchForm");
  const dialog   = document.getElementById("cartDialog");
  const backdrop = document.getElementById("cartBackdrop");
  const closeBtn = document.getElementById("cartClose");
  function openCart(e){ if(e) e.preventDefault(); if(searchForm) e && e.stopPropagation();
    if(backdrop) backdrop.hidden=false; if(dialog) dialog.hidden=false; document.body.style.overflow="hidden"; }
  function closeCart(e){ if(e) e.preventDefault(); if(backdrop) backdrop.hidden=true; if(dialog) dialog.hidden=true; document.body.style.overflow=""; }
  if(cartBtn){ cartBtn.addEventListener("click", openCart); }
  if(closeBtn){ closeBtn.addEventListener("click", closeCart); }
  if(backdrop){ backdrop.addEventListener("click", closeCart); }
  /* stop the search form from reacting when the click originated on the cart button */
  if(searchForm){ searchForm.addEventListener("submit", function(ev){
      const fromCart = ev.submitter && ev.submitter.id === "cartBtn";
      if(fromCart){ ev.preventDefault(); ev.stopPropagation(); openCart(ev); }
  }); }
})();
</script>
<script>(function(){
  const $=(s)=>document.querySelector(s);
  const cartBtn = $("#cartBtn");
  const searchForm = document.querySelector("form");
  const searchInput = document.querySelector("input[type=\"search\"]")||$("#search");
  const dialog   = document.getElementById("cartDialog");
  const backdrop = document.getElementById("cartBackdrop");
  const closeBtn = document.getElementById("cartClose");
  function openCart(e){ if(e){e.preventDefault(); e.stopPropagation();} if(backdrop) backdrop.hidden=false; if(dialog) dialog.hidden=false; document.body.style.overflow="hidden"; }
  function closeCart(e){ if(e){e.preventDefault(); e.stopPropagation();} if(backdrop) backdrop.hidden=true; if(dialog) dialog.hidden=true; document.body.style.overflow=""; }
  if(cartBtn){ cartBtn.addEventListener("click", openCart); }
  if(closeBtn){ closeBtn.addEventListener("click", closeCart); }
  if(backdrop){ backdrop.addEventListener("click", closeCart); }
  /* Only show search UI if there is a real query; otherwise do nothing */
  if(searchForm){ searchForm.addEventListener("submit", function(ev){
    const q = (searchInput && searchInput.value || "").trim();
    if(!q){ ev.preventDefault(); ev.stopPropagation(); /* no empty search popup */ }
  }, true); }
})();</script>
<script>
 (function(){
   const $=s=>document.querySelector(s);
   const btn=$("#cartBtn");
   const dialog=document.getElementById("cartDialog");
   const backdrop=document.getElementById("cartBackdrop");
   function openCart(){ if(backdrop) backdrop.hidden=false; if(dialog) dialog.hidden=false; document.body.style.overflow="hidden"; }
   function closeCart(){ if(dialog) dialog.hidden=true; if(backdrop) backdrop.hidden=true; document.body.style.overflow=""; }
   if(btn) btn.onclick=openCart;
   if(backdrop) backdrop.onclick=closeCart;
   const x=document.getElementById("cartClose"); if(x) x.onclick=closeCart;
   window.addEventListener("keydown",e=>{ if(e.key==="Escape") closeCart(); });
 })();
</script>
<script>
(function(){
 const btn=document.getElementById("cartBtn");
 const dlg=document.getElementById("cartDialog");
 const bg=document.getElementById("cartBackdrop");
 function openCart(){ if(bg) bg.hidden=false; if(dlg) dlg.hidden=false; document.body.style.overflow="hidden"; }
 function closeCart(){ if(bg) bg.hidden=true; if(dlg) dlg.hidden=true; document.body.style.overflow=""; }
 if(btn) btn.onclick=openCart;
 if(bg) bg.onclick=closeCart;
 const x=document.getElementById("cartClose"); if(x) x.onclick=closeCart;
 window.addEventListener("keydown",e=>{ if(e.key==="Escape") closeCart(); });
})();
</script>
</body>
</html>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const cartBtn = document.getElementById('cartBtn');
  if (cartBtn) {
    cartBtn.textContent = 'CART';
    cartBtn.setAttribute('aria-label','Open cart');
    cartBtn.addEventListener('click', function(){
      const ov = document.getElementById('cartOverlay');
      if (ov) ov.classList.add('show');
      else alert('Cart overlay not found yet');
    });
  }
});
</script>
<!-- Cart Overlay -->
<div id="cartOverlay" class="overlay" style="display:none;">
  <div class="sheet" style="background:rgba(20,20,24,.95);padding:20px;border-radius:18px;max-width:380px;margin:auto;">
    <div class="row-between" style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Your Cart</h3>
      <button id="closeCart" style="background:none;border:none;color:#fff;font-size:18px;">✕</button>
    </div>
    <div id="cartContent" style="margin-top:12px;color:#c7c7cc;">Cart is empty</div>
  </div>
</div>

<script>
document.querySelector('#cartBtn')?.addEventListener('click',()=>{
  document.querySelector('#cartOverlay').style.display='flex';
});
document.querySelector('#closeCart')?.addEventListener('click',()=>{
  document.querySelector('#cartOverlay').style.display='none';
});
</script>
<!-- === UPDATE CART STYLES: CENTERED MODAL === -->
<style>
  #cartPanel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 92%;
    max-width: 460px;
    background: #111;
    border: 1px solid #2a2a2e;
    border-radius: 20px;
    box-shadow: 0 25px 60px rgba(0,0,0,.6);
    padding: 24px;
    display: none;
    z-index: 10000;
    animation: fadeIn .25s ease;
  }
  #cartPanel.show {
    display: block;
  }
  #cartPanel h3 {
    margin: 0 0 12px;
    font-size: 20px;
    text-align: center;
  }
  #cartClose {
    appearance: none;
    border: 0;
    background: #222;
    color: #fff;
    padding: 8px 18px;
    border-radius: 12px;
    display: block;
    margin: 16px auto 0;
  }
  #cartEmpty {
    opacity: .8;
    text-align: center;
    margin-top: 20px;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translate(-50%, -46%); }
    to { opacity: 1; transform: translate(-50%, -50%); }
  }
</style>
<!-- === /UPDATE CART STYLES === -->
<!-- CART MODAL OVERRIDES -->
<style>
  /* Target multiple possibilities just in case the id/class differs */
  #cartPanel,
  .cart-panel,
  [data-cart-panel] {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;

    width: 92% !important;
    max-width: 480px !important;
    background: #111 !important;
    border: 1px solid #2a2a2e !important;
    border-radius: 20px !important;
    box-shadow: 0 25px 60px rgba(0,0,0,.6) !important;
    padding: 24px !important;
    z-index: 10000 !important;

    /* Kill any previous bottom/right/inset rules */
    bottom: auto !important;
    right: auto !important;
    inset: auto !important;
  }

  #cartPanel h3,
  .cart-panel h3,
  [data-cart-panel] h3 {
    margin: 0 0 12px !important;
    font-size: 20px !important;
    text-align: center !important;
  }

  #cartEmpty,
  .cart-empty,
  [data-cart-empty] {
    opacity: .8 !important;
    text-align: center !important;
    margin-top: 20px !important;
  }
</style>
<!-- /CART MODAL OVERRIDES -->
<!-- Force CART modal to enlarge + center -->
<style>
  #cartPanel,
  .cart-panel,
  [data-cart-panel] {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 90% !important;
    max-width: 500px !important;
    height: auto !important;
    min-height: 280px !important;
    background: #111 !important;
    border-radius: 22px !important;
    padding: 30px !important;
    z-index: 9999 !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    align-items: center !important;
    box-shadow: 0 20px 50px rgba(0,0,0,.7) !important;
  }

  #cartPanel h3,
  .cart-panel h3,
  [data-cart-panel] h3 {
    font-size: 22px !important;
    margin-bottom: 15px !important;
  }
</style>

<script>
  // Force real-time centering when opened
  document.addEventListener("DOMContentLoaded", () => {
    const cart = document.querySelector("#cartPanel, .cart-panel, [data-cart-panel]");
    if (cart) {
      const observer = new MutationObserver(() => {
        cart.style.top = "50%";
        cart.style.left = "50%";
        cart.style.transform = "translate(-50%, -50%)";
      });
      observer.observe(cart, { attributes: true, attributeFilter: ["style"] });
    }
  });
</script>
<!-- /Force CART modal to enlarge + center -->
<style>
.cart-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(30, 30, 35, 0.95);
  color: white;
  padding: 20px 30px;
  border-radius: 18px;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
  width: 80%;
  max-width: 400px;
  text-align: center;
  z-index: 9999;
  display: none;
}
.cart-modal.active {
  display: block;
}
</style>
<!-- v:cart-fix-4 -->
<style>
#cartDialog{
  position:fixed !important;
  top:50% !important;
  left:50% !important;
  transform:translate(-50%,-50%) !important;
  width:clamp(320px,60vw,420px) !important;
  max-height:60vh !important;
  border-radius:16px !important;
  z-index:1000 !important;
}
#cartBackdrop{
  position:fixed !important;
  inset:0 !important;
  background:rgba(0,0,0,.55) !important;
  backdrop-filter:blur(2px) !important;
  z-index:999 !important;
}
</style>
<!-- v:cart-fix-5 -->
<style>
  /* Resize + center the REAL cart dialog */
  #cartDialog{
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%,-50%) !important;
    width: clamp(320px, 55vw, 420px) !important;  /* a bit smaller */
    max-height: 55vh !important;                  /* a bit smaller */
    border-radius: 16px !important;
    z-index: 1000 !important;
  }
  #cartBackdrop{
    position: fixed !important;
    inset: 0 !important;
    background: rgba(0,0,0,.55) !important;
    backdrop-filter: blur(2px) !important;
    z-index: 999 !important;
  }
</style>

<script>
/* Kill any legacy cart UIs and stop auto-open */
(function(){
  const keep = new Set(['cartDialog','cartBackdrop','cartBtn','cartClose']);
  // Hide any old cart elements that might be stuck on screen
  document.querySelectorAll('[id*="cart"]').forEach(el=>{
    if(!keep.has(el.id)) el.style.display = 'none';
  });
  // Ensure our real cart is hidden by default
  const dialog = document.getElementById('cartDialog');
  const backdrop = document.getElementById('cartBackdrop');
  if (dialog) dialog.hidden = true;
  if (backdrop) backdrop.hidden = true;

  // Remove ANY accidental auto-open calls that might have slipped in
  // (If some inline script called openCart(), this prevents it from running again)
  window.openCart = window.openCart || function(){ 
    if (!dialog || !backdrop) return;
    backdrop.hidden = false; dialog.hidden = false; document.body.style.overflow = 'hidden';
  };
  window.closeCart = window.closeCart || function(){
    if (!dialog || !backdrop) return;
    dialog.hidden = true; backdrop.hidden = true; document.body.style.overflow = '';
  };
})();
</script>
<!-- v:cart-fix-6 -->
<style>
  /* Always hide any element marked hidden */
  [hidden]{display:none !important;}

  /* Nuke any legacy cart dialogs, keep only our #cartDialog visible */
  .cart-dialog:not(#cartDialog), .cart-modal:not(#cartDialog) { width:clamp(320px,65vw,440px); max-height:65vh; top:50%; left:50%; transform:translate(-50%,-50%); position:fixed; z-index:1000;  display:none !important; }

  /* Resize + center our real cart */
  #cartDialog{
    position:fixed !important;
    top:50% !important; left:50% !important; transform:translate(-50%,-50%) !important;
    width: clamp(320px, 52vw, 420px) !important;
    max-height: 55vh !important;
    border-radius:16px !important; z-index:1000 !important;
  }
  #cartBackdrop{
    position:fixed !important; inset:0 !important;
    background:rgba(0,0,0,.55) !important; backdrop-filter:blur(2px) !important;
    z-index:999 !important;
  }
</style>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const dialog   = $('#cartDialog');
  const backdrop = $('#cartBackdrop');
  const cartBtn  = $('#cartBtn');
  const closeBtn = $('#cartClose');

  // 1) Hide ANY stray/legacy cart UIs
  document.querySelectorAll('[id*="cart"], .cart-dialog, .cart-modal, .modal').forEach(el=>{ width:clamp(320px,65vw,440px); max-height:65vh; top:50%; left:50%; transform:translate(-50%,-50%); position:fixed; z-index:1000; 
    if (el !== dialog && el !== backdrop) {
      el.style.display = 'none';
      el.hidden = true;
      el.removeAttribute('open');
    }
  });

  // 2) Make sure our cart starts hidden and is closable
  function openCart(){ if(!dialog||!backdrop) return;
    backdrop.hidden=false; dialog.hidden=false; document.body.style.overflow='hidden';
  }
  function closeCart(){ if(!dialog||!backdrop) return;
    dialog.hidden=true; backdrop.hidden=true; document.body.style.overflow='';
  }
  window.openCart = openCart; window.closeCart = closeCart;

  // wire buttons (overwrite any previous handlers)
  if (cartBtn)  cartBtn.onclick  = openCart;
  if (closeBtn) closeBtn.onclick = closeCart;
  if (backdrop) backdrop.onclick = closeCart;
  window.addEventListener('keydown', e => { if (e.key === 'Escape') closeCart(); });

  // 3) Kill any accidental auto-open that may have been left in earlier scripts
  setTimeout(closeCart, 10);
})();
</script>
="ghost" id="adminPromptClose" type="button">Close</button>
        </div>
        <div style="margin-top:8px;">Please unlock Admin in Settings first.</div>
        <div class="actions" style="margin-top:12px;">
          <button class="primary" id="openSe
  <!--script>
  /* ========= Boot ========= */
  const APP_SCHEMA_VERSION = 4, SCHEMA_KEY = 'fitsnacks.schema';
  try{
    const cur = JSON.parse(localStorage.getItem(SCHEMA_KEY)||'0')||0;
    if(cur < APP_SCHEMA_VERSION) localStorage.setItem(SCHEMA_KEY, JSON.stringify(APP_SCHEMA_VERSION));
  }catch{ localStorage.setItem(SCHEMA_KEY, JSON.stringify(APP_SCHEMA_VERSION)); }
  if('serviceWorker' in navigator){ window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js')); }

  /* ---------- Helpers ---------- */
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmt = n => '$' + (Number(n)||0).toFixed(2);

  /* ---------- Storage Keys ---------- */
  const CART_KEY        = 'fitsnacks.cart.v1';
  const FAVORITES_KEY   = 'fitsnacks.favorites.v1';
  const PROMOS_KEY      = 'fitsnacks.promos.v1';
  const PROFILE_NAME_KEY= 'fitsnacks.profile.name';
  const PROFILE_LOC_KEY = 'fitsnacks.profile.location';
  const UNLOCK_KEY      = 'fitsnacks.admin.unlocked';
  const STOCK_KEY       = 'fitsnacks.stock.v1';
  const ORDERS_KEY      = 'fitsnacks.orders.v1';
  const LAST_ORDER_KEY  = 'fitsnacks.lastorder.v1';
  const DELIVERED_KEY   = 'fitsnacks.orders.delivered';

  /* ---------- External (optional) ---------- */
  const IFTTT_EVENT = 'Fitsnack_order';
  const IFTTT_KEY   = 'REPLACE_WITH_IFTTT_KEY';
  const IFTTT_URL   = `https://maker.ifttt.com/trigger/${IFTTT_EVENT}/with/key/${IFTTT_KEY}`;
  const ADMIN_PASSWORD = '8TSB077';

  /* ---------- Toasts ---------- */
  function showToast(msg, ms = 1800){
    const host = $('#toastHost'); if(!host) return;
    const el = document.createElement('div');
    el.className = 'toast'; el.textContent = msg;
    host.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 250); }, ms);
  }

  /* ---------- Persistent state ---------- */
  let cart      = new Map(JSON.parse(localStorage.getItem(CART_KEY) || '[]'));
  let favorites = new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]'));
  let promo     = null;
  let tip       = { type:'none', value:0 };
  let stock     = {};
  let orders    = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]');

  /* ---------- Stock ---------- */
  const DEFAULT_STOCK = {
    'Potato Chips': 20,'Protein Bar': 18,'Trail Mix': 15,'Granola Bar': 24,
    'Doritos Flamin’ Hot Nacho': 30,'Greek Yogurt': 12,'Mixed Nuts': 14,
    'Fruit Cup': 10,'Energy Drink': 16,'Chocolate Bar': 22
  };
  (function seedStock(){
    try{
      const cur = JSON.parse(localStorage.getItem(STOCK_KEY) || 'null');
      stock = cur && typeof cur === 'object' ? cur : {...DEFAULT_STOCK};
    }catch{ stock = {...DEFAULT_STOCK}; }
    localStorage.setItem(STOCK_KEY, JSON.stringify(stock));
  })();
  function saveStock(){ localStorage.setItem(STOCK_KEY, JSON.stringify(stock)); }
  function getStock(name){ return stock[name] ?? 0; }
  function setStock(name, qty){ stock[name] = Math.max(0, qty|0); saveStock(); applyOOSClasses(); }

  function applyOOSClasses(){
    $$('.card').forEach(card => {
      const s = getStock(card.dataset.name);
      card.classList.toggle('oos', (s||0) <= 0);
      const add = card.querySelector('.add'); if(add) add.disabled = (s||0) <= 0;
    });
  }

  /* ---------- Greeting & Profile ---------- */
  function updateGreeting(){
    const name = (localStorage.getItem(PROFILE_NAME_KEY) || '').trim();
    $('#greet') && ($('#greet').textContent = name ? `Hi, ${name} 👋` : 'Welcome 👋');
  }
  /* ---------- Carousel ---------- */
  function buildPromos(){
    const snapper = $('#snapper'); if(!snapper) return;
    let data = [];
    try{ data = JSON.parse(localStorage.getItem(PROMOS_KEY) || '[]'); }catch{}
    if(!data.length){
      data = [
        {img:'assets/carousel-1.jpg', title:'Fuel your study grind', cta:'Shop snacks', action:'scrollGrid'},
        {img:'assets/carousel-2.jpg', title:'Protein picks',       cta:'Filter: protein', action:'filter', value:'protein'},
        {img:'assets/carousel-3.jpg', title:'Need help?',          cta:'Open settings', action:'openSettings'}
      ];
      localStorage.setItem(PROMOS_KEY, JSON.stringify(data));
    }
    snapper.querySelectorAll('.snap-card').forEach(n => n.remove());
    const after = snapper.lastElementChild;
    data.forEach(p => {
      const c = document.createElement('div');
      c.className = 'snap-card';
      c.innerHTML = `<img class="banner" src="${p.img}" alt="${p.title}">
        <div class="snap-meta"><div class="snap-title">${p.title}</div>
        ${p.cta ? `<button class="ghost snap-cta" type="button">${p.cta}</button>` : ''}</div>`;
      snapper.insertBefore(c, after);
      c.addEventListener('click', e => {
        if(e.target.closest('.snap-cta')) return;
        if(p.action === 'scrollGrid') $('#grid')?.scrollIntoView({behavior:'smooth'});
        if(p.action === 'filter') activateChip(p.value || '');
        if(p.action === 'openSettings'){ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); }
      }, {passive:true});
      c.querySelector('.snap-cta')?.addEventListener('click', e => {
        e.stopPropagation();
        if(p.action === 'filter') activateChip(p.value || '');
        if(p.action === 'openSettings'){ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); }
        if(p.action === 'scrollGrid') $('#grid')?.scrollIntoView({behavior:'smooth'});
      });
    });

    const cards = $$('.snap-card');
    const dotsWrap = $('#snapDots'); if(!dotsWrap) return;
    dotsWrap.innerHTML = cards.map(() => '<div class="snap-dot"></div>').join('');
    const dots = $$('.snap-dot');
    const spacerLeft = snapper.firstElementChild;
    function setDot(i){ dots.forEach((d, k) => d.classList.toggle('active', k === i)); }
    function scrollToCard(i, smooth = true){
      const targetLeft = cards[i].offsetLeft - spacerLeft.offsetLeft;
      if(smooth) snapper.scrollTo({ left: targetLeft, behavior:'smooth' }); else snapper.scrollLeft = targetLeft;
      setDot(i);
    }
    dots.forEach((d, i) => d.addEventListener('click', () => scrollToCard(i, true)));
    setDot(0);

    // autoplay with interaction guard
    let idx = 0, hold = 5000, slide = 3000, start = null, phase = 'hold';
    let userInteracting = false, lastInteract = 0, inView = true;
    const INTERACT_COOLDOWN = 3500;
    ['pointerdown','wheel','touchstart','mousedown','scroll'].forEach(ev =>
      snapper.addEventListener(ev, () => { userInteracting = true; lastInteract = Date.now(); }, {passive:true})
    );
    const obs = new IntersectionObserver((ents) => { inView = ents.some(e => e.isIntersecting); }, { threshold:0.2 });
    obs.observe(snapper);
    let from = 0, to = 0;
    function step(ts){
      if(!cards.length || !inView) return requestAnimationFrame(step);
      if(userInteracting && (Date.now() - lastInteract) < INTERACT_COOLDOWN){ start = ts; return requestAnimationFrame(step); }
      if(!start) start = ts;
      const elapsed = ts - start;
      if(phase === 'hold'){
        if(elapsed >= hold){
          phase = 'slide'; start = ts; from = snapper.scrollLeft;
          idx = (idx + 1) % cards.length; to = cards[idx].offsetLeft - spacerLeft.offsetLeft;
        }
      }else{
        const t = Math.min(1, (ts - start) / slide);
        const e = t < .5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 8) / 2;
        snapper.scrollLeft = from + (to - from) * e;
        if(t >= 1){ phase = 'hold'; start = ts; setDot(idx); }
      }
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }
  /* ---------- Cart ---------- */
  function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(Array.from(cart.entries()))); }
  function refreshBadge(){
    let n = 0; for(const v of cart.values()) n += (v?.qty || 0);
    const badge = $('#cartBadge'); if(!badge) return;
    if(n > 0){ badge.textContent = String(n); badge.style.display = 'inline-flex'; }
    else { badge.style.display = 'none'; }
  }
  function renderCart(){
    let total = 0, html = '';
    for(const [name, info] of cart){
      const line = (info.price || 0) * (info.qty || 0);
      total += line;
      html += `<div class="row-between" style="margin-top:6px">
        <div style="display:flex;gap:10px;align-items:center">
          <button data-act="-" data-name="${name}" class="ghost" type="button" aria-label="Decrease">−</button>
          <div style="min-width:24px;text-align:center">${info.qty}</div>
          <button data-act="+" data-name="${name}" class="ghost" type="button" aria-label="Increase">+</button>
          <div style="font-weight:700;margin-left:8px">${name}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <div style="font-weight:700">${fmt(line)}</div>
          <button data-remove="${name}" class="ghost" type="button" style="padding:2px 6px;font-size:12px">x</button>
        </div>
      </div>`;
    }
    $('#cartContent') && ($('#cartContent').innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>');
    $('#cartTotal') && ($('#cartTotal').textContent = fmt(total));
  }

  /* Delegate +/− and remove in cart */
  document.addEventListener('click', e => {
    const b = e.target.closest('button[data-act][data-name]');
    if(b){
      const name = b.getAttribute('data-name');
      const act  = b.getAttribute('data-act');
      const entry = cart.get(name);
      if(entry){
        entry.qty = Math.max( (act === '+') ? entry.qty + 1 : entry.qty - 1, 0 );
        if(entry.qty === 0) cart.delete(name);
        saveCart(); renderCart(); refreshBadge();
      }
      return;
    }
    const rm = e.target.closest('button[data-remove]');
    if(rm){
      const name = rm.getAttribute('data-remove');
      if(cart.has(name)){ cart.delete(name); saveCart(); renderCart(); refreshBadge(); }
      return;
    }
  }, {passive:true});

  function openCart(){ $('#cartOverlay')?.classList.add('show'); }
  function closeCart(){ $('#cartOverlay')?.classList.remove('show'); }
  $('#cartBtn')?.addEventListener('click', openCart);
  $('#cartBack')?.addEventListener('click', closeCart);
  /* ---------- Favorites ---------- */
  function saveFavs(){ localStorage.setItem(FAVORITES_KEY, JSON.stringify(Array.from(favorites))); }
  function syncFavStars(){
    $$('.card').forEach(card => card.querySelector('.fav')?.classList.toggle('active', favorites.has(card.dataset.name)));
  }
  document.addEventListener('click', e => {
    const fav = e.target.closest('.fav'); if(!fav) return;
    e.stopPropagation();
    const card = fav.closest('.card'); if(!card) return;
    const name = card.dataset.name;
    if(favorites.has(name)) favorites.delete(name); else favorites.add(name);
    saveFavs(); syncFavStars();
    const activeFilter = $('#chips .chip.active')?.dataset.filter;
    if(activeFilter === 'favorites' && !favorites.has(name)){
      card.classList.add('hidden-by-filter'); searchAndFilter();
    }
  }, {passive:true});

  /* ---------- Search & Filter ---------- */
  function shouldShowForChip(val, card){
    if(!val) return true;
    if(val === 'favorites') return favorites.has(card.dataset.name);
    if(val === 'stock') return (getStock(card.dataset.name) || 0) > 0;
    const tags = (card.dataset.tags || '').toLowerCase();
    return tags.includes(val);
  }
  function activateChip(val){
    $$('#chips .chip').forEach(ch => ch.classList.toggle('active', ch.dataset.filter === val));
    $$('.card').forEach(c => c.classList.toggle('hidden-by-filter', !shouldShowForChip(val, c)));
    searchAndFilter();
  }
  function searchAndFilter(){
    const q = ($('#search')?.value || '').toLowerCase();
    $$('.card').forEach(c => {
      const hitsName = c.dataset.name.toLowerCase().includes(q);
      const visible = !c.classList.contains('hidden-by-filter') && hitsName;
      c.style.display = visible ? '' : 'none';
    });
  }
  $('#chips')?.addEventListener('click', e => {
    const chip = e.target.closest('.chip'); if(!chip) return;
    activateChip(chip.dataset.filter || '');
  });
  $('#search')?.addEventListener('input', searchAndFilter);

  /* ---------- Product Sheet ---------- */
  let currentProduct = null;
  function openProductSheet(card){
    currentProduct = { name: card.dataset.name, price: parseFloat(card.dataset.price), img: card.dataset.img };
    $('#sheetTitle') && ($('#sheetTitle').textContent = currentProduct.name);
    if($('#sheetImg')){ $('#sheetImg').src = currentProduct.img || ''; $('#sheetImg').alt = currentProduct.name || ''; }
    $('#sheetPrice') && ($('#sheetPrice').textContent = fmt(currentProduct.price));
    const s = getStock(currentProduct.name);
    $('#sheetStock') && ($('#sheetStock').textContent = 'Stock: ' + s);
    $('#sheetLowWarn') && ($('#sheetLowWarn').style.display = s > 0 && s <= 3 ? 'block' : 'none');
    $('#qtyVal') && ($('#qtyVal').textContent = '1');
    $('#sheetAdd') && ($('#sheetAdd').textContent = 'Add • ' + fmt(currentProduct.price));
    $('#productSheet')?.classList.add('show');
  }
  function closeProductSheet(){ $('#productSheet')?.classList.remove('show'); }
  $('#sheetClose')?.addEventListener('click', closeProductSheet);
  $('#qtyPlus')?.addEventListener('click', () => {
    let n = parseInt($('#qtyVal')?.textContent || '1', 10);
    n = Math.min(99, n + 1);
    $('#qtyVal') && ($('#qtyVal').textContent = n);
    $('#sheetAdd') && ($('#sheetAdd').textContent = 'Add • ' + fmt(n * (currentProduct?.price || 0)));
  });
  $('#qtyMinus')?.addEventListener('click', () => {
    let n = parseInt($('#qtyVal')?.textContent || '1', 10);
    n = Math.max(1, n - 1);
    $('#qtyVal') && ($('#qtyVal').textContent = n);
    $('#sheetAdd') && ($('#sheetAdd').textContent = 'Add • ' + fmt(n * (currentProduct?.price || 0)));
  });
  $('#sheetAdd')?.addEventListener('click', () => {
    if(!currentProduct) return;
    const qty = parseInt($('#qtyVal')?.textContent || '1', 10);
    const s = getStock(currentProduct.name);
    if(s <= 0){ showToast('Out of stock'); return; }
    if(qty > s){ showToast('Not enough stock'); return; }
    const entry = cart.get(currentProduct.name) || { price: currentProduct.price, qty:0 };
    entry.qty += qty; cart.set(currentProduct
  /* ---------- Promo & Tip ---------- */
  function parsePromo(code){
    code = (code || '').trim().toUpperCase();
    if(!code) return null;
    const mPct = code.match(/(SAVE|PCT)(\d{1,2})/);
    if(mPct) return { type:'percent', value: Math.min(50, parseInt(mPct[2],10)) };
    const mAmt = code.match(/(OFF|\$)(\d{1,3})/);
    if(mAmt) return { type:'amount', value: Math.min(50, parseInt(mAmt[2],10)) };
    return null;
  }
  function computeTotals(){
    let subtotal = 0;
    for(const [, i] of cart) subtotal += i.price * i.qty;
    let disc = 0;
    if(promo){
      if(promo.type === 'percent') disc = subtotal * (promo.value / 100);
      else if(promo.type === 'amount') disc = Math.min(subtotal, promo.value);
    }
    let tipVal = 0;
    if(tip.type === 'amount') tipVal = tip.value;
    else if(tip.type === 'percent') tipVal = (subtotal - disc) * (tip.value / 100);
    const total = Math.max(0, subtotal - disc) + tipVal;
    return { subtotal, disc, tip: tipVal, total };
  }
  function updateCheckoutBreakdown(){
    const { subtotal, disc, tip: tipVal, total } = computeTotals();
    $('#ckSub')  && ($('#ckSub').textContent  = fmt(subtotal));
    $('#ckDisc') && ($('#ckDisc').textContent = `-${fmt(disc)}`);
    $('#ckTip')  && ($('#ckTip').textContent  = fmt(tipVal));
    $('#ckTotal')&& ($('#ckTotal').textContent= fmt(total));
  }
  $('#checkoutPromo')?.addEventListener('input', e => {
    promo = parsePromo(e.target.value);
    $('#promoStatus') && ($('#promoStatus').textContent = promo ? (promo.type === 'percent' ? `Applying ${promo.value}% off` : `Applying $${promo.value} off`) : '');
    updateCheckoutBreakdown();
  });
  $$('.tip-btn').forEach(btn => btn.addEventListener('click', () => {
    const spec = btn.getAttribute('data-tip') || 'none';
    if(spec === 'none') tip = { type:'none', value:0 };
    else if(spec.startsWith('amount'))  tip = { type:'amount',  value: parseFloat(spec.split(':')[1]) || 0 };
    else if(spec.startsWith('percent')) tip = { type:'percent', value: parseFloat(spec.split(':')[1]) || 0 };
    updateCheckoutBreakdown(); showToast('Tip updated');
  }));

  /* ---------- Checkout Flow ---------- */
  function openCheckout(){
    const name = localStorage.getItem(PROFILE_NAME_KEY) || '';
    const loc  = localStorage.getItem(PROFILE_LOC_KEY) || '';
    $('#checkoutName') && ($('#checkoutName').value = name);
    $('#checkoutLocation') && ($('#checkoutLocation').value = loc);
    updateCheckoutBreakdown();
    $('#checkoutOverlay')?.classList.add('show');
  }
  function closeCheckout(){ $('#checkoutOverlay')?.classList.remove('show'); }
  $('#cartCheckout')?.addEventListener('click', () => {
    if(cart.size === 0){ showToast('Cart is empty'); return; }
    closeCart(); openCheckout();
  });
  $('#checkoutBack')?.addEventListener('click', () => { closeCheckout(); openCart(); });
  $('#checkoutClose')?.addEventListener('click', closeCheckout);

  async function writeOrderToFirestore(order){
    try{
      const { db } = window.__fs || {};
      if(!db) return null;
      const ref = await addDoc(collection(db, 'orders'), {
        when: serverTimestamp(),
        name: order.name,
        location: order.loc,
        lines: order.lines,
        total: order.total,
        status: 'active'
      });
      return ref.id;
    }catch(e){ console.warn('Firestore write failed', e); return null; }
  }
  async function placeOrder(){
    if(cart.size === 0){ showToast('Cart is empty'); return; }
    const name = ($('#checkoutName')?.value || '').trim();
    const loc  = ($('#checkoutLocation')?.value || '').trim();
    if(!name || !loc){ showToast('Add your name and location'); return; }

    localStorage.setItem(PROFILE_NAME_KEY, name);
    localStorage.setItem(PROFILE_LOC_KEY, loc);
    updateGreeting();

    const lines = Array.from(cart.entries()).map(([k,v]) => ({ name:k, qty:v.qty, price:v.price, line: v.qty*v.price }));
    const { subtotal, disc, tip: tipVal, total } = computeTotals();
    const order = {
      id: 'FS-' + Date.now(),
      at: new Date().toISOString(),
      name, loc, promo, tip, subtotal, discount: disc, total,
      lines
    };

    orders.push(order);
    localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
    localStorage.setItem(LAST_ORDER_KEY, JSON.stringify(order));

    // Optional IFTTT webhook (only if key is set)
    if(IFTTT_KEY && IFTTT_KEY !== 'REPLACE_WITH_IFTTT_KEY'){
      try{
        await fetch(IFTTT_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            value1: `${order.id} | ${name} @ ${loc} | ${fmt(total)}`,
            value2: lines.map(l => `${l.qty}× ${l.name}`).join(', '),
            value3: promo ? (promo.type==='percent' ? `${promo.value}% off` : `$${promo.value} off`) : ''
          })
        });
      }catch(err){ console.warn('IFTTT post failed', err); }
    }

    cart.clear(); saveCart(); renderCart(); refreshBadge();
    closeCheckout(); showToast('Order placed 🎉');

    if(isAdminUnlocked()){
      renderAdminOrders(); updateKpis(); buildHeatMap(); appendHistoryEvent(order);
    }
  }
  $('#checkoutPlace')?.addEventListener('click', placeOrder);

  /* Re-order last */
  $('#reorderLast')?.addEventListener('click', () => {
    const last = JSON.parse(localStorage.getItem(LAST_ORDER_KEY) || 'null');
    if(!last || !Array.isArray(last.lines) || !last.lines.length){ showToast('No previous order'); return; }
    for(const l of last.lines){
      const s = getStock(l.name);
      const qty = Math.min(l.qty, s);
      if(qty <= 0) continue;
      const entry = cart.get(l.name) || { price: l.price, qty:0 };
      entry.qty += qty; cart.set(l.name, entry);
      setStock(l.name, s - qty);
    }
    saveCart(); renderCart(); refreshBadge(); openCart(); showToast('Added last order items');
  });
  /* ---------- Settings & Admin ---------- */
  function switchTab(which){
    const gen = $('#settingsGeneral'), adm = $('#settingsAdmin');
    const tg = $('#tabGeneral'), ta = $('#tabAdmin');
    const isGen = which !== 'admin';
    gen && (gen.style.display = isGen ? '' : 'none');
    adm && (adm.style.display = isGen ? 'none' : '');
    tg && tg.classList.toggle('active', isGen);
    ta && ta.classList.toggle('active', !isGen);
  }
  $('#settingsBtn')?.addEventListener('click',()=>{ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); });
  $('#settingsClose')?.addEventListener('click',()=>$('#settingsOverlay')?.classList.remove('show'));
  $('#tabGeneral')?.addEventListener('click', ()=> switchTab('general'));
  $('#tabAdmin')?.addEventListener('click',   ()=> switchTab('admin'));
  $('#profileSave')?.addEventListener('click', ()=>{
    const n = ($('#profileName')?.value || '').trim();
    const l = ($('#profileLoc')?.value || '').trim();
    if(n) localStorage.setItem(PROFILE_NAME_KEY, n);
    if(l) localStorage.setItem(PROFILE_LOC_KEY, l);
    updateGreeting(); showToast('Saved');
  });

  function isAdminUnlocked(){ return localStorage.getItem(UNLOCK_KEY) === '1'; }
  function ensureAdminLoginVisible(){
    const area = $('#adminArea'); if(!area) return;
    area.style.display = isAdminUnlocked() ? '' : 'none';
  }
  $('#adminUnlock')?.addEventListener('click', ()=>{
    const pass = $('#adminPass')?.value || '';
    if(pass === ADMIN_PASSWORD){
      localStorage.setItem(UNLOCK_KEY,'1');
      ensureAdminLoginVisible(); buildAdminSubtabs(); buildAdminStockTable(); renderAdminOrders(); updateKpis(); buildHeatMap(); renderHistory();
      showToast('Admin unlocked');
    } else showToast('Wrong password');
  });
  $('#openSettingsFromPrompt')?.addEventListener('click', ()=>{
    $('#adminPrompt')?.classList.remove('show');
    $('#settingsOverlay')?.classList.add('show'); switchTab('admin');
  });

  /* ---- Admin Subtabs (fallbacks OK) ---- */
  const DEFAULT_SUBTABS = [
    { id:'stock',   label:'Stock',    panel:'adminStock'   },
    { id:'orders',  label:'Orders',   panel:'adminOrders'  },
    { id:'heat',    label:'Analytics (Heat Map)', panel:'adminHeat' },
    { id:'history', label:'History',  panel:'adminHistory' },
    { id:'promos',  label:'Promos',   panel:'adminPromos'  },
  ];
  async function loadSubtabsJSON(urls=[
    'assets/settings-tabs.json',
    'assets/admin.json',
    'assets/settings.json',
    'assets/ui.json'
  ]){
    for(const url of urls){
      try{
        const r = await fetch(url, {cache:'no-store'});
        if(!r.ok) continue;
        const j = await r.json();
        if(j?.admin?.subtabs?.length){
          return j.admin.subtabs.map(x => ({ id:x.id||x.panelId||x.label, label:x.label||x.id, panel:x.panelId||x.id }));
        }
        if(Array.isArray(j?.tabs)){
          const admin = j.tabs.find(t => String(t.id||t.label).toLowerCase().startsWith('admin'));
          if(admin?.subtabs?.length){
            return admin.subtabs.map(x => ({ id:x.id||x.panelId||x.label, label:x.label||x.id, panel:x.panelId||x.id }));
          }
        }
        if(Array.isArray(j?.adminSubtabs)) {
          return j.adminSubtabs.map(x => ({ id:x.id||x, label:x.label||x, panel:x.panelId||x.id||x }));
        }
      }catch{}
    }
    return DEFAULT_SUBTABS;
  }
  function setActiveSubtab(id){
    $$('.subtab').forEach(b => b.classList.toggle('active', b.dataset.sub === id));
    $('#adminStock')?.setAttribute('style','display:none;');
    $('#adminOrders')?.setAttribute('style','display:none;');
    $('#adminHeat')?.setAttribute('style','display:none;');
    $('#adminHistory')?.setAttribute('style','display:none;');
    $('#adminPromos')?.setAttribute('style','display:none;');
    if(id==='stock')   $('#adminStock').style.display='';
    if(id==='orders')  $('#adminOrders').style.display='';
    if(id==='heat')    $('#adminHeat').style.display='';
    if(id==='history') $('#adminHistory').style.display='';
    if(id==='promos')  $('#adminPromos').style.display='';
  }
  async function buildAdminSubtabs(){
    const bar = $('#adminSubtabs'); if(!bar) return;
    const tabs = await loadSubtabsJSON();
    bar.innerHTML = tabs.map((t,i)=>`<button class="subtab${i===0?' active':''}" data-sub="${t.id}" type="button">${t.label}</button>`).join('');
    bar.addEventListener('click', e=>{
      const b = e.target.closest('.subtab'); if(!b) return;
      setActiveSubtab(b.dataset.sub);
      if(b.dataset.sub==='orders') renderAdminOrders();
      if(b.dataset.sub==='stock')  buildAdminStockTable();
      if(b.dataset.sub==='heat')   buildHeatMap();
      if(b.dataset.sub==='history')renderHistory();
    }, {passive:true});
    setActiveSubtab(tabs[0]?.id || 'stock');
    showToast('Admin tabs: ' + tabs.map(t=>t.label).join(', '), 2200);
  }

  /* ---- Inventory helpers: pop-on-card ---- */
  function getCardByName(name){
    return [...document.querySelectorAll('.card')].find(c => c.dataset.name === name);
  }
  function flashCardNote(name, text = 'Saved'){
    const card = getCardByName(name);
    if(!card) return;
    const note = document.createElement('div');
    note.className = 'card-pop';
    note.textContent = text;
    card.appendChild(note);
    setTimeout(()=> note.remove(), 1000);
  }
  function pulseCard(name){
    const card = getCardByName(name);
    if(!card) return;
    card.classList.add('pulse');
    setTimeout(()=> card.classList.remove('pulse'), 400);
  }

  /* ---- Admin: Stock editor (editable list of products) ---- */
  function buildAdminStockTable(){
    const host = $('#adminStock'); if(!host) return;
    const names = Object.keys(stock).length ? Object.keys(stock) :
      [...$$('.card')].map(c => c.dataset.name);
    const rows = names.sort().map(n => `
      <div class="rowd" style="display:grid;grid-template-columns:1fr 90px 70px 70px;gap:8px;">
        <div>${n}</div>
        <div><input type="number" min="0" value="${getStock(n)}" data-stock="${n}" style="width:100%;padding:6px;border-radius:8px;background:#111;border:1px solid #2a2a30;color:#fff;"></div>
        <div><button class="ghost" data-stock-save="${n}" type="button">Save</button></div>
        <div><button class="ghost" data-stock-zero="${n}" type="button">Zero</button></div>
      </div>`).join('');
    host.innerHTML = `
      <div class="rowh" style="display:grid;grid-template-columns:1fr 90px 70px 70px;gap:8px;">
        <div>Item</div><div>Stock</div><div></div><div></div>
      </div>${rows}`;
  }
  /* Handle Save / Zero in Inventory and pop on card */
  document.addEventListener('click', e => {
    const s = e.target.closest('button[data-stock-save]');
    if(s){
      const name = s.getAttribute('data-stock-save');
      const input = $('#adminStock')?.querySelector(`[data-stock="${CSS.escape(name)}"]`);
      const val = parseInt(input?.value || '0', 10);
      setStock(name, isFinite(val) ? val : 0);
      showToast('Stock updated');

      // Pop on product card + pulse
      flashCardNote(name, `Stock: ${Math.max(0, val|0)}`);
      pulseCard(name);

      // Refresh dependent views
      renderAdminOrders(); updateKpis(); buildHeatMap();
      return;
    }
    const z = e.target.closest('button[data-stock-zero]');
    if(z){
      const name = z.getAttribute('data-stock-zero');
      setStock(name, 0);
      showToast('Stock zeroed');

      flashCardNote(name, 'Stock: 0');
      pulseCard(name);

      renderAdminOrders(); updateKpis(); buildHeatMap();
      return;
    }
  }, {passive:true});

  /* ---- Admin: Orders view (tap to detail) ---- */
  function renderAdminOrders(){
    const host = $('#adminOrders'); if(!host) return;
    if(!orders.length){
      host.innerHTML = '<div style="color:#c7c7cc;">No orders yet.</div>';
      return;
    }
    host.innerHTML = orders.slice().reverse().map((o,i) => `
      <div class="order-item" data-idx="${i}" data-id="${o.id||''}" style="padding:8px;border-bottom:1px solid #2a2a30;cursor:pointer">
        <div style="font-weight:700">${new Date(o.at||o.when).toLocaleString()}</div>
        <div>${o.name} @ ${o.loc||o.location}</div>
        <div style="font-weight:700">Total ${fmt(o.total)}</div>
        <div class="muted">Status: ${o.status||'active'}</div>
      </div>
    `).join('');
  }

  function openOrderSheetByIndex(idx){
    const o = orders.slice().reverse()[idx]; if(!o) return;
    $('#orderMeta').textContent=`${new Date(o.at||o.when).toLocaleString()} • ${o.name} @ ${o.loc||o.location}`;
    $('#orderLines').innerHTML=(o.lines||[]).map(l=>`
      <div class="row-between" style="padding:6px 0">
        <div>${l.name} × ${l.qty}</div><div style="font-weight:700">${fmt(l.line || l.price*l.qty)}</div>
      </div>`).join('');
    $('#orderTotal').textContent=fmt(o.total||0);
    $('#orderSheet').dataset.id = o.id||'';
    $('#orderSheet').dataset.idx = String(idx);
    document.body.appendChild($('#orderSheet'));
    $('#orderSheet').classList.add('show');
  }

  document.addEventListener('click', e=>{
    const row=e.target.closest('.order-item');
    if(row) openOrderSheetByIndex(parseInt(row.dataset.idx,10));
  }, {passive:true});

  $('#orderClose')?.addEventListener('click', ()=>$('#orderSheet').classList.remove('show'));
  $('#orderCancel')?.addEventListener('click', ()=>$('#orderSheet').classList.remove('show'));

  $('#orderDelivered')?.addEventListener('click', async ()=>{
    const idx = parseInt($('#orderSheet').dataset.idx||'-1',10);
    const list = orders.slice().reverse();
    const o = list[idx]; if(!o) return;

    o.status='delivered';

    // Add to delivered history (local)
    const hist=JSON.parse(localStorage.getItem(DELIVERED_KEY)||'[]'); 
    hist.unshift(o);
    localStorage.setItem(DELIVERED_KEY, JSON.stringify(hist));

    // Write back to original order array (reverse mapping)
    orders = list.slice().reverse();
    localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));

    // Try Firestore status update (best-effort)
    try{
      if(o.id && window.__fs?.db){
        const { db } = window.__fs;
        await updateDoc(doc(db,'orders',o.id), { status:'delivered' });
      }
    }catch(e){ console.warn('Failed to update Firestore status', e); }

    renderHistory(); renderAdminOrders(); updateKpis();
    $('#orderSheet').classList.remove('show');
    showToast('Marked delivered');
  });

  /* ---- Admin: KPIs ---- */
  function updateKpis(){
    const openCount = orders.length;
    const revenue = orders.reduce((a,b)=>a+(b.total||0),0);
    $('#kpiOpen') && ($('#kpiOpen').textContent = String(openCount));
    $('#kpi
  /* ---------- Bootstrap ---------- */
  document.addEventListener('DOMContentLoaded', async () => {
    try{
      updateGreeting();
      buildPromos();
      renderCart(); refreshBadge();
      applyOOSClasses();
      activateChip('');
      ensureAdminLoginVisible();
      if(isAdminUnlocked()){
        await buildAdminSubtabs();
        buildAdminStockTable();
        renderAdminOrders();
        updateKpis();
        buildHeatMap();
        renderHistory();
      }

      // Overlay close on backdrop & ESC
      document.querySelectorAll('.overlay').forEach(ov=>{
        ov.addEventListener('click', (e)=>{ if(e.target===ov) ov.classList.remove('show'); }, {passive:true});
      });
      document.addEventListener('keydown', e=>{
        if(e.key==='Escape'){
          document.querySelectorAll('.overlay.show').forEach(ov=>ov.classList.remove('show'));
        }
      });

      // Safe binds
      $('#cartBtn')?.addEventListener('click',()=>$('#cartOverlay')?.classList.add('show'));
      $('#cartBack')?.addEventListener('click',()=>$('#cartOverlay')?.classList.remove('show'));
    }catch(e){
      console.error('Bootstrap error', e);
    }
  });
  </script-->
</body>
</html>
<!-- rebuild 1759556295 -->
html>
<!-- rebuild 1759556295 -->
<!-- deploy 1759818838 -->
<style id="headerStyles">
  .app-header{position:sticky;top:0;z-index:50;background:#0d0d10bf;
    -webkit-backdrop-filter:saturate(180%) blur(10px);backdrop-filter:saturate(180%) blur(10px);
    padding:12px 16px;display:flex;gap:12px;align-items:center}
  .search{flex:1;display:flex;align-items:center;border:1px solid #2a2a2e;border-radius:16px;padding:10px 14px}
  .search input{all:unset;flex:1;color:#fff}
  .btn{border:1px solid #2a2a2e;border-radius:16px;padding:10px 16px;color:#fff}
  /* modal */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none}
  .dialog{position:fixed;left:50%;top:18%;transform:translateX(-50%);
    background:#121217;border:1px solid #2a2a2e;border-radius:16px;padding:16px;min-width:320px;max-width:92vw}
  .show{display:block}
</style>
