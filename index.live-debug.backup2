<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>FitSnacks</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0d">

  <!-- Preload carousel images -->
  <link rel="preload" as="image" href="assets/carousel-1.jpg">
  <link rel="preload" as="image" href="assets/carousel-2.jpg">
  <link rel="preload" as="image" href="assets/carousel-3.jpg">

  <style>
    :root{
      --bg:#0b0b0d; --text:#e9e9ec; --muted:#a9a9b1; --accent:#2ee6a6;
      --good:#2ee6a6; --warn:#ffb020; --badge:#ff3b30; --radius:18px;
      --blur:18px; --snap-gap:12px; --heat-bg:#121216; --heat-cell:#1b1b21;
    }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--text);
      font:16px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; }
    .app{ max-width:393px; min-height:100svh; margin:0 auto; padding:12px 12px 64px; box-sizing:border-box; }

    /* Shared glass */
    .card,.sheet,.btn,.search,.chip,.tab,.ghost,.primary,.field{
      -webkit-backdrop-filter:blur(var(--blur)); backdrop-filter:blur(var(--blur));
      background:rgba(20,20,24,0.60); border:1px solid rgba(255,255,255,.08);
      box-shadow:0 4px 24px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .row{ display:flex; align-items:center; gap:12px; position:relative; }
    .row-between{ display:flex; align-items:center; justify-content:space-between; gap:12px; }

    /* Header */
    .search-wrap{ flex:0 0 160px; min-width:0; position:relative; }
    .search{ width:100%; border-radius:999px; padding:12px 44px 12px 36px; color:var(--text); outline:0; border:1px solid #2a2a2e; }
    .icon-left{ position:absolute; left:12px; top:50%; transform:translateY(-50%); pointer-events:none; }
    .icon-rights{ margin-left:auto; display:flex; gap:10px; flex-shrink:0; position:relative; z-index:10060; }
    .btn{ border-radius:14px; width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }
    #cartBtn .badge{ position:absolute; top:-6px; right:-8px; background:var(--badge); color:#fff; border-radius:999px; padding:1px 6px; font-size:12px; font-weight:700; display:block; }

    .greet{ margin:8px 2px 2px; color:#c7c7cc; font-size:14px; }

    /* Carousel */
    .carousel{ margin:10px 0 6px; position:relative; z-index:1; }
    .snapper{ height:100px; display:flex; align-items:stretch; gap:var(--snap-gap); overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; padding:0 var(--snap-gap); }
    .snapper::-webkit-scrollbar{display:block;}
    .snap-spacer{flex:0 0 7.5%;}
    .snap-card{ position:relative; flex:0 0 85%; scroll-snap-align:center; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center; }
    .banner{ width:100%; height:100%; object-fit:cover; }
    .snap-meta{ position:absolute; left:10px; bottom:8px; right:10px; display:flex; justify-content:space-between; gap:8px; pointer-events:none; }
    .snap-title{ font-weight:800; text-shadow:0 1px 6px rgba(0,0,0,.6); }
    .snap-cta{ pointer-events:auto; }
    .snap-dots{ display:flex; justify-content:center; gap:6px; margin-top:6px; }
    .snap-dot{ width:6px; height:6px; border-radius:999px; background:#1a2521; border:1px solid rgba(46,230,166,.35); }
    .snap-dot.active{ background:var(--accent); }

    /* Chips */
    .chips{ display:flex; gap:10px; margin:6px 0 12px; flex-wrap:wrap; }
    .chip{ padding:6px 10px; border-radius:999px; font-size:13px; cursor:pointer; }
    .chip.active{ outline:2px solid var(--accent); }

    /* Grid */
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .card{ border-radius:16px; padding:10px; position:relative; display:flex; flex-direction:column; min-height:190px; }
    .thumb{ height:90px; border-radius:12px; overflow:hidden; margin-bottom:8px; display:flex; align-items:center; justify-c
    /* Overlays */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:block; align-items:center; justify-content:center; padding:20px; z-index:9990; }
    .overlay.show{ display:flex; }
    .sheet{ width:92%; max-width:480px; border-radius:20px; padding:16px; }
    #cartOverlay,#checkoutOverlay,#settingsOverlay,#orderSheet,#productSheet,#adminPrompt{ align-items:flex-end; }
    #cartOverlay .sheet,#checkoutOverlay .sheet,#settingsOverlay .sheet,#orderSheet .sheet,#productSheet .sheet,#adminPrompt .sheet{
      width:100%; border-top-left-radius:24px; border-top-right-radius:24px; border-bottom-left-radius:0; border-bottom-right-radius:0;
      padding-bottom:calc(16px + env(safe-area-inset-bottom)); transform:translateY(100%); -webkit-transform:translateY(100%);
      animation:slideUp 220ms ease-out forwards; -webkit-animation:slideUp 220ms ease-out forwards;
    }
    @keyframes slideUp{ from{ transform:translateY(100%);} to{ transform:translateY(0);} }
    .overlay.show .sheet{ transform:translateY(0)!important; -webkit-transform:translateY(0)!important; }

    /* Settings/Admin */
    .tabs{ display:flex; gap:8px; margin:6px 0 12px; }
    .tab{ padding:8px 10px; border-radius:10px; cursor:pointer; border:1px solid #2a2a30; background:#18181d; }
    .tab.active{ background:#24242a; }
    .sheet-body{ max-height:70svh; overflow:auto; padding-right:4px; }
    .admin-subtabs{ display:flex; gap:6px; margin:10px 0; flex-wrap:wrap; }
    .subtab{ padding:6px 10px; border-radius:10px; cursor:pointer; border:1px solid #2a2a30; background:#18181d; font-size:13px; }
    .subtab.active{ background:#24242a; }
    .admin-list{ border:1px solid #2a2a30; border-radius:12px; padding:8px; margin-top:8px; }

    .kpis{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .kpi{ padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.1); }
    .kpi .label{ color:#c7c7cc; font-size:12px; }
    .kpi .value{ font-weight:800; font-size:18px; margin-top:4px; }

    /* Heat map */
    .heat{ background:var(--heat-bg); border:1px solid #23232a; border-radius:12px; padding:8px; }
    .heat-grid{ display:grid; grid-template-columns: 20px repeat(24, 1fr); gap:4px; align-items:center; }
    .heat-cell{ height:16px; border-radius:4px; background:var(--heat-cell); }
    .heat-legend{ display:flex; gap:6px; align-items:center; margin-top:8px; font-size:12px; color:#c7c7cc; }
    .legend-swatch{ width:20px; height:10px; border-radius:4px; background:var(--heat-cell); }

    /* Sticky cart bar */
    #cartBar{
      position:fixed;left:12px;right:12px;bottom:12px;display:block;align-items:center;justify-content:space-between;
      gap:10px;padding:10px 12px;border-radius:14px;z-index:1000;
      -webkit-backdrop-filter:blur(var(--blur));backdrop-filter:blur(var(--blur));
      background:rgba(20,20,24,0.7);border:1px solid rgba(255,255,255,.08);
      box-shadow:0 6px 24px rgba(0,0,0,.25);
    }
    #cartBar.show{display:flex}

    /* Toasts */
    #toastHost{position:fixed;left:0;right:0;bottom:calc(16px + env(safe-area-inset-bottom));display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;z-index:11000}
    .toast{pointer-events:auto;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:rgba(24,24,32,.9);font-weight:600;opacity:0;transform:translateY(8px);transition:opacity .22s ease,transform .22s ease}
    .toast.show{opacity:1;transform:translateY(0)}

    /* Z-order */
    #settingsOverlay{ z-index: 10000; }
    #orderSheet{ z-index: 10050; }

    /* --- Stock save pop on product card --- */
    .card-pop{
      position:absolute; right:10px; top:10px;
      background:rgba(46,230,166,.95); color:#001a12;
      border-radius:10px; padding:6px 8px; font-weight:800; font-size:12px;
      border:1px solid rgba(255,255,255,.15);
      pointer-events:none;
      transform:translateY(-6px) scale(.95); opacity:0;
      animation:popfade .9s ease-out forwards;
    }
    @keyframes popfade{
      0%  {opacity:0; transform:translateY(-6px) scale(.95)}
          <!-- Filter chips -->
    <div class="chips" id="chips">
      <div class="chip" data-filter="">all</div>
      <div class="chip" data-filter="vegan">vegan</div>
      <div class="chip" data-filter="gluten-free">gluten-free</div>
      <div class="chip" data-filter="protein">protein</div>
      <div class="chip" data-filter="favorites">favorites</div>
      <div class="chip" data-filter="stock">stock</div>
    </div>

    <!-- Product grid -->
    <div id="grid" class="grid" role="list">
      <div class="card" role="listitem" data-name="Potato Chips" data-price="2.50" data-img="assets/product-funyuns.jpg" data-tags="snack">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-funyuns.jpg" alt="Potato Chips" loading="lazy"></div>
        <div class="title">Potato Chips</div>
        <div class="price">$2.50</div>
        <button class="add" aria-label="Add Potato Chips">+</button>
      </div>
      <div class="card" role="listitem" data-name="Protein Bar" data-price="2.99" data-img="assets/product-chesters.jpg" data-tags="protein">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-chesters.jpg" alt="Protein Bar" loading="lazy"></div>
        <div class="title">Protein Bar</div>
        <div class="price">$2.99</div>
        <button class="add" aria-label="Add Protein Bar">+</button>
      </div>
      <div class="card" role="listitem" data-name="Trail Mix" data-price="3.49" data-img="assets/product-cheetos.jpg" data-tags="vegan,gluten-free">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-cheetos.jpg" alt="Trail Mix" loading="lazy"></div>
        <div class="title">Trail Mix</div>
        <div class="price">$3.49</div>
        <button class="add" aria-label="Add Trail Mix">+</button>
      </div>
      <div class="card" role="listitem" data-name="Granola Bar" data-price="1.99" data-img="assets/product-granola.jpg" data-tags="vegan,protein">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-granola.jpg" alt="Granola Bar" loading="lazy"></div>
        <div class="title">Granola Bar</div>
        <div class="price">$1.99</div>
        <button class="add" aria-label="Add Granola Bar">+</button>
      </div>
      <div class="card" role="listitem" data-name="Doritos Flamin‚Äô Hot Nacho" data-price="2.00" data-img="assets/product-doritos.jpg" data-tags="snack">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-doritos.jpg" alt="Doritos Flamin‚Äô Hot Nacho" loading="lazy"></div>
        <div class="title">Doritos Flamin‚Äô Hot Nacho</div>
        <div class="price">$2.00</div>
        <button class="add" aria-label="Add Doritos Flamin‚Äô Hot Nacho">+</button>
      </div>
      <div class="card" role="listitem" data-name="Greek Yogurt" data-price="2.00" data-img="assets/greek-yogurt.jpeg?v=3" data-tags="protein">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb">
          <img src="assets/greek-yogurt.jpeg?v=3" alt="Greek Yogurt" loading="lazy"
               onerror="if(!this.__triedJPG){this.__triedJPG=1;this.src='assets/greek-yogurt.jpg?v=3';}else{this.src='assets/product-yogurt.jpg';}">
        </div>
        <div class="title">Greek Yogurt</div>
        <div class="price">$2.00</div>
        <button class="add" aria-label="Add Greek Yogurt">+</button>
      </div>
      <div class="card" role="listitem" data-name="Mixed Nuts" data-price="3.20" data-img="assets/product-nuts.jpg" data-tags="vegan,protein">
        <button class="fav" aria-label="Favorite"><span>‚≠ê</span></button>
        <div class="thumb"><img src="assets/product-nuts.jpg" alt="Mixed Nuts" loading="lazy"></div>
        <div class="title">Mixed Nuts</div>
        <div class="price">$3.20</div>
        <button class="a
    <!-- Product mini sheet -->
    <div id="productSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Add item">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3 id="sheetTitle">Item</h3>
          <button class="ghost" id="sheetClose" type="button">Close</button>
        </div>
        <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
          <div style="width:88px;height:88px;border-radius:12px;overflow:hidden;border:1px solid #2a2a30;">
            <img id="sheetImg" alt="" style="width:100%;height:100%;object-fit:cover">
          </div>
          <div style="flex:1">
            <div id="sheetPrice" class="price" style="font-size:18px;"></div>
            <div id="sheetStock" style="margin-top:6px;color:#c7c7cc;font-size:13px;">Stock: --</div>
            <div id="sheetLowWarn" style="display:block;margin-top:6px;color:#ff6b6b;font-weight:600;font-size:13px;">Low stock</div>
          </div>
        </div>
        <div class="row-between" style="margin-top:10px;">
          <div class="qty" style="display:flex;align-items:center;gap:8px;">
            <button id="qtyMinus" class="ghost" type="button" aria-label="Decrease">‚àí</button>
            <div id="qtyVal" aria-live="polite" style="min-width:24px;text-align:center;">1</div>
            <button id="qtyPlus" class="ghost" type="button" aria-label="Increase">+</button>
          </div>
          <button class="primary" id="sheetAdd" type="button">Add</button>
        </div>
      </div>
    </div>

    <!-- Order details sheet -->
    <div id="orderSheet" class="overlay" role="dialog" aria-modal="true" aria-label="Order details">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Order</h3>
          <button class="ghost" id="orderClose" type="button">Close</button>
        </div>
        <div id="orderMeta" style="margin-top:6px;color:#c7c7cc;font-size:13px">‚Äì</div>
        <div id="orderLines" class="admin-list" style="margin-top:8px">‚Äì</div>
        <div class="row-between" style="margin-top:10px;">
          <strong>Total</strong><strong id="orderTotal">$0.00</strong>
        </div>
        <div class="actions" style="margin-top:12px;">
          <button class="ghost" id="orderCancel" type="button">Cancel</button>
          <button class="primary" id="orderDelivered" type="button">Mark Delivered</button>
        </div>
      </div>
    </div>

    <!-- Cart -->
    <div id="cartOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Cart">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Cart</h3>
          <button class="ghost" id="cartBack" type="button">Back</button>
        </div>
        <div id="cartContent" class="sheet-body">Cart is empty</div>
        <div class="row-between" style="margin-top:10px;">
          <strong>Total</strong><strong id="cartTotal">$0.00</strong>
        </div>
        <div class="actions" style="margin-top:12px;">
          <button class="ghost" id="reorderLast" type="button">Re-order last</button>
          <button class="primary" id="cartCheckout" type="button">Checkout</button>
        </div>
      </div>
    </div>

    <!-- Checkout -->
    <div id="checkoutOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Checkout">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Checkout</h3>
          <button class="ghost" id="checkoutClose" type="button">Close</button>
        </div>

        <div class="sheet-body">
          <div style="margin-top:6px;">Your name:</div>
          <input id="checkoutName" class="field" style="width:100%;padding:10px;border-radius:10px" autocomplete="name">
          <div style="margin-top:10px;">Where are you on campus?</div>
          <input id="checkoutLocation" class="field" style="width:100%;padding:10px;border-radius:10px" autocomplete="organization-title">

          <div style="margin-top:12px;">Promo code</div>
          <input id="checkoutPromo" class="
    <!-- Settings / Admin -->
    <div id="settingsOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Settings">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Settings</h3>
          <button class="ghost" id="settingsClose" type="button">Close</button>
        </div>

        <div class="tabs" role="tablist" aria-label="Settings tabs">
          <button id="tabGeneral" class="tab active" role="tab" aria-selected="true">General</button>
          <button id="tabAdmin" class="tab" role="tab" aria-selected="false">Admin</button>
        </div>

        <div id="settingsGeneral" class="sheet-body" role="tabpanel" aria-labelledby="tabGeneral">
          <div style="margin-top:6px;">Your name</div>
          <input id="profileName" class="field" style="width:100%;padding:10px;border-radius:10px">
          <div style="margin-top:10px;">Default location</div>
          <input id="profileLoc" class="field" style="width:100%;padding:10px;border-radius:10px">
          <div class="actions" style="margin-top:12px;">
            <button class="primary" id="profileSave" type="button">Save</button>
          </div>
        </div>

        <div id="settingsAdmin" class="sheet-body" role="tabpanel" aria-labelledby="tabAdmin" style="display:block;">
          <div style="margin-top:6px;">Admin password</div>
          <input id="adminPass" class="field" style="width:100%;padding:10px;border-radius:10px" type="password">
          <div class="actions" style="margin-top:12px;">
            <button class="primary" id="adminUnlock" type="button">Unlock</button>
          </div>

          <!-- Admin area appears after unlock -->
          <div id="adminArea" style="display:block; margin-top:16px;">
            <div class="kpis">
              <div class="kpi"><div class="label">Open orders</div><div class="value" id="kpiOpen">0</div></div>
              <div class="kpi"><div class="label">Revenue (local)</div><div class="value" id="kpiRev">$0.00</div></div>
            </div>

            <!-- Subtabs -->
            <div class="admin-subtabs" id="adminSubtabs"></div>

            <!-- Panels -->
            <div id="adminPanels">
              <div id="adminStock"   class="admin-list" style="display:block;"></div>
              <div id="adminOrders"  class="admin-list" style="display:block;"></div>
              <div id="adminHeat"    class="admin-list" style="display:block;">
                <div class="heat">
                  <div style="font-weight:700;margin-bottom:6px;">Orders Heat Map (7√ó24)</div>
                  <div class="heat-grid" id="heatGrid"></div>
                  <div class="heat-legend">
                    <span>Low</span>
                    <div class="legend-swatch" id="legendLow"></div>
                    <div class="legend-swatch" id="legendMid"></div>
                    <div class="legend-swatch" id="legendHigh"></div>
                    <span>High</span>
                  </div>
                </div>
              </div>
              <div id="adminHistory" class="admin-list" style="display:block;"></div>
              <div id="adminPromos"  class="admin-list" style="display:block;">
                <div style="margin-bottom:8px;">Active promo pattern examples: <code>SAVE10</code>, <code>$3</code></div>
                <div style="color:#c7c7cc;">(This simple demo reads codes at checkout; extend here to manage scheduled promos.)</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Optional admin prompt overlay -->
    <div id="adminPrompt" class="overlay" role="dialog" aria-modal="true" aria-label="Admin prompt">
      <div class="sheet" role="document">
        <div class="row-between">
          <h3>Admin required</h3>
          <button class="ghost" id="adminPromptClose" type="button">Close</button>
        </div>
        <div style="margin-top:8px;">Please unlock Admin in Settings first.</div>
        <div class="actions" style="margin-top:12px;">
          <button class="primary" id="openSe
  <!--script>
  /* ========= Boot ========= */
  const APP_SCHEMA_VERSION = 4, SCHEMA_KEY = 'fitsnacks.schema';
  try{
    const cur = JSON.parse(localStorage.getItem(SCHEMA_KEY)||'0')||0;
    if(cur < APP_SCHEMA_VERSION) localStorage.setItem(SCHEMA_KEY, JSON.stringify(APP_SCHEMA_VERSION));
  }catch{ localStorage.setItem(SCHEMA_KEY, JSON.stringify(APP_SCHEMA_VERSION)); }
  if('serviceWorker' in navigator){ window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js')); }

  /* ---------- Helpers ---------- */
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmt = n => '$' + (Number(n)||0).toFixed(2);

  /* ---------- Storage Keys ---------- */
  const CART_KEY        = 'fitsnacks.cart.v1';
  const FAVORITES_KEY   = 'fitsnacks.favorites.v1';
  const PROMOS_KEY      = 'fitsnacks.promos.v1';
  const PROFILE_NAME_KEY= 'fitsnacks.profile.name';
  const PROFILE_LOC_KEY = 'fitsnacks.profile.location';
  const UNLOCK_KEY      = 'fitsnacks.admin.unlocked';
  const STOCK_KEY       = 'fitsnacks.stock.v1';
  const ORDERS_KEY      = 'fitsnacks.orders.v1';
  const LAST_ORDER_KEY  = 'fitsnacks.lastorder.v1';
  const DELIVERED_KEY   = 'fitsnacks.orders.delivered';

  /* ---------- External (optional) ---------- */
  const IFTTT_EVENT = 'Fitsnack_order';
  const IFTTT_KEY   = 'REPLACE_WITH_IFTTT_KEY';
  const IFTTT_URL   = `https://maker.ifttt.com/trigger/${IFTTT_EVENT}/with/key/${IFTTT_KEY}`;
  const ADMIN_PASSWORD = '8TSB077';

  /* ---------- Toasts ---------- */
  function showToast(msg, ms = 1800){
    const host = $('#toastHost'); if(!host) return;
    const el = document.createElement('div');
    el.className = 'toast'; el.textContent = msg;
    host.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 250); }, ms);
  }

  /* ---------- Persistent state ---------- */
  let cart      = new Map(JSON.parse(localStorage.getItem(CART_KEY) || '[]'));
  let favorites = new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]'));
  let promo     = null;
  let tip       = { type:'none', value:0 };
  let stock     = {};
  let orders    = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]');

  /* ---------- Stock ---------- */
  const DEFAULT_STOCK = {
    'Potato Chips': 20,'Protein Bar': 18,'Trail Mix': 15,'Granola Bar': 24,
    'Doritos Flamin‚Äô Hot Nacho': 30,'Greek Yogurt': 12,'Mixed Nuts': 14,
    'Fruit Cup': 10,'Energy Drink': 16,'Chocolate Bar': 22
  };
  (function seedStock(){
    try{
      const cur = JSON.parse(localStorage.getItem(STOCK_KEY) || 'null');
      stock = cur && typeof cur === 'object' ? cur : {...DEFAULT_STOCK};
    }catch{ stock = {...DEFAULT_STOCK}; }
    localStorage.setItem(STOCK_KEY, JSON.stringify(stock));
  })();
  function saveStock(){ localStorage.setItem(STOCK_KEY, JSON.stringify(stock)); }
  function getStock(name){ return stock[name] ?? 0; }
  function setStock(name, qty){ stock[name] = Math.max(0, qty|0); saveStock(); applyOOSClasses(); }

  function applyOOSClasses(){
    $$('.card').forEach(card => {
      const s = getStock(card.dataset.name);
      card.classList.toggle('oos', (s||0) <= 0);
      const add = card.querySelector('.add'); if(add) add.disabled = (s||0) <= 0;
    });
  }

  /* ---------- Greeting & Profile ---------- */
  function updateGreeting(){
    const name = (localStorage.getItem(PROFILE_NAME_KEY) || '').trim();
    $('#greet') && ($('#greet').textContent = name ? `Hi, ${name} üëã` : 'Welcome üëã');
  }
  /* ---------- Carousel ---------- */
  function buildPromos(){
    const snapper = $('#snapper'); if(!snapper) return;
    let data = [];
    try{ data = JSON.parse(localStorage.getItem(PROMOS_KEY) || '[]'); }catch{}
    if(!data.length){
      data = [
        {img:'assets/carousel-1.jpg', title:'Fuel your study grind', cta:'Shop snacks', action:'scrollGrid'},
        {img:'assets/carousel-2.jpg', title:'Protein picks',       cta:'Filter: protein', action:'filter', value:'protein'},
        {img:'assets/carousel-3.jpg', title:'Need help?',          cta:'Open settings', action:'openSettings'}
      ];
      localStorage.setItem(PROMOS_KEY, JSON.stringify(data));
    }
    snapper.querySelectorAll('.snap-card').forEach(n => n.remove());
    const after = snapper.lastElementChild;
    data.forEach(p => {
      const c = document.createElement('div');
      c.className = 'snap-card';
      c.innerHTML = `<img class="banner" src="${p.img}" alt="${p.title}">
        <div class="snap-meta"><div class="snap-title">${p.title}</div>
        ${p.cta ? `<button class="ghost snap-cta" type="button">${p.cta}</button>` : ''}</div>`;
      snapper.insertBefore(c, after);
      c.addEventListener('click', e => {
        if(e.target.closest('.snap-cta')) return;
        if(p.action === 'scrollGrid') $('#grid')?.scrollIntoView({behavior:'smooth'});
        if(p.action === 'filter') activateChip(p.value || '');
        if(p.action === 'openSettings'){ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); }
      }, {passive:true});
      c.querySelector('.snap-cta')?.addEventListener('click', e => {
        e.stopPropagation();
        if(p.action === 'filter') activateChip(p.value || '');
        if(p.action === 'openSettings'){ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); }
        if(p.action === 'scrollGrid') $('#grid')?.scrollIntoView({behavior:'smooth'});
      });
    });

    const cards = $$('.snap-card');
    const dotsWrap = $('#snapDots'); if(!dotsWrap) return;
    dotsWrap.innerHTML = cards.map(() => '<div class="snap-dot"></div>').join('');
    const dots = $$('.snap-dot');
    const spacerLeft = snapper.firstElementChild;
    function setDot(i){ dots.forEach((d, k) => d.classList.toggle('active', k === i)); }
    function scrollToCard(i, smooth = true){
      const targetLeft = cards[i].offsetLeft - spacerLeft.offsetLeft;
      if(smooth) snapper.scrollTo({ left: targetLeft, behavior:'smooth' }); else snapper.scrollLeft = targetLeft;
      setDot(i);
    }
    dots.forEach((d, i) => d.addEventListener('click', () => scrollToCard(i, true)));
    setDot(0);

    // autoplay with interaction guard
    let idx = 0, hold = 5000, slide = 3000, start = null, phase = 'hold';
    let userInteracting = false, lastInteract = 0, inView = true;
    const INTERACT_COOLDOWN = 3500;
    ['pointerdown','wheel','touchstart','mousedown','scroll'].forEach(ev =>
      snapper.addEventListener(ev, () => { userInteracting = true; lastInteract = Date.now(); }, {passive:true})
    );
    const obs = new IntersectionObserver((ents) => { inView = ents.some(e => e.isIntersecting); }, { threshold:0.2 });
    obs.observe(snapper);
    let from = 0, to = 0;
    function step(ts){
      if(!cards.length || !inView) return requestAnimationFrame(step);
      if(userInteracting && (Date.now() - lastInteract) < INTERACT_COOLDOWN){ start = ts; return requestAnimationFrame(step); }
      if(!start) start = ts;
      const elapsed = ts - start;
      if(phase === 'hold'){
        if(elapsed >= hold){
          phase = 'slide'; start = ts; from = snapper.scrollLeft;
          idx = (idx + 1) % cards.length; to = cards[idx].offsetLeft - spacerLeft.offsetLeft;
        }
      }else{
        const t = Math.min(1, (ts - start) / slide);
        const e = t < .5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 8) / 2;
        snapper.scrollLeft = from + (to - from) * e;
        if(t >= 1){ phase = 'hold'; start = ts; setDot(idx); }
      }
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }
  /* ---------- Cart ---------- */
  function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(Array.from(cart.entries()))); }
  function refreshBadge(){
    let n = 0; for(const v of cart.values()) n += (v?.qty || 0);
    const badge = $('#cartBadge'); if(!badge) return;
    if(n > 0){ badge.textContent = String(n); badge.style.display = 'inline-flex'; }
    else { badge.style.display = 'none'; }
  }
  function renderCart(){
    let total = 0, html = '';
    for(const [name, info] of cart){
      const line = (info.price || 0) * (info.qty || 0);
      total += line;
      html += `<div class="row-between" style="margin-top:6px">
        <div style="display:flex;gap:10px;align-items:center">
          <button data-act="-" data-name="${name}" class="ghost" type="button" aria-label="Decrease">‚àí</button>
          <div style="min-width:24px;text-align:center">${info.qty}</div>
          <button data-act="+" data-name="${name}" class="ghost" type="button" aria-label="Increase">+</button>
          <div style="font-weight:700;margin-left:8px">${name}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <div style="font-weight:700">${fmt(line)}</div>
          <button data-remove="${name}" class="ghost" type="button" style="padding:2px 6px;font-size:12px">x</button>
        </div>
      </div>`;
    }
    $('#cartContent') && ($('#cartContent').innerHTML = html || '<div style="color:#aaa;margin-top:8px;">Cart is empty</div>');
    $('#cartTotal') && ($('#cartTotal').textContent = fmt(total));
  }

  /* Delegate +/‚àí and remove in cart */
  document.addEventListener('click', e => {
    const b = e.target.closest('button[data-act][data-name]');
    if(b){
      const name = b.getAttribute('data-name');
      const act  = b.getAttribute('data-act');
      const entry = cart.get(name);
      if(entry){
        entry.qty = Math.max( (act === '+') ? entry.qty + 1 : entry.qty - 1, 0 );
        if(entry.qty === 0) cart.delete(name);
        saveCart(); renderCart(); refreshBadge();
      }
      return;
    }
    const rm = e.target.closest('button[data-remove]');
    if(rm){
      const name = rm.getAttribute('data-remove');
      if(cart.has(name)){ cart.delete(name); saveCart(); renderCart(); refreshBadge(); }
      return;
    }
  }, {passive:true});

  function openCart(){ $('#cartOverlay')?.classList.add('show'); }
  function closeCart(){ $('#cartOverlay')?.classList.remove('show'); }
  $('#cartBtn')?.addEventListener('click', openCart);
  $('#cartBack')?.addEventListener('click', closeCart);
  /* ---------- Favorites ---------- */
  function saveFavs(){ localStorage.setItem(FAVORITES_KEY, JSON.stringify(Array.from(favorites))); }
  function syncFavStars(){
    $$('.card').forEach(card => card.querySelector('.fav')?.classList.toggle('active', favorites.has(card.dataset.name)));
  }
  document.addEventListener('click', e => {
    const fav = e.target.closest('.fav'); if(!fav) return;
    e.stopPropagation();
    const card = fav.closest('.card'); if(!card) return;
    const name = card.dataset.name;
    if(favorites.has(name)) favorites.delete(name); else favorites.add(name);
    saveFavs(); syncFavStars();
    const activeFilter = $('#chips .chip.active')?.dataset.filter;
    if(activeFilter === 'favorites' && !favorites.has(name)){
      card.classList.add('hidden-by-filter'); searchAndFilter();
    }
  }, {passive:true});

  /* ---------- Search & Filter ---------- */
  function shouldShowForChip(val, card){
    if(!val) return true;
    if(val === 'favorites') return favorites.has(card.dataset.name);
    if(val === 'stock') return (getStock(card.dataset.name) || 0) > 0;
    const tags = (card.dataset.tags || '').toLowerCase();
    return tags.includes(val);
  }
  function activateChip(val){
    $$('#chips .chip').forEach(ch => ch.classList.toggle('active', ch.dataset.filter === val));
    $$('.card').forEach(c => c.classList.toggle('hidden-by-filter', !shouldShowForChip(val, c)));
    searchAndFilter();
  }
  function searchAndFilter(){
    const q = ($('#search')?.value || '').toLowerCase();
    $$('.card').forEach(c => {
      const hitsName = c.dataset.name.toLowerCase().includes(q);
      const visible = !c.classList.contains('hidden-by-filter') && hitsName;
      c.style.display = visible ? '' : 'none';
    });
  }
  $('#chips')?.addEventListener('click', e => {
    const chip = e.target.closest('.chip'); if(!chip) return;
    activateChip(chip.dataset.filter || '');
  });
  $('#search')?.addEventListener('input', searchAndFilter);

  /* ---------- Product Sheet ---------- */
  let currentProduct = null;
  function openProductSheet(card){
    currentProduct = { name: card.dataset.name, price: parseFloat(card.dataset.price), img: card.dataset.img };
    $('#sheetTitle') && ($('#sheetTitle').textContent = currentProduct.name);
    if($('#sheetImg')){ $('#sheetImg').src = currentProduct.img || ''; $('#sheetImg').alt = currentProduct.name || ''; }
    $('#sheetPrice') && ($('#sheetPrice').textContent = fmt(currentProduct.price));
    const s = getStock(currentProduct.name);
    $('#sheetStock') && ($('#sheetStock').textContent = 'Stock: ' + s);
    $('#sheetLowWarn') && ($('#sheetLowWarn').style.display = s > 0 && s <= 3 ? 'block' : 'none');
    $('#qtyVal') && ($('#qtyVal').textContent = '1');
    $('#sheetAdd') && ($('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmt(currentProduct.price));
    $('#productSheet')?.classList.add('show');
  }
  function closeProductSheet(){ $('#productSheet')?.classList.remove('show'); }
  $('#sheetClose')?.addEventListener('click', closeProductSheet);
  $('#qtyPlus')?.addEventListener('click', () => {
    let n = parseInt($('#qtyVal')?.textContent || '1', 10);
    n = Math.min(99, n + 1);
    $('#qtyVal') && ($('#qtyVal').textContent = n);
    $('#sheetAdd') && ($('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmt(n * (currentProduct?.price || 0)));
  });
  $('#qtyMinus')?.addEventListener('click', () => {
    let n = parseInt($('#qtyVal')?.textContent || '1', 10);
    n = Math.max(1, n - 1);
    $('#qtyVal') && ($('#qtyVal').textContent = n);
    $('#sheetAdd') && ($('#sheetAdd').textContent = 'Add ‚Ä¢ ' + fmt(n * (currentProduct?.price || 0)));
  });
  $('#sheetAdd')?.addEventListener('click', () => {
    if(!currentProduct) return;
    const qty = parseInt($('#qtyVal')?.textContent || '1', 10);
    const s = getStock(currentProduct.name);
    if(s <= 0){ showToast('Out of stock'); return; }
    if(qty > s){ showToast('Not enough stock'); return; }
    const entry = cart.get(currentProduct.name) || { price: currentProduct.price, qty:0 };
    entry.qty += qty; cart.set(currentProduct
  /* ---------- Promo & Tip ---------- */
  function parsePromo(code){
    code = (code || '').trim().toUpperCase();
    if(!code) return null;
    const mPct = code.match(/(SAVE|PCT)(\d{1,2})/);
    if(mPct) return { type:'percent', value: Math.min(50, parseInt(mPct[2],10)) };
    const mAmt = code.match(/(OFF|\$)(\d{1,3})/);
    if(mAmt) return { type:'amount', value: Math.min(50, parseInt(mAmt[2],10)) };
    return null;
  }
  function computeTotals(){
    let subtotal = 0;
    for(const [, i] of cart) subtotal += i.price * i.qty;
    let disc = 0;
    if(promo){
      if(promo.type === 'percent') disc = subtotal * (promo.value / 100);
      else if(promo.type === 'amount') disc = Math.min(subtotal, promo.value);
    }
    let tipVal = 0;
    if(tip.type === 'amount') tipVal = tip.value;
    else if(tip.type === 'percent') tipVal = (subtotal - disc) * (tip.value / 100);
    const total = Math.max(0, subtotal - disc) + tipVal;
    return { subtotal, disc, tip: tipVal, total };
  }
  function updateCheckoutBreakdown(){
    const { subtotal, disc, tip: tipVal, total } = computeTotals();
    $('#ckSub')  && ($('#ckSub').textContent  = fmt(subtotal));
    $('#ckDisc') && ($('#ckDisc').textContent = `-${fmt(disc)}`);
    $('#ckTip')  && ($('#ckTip').textContent  = fmt(tipVal));
    $('#ckTotal')&& ($('#ckTotal').textContent= fmt(total));
  }
  $('#checkoutPromo')?.addEventListener('input', e => {
    promo = parsePromo(e.target.value);
    $('#promoStatus') && ($('#promoStatus').textContent = promo ? (promo.type === 'percent' ? `Applying ${promo.value}% off` : `Applying $${promo.value} off`) : '');
    updateCheckoutBreakdown();
  });
  $$('.tip-btn').forEach(btn => btn.addEventListener('click', () => {
    const spec = btn.getAttribute('data-tip') || 'none';
    if(spec === 'none') tip = { type:'none', value:0 };
    else if(spec.startsWith('amount'))  tip = { type:'amount',  value: parseFloat(spec.split(':')[1]) || 0 };
    else if(spec.startsWith('percent')) tip = { type:'percent', value: parseFloat(spec.split(':')[1]) || 0 };
    updateCheckoutBreakdown(); showToast('Tip updated');
  }));

  /* ---------- Checkout Flow ---------- */
  function openCheckout(){
    const name = localStorage.getItem(PROFILE_NAME_KEY) || '';
    const loc  = localStorage.getItem(PROFILE_LOC_KEY) || '';
    $('#checkoutName') && ($('#checkoutName').value = name);
    $('#checkoutLocation') && ($('#checkoutLocation').value = loc);
    updateCheckoutBreakdown();
    $('#checkoutOverlay')?.classList.add('show');
  }
  function closeCheckout(){ $('#checkoutOverlay')?.classList.remove('show'); }
  $('#cartCheckout')?.addEventListener('click', () => {
    if(cart.size === 0){ showToast('Cart is empty'); return; }
    closeCart(); openCheckout();
  });
  $('#checkoutBack')?.addEventListener('click', () => { closeCheckout(); openCart(); });
  $('#checkoutClose')?.addEventListener('click', closeCheckout);

  async function writeOrderToFirestore(order){
    try{
      const { db } = window.__fs || {};
      if(!db) return null;
      const ref = await addDoc(collection(db, 'orders'), {
        when: serverTimestamp(),
        name: order.name,
        location: order.loc,
        lines: order.lines,
        total: order.total,
        status: 'active'
      });
      return ref.id;
    }catch(e){ console.warn('Firestore write failed', e); return null; }
  }
  async function placeOrder(){
    if(cart.size === 0){ showToast('Cart is empty'); return; }
    const name = ($('#checkoutName')?.value || '').trim();
    const loc  = ($('#checkoutLocation')?.value || '').trim();
    if(!name || !loc){ showToast('Add your name and location'); return; }

    localStorage.setItem(PROFILE_NAME_KEY, name);
    localStorage.setItem(PROFILE_LOC_KEY, loc);
    updateGreeting();

    const lines = Array.from(cart.entries()).map(([k,v]) => ({ name:k, qty:v.qty, price:v.price, line: v.qty*v.price }));
    const { subtotal, disc, tip: tipVal, total } = computeTotals();
    const order = {
      id: 'FS-' + Date.now(),
      at: new Date().toISOString(),
      name, loc, promo, tip, subtotal, discount: disc, total,
      lines
    };

    orders.push(order);
    localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
    localStorage.setItem(LAST_ORDER_KEY, JSON.stringify(order));

    // Optional IFTTT webhook (only if key is set)
    if(IFTTT_KEY && IFTTT_KEY !== 'REPLACE_WITH_IFTTT_KEY'){
      try{
        await fetch(IFTTT_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            value1: `${order.id} | ${name} @ ${loc} | ${fmt(total)}`,
            value2: lines.map(l => `${l.qty}√ó ${l.name}`).join(', '),
            value3: promo ? (promo.type==='percent' ? `${promo.value}% off` : `$${promo.value} off`) : ''
          })
        });
      }catch(err){ console.warn('IFTTT post failed', err); }
    }

    cart.clear(); saveCart(); renderCart(); refreshBadge();
    closeCheckout(); showToast('Order placed üéâ');

    if(isAdminUnlocked()){
      renderAdminOrders(); updateKpis(); buildHeatMap(); appendHistoryEvent(order);
    }
  }
  $('#checkoutPlace')?.addEventListener('click', placeOrder);

  /* Re-order last */
  $('#reorderLast')?.addEventListener('click', () => {
    const last = JSON.parse(localStorage.getItem(LAST_ORDER_KEY) || 'null');
    if(!last || !Array.isArray(last.lines) || !last.lines.length){ showToast('No previous order'); return; }
    for(const l of last.lines){
      const s = getStock(l.name);
      const qty = Math.min(l.qty, s);
      if(qty <= 0) continue;
      const entry = cart.get(l.name) || { price: l.price, qty:0 };
      entry.qty += qty; cart.set(l.name, entry);
      setStock(l.name, s - qty);
    }
    saveCart(); renderCart(); refreshBadge(); openCart(); showToast('Added last order items');
  });
  /* ---------- Settings & Admin ---------- */
  function switchTab(which){
    const gen = $('#settingsGeneral'), adm = $('#settingsAdmin');
    const tg = $('#tabGeneral'), ta = $('#tabAdmin');
    const isGen = which !== 'admin';
    gen && (gen.style.display = isGen ? '' : 'none');
    adm && (adm.style.display = isGen ? 'none' : '');
    tg && tg.classList.toggle('active', isGen);
    ta && ta.classList.toggle('active', !isGen);
  }
  $('#settingsBtn')?.addEventListener('click',()=>{ $('#settingsOverlay')?.classList.add('show'); switchTab('general'); });
  $('#settingsClose')?.addEventListener('click',()=>$('#settingsOverlay')?.classList.remove('show'));
  $('#tabGeneral')?.addEventListener('click', ()=> switchTab('general'));
  $('#tabAdmin')?.addEventListener('click',   ()=> switchTab('admin'));
  $('#profileSave')?.addEventListener('click', ()=>{
    const n = ($('#profileName')?.value || '').trim();
    const l = ($('#profileLoc')?.value || '').trim();
    if(n) localStorage.setItem(PROFILE_NAME_KEY, n);
    if(l) localStorage.setItem(PROFILE_LOC_KEY, l);
    updateGreeting(); showToast('Saved');
  });

  function isAdminUnlocked(){ return localStorage.getItem(UNLOCK_KEY) === '1'; }
  function ensureAdminLoginVisible(){
    const area = $('#adminArea'); if(!area) return;
    area.style.display = isAdminUnlocked() ? '' : 'none';
  }
  $('#adminUnlock')?.addEventListener('click', ()=>{
    const pass = $('#adminPass')?.value || '';
    if(pass === ADMIN_PASSWORD){
      localStorage.setItem(UNLOCK_KEY,'1');
      ensureAdminLoginVisible(); buildAdminSubtabs(); buildAdminStockTable(); renderAdminOrders(); updateKpis(); buildHeatMap(); renderHistory();
      showToast('Admin unlocked');
    } else showToast('Wrong password');
  });
  $('#openSettingsFromPrompt')?.addEventListener('click', ()=>{
    $('#adminPrompt')?.classList.remove('show');
    $('#settingsOverlay')?.classList.add('show'); switchTab('admin');
  });

  /* ---- Admin Subtabs (fallbacks OK) ---- */
  const DEFAULT_SUBTABS = [
    { id:'stock',   label:'Stock',    panel:'adminStock'   },
    { id:'orders',  label:'Orders',   panel:'adminOrders'  },
    { id:'heat',    label:'Analytics (Heat Map)', panel:'adminHeat' },
    { id:'history', label:'History',  panel:'adminHistory' },
    { id:'promos',  label:'Promos',   panel:'adminPromos'  },
  ];
  async function loadSubtabsJSON(urls=[
    'assets/settings-tabs.json',
    'assets/admin.json',
    'assets/settings.json',
    'assets/ui.json'
  ]){
    for(const url of urls){
      try{
        const r = await fetch(url, {cache:'no-store'});
        if(!r.ok) continue;
        const j = await r.json();
        if(j?.admin?.subtabs?.length){
          return j.admin.subtabs.map(x => ({ id:x.id||x.panelId||x.label, label:x.label||x.id, panel:x.panelId||x.id }));
        }
        if(Array.isArray(j?.tabs)){
          const admin = j.tabs.find(t => String(t.id||t.label).toLowerCase().startsWith('admin'));
          if(admin?.subtabs?.length){
            return admin.subtabs.map(x => ({ id:x.id||x.panelId||x.label, label:x.label||x.id, panel:x.panelId||x.id }));
          }
        }
        if(Array.isArray(j?.adminSubtabs)) {
          return j.adminSubtabs.map(x => ({ id:x.id||x, label:x.label||x, panel:x.panelId||x.id||x }));
        }
      }catch{}
    }
    return DEFAULT_SUBTABS;
  }
  function setActiveSubtab(id){
    $$('.subtab').forEach(b => b.classList.toggle('active', b.dataset.sub === id));
    $('#adminStock')?.setAttribute('style','display:block;');
    $('#adminOrders')?.setAttribute('style','display:block;');
    $('#adminHeat')?.setAttribute('style','display:block;');
    $('#adminHistory')?.setAttribute('style','display:block;');
    $('#adminPromos')?.setAttribute('style','display:block;');
    if(id==='stock')   $('#adminStock').style.display='';
    if(id==='orders')  $('#adminOrders').style.display='';
    if(id==='heat')    $('#adminHeat').style.display='';
    if(id==='history') $('#adminHistory').style.display='';
    if(id==='promos')  $('#adminPromos').style.display='';
  }
  async function buildAdminSubtabs(){
    const bar = $('#adminSubtabs'); if(!bar) return;
    const tabs = await loadSubtabsJSON();
    bar.innerHTML = tabs.map((t,i)=>`<button class="subtab${i===0?' active':''}" data-sub="${t.id}" type="button">${t.label}</button>`).join('');
    bar.addEventListener('click', e=>{
      const b = e.target.closest('.subtab'); if(!b) return;
      setActiveSubtab(b.dataset.sub);
      if(b.dataset.sub==='orders') renderAdminOrders();
      if(b.dataset.sub==='stock')  buildAdminStockTable();
      if(b.dataset.sub==='heat')   buildHeatMap();
      if(b.dataset.sub==='history')renderHistory();
    }, {passive:true});
    setActiveSubtab(tabs[0]?.id || 'stock');
    showToast('Admin tabs: ' + tabs.map(t=>t.label).join(', '), 2200);
  }

  /* ---- Inventory helpers: pop-on-card ---- */
  function getCardByName(name){
    return [...document.querySelectorAll('.card')].find(c => c.dataset.name === name);
  }
  function flashCardNote(name, text = 'Saved'){
    const card = getCardByName(name);
    if(!card) return;
    const note = document.createElement('div');
    note.className = 'card-pop';
    note.textContent = text;
    card.appendChild(note);
    setTimeout(()=> note.remove(), 1000);
  }
  function pulseCard(name){
    const card = getCardByName(name);
    if(!card) return;
    card.classList.add('pulse');
    setTimeout(()=> card.classList.remove('pulse'), 400);
  }

  /* ---- Admin: Stock editor (editable list of products) ---- */
  function buildAdminStockTable(){
    const host = $('#adminStock'); if(!host) return;
    const names = Object.keys(stock).length ? Object.keys(stock) :
      [...$$('.card')].map(c => c.dataset.name);
    const rows = names.sort().map(n => `
      <div class="rowd" style="display:grid;grid-template-columns:1fr 90px 70px 70px;gap:8px;">
        <div>${n}</div>
        <div><input type="number" min="0" value="${getStock(n)}" data-stock="${n}" style="width:100%;padding:6px;border-radius:8px;background:#111;border:1px solid #2a2a30;color:#fff;"></div>
        <div><button class="ghost" data-stock-save="${n}" type="button">Save</button></div>
        <div><button class="ghost" data-stock-zero="${n}" type="button">Zero</button></div>
      </div>`).join('');
    host.innerHTML = `
      <div class="rowh" style="display:grid;grid-template-columns:1fr 90px 70px 70px;gap:8px;">
        <div>Item</div><div>Stock</div><div></div><div></div>
      </div>${rows}`;
  }
  /* Handle Save / Zero in Inventory and pop on card */
  document.addEventListener('click', e => {
    const s = e.target.closest('button[data-stock-save]');
    if(s){
      const name = s.getAttribute('data-stock-save');
      const input = $('#adminStock')?.querySelector(`[data-stock="${CSS.escape(name)}"]`);
      const val = parseInt(input?.value || '0', 10);
      setStock(name, isFinite(val) ? val : 0);
      showToast('Stock updated');

      // Pop on product card + pulse
      flashCardNote(name, `Stock: ${Math.max(0, val|0)}`);
      pulseCard(name);

      // Refresh dependent views
      renderAdminOrders(); updateKpis(); buildHeatMap();
      return;
    }
    const z = e.target.closest('button[data-stock-zero]');
    if(z){
      const name = z.getAttribute('data-stock-zero');
      setStock(name, 0);
      showToast('Stock zeroed');

      flashCardNote(name, 'Stock: 0');
      pulseCard(name);

      renderAdminOrders(); updateKpis(); buildHeatMap();
      return;
    }
  }, {passive:true});

  /* ---- Admin: Orders view (tap to detail) ---- */
  function renderAdminOrders(){
    const host = $('#adminOrders'); if(!host) return;
    if(!orders.length){
      host.innerHTML = '<div style="color:#c7c7cc;">No orders yet.</div>';
      return;
    }
    host.innerHTML = orders.slice().reverse().map((o,i) => `
      <div class="order-item" data-idx="${i}" data-id="${o.id||''}" style="padding:8px;border-bottom:1px solid #2a2a30;cursor:pointer">
        <div style="font-weight:700">${new Date(o.at||o.when).toLocaleString()}</div>
        <div>${o.name} @ ${o.loc||o.location}</div>
        <div style="font-weight:700">Total ${fmt(o.total)}</div>
        <div class="muted">Status: ${o.status||'active'}</div>
      </div>
    `).join('');
  }

  function openOrderSheetByIndex(idx){
    const o = orders.slice().reverse()[idx]; if(!o) return;
    $('#orderMeta').textContent=`${new Date(o.at||o.when).toLocaleString()} ‚Ä¢ ${o.name} @ ${o.loc||o.location}`;
    $('#orderLines').innerHTML=(o.lines||[]).map(l=>`
      <div class="row-between" style="padding:6px 0">
        <div>${l.name} √ó ${l.qty}</div><div style="font-weight:700">${fmt(l.line || l.price*l.qty)}</div>
      </div>`).join('');
    $('#orderTotal').textContent=fmt(o.total||0);
    $('#orderSheet').dataset.id = o.id||'';
    $('#orderSheet').dataset.idx = String(idx);
    document.body.appendChild($('#orderSheet'));
    $('#orderSheet').classList.add('show');
  }

  document.addEventListener('click', e=>{
    const row=e.target.closest('.order-item');
    if(row) openOrderSheetByIndex(parseInt(row.dataset.idx,10));
  }, {passive:true});

  $('#orderClose')?.addEventListener('click', ()=>$('#orderSheet').classList.remove('show'));
  $('#orderCancel')?.addEventListener('click', ()=>$('#orderSheet').classList.remove('show'));

  $('#orderDelivered')?.addEventListener('click', async ()=>{
    const idx = parseInt($('#orderSheet').dataset.idx||'-1',10);
    const list = orders.slice().reverse();
    const o = list[idx]; if(!o) return;

    o.status='delivered';

    // Add to delivered history (local)
    const hist=JSON.parse(localStorage.getItem(DELIVERED_KEY)||'[]'); 
    hist.unshift(o);
    localStorage.setItem(DELIVERED_KEY, JSON.stringify(hist));

    // Write back to original order array (reverse mapping)
    orders = list.slice().reverse();
    localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));

    // Try Firestore status update (best-effort)
    try{
      if(o.id && window.__fs?.db){
        const { db } = window.__fs;
        await updateDoc(doc(db,'orders',o.id), { status:'delivered' });
      }
    }catch(e){ console.warn('Failed to update Firestore status', e); }

    renderHistory(); renderAdminOrders(); updateKpis();
    $('#orderSheet').classList.remove('show');
    showToast('Marked delivered');
  });

  /* ---- Admin: KPIs ---- */
  function updateKpis(){
    const openCount = orders.length;
    const revenue = orders.reduce((a,b)=>a+(b.total||0),0);
    $('#kpiOpen') && ($('#kpiOpen').textContent = String(openCount));
    $('#kpi
  /* ---------- Bootstrap ---------- */
  document.addEventListener('DOMContentLoaded', async () => {
    try{
      updateGreeting();
      buildPromos();
      renderCart(); refreshBadge();
      applyOOSClasses();
      activateChip('');
      ensureAdminLoginVisible();
      if(isAdminUnlocked()){
        await buildAdminSubtabs();
        buildAdminStockTable();
        renderAdminOrders();
        updateKpis();
        buildHeatMap();
        renderHistory();
      }

      // Overlay close on backdrop & ESC
      document.querySelectorAll('.overlay').forEach(ov=>{
        ov.addEventListener('click', (e)=>{ if(e.target===ov) ov.classList.remove('show'); }, {passive:true});
      });
      document.addEventListener('keydown', e=>{
        if(e.key==='Escape'){
          document.querySelectorAll('.overlay.show').forEach(ov=>ov.classList.remove('show'));
        }
      });

      // Safe binds
      $('#cartBtn')?.addEventListener('click',()=>$('#cartOverlay')?.classList.add('show'));
      $('#cartBack')?.addEventListener('click',()=>$('#cartOverlay')?.classList.remove('show'));
    }catch(e){
      console.error('Bootstrap error', e);
    }
  });
  </script-->
</body>
</html>
<!-- rebuild 1759556295 -->
